{"title":"MoonScript与ElasticSearch客户端","uid":"5f974a115cefd23be7d8b6092b3445d0","slug":"old_topic/2016-09-17-361","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T07:45:09.161Z","comments":true,"path":"api/articles/old_topic/2016-09-17-361.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<p>作者：糖果</p>\n<p>从Github上看，有一位叫做Dhaval Kapil老师完成了ElasticSearch for Lua的工作，另一位来自阿根廷的叫做Cristian Haunsen的老师，完成了ElasticSearch for Lapis的客户端程序写作工作,dhavalkapil还有一个博客可以访问：<a href=\"http://dhavalkapil.com\">dhavalkapil.com</a></p>\n<p>这次实验的目标，是测试一下本地直接运行ES for Lua，然后在Lapis中访问ES，我们的日志在ES，可以用Lua，也可以用Python完成ES的访问工作， Python没有问题，Lua就看这个实验了。</p>\n<p>测试代码，如下：</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token keyword\">local</span> elasticsearch <span class=\"token operator\">=</span> require <span class=\"token string\">\"elasticsearch\"</span>\n\n<span class=\"token keyword\">local</span> client <span class=\"token operator\">=</span> elasticsearch<span class=\"token punctuation\">.</span><span class=\"token function\">client</span><span class=\"token punctuation\">&#123;</span>\n    hosts <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">-- Ignoring any of the following hosts parameters is allowed.</span>\n        <span class=\"token comment\">-- The default shall be set</span>\n        protocol <span class=\"token operator\">=</span> <span class=\"token string\">\"http\"</span><span class=\"token punctuation\">,</span>\n        host <span class=\"token operator\">=</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span>\n        port <span class=\"token operator\">=</span> <span class=\"token number\">9200</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">-- Optional parameters</span>\n    params <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n      pingTimeout <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">-- Will connect to default host/port</span>\n<span class=\"token keyword\">local</span> client <span class=\"token operator\">=</span> elasticsearch<span class=\"token punctuation\">.</span><span class=\"token function\">client</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">local</span> data<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> client<span class=\"token punctuation\">:</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>Full list of params（全参数列表）:</p>\n<ol>\n<li class=\"lvl-3\">\n<p>pingTimeout : The timeout of a connection for ping and sniff request. Default is 1.</p>\n</li>\n<li class=\"lvl-3\">\n<p>selector : The type of selection strategy to be used. Default is RoundRobinSelector.</p>\n</li>\n<li class=\"lvl-3\">\n<p>connectionPool : The type of connection pool to be used. Default is StaticConnectionPool.</p>\n</li>\n<li class=\"lvl-3\">\n<p>connectionPoolSettings : The connection pool settings,</p>\n</li>\n<li class=\"lvl-3\">\n<p>maxRetryCount : The maximum times to retry if a particular connection fails.</p>\n</li>\n<li class=\"lvl-3\">\n<p>logLevel : The level of logging to be done. Default is warning.</p>\n</li>\n</ol>\n<h4 id=\"getting-info-of-elasticsearch-server取得es服务器信息\"><a class=\"markdownIt-Anchor\" href=\"#getting-info-of-elasticsearch-server取得es服务器信息\"></a> Getting info of elasticsearch server（取得ES服务器信息）</h4>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token keyword\">local</span> data<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> client<span class=\"token punctuation\">:</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<h4 id=\"index-a-document创建索引文档\"><a class=\"markdownIt-Anchor\" href=\"#index-a-document创建索引文档\"></a> Index a document（创建索引文档）</h4>\n<p>Everything is represented as a lua table.(一切皆为Lua Table)</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token keyword\">local</span> data<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> client<span class=\"token punctuation\">:</span><span class=\"token function\">index</span><span class=\"token punctuation\">&#123;</span>\n  index <span class=\"token operator\">=</span> <span class=\"token string\">\"my_index\"</span><span class=\"token punctuation\">,</span>\n  type <span class=\"token operator\">=</span> <span class=\"token string\">\"my_type\"</span><span class=\"token punctuation\">,</span>\n  id <span class=\"token operator\">=</span> <span class=\"token string\">\"my_doc\"</span><span class=\"token punctuation\">,</span>\n  body <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n    my_key <span class=\"token operator\">=</span> <span class=\"token string\">\"my_param\"</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"get-a-document取得文档\"><a class=\"markdownIt-Anchor\" href=\"#get-a-document取得文档\"></a> Get a document（取得文档）</h4>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\">data<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> client<span class=\"token punctuation\">:</span><span class=\"token function\">get</span><span class=\"token punctuation\">&#123;</span>\n  index <span class=\"token operator\">=</span> <span class=\"token string\">\"my_index\"</span><span class=\"token punctuation\">,</span>\n  type <span class=\"token operator\">=</span> <span class=\"token string\">\"my_type\"</span><span class=\"token punctuation\">,</span>\n  id <span class=\"token operator\">=</span> <span class=\"token string\">\"my_doc\"</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"delete-a-document删除文档\"><a class=\"markdownIt-Anchor\" href=\"#delete-a-document删除文档\"></a> Delete a document（删除文档）</h4>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\">data<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> client<span class=\"token punctuation\">:</span><span class=\"token function\">delete</span><span class=\"token punctuation\">&#123;</span>\n  index <span class=\"token operator\">=</span> <span class=\"token string\">\"my_index\"</span><span class=\"token punctuation\">,</span>\n  type <span class=\"token operator\">=</span> <span class=\"token string\">\"my_type\"</span><span class=\"token punctuation\">,</span>\n  id <span class=\"token operator\">=</span> <span class=\"token string\">\"my_doc\"</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"searching-a-document-检索文档\"><a class=\"markdownIt-Anchor\" href=\"#searching-a-document-检索文档\"></a> Searching a document （检索文档）</h4>\n<p>You can search a document using either query string:（使有查询字符进行检索）</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\">data<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> client<span class=\"token punctuation\">:</span><span class=\"token function\">search</span><span class=\"token punctuation\">&#123;</span>\n  index <span class=\"token operator\">=</span> <span class=\"token string\">\"my_index\"</span><span class=\"token punctuation\">,</span>\n  type <span class=\"token operator\">=</span> <span class=\"token string\">\"my_type\"</span><span class=\"token punctuation\">,</span>\n  q <span class=\"token operator\">=</span> <span class=\"token string\">\"my_key:my_param\"</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"or-either-a-request-body或是请求体\"><a class=\"markdownIt-Anchor\" href=\"#or-either-a-request-body或是请求体\"></a> Or either a request body:(或是请求体)</h4>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\">data<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> client<span class=\"token punctuation\">:</span><span class=\"token function\">search</span><span class=\"token punctuation\">&#123;</span>\n  index <span class=\"token operator\">=</span> <span class=\"token string\">\"my_index\"</span><span class=\"token punctuation\">,</span>\n  type <span class=\"token operator\">=</span> <span class=\"token string\">\"my_type\"</span><span class=\"token punctuation\">,</span>\n  body <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n    query <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n      match <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n        my_key <span class=\"token operator\">=</span> <span class=\"token string\">\"my_param\"</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"update-a-document更新文档\"><a class=\"markdownIt-Anchor\" href=\"#update-a-document更新文档\"></a> Update a document（更新文档）</h4>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\">data<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> client<span class=\"token punctuation\">:</span><span class=\"token function\">update</span><span class=\"token punctuation\">&#123;</span>\n  index <span class=\"token operator\">=</span> <span class=\"token string\">\"my_index\"</span><span class=\"token punctuation\">,</span>\n  type <span class=\"token operator\">=</span> <span class=\"token string\">\"my_type\"</span><span class=\"token punctuation\">,</span>\n  id <span class=\"token operator\">=</span> <span class=\"token string\">\"my_doc\"</span><span class=\"token punctuation\">,</span>\n  body <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n    doc <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n      my_key <span class=\"token operator\">=</span> <span class=\"token string\">\"new_param\"</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>其实MoonScript for ElasticSearch的库是一个纯正的MoonScript实现，但从Readme中描述<br />\n是没显明的看是用MoonScript实现，不防抽出的MoonScript核心实现，贴出来看一下：</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\">client <span class=\"token operator\">=</span> elasticsearch<span class=\"token punctuation\">.</span><span class=\"token function\">client</span> <span class=\"token punctuation\">&#123;</span>\n    hosts<span class=\"token punctuation\">:</span> config<span class=\"token punctuation\">.</span>elasticsearch<span class=\"token punctuation\">.</span>hosts <span class=\"token keyword\">and</span> <span class=\"token function\">parse_hosts_config</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>elasticsearch<span class=\"token punctuation\">.</span>hosts<span class=\"token punctuation\">)</span> <span class=\"token keyword\">or</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token punctuation\">&#123;</span>\n            protocol<span class=\"token punctuation\">:</span> <span class=\"token string\">\"http\"</span>\n            host<span class=\"token punctuation\">:</span> <span class=\"token string\">\"127.0.0.1\"</span>\n            port<span class=\"token punctuation\">:</span> <span class=\"token number\">9200</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    params<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">-- Should return a table with &#123; status, statusCode, body &#125;</span>\n        preferred_engine<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>method<span class=\"token punctuation\">,</span> uri<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">,</span> body<span class=\"token punctuation\">,</span> timeout<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span>\n            http <span class=\"token operator\">=</span> require <span class=\"token string\">\"resty.http\"</span>\n            httpc <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span>new!\n            args <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">:</span>method<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span>body<span class=\"token punctuation\">,</span> headers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"application/json\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span>\n            res<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> httpc\\<span class=\"token function\">request_uri</span><span class=\"token punctuation\">(</span>uri<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> res\n                ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"failed to request: \"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">return</span>\n\n            response <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n            response<span class=\"token punctuation\">.</span>code <span class=\"token operator\">=</span> res<span class=\"token punctuation\">.</span>status\n            response<span class=\"token punctuation\">.</span>statusCode <span class=\"token operator\">=</span> res<span class=\"token punctuation\">.</span>status\n            response<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> res<span class=\"token punctuation\">.</span>body\n            <span class=\"token keyword\">return</span> response\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">:</span>interpolate_query<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span>client\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>API封装以外，用的还是&quot;resty.http&quot;调用，这里有一个疑问，resty.http和simple.http是<br />\n不是同一个部件？</p>\n<p><a href=\"http://lua.ren/topic/270/elasticsearch%E7%9A%84lua%E5%AE%A2%E6%88%B7%E7%AB%AF\">原文</a></p>\n<p><a href=\"https://github.com/CriztianiX/lapis-elasticsearch\">lapis-elasticsearch</a></p>\n<p>PS：本文测式用代码都来自至官方ES-LUA的Github的Readme。</p>\n","text":"作者：糖果 从Github上看，有一位叫做Dhaval Kapil老师完成了ElasticSearch for Lua的工作，另一位来自阿根廷的叫做Cristian Haunsen的老师，完成了ElasticSearch for Lapis的客户端程序写作工作,dhavalkap...","link":"","photos":[],"count_time":{"symbolsCount":"3.7k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#getting-info-of-elasticsearch-server%E5%8F%96%E5%BE%97es%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BF%A1%E6%81%AF\"><span class=\"toc-text\"> Getting info of elasticsearch server（取得ES服务器信息）</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#index-a-document%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E6%96%87%E6%A1%A3\"><span class=\"toc-text\"> Index a document（创建索引文档）</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#get-a-document%E5%8F%96%E5%BE%97%E6%96%87%E6%A1%A3\"><span class=\"toc-text\"> Get a document（取得文档）</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#delete-a-document%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3\"><span class=\"toc-text\"> Delete a document（删除文档）</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#searching-a-document-%E6%A3%80%E7%B4%A2%E6%96%87%E6%A1%A3\"><span class=\"toc-text\"> Searching a document （检索文档）</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#or-either-a-request-body%E6%88%96%E6%98%AF%E8%AF%B7%E6%B1%82%E4%BD%93\"><span class=\"toc-text\"> Or either a request body:(或是请求体)</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#update-a-document%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3\"><span class=\"toc-text\"> Update a document（更新文档）</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"HiLua框架与MoonScript库的交互过程","uid":"e42217fa2cd64fc77d86460421fbfaca","slug":"old_topic/2016-09-17-360","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T07:45:09.169Z","comments":true,"path":"api/articles/old_topic/2016-09-17-360.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"作者：糖果 上一篇是用.so作为框架的库，这是接上回，用MoonScript实现库。 在HiLua工程中，创建/libs/moon目录，建立MoonScript库代码，如下： HiLog.moon class HiLog @log: => print(\"HiLog...\") re...","link":"","photos":[],"count_time":{"symbolsCount":"1.1k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"MoonScript与Redis客户端","uid":"55c8ceefd620d530c7de11d61153ba84","slug":"old_topic/2016-09-17-363","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T07:45:09.208Z","comments":true,"path":"api/articles/old_topic/2016-09-17-363.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"所谓的Redis LUA客户端有两种版本，一种就是本地可运行版本，还有一个版本是OpenResty的版本，下面介绍的这段Moonscript段代码是本地版的。 作者：糖果 candylab.moon redis = require \"redis\" client = redis.c...","link":"","photos":[],"count_time":{"symbolsCount":540,"symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}