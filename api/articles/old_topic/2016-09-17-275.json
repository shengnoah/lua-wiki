{"title":"Lua获取网络时间","uid":"ac0402ecf46546727fdbca4cc5ec0bdf","slug":"old_topic/2016-09-17-275","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T06:15:59.745Z","comments":true,"path":"api/articles/old_topic/2016-09-17-275.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":null,"content":"<p>作者：ani_di<br>版权所有，转载务必保留此链接 <a href=\"http://blog.csdn.net/ani_di\">http://blog.csdn.net/ani_di</a></p>\n<p>Lua获取网络时间<br>网络授时服务是一些网络上的时间服务器提供的时间，一般用于本地时钟同步。 授时服务有很多种，一般我们选择RFC-868。这个协议的工作流程是：（S代表Server，C代表Client）</p>\n<p>S: 检测端口37<br>U: 连接到端口37<br>S: 以32位二进制数发送时间<br>U: 接收时间<br>U: 关闭连接<br>S: 关闭连接<br>协议非常简单，用TCP连接上后，服务器直接把时间发送回来。发送的是从1900年1月1日午夜到现在的秒数。</p>\n<p>使用luasocket<br>实现的方案有很多种，Lua不一定是最简单的，选择只是出于个人兴趣。直接上代码吧</p>\n<hr>\n<p>– Network Time Protocal<br>– Author: ani_di</p>\n<hr>\n<p>源码：</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">package</span>.<span class=\"built_in\">cpath</span> = <span class=\"built_in\">package</span>.<span class=\"built_in\">cpath</span> .. <span class=\"string\">&#x27;;D:\\\\tools\\\\Lua\\\\5.1\\\\clibs\\\\?.dll;?.dll&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> socket = <span class=\"built_in\">require</span> <span class=\"string\">&quot;socket.core&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">server_ip = &#123;</span><br><span class=\"line\">        <span class=\"comment\">-- &quot;129.6.15.29&quot;,</span></span><br><span class=\"line\">        <span class=\"string\">&quot;132.163.4.101&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;132.163.4.102&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;132.163.4.103&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;128.138.140.44&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;192.43.244.18&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;131.107.1.10&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;66.243.43.21&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;216.200.93.8&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;208.184.49.9&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;207.126.98.204&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;207.200.81.113&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;205.188.185.33&quot;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">nstol</span><span class=\"params\">(str)</span></span></span><br><span class=\"line\">    <span class=\"built_in\">assert</span>(str <span class=\"keyword\">and</span> #str == <span class=\"number\">4</span>)</span><br><span class=\"line\">    <span class=\"keyword\">local</span> t = &#123;str:<span class=\"built_in\">byte</span>(<span class=\"number\">1</span>,<span class=\"number\">-1</span>)&#125;</span><br><span class=\"line\">    <span class=\"keyword\">local</span> n = <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> k = <span class=\"number\">1</span>, #t <span class=\"keyword\">do</span></span><br><span class=\"line\">        n= n*<span class=\"number\">256</span> + t[k]</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> n</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- get time from a ip address, use tcp protocl</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">gettime</span><span class=\"params\">(ip)</span></span></span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;connect &#x27;</span>, ip)</span><br><span class=\"line\">    <span class=\"keyword\">local</span> tcp = socket.tcp()</span><br><span class=\"line\">    tcp:settimeout(<span class=\"number\">10</span>)</span><br><span class=\"line\">    tcp:connect(ip, <span class=\"number\">37</span>)</span><br><span class=\"line\">    success, <span class=\"built_in\">time</span> = <span class=\"built_in\">pcall</span>(nstol, tcp:receive(<span class=\"number\">4</span>))</span><br><span class=\"line\">    tcp:<span class=\"built_in\">close</span>()</span><br><span class=\"line\">    <span class=\"keyword\">return</span> success <span class=\"keyword\">and</span> <span class=\"built_in\">time</span> <span class=\"keyword\">or</span> <span class=\"literal\">nil</span></span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">nettime</span><span class=\"params\">()</span></span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> _, ip <span class=\"keyword\">in</span> <span class=\"built_in\">pairs</span>(server_ip) <span class=\"keyword\">do</span></span><br><span class=\"line\">        <span class=\"built_in\">time</span> = gettime(ip)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"built_in\">time</span> <span class=\"keyword\">then</span> </span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">time</span></span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br></pre></td></tr></table></figure>\n\n<p>代码原理不细说，非常简单。唯一值得一提的是socket库包含。最开始用的这句 require “socket”</p>\n<p>在解释器中表现很好，但在用C中调用会找不到相应的module。错误提示</p>\n<pre><code>no field package.preload[&#39;socket&#39;]\nno file &#39;.\\socket.lua&#39;\nno file &#39;F:\\Projects\\Lua\\nettime\\lua\\socket.lua&#39;\nno file &#39;F:\\Projects\\Lua\\nettime\\lua\\socket\\init.lua&#39;\nno file &#39;F:\\Projects\\Lua\\nettime\\socket.lua&#39;\nno file &#39;F:\\Projects\\Lua\\nettime\\socket\\init.lua&#39;\nno file &#39;D:\\tools\\Lua\\5.1\\lua\\socket.luac&#39;\nno file &#39;.\\socket.dll&#39;\nno file &#39;.\\socket51.dll&#39;\nno file &#39;F:\\Projects\\Lua\\nettime\\socket.dll&#39;\nno file &#39;F:\\Projects\\Lua\\nettime\\socket51.dll&#39;\nno file &#39;F:\\Projects\\Lua\\nettime\\clibs\\socket.dll&#39;\nno file &#39;F:\\Projects\\Lua\\nettime\\clibs\\socket51.dll&#39;\nno file &#39;F:\\Projects\\Lua\\nettime\\loadall.dll&#39;\nno file &#39;F:\\Projects\\Lua\\nettime\\clibs\\loadall.dll&#39;.\n</code></pre>\n<p>网上也有好多类似的提问，大抵是没仔细看作者的Guide。显著的有这么一句</p>\n<p>The other two environment variables instruct the compatibility module to look for dynamic libraries and extension modules in the appropriate directories and with the appropriate filename extensions.&gt;</p>\n<p>LUAPATH=/?.lua;?.lua LUACPATH=/?.dll;?.dll</p>\n<p>至于”socket.core”，windows默认安装位于“\\socket\\core.dll”。</p>\n<p>C宿主调用</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;lua.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;lauxlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;lualib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;time.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;Windows.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">load</span><span class=\"params\">(lua_State* L, <span class=\"type\">const</span> <span class=\"type\">char</span>* func, <span class=\"type\">unsigned</span> <span class=\"type\">int</span>* utc)</span> &#123;</span><br><span class=\"line\">   lua_getglobal(L, func);</span><br><span class=\"line\">   <span class=\"keyword\">if</span> (lua_pcall(L, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>)) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Error Msg pcall %s.\\n&quot;</span>, lua_tostring(L, <span class=\"number\">-1</span>));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">if</span> (!lua_isnumber(L,<span class=\"number\">-1</span>)) &#123;</span><br><span class=\"line\">       <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;time should be a number\\n&quot;</span> );</span><br><span class=\"line\">       <span class=\"keyword\">return</span> <span class=\"number\">-2</span>;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   *utc = lua_tonumber(L,<span class=\"number\">-1</span>);</span><br><span class=\"line\">   lua_pop(L, <span class=\"number\">-1</span>);</span><br><span class=\"line\">   <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">TimetToFileTime</span><span class=\"params\">( <span class=\"type\">time_t</span> t, LPFILETIME pft )</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    LONGLONG ll = Int32x32To64(t, <span class=\"number\">10000000</span>) + <span class=\"number\">116444736000000000</span>;</span><br><span class=\"line\">    pft-&gt;dwLowDateTime = (DWORD) ll;</span><br><span class=\"line\">    pft-&gt;dwHighDateTime = ll &gt;&gt;<span class=\"number\">32</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   lua_State* L = luaL_newstate();</span><br><span class=\"line\">   <span class=\"type\">unsigned</span> <span class=\"type\">int</span> utc = <span class=\"number\">0</span>;</span><br><span class=\"line\">   luaL_openlibs(L);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (luaL_loadfile(L, <span class=\"string\">&quot;nettime.lua&quot;</span>) || lua_pcall(L, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>)) &#123;</span><br><span class=\"line\">       <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Error Msg load %s.\\n&quot;</span>, lua_tostring(L, <span class=\"number\">-1</span>));</span><br><span class=\"line\">       <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(load(L,<span class=\"string\">&quot;nettime&quot;</span>, &amp;utc) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"type\">time_t</span> tt = utc - <span class=\"number\">2208988800L</span>;</span><br><span class=\"line\">        SYSTEMTIME st;</span><br><span class=\"line\">        FILETIME ft;</span><br><span class=\"line\">        TimetToFileTime(tt, &amp;ft);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (FileTimeToSystemTime(&amp;ft, &amp;st))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Today is: %d-%d-%d\\n&quot;</span>, st.wYear, st.wMonth, st.wDay);</span><br><span class=\"line\">            SetSystemTime(&amp;st);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;No network!&quot;</span>);</span><br><span class=\"line\">        Sleep(<span class=\"number\">10000</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">   &#125; <span class=\"keyword\">while</span> (<span class=\"number\">1</span>);</span><br><span class=\"line\">   lua_close(L);</span><br><span class=\"line\">   <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>糖果收集编辑</p>\n","text":"作者：ani_di版权所有，转载务必保留此链接 http://blog.csdn.net/ani_di Lua获取网络时间网络授时服务是一些网络上的时间服务器提供的时间，一般用于本地时钟同步。 授时服务有很多种，一般我们选择RFC-868。这个协议的工作流程是：（S代表Serve...","link":"","photos":[],"count_time":{"symbolsCount":"4.5k","symbolsTime":"4 mins."},"categories":[{"name":"topic","slug":"topic","count":308,"path":"api/categories/topic.json"}],"tags":[],"toc":"","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"又见QT","uid":"92cca58992d4502022c1dbbf5585cfdb","slug":"old_topic/2016-09-17-274","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T06:15:59.745Z","comments":true,"path":"api/articles/old_topic/2016-09-17-274.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":null,"text":"MinGW https://sourceforge.net/projects/mingw/?source=top3_dlp_t5 PyQT5 https://riverbankcomputing.com/software/pyqt/download5 PyQT4 https://...","link":"","photos":[],"count_time":{"symbolsCount":512,"symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":308,"path":"api/categories/topic.json"}],"tags":[],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"微博API发送微博","uid":"a7777311d1e67a84d45b8c65389d0ce5","slug":"old_topic/2016-09-17-276","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T06:15:59.745Z","comments":true,"path":"api/articles/old_topic/2016-09-17-276.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":null,"text":"使用微博的API和SDK的其中的关键一步是取得token. 而取得token是需要通过oauth2认证才可以得到。 下面是一段取得token的代码逻辑： 123456789APP_KEY =&#x27;012345678&#x27;APP_SECRET = &#x27;01234...","link":"","photos":[],"count_time":{"symbolsCount":"1.1k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":308,"path":"api/categories/topic.json"}],"tags":[],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}