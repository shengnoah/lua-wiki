{"title":"OpenResty China的登陆处理与发贴限制","uid":"25b1e87350d6efc1b47c2b7e104bcc7d","slug":"old_topic/2016-09-17-282","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T07:45:09.170Z","comments":true,"path":"api/articles/old_topic/2016-09-17-282.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<p>作者：糖果</p>\n<p>Openresty China是饭总之前创建，现在由我来维护一个线上的版本。最开始的时候，对于orchina.org的用户来说的，是有三天内不能发贴的限制的，但之后我们想用一个用户激活的标志来控制是否允许用户发帖，从路由和视图几角度来看，如下：</p>\n<p>1.Login登陆模块。</p>\n<p>Openresty China用的是Lor框架，封装出了Session功能：</p>\n<p>/app/routes/auth.lua 这个文件中，集中处理了登陆登出的功能， 在登陆时，在session保存了一个变量，用于之后是否可发贴的判断逻辑。</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\">auth_router<span class=\"token punctuation\">:</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/login\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">local</span> username <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>username \n    <span class=\"token keyword\">local</span> password <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>password\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> username <span class=\"token keyword\">or</span> <span class=\"token keyword\">not</span> password <span class=\"token keyword\">or</span> username <span class=\"token operator\">==</span> <span class=\"token string\">\"\"</span> <span class=\"token keyword\">or</span> password <span class=\"token operator\">==</span> <span class=\"token string\">\"\"</span> <span class=\"token keyword\">then</span>\n        <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">:</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n            success <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span><span class=\"token punctuation\">,</span>\n            msg <span class=\"token operator\">=</span> <span class=\"token string\">\"用户名和密码不得为空.\"</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">end</span>\n    <span class=\"token keyword\">local</span> isExist <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span>\n    <span class=\"token keyword\">local</span> userid <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    password <span class=\"token operator\">=</span> utils<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>password <span class=\"token operator\">..</span> <span class=\"token string\">\"#\"</span> <span class=\"token operator\">..</span> pwd_secret<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">local</span> result<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> user_model<span class=\"token punctuation\">:</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">local</span> user <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> result <span class=\"token keyword\">and</span> <span class=\"token keyword\">not</span> err <span class=\"token keyword\">then</span>\n        <span class=\"token keyword\">if</span> result <span class=\"token keyword\">and</span> <span class=\"token operator\">#</span>result <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token keyword\">then</span>\n            isExist <span class=\"token operator\">=</span> <span class=\"token keyword\">true</span>\n            user <span class=\"token operator\">=</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> \n            userid <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>id\n        <span class=\"token keyword\">end</span>\n    <span class=\"token keyword\">else</span>\n        isExist <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span>\n    <span class=\"token keyword\">end</span>\n    <span class=\"token keyword\">if</span> isExist <span class=\"token operator\">==</span> <span class=\"token keyword\">true</span> <span class=\"token keyword\">then</span>\n        req<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"user\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n            username <span class=\"token operator\">=</span> username<span class=\"token punctuation\">,</span>\n            userid <span class=\"token operator\">=</span> userid<span class=\"token punctuation\">,</span>\n            create_time <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>create_time <span class=\"token keyword\">or</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n            is_active <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>is_active\n\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">:</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n            success <span class=\"token operator\">=</span> <span class=\"token keyword\">true</span><span class=\"token punctuation\">,</span>\n            msg <span class=\"token operator\">=</span> <span class=\"token string\">\"登录成功.\"</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">else</span>\n        <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">:</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n            success <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span><span class=\"token punctuation\">,</span>\n            msg <span class=\"token operator\">=</span> <span class=\"token string\">\"用户名或密码错误，请检查!\"</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>首先是判断是否有登陆这个用户的ID，如果的确存在这个用户，就把这个用户的用户名，id,和create_time 用户创建时间保存到session中，这个数据的种子就是这这个时机埋的。 之后我们不用时间计算是否可以发展，引入is_active字段。</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token keyword\">local</span> result<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> user_model<span class=\"token punctuation\">:</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>整个发贴限制的流程中，只有这么一句从数据库中，读出数据的处理，然后设定到session。</p>\n<p>/app/model/user.lua</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token keyword\">function</span> user_model<span class=\"token punctuation\">:</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">local</span> res<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span>  db<span class=\"token punctuation\">:</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select * from user where username=? and password=?\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>username<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">,</span> err\n<span class=\"token keyword\">end</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<p>2.发表新文章的模块。<br />\n发表新文章的一个地方，是在导航条上， /app/views/header.html</p>\n<pre class=\"line-numbers language-markup\" data-language=\"markup\"><code class=\"language-markup\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ul</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>dropdown-menu<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">role</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>menu<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/user/&#123;&#123;locals.username&#125;&#125;/index<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>我的主页<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>divider<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/settings<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>个人设置<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/topic/new<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>发布新文章<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>divider<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>nofollow<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/auth/logout<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>退出<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>“发布新文章”直接跳转的路由是/topic/new：</p>\n<p>app/routes/topic.lua</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\">topic_router<span class=\"token punctuation\">:</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/new\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">local</span> diff_days<span class=\"token punctuation\">,</span> diff<span class=\"token punctuation\">,</span> is_active  <span class=\"token operator\">=</span> utils<span class=\"token punctuation\">.</span><span class=\"token function\">days_after_registry</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">--[[    \n    if diff_days&lt;3 then\n        return res:render(\"error\", &#123;\n            errMsg = \"注册时间不到3天，不允许发布文章\"\n        &#125;)\n    end\n--]]</span>\n<span class=\"token comment\">---[[</span>\n    <span class=\"token keyword\">if</span>  is_active <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token keyword\">then</span>\n        <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">:</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n            errMsg <span class=\"token operator\">=</span> <span class=\"token string\">\"用户未激活，不能发布文章! 加入QQ群：522410959 进行激活。\"</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">end</span>\n<span class=\"token comment\">--]]    </span>\n    res<span class=\"token punctuation\">:</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"topic/new\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>最开始的逻辑，是用/app/libs/utils.lua中的days_after_registry，求出用户创建用户的天数，如果超过了三天，才可以发布文章，如果天数不够，就调用/app/views/error.html模板，把错误信息显示出来 。</p>\n<p>utils.lua</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token keyword\">function</span> _M<span class=\"token punctuation\">.</span><span class=\"token function\">days_after_registry</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">local</span> diff <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">local</span> diff_days <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token comment\">-- default value, days after registry</span>\n    <span class=\"token keyword\">local</span> is_active<span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">if</span> req <span class=\"token keyword\">and</span> req<span class=\"token punctuation\">.</span>session <span class=\"token keyword\">then</span>\n        <span class=\"token keyword\">local</span> user <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"user\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">local</span> create_time <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>create_time\n<span class=\"token comment\">---[[</span>\n        <span class=\"token keyword\">if</span> create_time <span class=\"token keyword\">then</span>\n            <span class=\"token keyword\">local</span> now <span class=\"token operator\">=</span> <span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">-- seconds</span>\n            create_time <span class=\"token operator\">=</span> <span class=\"token function\">date</span><span class=\"token punctuation\">(</span>create_time<span class=\"token punctuation\">)</span>\n            diff <span class=\"token operator\">=</span> date<span class=\"token punctuation\">.</span><span class=\"token function\">diff</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">,</span> create_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><span class=\"token function\">spandays</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            diff_days <span class=\"token operator\">=</span> <span class=\"token function\">mfloor</span><span class=\"token punctuation\">(</span>diff<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">end</span>\n<span class=\"token comment\">--]]</span>\n        is_active <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>is_active\n        <span class=\"token comment\">--diff_days = is_active </span>\n    <span class=\"token keyword\">end</span>\n\n    <span class=\"token keyword\">return</span> diff_days<span class=\"token punctuation\">,</span> diff<span class=\"token punctuation\">,</span> is_active\n<span class=\"token keyword\">end</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>days_after_registry函数中，取是session中的user信息，然后取得create_time和当前系统时间比较，返回差的天数。因为我们在数据库中新建了一个is_active字段单独存放用户是否要激活的状态数据，就不要进行这种时是计算了，直接取出is_active字段进行判断。</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token keyword\">if</span>  is_active <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token keyword\">then</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">:</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n        errMsg <span class=\"token operator\">=</span> <span class=\"token string\">\"用户未激活，不能发布文章! 加入QQ群：522410959 进行激活。\"</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span>\n\nres<span class=\"token punctuation\">:</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"topic/new\"</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>3.最后一步，显示出错信息。<br />\n调用/app/views/error.html模板，把错误信息显示出来 。</p>\n<pre class=\"line-numbers language-markup\" data-language=\"markup\"><code class=\"language-markup\">\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span> <span class=\"token attr-name\">data-controller-name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sessions<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n&#123;(header.html)&#125;\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>main<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>main-container container<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>row<span class=\"token punctuation\">\"</span></span> <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value css language-css\"><span class=\"token property\">margin-top</span><span class=\"token punctuation\">:</span>30px<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\"</span></span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>col-md-12<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>panel panel-default<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>panel-heading<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>错误<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>panel-body<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n                   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>panel-body markdown<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n                        &#123;&#123; errMsg &#125;&#125;\n                    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">\n    <span class=\"token function\">$</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ready</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n        \n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n&#123;(footer.html)&#125;\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>到此，这个机能调整完毕。</p>\n","text":"作者：糖果 Openresty China是饭总之前创建，现在由我来维护一个线上的版本。最开始的时候，对于orchina.org的用户来说的，是有三天内不能发贴的限制的，但之后我们想用一个用户激活的标志来控制是否允许用户发帖，从路由和视图几角度来看，如下： 1.Login登陆模块...","link":"","photos":[],"count_time":{"symbolsCount":"4.8k","symbolsTime":"4 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[],"toc":"","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"OpenResty 中的连接池","uid":"34fb78ae79ed28901f3aef22da440208","slug":"old_topic/2016-09-17-280","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T07:45:09.230Z","comments":true,"path":"api/articles/old_topic/2016-09-17-280.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"OpenResty 中的连接池 作者：ms2008 编辑整理：糖果 注：set_keepalive 和 close 互斥(一个 socket 对象不能执行多次 setkeepalive 操作，会报：连接已关闭) 连接池的大小是对每一个 nginx worker 而言的。如果有 N...","link":"","photos":[],"count_time":{"symbolsCount":"1.4k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Python的命令行解析工具OptParse","uid":"3d930fa3cf2f5987b2f125f1dac087cf","slug":"old_topic/2016-09-17-283","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T07:45:09.162Z","comments":true,"path":"api/articles/old_topic/2016-09-17-283.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"作者：糖果 无论是用C语言，还是用Java，有时都会写一些命令行的工具，解析用户在命令输入的参数，而Python有自己特色的命令行参数解析库，就是optparse。hpfeed-cli的源码就是用optparse来解析命令行参数的，hpfeed是给威胁地图发送威胁数据的，使用的是...","link":"","photos":[],"count_time":{"symbolsCount":"2.5k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}