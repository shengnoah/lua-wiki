{"title":"Lapis的数据库查询分页功能","uid":"4a3d58a7b2640de2406b2e1d53c042d1","slug":"old_topic/2016-09-17-224","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T07:45:09.175Z","comments":true,"path":"api/articles/old_topic/2016-09-17-224.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<p>作者：leafo</p>\n<p>翻译：糖果</p>\n<h3>Pagination分页</h3> \n<blockquote>Using the paginated method on models we can easily paginate through a query that might otherwise return many results. The arguments are the same as the select method but instead of the result it returns a specialPaginator object.</blockquote> \n<p>使用paginated方法，我们可以很轻松的实现多检索结果的分页效果。select方法的参数都是一样的，但是返回的查询结果是特定的Paginator对象。</p>\n<blockquote>For example, say we have the following table and model: (See Database Schemas for more information on creating tables.)</blockquote> \n<p>例如,下面的数据表定义：（Database Schemas那章有更多关于表创建的细节内容。）</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token function\">create_table</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"users\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">,</span> types<span class=\"token punctuation\">.</span>serial <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> types<span class=\"token punctuation\">.</span>varchar <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"group_id\"</span><span class=\"token punctuation\">,</span> types<span class=\"token punctuation\">.</span>foreign_key <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token string\">\"PRIMARY KEY(id)\"</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">local</span> Users <span class=\"token operator\">=</span> Model<span class=\"token punctuation\">:</span><span class=\"token function\">extend</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"users\"</span><span class=\"token punctuation\">)</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>We can create a paginator like so:</blockquote> \n<p>我们可以创建一个分页器：</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token keyword\">local</span> paginated <span class=\"token operator\">=</span> Users<span class=\"token punctuation\">:</span><span class=\"token function\">paginated</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"where group_id = ? order by name asc\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">123</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<blockquote>A paginator can be configured by passing a table as the last argument. The following options are supported: per_page: sets the number of items per page</blockquote> \n<p>可以在最后一个参数传个lua table定义来配置分页器，下面的这个设置：per_page:设置每页显示项目的条数。</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token keyword\">local</span> paginated2 <span class=\"token operator\">=</span> Users<span class=\"token punctuation\">:</span><span class=\"token function\">paginated</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"where group_id = ?\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> per_page <span class=\"token operator\">=</span> <span class=\"token number\">100</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<blockquote>prepare_results: a function that is passed the results of get_page and get_all for processing before they are returned. This is useful for bundling preloading information into the paginator. The prepare function takes 1 argument, the results, and it must return the results after they have been processed:</blockquote> \n<p>prepare_results:此函数在把结果传给get_page和get_all处理之前就返回了。这个为分页器提前绑定信息很有用。预处理函数有一个参数，结果， 在返回结果之后就已对处理完了。</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token keyword\">local</span> preloaded <span class=\"token operator\">=</span> Posts<span class=\"token punctuation\">:</span><span class=\"token function\">paginated</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"where category = ?\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"cats\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n  per_page <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n  prepare_results <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>posts<span class=\"token punctuation\">)</span>\n    Users<span class=\"token punctuation\">:</span><span class=\"token function\">include_in</span><span class=\"token punctuation\">(</span>posts<span class=\"token punctuation\">,</span> <span class=\"token string\">\"user_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> posts\n  <span class=\"token keyword\">end</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>Any additional options sent to paginated are passed directly to the underlying select method call when a page is loaded. For example you can provide a fields option in order to limit the fields returned by a page.</blockquote> \n<p>在页面被加载后，任何附加参数被传给分页器都直接被select底层方法调用， 例如你可提供一个fields 选项，来限制每页返回的字段数。</p>\n<blockquote>Whenever possible you should specify an ORDER clause in your paginated query, as the database might returned unexpected results for each page. The paginator has the following methods:</blockquote> \n<p>可能你在查询中指定了一个ORDER语句， 数据库的分页数据可能返回了非预期的结果，分页器有下面的这些方法。</p>\n<h4>get_all()</h4> \n<blockquote>Gets all the items that the query can return, is the same as calling the select method directly. Returns an array table of model instances.</blockquote> \n<p>返回所有的查询项目，效果和直接调用select一样，Model返回的是lua的数组table。</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token keyword\">local</span> users <span class=\"token operator\">=</span> paginated<span class=\"token punctuation\">:</span><span class=\"token function\">get_all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nSELECT <span class=\"token operator\">*</span> from <span class=\"token string\">\"users\"</span> where group_id <span class=\"token operator\">=</span> <span class=\"token number\">123</span> order by name asc\n<span class=\"token function\">get_page</span><span class=\"token punctuation\">(</span>page_num<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<blockquote>Gets page_numth page, where pages are 1 indexed. The number of items per page is controlled by theper_page option, and defaults to 10. Returns an array table of model instances.</blockquote> \n<p>取得提定的page_num页， 页数从1索引 ，每页多少项是通过per_page这个参数来控制的，默认是10， Model返回的是lua的数组table。</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token keyword\">local</span> page1 <span class=\"token operator\">=</span> paginated<span class=\"token punctuation\">:</span><span class=\"token function\">get_page</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">local</span> page6 <span class=\"token operator\">=</span> paginated<span class=\"token punctuation\">:</span><span class=\"token function\">get_page</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span>\nSELECT <span class=\"token operator\">*</span> from <span class=\"token string\">\"users\"</span> where group_id <span class=\"token operator\">=</span> <span class=\"token number\">123</span> order by name asc limit <span class=\"token number\">10</span> offset <span class=\"token number\">0</span>\nSELECT <span class=\"token operator\">*</span> from <span class=\"token string\">\"users\"</span> where group_id <span class=\"token operator\">=</span> <span class=\"token number\">123</span> order by name asc limit <span class=\"token number\">10</span> offset <span class=\"token number\">50</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<h4>num_pages()</h4> \n<blockquote>Returns the total number of pages.</blockquote> \n<p>返回总页数。</p>\n<h4>total_items()</h4> \n<blockquote>Gets the total number of items that can be returned. The paginator will parse the query and remove all clauses except for the WHERE when issuing a COUNT.</blockquote> \n<p>返回总项目数，分页器会分析查询，当查询是COUNT就移去WHERE之句。</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token keyword\">local</span> users <span class=\"token operator\">=</span> paginated<span class=\"token punctuation\">:</span><span class=\"token function\">total_items</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nSELECT <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> as c from <span class=\"token string\">\"users\"</span> where group_id <span class=\"token operator\">=</span> <span class=\"token number\">123</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<blockquote>Returns an iterator function that can be used to iterate through each page of the results. Useful for processing a large query without having the entire result set loaded in memory at once.</blockquote> \n<p>返回一个迭代函数，被用于遍历每页的结果。在有大型查询处理，内存一次放不下时，很有用。</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token keyword\">for</span> page_results<span class=\"token punctuation\">,</span> page_num <span class=\"token keyword\">in</span> paginated<span class=\"token punctuation\">:</span><span class=\"token function\">each_page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n  <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>page_results<span class=\"token punctuation\">,</span> page_num<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<blockquote>Be careful modifying rows when iterating over each page, as your modifications might change the pagination order and you may process rows multiple times or none at all.</blockquote> \n<p>遍历每页中行要小心，你的编辑可能会改变分页的顺序，还有你可能会对行结果处理多次，或一次也没有。</p>\n<h4>has_items()</h4> \n<blockquote>Checks to see if the paginator returns at least 1 item. Returns a boolean. This is more efficient than counting the items and checking for a number greater than 0 because the query generated by this function doesn’t do any counting.</blockquote> \n<p>检查处理，判断分页器至少返回一条数据。返回的是boolean值，这个比判断返回结果&gt;0更高效，因为用这函数生成不会产生任何的计数查询。</p>\n<pre class=\"line-numbers language-lua\" data-language=\"lua\"><code class=\"language-lua\"><span class=\"token keyword\">if</span> pager<span class=\"token punctuation\">:</span><span class=\"token function\">has_items</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">then</span>\n  <span class=\"token comment\">-- ...</span>\n<span class=\"token keyword\">end</span>\nSELECT <span class=\"token number\">1</span> FROM <span class=\"token string\">\"users\"</span> where group_id <span class=\"token operator\">=</span> <span class=\"token number\">123</span> limit <span class=\"token number\">1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>","text":"作者：leafo 翻译：糖果 Pagination分页 Using the paginated method on models we can easily paginate through a query that might otherwise return many res...","link":"","photos":[],"count_time":{"symbolsCount":"4.4k","symbolsTime":"4 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\"><span class=\"toc-text\">Pagination分页</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\"><span class=\"toc-text\">get_all()</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\"><span class=\"toc-text\">num_pages()</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\"><span class=\"toc-text\">total_items()</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\"><span class=\"toc-text\">has_items()</span></a></li></ol></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"在Heroku云上部署Lua应用","uid":"2707eecc13e3136ac3d2044a4e3fff26","slug":"old_topic/2016-09-17-223","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T07:45:09.208Z","comments":true,"path":"api/articles/old_topic/2016-09-17-223.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"在Heroku云上部署Lua应用 Running Lua on Heroku Posted February 05, 2012 by leafo (@moonscript) Since the release of Heroku’s Cedar platform they've ...","link":"","photos":[],"count_time":{"symbolsCount":"7.7k","symbolsTime":"7 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Writing a DSL in Lua","uid":"27a76f8b85be215ce4dc3b40107bebc6","slug":"old_topic/2016-09-17-225","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T07:45:09.148Z","comments":true,"path":"api/articles/old_topic/2016-09-17-225.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"作者：leafo DSLs, or domain specific languages, are programming languages that are designed to implement a set of features specific to a partic...","link":"","photos":[],"count_time":{"symbolsCount":"10k","symbolsTime":"9 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}