{"title":"稀疏数组","uid":"6e867546fc7beccba02bf189db02a81f","slug":"old_topic/2016-09-17-329","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T07:45:09.204Z","comments":true,"path":"api/articles/old_topic/2016-09-17-329.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":null,"content":"<h1>稀疏数组</h1>\n<p>请看示例代码（注意data的数组下标）：</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- http://www.kyne.com.au/~mark/software/lua-cjson.php</span></span><br><span class=\"line\"><span class=\"comment\">-- version: 2.1 devel</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> json = <span class=\"built_in\">require</span>(<span class=\"string\">&quot;cjson&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">local</span> data = &#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>&#125;</span><br><span class=\"line\">data[<span class=\"number\">1000</span>] = <span class=\"number\">99</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- ... do the other things</span></span><br><span class=\"line\">ngx.say(json.encode(data))</span><br></pre></td></tr></table></figure>\n<p>运行日志报错结果：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2015/06/27 00:23:13 [error] 2714#0: *40 lua entry thread aborted: runtime error: ...ork/git/github.com/lua-resty-memcached-server/t/test.lua:13: Cannot serialise table: excessively sparse array</span><br><span class=\"line\">stack traceback:</span><br><span class=\"line\">coroutine 0:</span><br><span class=\"line\">    [C]: in function &#x27;encode&#x27;</span><br><span class=\"line\">    ...ork/git/github.com/lua-resty-memcached-server/t/test.lua:13: in function &lt;...ork/git/github.com/lua-resty-memcached-server/t/test.lua:1&gt;, client: 127.0.0.1, server: localhost, request: &quot;GET /test HTTP/1.1&quot;, host: &quot;127.0.0.1:8001&quot;</span><br></pre></td></tr></table></figure>\n<p>如果把data的数组下标修改成5，那么这个json.encode就会是成功的。结果是：[1,2,null,null,99]</p>\n<p>为什么下标是1000就失败呢？实际上这么做是cjson想保护你的内存资源。她担心这个下标过大直接撑爆内存（贴心小棉袄啊）。如果我们一定要让这种情况下可以encode，就要尝试encode_sparse_array api了。有兴趣的同学可以自己试一试。我相信你看过有关cjson的代码后，就知道cjson的一个简单危险防范应该是怎样完成的。</p>\n","text":"稀疏数组 请看示例代码（注意data的数组下标）： 12345678910-- http://www.kyne.com.au/~mark/software/lua-cjson.php-- version: 2.1 devellocal json = require(&quot;c...","link":"","photos":[],"count_time":{"symbolsCount":"1k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":308,"path":"api/categories/topic.json"}],"tags":[],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\"><span class=\"toc-text\">稀疏数组</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"跨平台的库选择","uid":"9292b5d7db49cf3a15a4dacf7bf55d0e","slug":"old_topic/2016-09-17-327","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T07:45:09.226Z","comments":true,"path":"api/articles/old_topic/2016-09-17-327.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":null,"text":"跨平台的库选择 大家看过上面三个json的例子就发现，都是围绕cjson库的。原因也比较简单，就是cjson是默认绑定到openresty上的。很多开发喜欢 windows 系统，可以选择 dkjson（编解码效率没有cjson快，优势是纯Lua，完美跨任何平台）。 并且我们的代...","link":"","photos":[],"count_time":{"symbolsCount":770,"symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":308,"path":"api/categories/topic.json"}],"tags":[],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"编码为array还是object","uid":"dcced3e4781903088f00b4d841a17520","slug":"old_topic/2016-09-17-326","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T07:45:09.220Z","comments":true,"path":"api/articles/old_topic/2016-09-17-326.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":null,"text":"编码为array还是object 首先大家请看这段源码： 12345-- http://www.kyne.com.au/~mark/software/lua-cjson.php-- version: 2.1 devellocal json = require(&quot;cjso...","link":"","photos":[],"count_time":{"symbolsCount":"2k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":308,"path":"api/categories/topic.json"}],"tags":[],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}