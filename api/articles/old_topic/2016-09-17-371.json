{"title":"MoonScript API","uid":"718dd50cb1bd8b8045cdc3956cf5b840","slug":"old_topic/2016-09-17-371","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T06:15:59.753Z","comments":true,"path":"api/articles/old_topic/2016-09-17-371.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":null,"content":"<p>{<br>  target: “reference/api”<br>  template: “reference”<br>  title: “Compiler API”<br>  short_name: “api”<br>}</p>\n<h1 id=\"MoonScript-Compiler-API\"><a href=\"#MoonScript-Compiler-API\" class=\"headerlink\" title=\"MoonScript Compiler API\"></a>MoonScript Compiler API</h1><h2 id=\"Autocompiling-with-the-moonscript-Module\"><a href=\"#Autocompiling-with-the-moonscript-Module\" class=\"headerlink\" title=\"Autocompiling with the moonscript Module\"></a>Autocompiling with the <code>moonscript</code> Module</h2><p>After installing MoonScript, you can include the <code>moonscript</code> module to make<br>any Lua script MoonScript aware.</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">require</span> <span class=\"string\">&quot;moonscript&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>After <code>moonscript</code> is required, Lua’s package loader is updated to search for<br><code>.moon</code> files on any subsequent calls to <code>require</code>. The search path for <code>.moon</code><br>files is based on the current <code>package.path</code> value in Lua when <code>moonscript</code> is<br>required. Any search paths in <code>package.path</code> ending in <code>.lua</code> are copied,<br>rewritten to end in <code>.moon</code>, and then inserted in <code>package.moonpath</code>.</p>\n<p>The <code>moonloader</code> is the function that is responsible for searching<br><code>package.moonpath</code> for a file available to be included. It is inserted in the<br>second position of the <code>package.loaders</code> table. This means that a matching <code>.moon</code> file<br>will be loaded over a matching <code>.lua</code> file that has the same base name.</p>\n<p>For more information on Lua’s <code>package.loaders</code> see <a href=\"http://www.lua.org/manual/5.1/manual.html#pdf-package.loaders\">Lua Reference Manual<br>&mdash;<br>package.loaders</a></p>\n<p>The <code>moonloader</code>, when finding a valid path to a <code>.moon</code> file, will parse and<br>compile the file in memory. The code is then turned into a function using the<br>built in <code>load</code> function, which is run as the module.</p>\n<p>If you are executing MoonScript code with the included <code>moon</code> command line tool<br>then it is not required to include this module before including any other<br>MoonScript modules.</p>\n<h2 id=\"moonscript-base-Module\"><a href=\"#moonscript-base-Module\" class=\"headerlink\" title=\"moonscript.base Module\"></a><code>moonscript.base</code> Module</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">moonscript = require &quot;moonscript.base&quot;</span><br></pre></td></tr></table></figure>\n\n<p>This module contains an assortment of functions for loading and compiling<br>MoonScript code from within Lua.</p>\n<p>The module provides <code>load</code>, <code>loadfile</code>, <code>loadstring</code> functions, which are<br>analogous to the similarly named Lua functions. The major difference is that<br>they load MoonScript code instead of Lua code.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">moonscript = require &quot;moonscript.base&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">fn = moonscript.loadstring &#x27;print &quot;hi!&quot;&#x27;</span><br><span class=\"line\">fn!</span><br></pre></td></tr></table></figure>\n\n<p>All of these functions can take an optional last argument, a table of options.<br>The only option right now is <code>implicitly_return_root</code>. Setting this to <code>false</code><br>makes it so the file does not implicitly return its last statement.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">moonscript = require &quot;moonscript.base&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">fn = moonscript.loadstring &quot;10&quot;</span><br><span class=\"line\">print fn! -- prints &quot;10&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">fn = moonscript.loadstring &quot;10&quot;, implicitly_return_root: false</span><br><span class=\"line\">print fn! -- prints nothing</span><br></pre></td></tr></table></figure>\n\n<p>One more useful function is provided: <code>to_lua</code>. This function takes a string of<br>MoonScript code and returns the compiled Lua result along with the line mapping<br>table. If there are any errors then <code>nil</code> and the error message are returned.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import to_lua from require &quot;moonscript.base&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">lua_code, line_tabel = to_lua [[</span><br><span class=\"line\">x = 124</span><br><span class=\"line\">print &quot;hello world #&#123;x&#125;&quot;</span><br><span class=\"line\">]]</span><br></pre></td></tr></table></figure>\n\n<p>Similar to the <code>load*</code> functions from above, <code>to_lua</code> can take an optional<br>final argument of a table of options.</p>\n<p>The second return value of <code>to_lua</code> is useful if you want to perform line<br>number reversal. It’s a table where the key is a Lua line number and the value<br>is a character offset from the original MoonScript source.</p>\n<h2 id=\"Programmatically-Compiling\"><a href=\"#Programmatically-Compiling\" class=\"headerlink\" title=\"Programmatically Compiling\"></a>Programmatically Compiling</h2><p>If you need finer grained control over the compilation process you can use the<br>raw parse and compile modules.</p>\n<p>Parsing converts a string of MoonScript into an abstract syntax tree. Compiling<br>converts an abstract syntax tree into a Lua code string.</p>\n<p>Knowledge of this API may be useful for creating tools to aid the generation of<br>Lua code from MoonScript code. For example, you could build a macro system by<br>analyzing and manipulating the abstract syntax tree. Be warned though, the<br>format of the abstract syntax tree is undocumented and may change in the<br>future.</p>\n<p>Here is a quick example of how you would compile a MoonScript string to a Lua<br>String (This is effectively the same as the <code>to_lua</code> function described above):</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">parse = require &quot;moonscript.parse&quot;</span><br><span class=\"line\">compile = require &quot;moonscript.compile&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">moon_code = [[(-&gt; print &quot;hello world&quot;)!]]</span><br><span class=\"line\"></span><br><span class=\"line\">tree, err = parse.string moon_code</span><br><span class=\"line\">unless tree</span><br><span class=\"line\">  error &quot;Parse error: &quot; .. err</span><br><span class=\"line\"></span><br><span class=\"line\">lua_code, err, pos = compile.tree tree</span><br><span class=\"line\">unless lua_code</span><br><span class=\"line\">  error compile.format_error err, pos, moon_code</span><br><span class=\"line\"></span><br><span class=\"line\">-- our code is ready</span><br><span class=\"line\">print lua_code</span><br></pre></td></tr></table></figure>","text":"{ target: “reference/api” template: “reference” title: “Compiler API” short_name: “api”} MoonScript Compiler APIAutocompiling with the moons...","link":"","photos":[],"count_time":{"symbolsCount":"4.2k","symbolsTime":"4 mins."},"categories":[{"name":"topic","slug":"topic","count":308,"path":"api/categories/topic.json"}],"tags":[],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#MoonScript-Compiler-API\"><span class=\"toc-text\">MoonScript Compiler API</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Autocompiling-with-the-moonscript-Module\"><span class=\"toc-text\">Autocompiling with the moonscript Module</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#moonscript-base-Module\"><span class=\"toc-text\">moonscript.base Module</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Programmatically-Compiling\"><span class=\"toc-text\">Programmatically Compiling</span></a></li></ol></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"善良比聪明重要---亚马逊 CEO 杰夫·贝佐斯（Jeff Bezos）在母校普林斯顿大学演讲","uid":"80b2bfed22c13e124acdd5132be472fa","slug":"old_topic/2016-09-17-373","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T06:15:59.753Z","comments":true,"path":"api/articles/old_topic/2016-09-17-373.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":null,"text":"2010 年，亚马逊 CEO 杰夫·贝佐斯（Jeff Bezos）在母校普林斯顿大学的毕业典礼上，勉励年轻人，善用自己的天赋，做出对的选择。因为，「人生到头来，我们的选择，决定了我们是什么样的人。」 以下是 Bezos 演讲内容： As a kid, I spent my sum...","link":"","photos":[],"count_time":{"symbolsCount":"9.6k","symbolsTime":"9 mins."},"categories":[{"name":"topic","slug":"topic","count":308,"path":"api/categories/topic.json"}],"tags":[{"name":"lua","slug":"lua","count":153,"path":"api/tags/lua.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Nginx+Lua返回JSON类型数据","uid":"054f428f76705613481e9cfa45f6bed2","slug":"old_topic/2016-09-17-377","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T06:15:59.754Z","comments":true,"path":"api/articles/old_topic/2016-09-17-377.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":null,"text":"作者：糖果 Nginx返回JSON数据，一种是直接在配置文件里设置，一种是通过Lua代码封装完成，讲Nginx中执行Lua返回JSON的关键，一个用API函数ngx.say，同时配合json.encode对JSON格式的字符串进行编码，然后设定响应头信息的类型。 Nginx Co...","link":"","photos":[],"count_time":{"symbolsCount":"2.9k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":308,"path":"api/categories/topic.json"}],"tags":[{"name":"lua","slug":"lua","count":153,"path":"api/tags/lua.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}