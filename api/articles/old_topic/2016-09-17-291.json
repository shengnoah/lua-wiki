{"title":"usages","uid":"d8c0c50cf48649c0a5b21963dbcc373c","slug":"old_topic/2016-09-17-291","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T06:15:59.746Z","comments":true,"path":"api/articles/old_topic/2016-09-17-291.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":null,"content":"<hr>\n<p>category: Guides<br>redirect_from:<br>    - /docs/v0.4.0/guides/usages/<br>    - /docs/latest/guides/usages/<br>title: “使用场景”<br>sort_title: “2”</p>\n<hr>\n<p>Orange是基于插件设计的，基本思想是通过实现各种插件灵活的在Nginx的各个执行阶段进行逻辑处理。</p>\n<p>Orange提供的默认插件功能如下：</p>\n<ul>\n<li>全局的监控插件，可统计API访问情况、Nginx连接情况、流量统计、QPS等</li>\n<li>自定义监控，可根据配置的规则筛选监控项，统计其各个指标</li>\n<li>rewrite插件，可通过UI配置各种rewrite策略，省去手写nginx rewrite，然后重启的麻烦</li>\n<li>redirect插件，实现请求重定向功能</li>\n<li>HTTP Basic Authorization，为API动态配置鉴权</li>\n<li>简单地WAF应用防火墙，可提取各个请求参数，通过各种匹配规则甄别需要禁止的流量</li>\n<li>分流插件，可分为三个使用场景：<ul>\n<li>作为proxy，如代理后端的多个HTTP应用</li>\n<li>用于AB测试</li>\n<li>用于动态分流，API版本控制等</li>\n</ul>\n</li>\n</ul>\n<p>其它插件，用户可根据具体需要按规范编写即可。</p>\n<h2 id=\"典型使用案例\"><a href=\"#典型使用案例\" class=\"headerlink\" title=\"典型使用案例\"></a>典型使用案例</h2><p>以下使用案例对于成体系、各职责/配置比较健全的团队来说可能并不存在，但仍可能具有一些参考意义。</p>\n<h3 id=\"Case-1\"><a href=\"#Case-1\" class=\"headerlink\" title=\"Case 1\"></a>Case 1</h3><p>想象下面的场景：</p>\n<ul>\n<li>原来的Nginx配置文件中包含大量的rewrite语句，每次更改需要重启</li>\n<li>有时候rewrite特别难写，比如我需要把来自于某个Host并且uri以<code>/user</code>开头的请求rewrite到以<code>/some_host/user</code>开头，如果是在Nginx里写，一般要通过<code>if</code>判断Host，再rewrite，可能需要多次调试和reload才能成功。这对于有经验的运维或是开发可能并不是难事，但对刚接手的新人或是不熟悉Nginx的运维人员来说，就是一件头疼事儿了</li>\n<li>再想像一下，如果再加上几个限制条件，比如需要来自某些IP访问某个Host并且Header里含有某个标识变量的请求执行某个rewrite，Orz…</li>\n<li>原来对于某个移动端API，客户端已经发布了很多个版本，每个版本的该API内部实现可能都不太一样，如果需要后端去兼容这个更改，可能就需要在代码中添加大量的<code>if/else</code>，或者给同一个职责的API取不同的名字(其它更好的实践暂且不表)。长此以往，API的版本管理可能就是一团乱麻</li>\n</ul>\n<p>这时，通过Orange的rewrite/redirect插件就能很方便的解决这个问题，并且实时生效无需重启或是reload：</p>\n<ul>\n<li>orange的rewrite/redirect规则配置非常简单，基本上只需要了解一些Nginx/lua正则表达式的知识即可解决上述场景中提到的问题，无须更改Nginx配置文件</li>\n<li>orange可以提取请求中的各个变量或是标识，比如URI、Header、QueryString、Referer、Host等等，然后根据这些提取出来的值做匹配规则运算，匹配成功的就可以执行各种rewrite、redirect操作将uri变得更有条理，也更好管理。</li>\n</ul>\n<h3 id=\"Case-2\"><a href=\"#Case-2\" class=\"headerlink\" title=\"Case 2\"></a>Case 2</h3><p>在内部系统中，大量模块或者异构的子系统之间都是通过HTTP交互的，这时不可避免的要引入一个七层负载，选型最多的基本上也就是Nginx了。对于内部网关的管理，可能存在的问题：</p>\n<ul>\n<li>由于是内部使用，运维对外网隔离比较严格，但内网隔离性可能就会略差，这是就可能发生内部服务API被调用者误调用或者乱调用的问题</li>\n<li>为了使用方便，内部的一些通用API是不需要鉴权的，但当需要排查问题的时候，如果有多个使用方，很难甄别到底是谁调用的</li>\n</ul>\n<p>Orange提供的WAF插件可以解决这个问题：</p>\n<ul>\n<li>如对API请求做白名单限制，白名单可以以比较常用的IP、Header作为判断条件</li>\n<li>Orange提供的默认插件都有Log功能，可将某条匹配规则的Log开启，这样出现问题时就可以根据匹配规则的Log，然后结合Nginx本身的访问日志来甄别流量来源了</li>\n</ul>\n<h3 id=\"Case-3\"><a href=\"#Case-3\" class=\"headerlink\" title=\"Case 3\"></a>Case 3</h3><p>应用的AB测试或者流量切分，虽然业界已经有很多方案可供参考，各个公司或团队也有相应实现，Orange给出了另一种动态解决方案</p>\n<ul>\n<li>由自定义的条件表达式选择出某部分流量，动态分流到指定的upstream server，结束后只需要关闭这条规则即可</li>\n<li>线上问题排查，如果某个API出了问题，可临时添加一条规则，将测试账户的流量打到某台机器或者某个新的bug fix的upstream server，待排查完后清除规则、升级bug fix版本</li>\n</ul>\n","text":" category: Guidesredirect_from: - /docs/v0.4.0/guides/usages/ - /docs/latest/guides/usages/title: “使用场景”sort_title: “2” Orange是基于插件设计的，基本思想是...","link":"","photos":[],"count_time":{"symbolsCount":"1.9k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":308,"path":"api/categories/topic.json"}],"tags":[],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%85%B8%E5%9E%8B%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B\"><span class=\"toc-text\">典型使用案例</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Case-1\"><span class=\"toc-text\">Case 1</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Case-2\"><span class=\"toc-text\">Case 2</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Case-3\"><span class=\"toc-text\">Case 3</span></a></li></ol></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"contributing.md","uid":"34e290003619093bbec60504e43213d8","slug":"old_topic/2016-09-17-294","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T06:15:59.747Z","comments":true,"path":"api/articles/old_topic/2016-09-17-294.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":null,"text":" category: Guidesredirect_from: - /docs/v0.4.0/guides/contributing/ - /docs/latest/guides/contributing/title: “参与开发”sort_title: “5” 如何做？ For...","link":"","photos":[],"count_time":{"symbolsCount":485,"symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":308,"path":"api/categories/topic.json"}],"tags":[],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"about.md","uid":"5a02071a23aad12b54752e188cb304af","slug":"old_topic/2016-09-17-295","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T06:15:59.747Z","comments":true,"path":"api/articles/old_topic/2016-09-17-295.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":null,"text":" category: Guidesredirect_from: - /docs/v0.4.0/guides/about/ - /docs/latest/guides/about/title: “关于Orange”sort_title: “1” 欢迎使用Orange，使用过程中如碰...","link":"","photos":[],"count_time":{"symbolsCount":904,"symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":308,"path":"api/categories/topic.json"}],"tags":[],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}