{"title":"ORC索引页显示的Lapis实现","uid":"d2259f558f383bf9636ac7b5a9eaea5a","slug":"old_topic/2016-09-17-269","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T07:45:09.204Z","comments":true,"path":"api/articles/old_topic/2016-09-17-269.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":[],"content":"<p>作者：糖果</p>\n<p>ORC是是用LOR框架完成的，这次尝试实现用Lapis来实现，ORC索引页面的显示， 国为ORC是后端前端分开的， 实际上后端只要根据用输入返回按接口定义的JSON数据就好。</p>\n<p>这个实验会涉及到几个最学用的点：</p>\n<h5 id=\"1-简单的用SQL对业务表进行left-join，这个和语言平台无关。\">1.简单的用SQL对业务表进行left join，这个和语言平台无关。</h5>\n<h5 id=\"2-OR的LUA框架返回JSON-JSON数据的编解码。\">2.OR的LUA框架返回JSON, JSON数据的编解码。</h5>\n<h5 id=\"3-常规不使用ORM访问数据库。\">3.常规不使用ORM访问数据库。</h5>\n<h5 id=\"4-Lapis模板，在模板中进行子模板渲染。\">4.Lapis模板，在模板中进行子模板渲染。</h5>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">local</span> lapis = <span class=\"built_in\">require</span> <span class=\"string\">&quot;lapis&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> app = lapis.Application()</span><br><span class=\"line\"><span class=\"keyword\">local</span> db = <span class=\"built_in\">require</span>(<span class=\"string\">&quot;lapis.db&quot;</span>)</span><br><span class=\"line\">app:enable(<span class=\"string\">&quot;etlua&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">app:get(<span class=\"string\">&quot;/topics/all&quot;</span>, <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">(self)</span></span></span><br><span class=\"line\">    page_no = <span class=\"number\">1</span></span><br><span class=\"line\">    page_size = <span class=\"number\">10</span></span><br><span class=\"line\">    category = <span class=\"number\">3</span>  </span><br><span class=\"line\">    <span class=\"keyword\">local</span> sql = <span class=\"string\">&quot;select t.*, c.name as category_name, u.avatar as avatar from topic t &quot;</span> ..</span><br><span class=\"line\">                                <span class=\"string\">&quot;left join user u on t.user_id=u.id &quot;</span> ..</span><br><span class=\"line\">                                <span class=\"string\">&quot;left join category c on t.category_id=c.id &quot;</span> ..</span><br><span class=\"line\">                                <span class=\"string\">&quot;where t.category_id=1 &quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">local</span> res, err = db.query(sql)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123; json = &#123; data = &#123;totalCount=<span class=\"string\">&quot;54&quot;</span>, currentPage=<span class=\"string\">&quot;1&quot;</span>,topics = res, totalPage=<span class=\"number\">2</span>&#125;, success=<span class=\"literal\">true</span> &#125;&#125;</span><br><span class=\"line\"><span class=\"keyword\">end</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">return</span> app</span><br></pre></td></tr></table></figure>\n<p>值的注意的是，db.query(sql)返回的结果res本身就是JSON形式，不需要进入JSON编解码。  因为LORj框架是不提供ORM的，所以ORC所有返回接口几乎都是纯SQL。 因为Lapis的底层用的也是resty-mysql<br>\n,他们之间执行SQL是兼容的。</p>\n<p>下面是节选的Lapis的Mysql库的源码：</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"keyword\">local</span> mysql = <span class=\"built_in\">require</span>(<span class=\"string\">&quot;resty.mysql&quot;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">(q)</span></span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> logger <span class=\"keyword\">then</span></span><br><span class=\"line\">        logger.query(q)</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">local</span> db = ngx <span class=\"keyword\">and</span> ngx.ctx.resty_mysql_db</span><br><span class=\"line\">      <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> (db) <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">local</span> err</span><br><span class=\"line\">        db, err = <span class=\"built_in\">assert</span>(mysql:new())</span><br><span class=\"line\">        db:set_timeout(timeout)</span><br><span class=\"line\">        <span class=\"keyword\">local</span> options = &#123;</span><br><span class=\"line\">          database = database,</span><br><span class=\"line\">          user = user,</span><br><span class=\"line\">          password = password,</span><br><span class=\"line\">          ssl = ssl,</span><br><span class=\"line\">          ssl_verify = ssl_verify</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"built_in\">path</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">          options.<span class=\"built_in\">path</span> = <span class=\"built_in\">path</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">          options.host = host</span><br><span class=\"line\">          options.port = port</span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">        <span class=\"built_in\">assert</span>(db:connect(options))</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ngx <span class=\"keyword\">then</span></span><br><span class=\"line\">          ngx.ctx.resty_mysql_db = db</span><br><span class=\"line\">          after_dispatch(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span></span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> db:set_keepalive(max_idle_timeout, pool_size)</span><br><span class=\"line\">          <span class=\"keyword\">end</span>)</span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">local</span> start_time</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ngx <span class=\"keyword\">and</span> <span class=\"built_in\">config</span>.measure_performance <span class=\"keyword\">then</span></span><br><span class=\"line\">        ngx.update_time()</span><br><span class=\"line\">        start_time = ngx.now()</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">local</span> res, err, errcode, sqlstate = <span class=\"built_in\">assert</span>(db:query(q))</span><br><span class=\"line\">      <span class=\"keyword\">local</span> result</span><br><span class=\"line\">      <span class=\"keyword\">if</span> err == <span class=\"string\">&#x27;again&#x27;</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        result = &#123;</span><br><span class=\"line\">          res</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> err == <span class=\"string\">&#x27;again&#x27;</span> <span class=\"keyword\">do</span></span><br><span class=\"line\">          res, err, errcode, sqlstate = <span class=\"built_in\">assert</span>(db:read_result())</span><br><span class=\"line\">          <span class=\"built_in\">table</span>.<span class=\"built_in\">insert</span>(result, res)</span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        result = res</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> start_time <span class=\"keyword\">then</span></span><br><span class=\"line\">        ngx.update_time()</span><br><span class=\"line\">        increment_perf(<span class=\"string\">&quot;db_time&quot;</span>, ngx.now() - start_time)</span><br><span class=\"line\">        increment_perf(<span class=\"string\">&quot;db_count&quot;</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">      <span class=\"keyword\">end</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> result</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>ORC的前端代码，除了其它和这个实验不相关的Layout，主要的代码如下：</p>\n<p>meta.etlua</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=&quot;/static/js/juicer.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p><img src=\"http://file.epubit.com.cn/ScreenShow/16087e7dceeca78a5bfe\" alt=\"图像说明文字\"></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;% <span class=\"title function_\">render</span>(<span class=\"string\">&quot;views.meta&quot;</span>) %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;/static/js/index.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这里的index.js的代码也不是很多：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(<span class=\"keyword\">function</span> (<span class=\"params\">L</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> _this = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    L.<span class=\"property\">Index</span> = L.<span class=\"property\">Index</span> || &#123;&#125;;</span><br><span class=\"line\">    _this = L.<span class=\"property\">Index</span> = &#123;</span><br><span class=\"line\">        <span class=\"attr\">data</span>: &#123;</span><br><span class=\"line\">            <span class=\"attr\">current_category</span>: <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attr\">init</span>: <span class=\"keyword\">function</span> (<span class=\"params\">current_category</span>) &#123;</span><br><span class=\"line\">            _this.<span class=\"property\">data</span>.<span class=\"property\">current_category</span> = current_category || <span class=\"string\">&quot;0&quot;</span>;</span><br><span class=\"line\">            _this.<span class=\"title function_\">loadTopics</span>(<span class=\"string\">&quot;default&quot;</span>);</span><br><span class=\"line\">            <span class=\"comment\">//_this.loadTopics(&quot;ir-black&quot;);</span></span><br><span class=\"line\">            _this.<span class=\"title function_\">initEvents</span>();</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        scrollTop: function () &#123;</span></span><br><span class=\"line\"><span class=\"comment\">            $(&#x27;html, body&#x27;).animate(&#123;scrollTop: 0&#125;, 0);</span></span><br><span class=\"line\"><span class=\"comment\">        &#125;,</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attr\">initEvents</span>: <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            $(<span class=\"variable language_\">document</span>).<span class=\"title function_\">on</span>(<span class=\"string\">&quot;click&quot;</span>, <span class=\"string\">&quot;#topic-type-tab a&quot;</span>, <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">                $(<span class=\"string\">&quot;#topic-type-tab a&quot;</span>).<span class=\"title function_\">each</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">                    $(<span class=\"variable language_\">this</span>).<span class=\"title function_\">removeClass</span>(<span class=\"string\">&quot;active&quot;</span>);</span><br><span class=\"line\">                &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">                $(<span class=\"variable language_\">this</span>).<span class=\"title function_\">addClass</span>(<span class=\"string\">&quot;active&quot;</span>);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">            $(<span class=\"string\">&quot;#default-topics-btn&quot;</span>).<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">                _this.<span class=\"title function_\">loadTopics</span>(<span class=\"string\">&quot;default&quot;</span>);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">            $(<span class=\"string\">&quot;#recent-reply-topics-btn&quot;</span>).<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">                _this.<span class=\"title function_\">loadTopics</span>(<span class=\"string\">&quot;recent-reply&quot;</span>);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">            $(<span class=\"string\">&quot;#good-topics-btn&quot;</span>).<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">                _this.<span class=\"title function_\">loadTopics</span>(<span class=\"string\">&quot;good&quot;</span>);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            </span><br><span class=\"line\">            </span><br><span class=\"line\">            $(<span class=\"string\">&quot;#noreply-topics-btn&quot;</span>).<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">                _this.<span class=\"title function_\">loadTopics</span>(<span class=\"string\">&quot;noreply&quot;</span>);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attr\">loadTopics</span>: <span class=\"keyword\">function</span> (<span class=\"params\">type, pageNo</span>) &#123;</span><br><span class=\"line\">            pageNo = pageNo || <span class=\"number\">1</span>;</span><br><span class=\"line\">            $.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">                <span class=\"attr\">url</span>: <span class=\"string\">&#x27;/topics/all&#x27;</span>,</span><br><span class=\"line\">                <span class=\"attr\">type</span>: <span class=\"string\">&#x27;get&#x27;</span>,</span><br><span class=\"line\">                <span class=\"attr\">cache</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">                <span class=\"attr\">data</span>: &#123;</span><br><span class=\"line\">                    <span class=\"attr\">page_no</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">                    <span class=\"attr\">type</span>: type,</span><br><span class=\"line\">                    <span class=\"attr\">category</span>: _this.<span class=\"property\">data</span>.<span class=\"property\">current_category</span></span><br><span class=\"line\">                &#125;,</span><br><span class=\"line\">                <span class=\"attr\">dataType</span>: <span class=\"string\">&#x27;json&#x27;</span>,</span><br><span class=\"line\">                <span class=\"attr\">success</span>: <span class=\"keyword\">function</span> (<span class=\"params\">result</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (result.<span class=\"property\">success</span>) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (!result.<span class=\"property\">data</span> || (result.<span class=\"property\">data</span> &amp;&amp; result.<span class=\"property\">data</span>.<span class=\"property\">topics</span>.<span class=\"property\">length</span> &lt;= <span class=\"number\">0</span>)) &#123;</span><br><span class=\"line\">                            $(<span class=\"string\">&quot;#topics-body&quot;</span>).<span class=\"title function_\">html</span>(<span class=\"string\">&#x27;&lt;div class=&quot;alert alert-info&quot; role=&quot;alert&quot;&gt;此分类下没有任何内容&lt;/div&gt;&#x27;</span>);</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            _this.<span class=\"title function_\">page</span>(result, type, <span class=\"number\">1</span>);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        $(<span class=\"string\">&quot;#topics-body&quot;</span>).<span class=\"title function_\">html</span>(<span class=\"string\">&#x27;&lt;div class=&quot;alert alert-danger&quot; role=&quot;alert&quot;&gt;&#x27;</span> + result.<span class=\"property\">msg</span> + <span class=\"string\">&#x27;&lt;/div&gt;&#x27;</span>);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;,</span><br><span class=\"line\">                <span class=\"attr\">error</span>: <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">                    $(<span class=\"string\">&quot;#topics-body&quot;</span>).<span class=\"title function_\">html</span>(<span class=\"string\">&#x27;&lt;div class=&quot;alert alert-danger&quot; role=&quot;alert&quot;&gt;error to send request.&lt;/div&gt;&#x27;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"attr\">page</span>: <span class=\"keyword\">function</span> (<span class=\"params\">result, type, pageNo</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> data = result.<span class=\"property\">data</span> || &#123;&#125;;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> $container = $(<span class=\"string\">&quot;#topics-body&quot;</span>);</span><br><span class=\"line\">            $container.<span class=\"title function_\">empty</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">var</span> tpl = $(<span class=\"string\">&quot;#topic-item-tpl&quot;</span>).<span class=\"title function_\">html</span>();</span><br><span class=\"line\">            <span class=\"keyword\">var</span> html = <span class=\"title function_\">juicer</span>(tpl, data);</span><br><span class=\"line\">            $container.<span class=\"title function_\">html</span>(html);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">var</span> currentPage = data.<span class=\"property\">currentPage</span>;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> totalPage = data.<span class=\"property\">totalPage</span>;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> totalCount = data.<span class=\"property\">totalCount</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (totalPage &gt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                $(<span class=\"string\">&quot;#pagebar&quot;</span>).<span class=\"title function_\">show</span>();</span><br><span class=\"line\">                $.fn.<span class=\"title function_\">jpagebar</span>(&#123;</span><br><span class=\"line\">                    <span class=\"attr\">renderTo</span>: $(<span class=\"string\">&quot;#pagebar&quot;</span>),</span><br><span class=\"line\">                    <span class=\"attr\">totalpage</span>: totalPage,</span><br><span class=\"line\">                    <span class=\"attr\">totalcount</span>: totalCount,</span><br><span class=\"line\">                    <span class=\"attr\">pagebarCssName</span>: <span class=\"string\">&#x27;pagination2&#x27;</span>,</span><br><span class=\"line\">                    <span class=\"attr\">currentPage</span>: currentPage,</span><br><span class=\"line\">                    <span class=\"attr\">onClickPage</span>: <span class=\"keyword\">function</span> (<span class=\"params\">pageNo</span>) &#123;</span><br><span class=\"line\">                        $.fn.<span class=\"title function_\">setCurrentPage</span>(<span class=\"variable language_\">this</span>, pageNo);</span><br><span class=\"line\">                        $.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">                            <span class=\"attr\">url</span>: <span class=\"string\">&#x27;/topics/all&#x27;</span>,</span><br><span class=\"line\">                            <span class=\"attr\">type</span>: <span class=\"string\">&#x27;get&#x27;</span>,</span><br><span class=\"line\">                            <span class=\"attr\">cache</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">                            <span class=\"attr\">data</span>: &#123;</span><br><span class=\"line\">                                <span class=\"attr\">page_no</span>: pageNo,</span><br><span class=\"line\">                                <span class=\"attr\">type</span>: type,</span><br><span class=\"line\">                                <span class=\"attr\">category</span>: _this.<span class=\"property\">data</span>.<span class=\"property\">current_category</span></span><br><span class=\"line\">                            &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">                            <span class=\"attr\">dataType</span>: <span class=\"string\">&#x27;json&#x27;</span>,</span><br><span class=\"line\">                            <span class=\"attr\">success</span>: <span class=\"keyword\">function</span> (<span class=\"params\">result</span>) &#123;</span><br><span class=\"line\">                                <span class=\"keyword\">var</span> data = result.<span class=\"property\">data</span> || &#123;&#125;;</span><br><span class=\"line\">                                <span class=\"keyword\">var</span> $container = $(<span class=\"string\">&quot;#topics-body&quot;</span>);</span><br><span class=\"line\">                                $container.<span class=\"title function_\">empty</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">                                <span class=\"keyword\">var</span> tpl = $(<span class=\"string\">&quot;#topic-item-tpl&quot;</span>).<span class=\"title function_\">html</span>();</span><br><span class=\"line\">                                <span class=\"keyword\">var</span> html = <span class=\"title function_\">juicer</span>(tpl, data);</span><br><span class=\"line\">                                $container.<span class=\"title function_\">html</span>(html);</span><br><span class=\"line\">                               <span class=\"comment\">// _this.scrollTop();</span></span><br><span class=\"line\">                            &#125;,</span><br><span class=\"line\">                            <span class=\"attr\">error</span>: <span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">                                $(<span class=\"string\">&quot;#topics-body&quot;</span>).<span class=\"title function_\">html</span>(<span class=\"string\">&#x27;&lt;div class=&quot;alert alert-danger&quot; role=&quot;alert&quot;&gt;error to find topics page.&lt;/div&gt;&#x27;</span>);</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                $(<span class=\"string\">&quot;#pagebar&quot;</span>).<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;(<span class=\"variable constant_\">APP</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>ORC并没有使用传统的框架分页器对象，结合框架模板语言来实现分页，LOR框架也暂时不提供这些功能。用的是Juicer前端模板来实现把后端返回的JSON数据的字段，渲染到前端的Layout标签中。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> tpl = $(<span class=\"string\">&quot;#topic-item-tpl&quot;</span>).<span class=\"title function_\">html</span>();</span><br><span class=\"line\"><span class=\"keyword\">var</span> html = <span class=\"title function_\">juicer</span>(tpl, data);</span><br><span class=\"line\">$container.<span class=\"title function_\">html</span>(html);</span><br></pre></td></tr></table></figure>\n<p>juicer把data数据提供给了topic-item-tpl这个标签类，并在前端页面嵌入了 {@each topics as t}语法，取得JSON数据的值， t.title, t.avatar等。</p>\n<p>上面这段代码，把后端返回JSON数据返回在前端渲染，主要靠的是juicer。按目前ORC这种写法， 前后端都是通过JSON数据建立联系，ORM,Etlua标记，分页器这种中间模块都没用到。下面的实验就是把这些功能，应用到ORC上。</p>\n<p>PS:<br>\nORC=Openrest China</p>\n<p>下一篇实验是对ORC的内容页进行Lapis的代码实现移植。</p>\n","text":"作者：糖果 ORC是是用LOR框架完成的，这次尝试实现用Lapis来实现，ORC索引页面的显示， 国为ORC是后端前端分开的， 实际上后端只要根据用输入返回按接口定义的JSON数据就好。 这个实验会涉及到几个最学用的点： 1.简单的用SQL对业务表进行left join，这个和语...","link":"","photos":[],"count_time":{"symbolsCount":"9.3k","symbolsTime":"8 mins."},"categories":[{"name":"topic","slug":"topic","count":308,"path":"api/categories/topic.json"}],"tags":[],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#1-%E7%AE%80%E5%8D%95%E7%9A%84%E7%94%A8SQL%E5%AF%B9%E4%B8%9A%E5%8A%A1%E8%A1%A8%E8%BF%9B%E8%A1%8Cleft-join%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%92%8C%E8%AF%AD%E8%A8%80%E5%B9%B3%E5%8F%B0%E6%97%A0%E5%85%B3%E3%80%82\"><span class=\"toc-text\">1.简单的用SQL对业务表进行left join，这个和语言平台无关。</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#2-OR%E7%9A%84LUA%E6%A1%86%E6%9E%B6%E8%BF%94%E5%9B%9EJSON-JSON%E6%95%B0%E6%8D%AE%E7%9A%84%E7%BC%96%E8%A7%A3%E7%A0%81%E3%80%82\"><span class=\"toc-text\">2.OR的LUA框架返回JSON, JSON数据的编解码。</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#3-%E5%B8%B8%E8%A7%84%E4%B8%8D%E4%BD%BF%E7%94%A8ORM%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93%E3%80%82\"><span class=\"toc-text\">3.常规不使用ORM访问数据库。</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#4-Lapis%E6%A8%A1%E6%9D%BF%EF%BC%8C%E5%9C%A8%E6%A8%A1%E6%9D%BF%E4%B8%AD%E8%BF%9B%E8%A1%8C%E5%AD%90%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93%E3%80%82\"><span class=\"toc-text\">4.Lapis模板，在模板中进行子模板渲染。</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"关于Linux环境变量命令ENV","uid":"074f77a9b17de10d6ce47d49abfb9adf","slug":"old_topic/2016-09-17-267","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T07:45:09.226Z","comments":true,"path":"api/articles/old_topic/2016-09-17-267.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":null,"text":"这个测试有几种入口，export，或是用户请求url，我们先从本地做测试，然后搭建一个bshell的CGI环境。 12export testcase=ls\\;lseval ret=$testcase 我们看一下C实现 123456789#include &lt;stdio.h&g...","link":"","photos":[],"count_time":{"symbolsCount":320,"symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":308,"path":"api/categories/topic.json"}],"tags":[],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"ElasticSearch的LUA客户端","uid":"fc17f56f18c6188c98c1c7bfedd06596","slug":"old_topic/2016-09-17-270","date":"2016-09-17T14:50:18.000Z","updated":"2024-03-14T07:45:09.161Z","comments":true,"path":"api/articles/old_topic/2016-09-17-270.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":null,"text":"作者：糖果 从Github上看，有一位叫做Dhaval Kapil老师完成了ElasticSearch for Lua的工作，另一位来自阿根廷的叫做Cristian Haunsen的老师，完成了ElasticSearch for Lapis的客户端程序写作工作,dhavalkap...","link":"","photos":[],"count_time":{"symbolsCount":"2.8k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":308,"path":"api/categories/topic.json"}],"tags":[],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}