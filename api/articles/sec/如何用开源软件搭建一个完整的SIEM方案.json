{"title":"如何用开源软件搭建一个完整的SIEM方案","uid":"f7038f4d4abdf1ff3ce158196a4b7e2d","slug":"sec/如何用开源软件搭建一个完整的SIEM方案","date":"2024-03-14T07:45:09.056Z","updated":"2024-03-14T07:45:09.056Z","comments":true,"path":"api/articles/sec/如何用开源软件搭建一个完整的SIEM方案.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<h1 id=\"如何用开源软件搭建一个完整的siem方案\"><a class=\"markdownIt-Anchor\" href=\"#如何用开源软件搭建一个完整的siem方案\"></a> 如何用开源软件搭建一个完整的SIEM方案</h1>\n<p>SIEM是企业安全运营中心的核心引擎，用于收集、分析和存储安全事件信息并为安全运营的各个流程提供决策信息。SIEM极为复杂，因此绝大多数企业都选择购买价格不菲的商业产品/服务。</p>\n<p>但是，高企的价位和运营成本使SIEM成为大型企业才能享用的网络安全“奢侈品”，对于很多安全预算有限的中小型企业，部署SIEM会挤占大量研发、营销和人才预算。</p>\n<p>云安全公司SOCFortress认为，网络安全是一种权利，而不应该是特权。该公司推荐了一整套开源工具来帮助企业搭建功能不输商业产品的开源SIEM（甚至SOC）方案，整理如下：</p>\n<p><strong>构成SIEM堆栈的关键要素</strong></p>\n<p>我们首先需要了解SIEM堆栈的关键构成。如果没有合适的工具，安全团队将很难检测、评估、分类和响应安全事件。随着网络的增长和采集日志量的增加，这一点尤其重要。</p>\n<p>以下是<strong>必须整合到</strong>SIEM堆栈中的关键功能模块。</p>\n<ol>\n<li class=\"lvl-3\">\n<p>日志采集</p>\n</li>\n<li class=\"lvl-3\">\n<p>日志分析</p>\n</li>\n<li class=\"lvl-3\">\n<p>后端存储</p>\n</li>\n<li class=\"lvl-3\">\n<p>可视化</p>\n</li>\n<li class=\"lvl-3\">\n<p>智力充实</p>\n</li>\n<li class=\"lvl-3\">\n<p>案例管理</p>\n</li>\n<li class=\"lvl-3\">\n<p>自动化</p>\n</li>\n<li class=\"lvl-3\">\n<p>调查与应对</p>\n</li>\n<li class=\"lvl-3\">\n<p>监测</p>\n</li>\n</ol>\n<p><img src=\"https://pic4.zhimg.com/80/v2-6bb3a4fc6530246038e6831742c780b3_1440w.webp\" alt=\"\" /></p>\n<p><strong>日志采集</strong></p>\n<p>在SOC分析师查看安全日志之前，首先需要确定采集哪些日志源。常见的日志包括：</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>端点日志（Windows事件、Sysmon、Powershell日志等）</p>\n</li>\n<li class=\"lvl-2\">\n<p>网络设备（防火墙(IDS/IPS)、交换机、接入点）</p>\n</li>\n<li class=\"lvl-2\">\n<p>代理（Apache、NGINX等）</p>\n</li>\n<li class=\"lvl-2\">\n<p>第三方（AWS Cloud Trail、O365、Tenable等）</p>\n</li>\n</ul>\n<p>当我们开始从多个来源采集日志时，确保日志被规范化为通用字段名称，这一点至关重要。例如，source_ip、source_ipv4_ip都应重写为src_ip字段。当我们开始开发仪表板和警报策略时，这将节省时间和精力。</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-e9819fde0d893ca016cef5f13eb76470_1440w.webp\" alt=\"\" /></p>\n<p>通过日志规范化，我们现在可以搭建一个通用仪表板，显示所有日志来源的网络连接。</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-756753db8f0a8b85cd80e908d3aa8c54_1440w.webp\" alt=\"\" /></p>\n<p><strong>GrayLog</strong></p>\n<p>在日志采集方面，Graylog是我们的首选工具。Graylog负责从各种日志源收集日志：</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>Wazuh管理器</p>\n</li>\n<li class=\"lvl-2\">\n<p>网络设备</p>\n</li>\n<li class=\"lvl-2\">\n<p>来自第三方的Syslog转发器（例如Cylance、Crowdstrike等）</p>\n</li>\n<li class=\"lvl-2\">\n<p>以及其他大量功能</p>\n</li>\n</ul>\n<p>Graylog还能处理存储在Wazuh-Indexer后端中的索引管理，以适应所选的索引生命周期。</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-ff8cc560aedea7ec717bb01357380583_1440w.webp\" alt=\"\" /></p>\n<p><strong>日志分析</strong></p>\n<p>虽然采集大量日志是一个很好的起点，但我们还需要能够分析收集到的日志中的元数据细节，以提高警报准确率并确定安全事件的优先级。</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>分析从端点/服务收到的日志。</p>\n</li>\n<li class=\"lvl-2\">\n<p>通过日志分析确定采集的日志的严重性，支持自定义规则的功能。</p>\n</li>\n<li class=\"lvl-2\">\n<p>能够丢弃警报噪音以限制不必要的数据溢出。</p>\n</li>\n</ul>\n<p>每个企业的网络环境都不尽相同，因此需要灵活地创建自己的自定义规则。企业可以尝试Wazuh的自定义规则——免费的高级Wazuh检测规则。</p>\n<p><strong>Wazuh</strong></p>\n<p>Wazuh是一个很棒的工具，它不仅可以从端点收集日志，而且还内置了内置规则，可以分析日志内容以检测攻击。</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-caa9543c75dd889907d69883aa72b106_1440w.webp\" alt=\"\" /></p>\n<p>Wazuh还提供：</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>配置评估</p>\n</li>\n<li class=\"lvl-2\">\n<p>文件完整性监控</p>\n</li>\n<li class=\"lvl-2\">\n<p>漏洞检测</p>\n</li>\n<li class=\"lvl-2\">\n<p>以及更多</p>\n</li>\n</ul>\n<p><strong>后端存储</strong></p>\n<p>采集和分析日志很棒，但这些日志将存储在哪里？我们必须搭建一个后端存储架构，具备如下功能：</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>存储、搜索和查看数据（收集的安全事件）</p>\n</li>\n<li class=\"lvl-2\">\n<p>高可用性</p>\n</li>\n<li class=\"lvl-2\">\n<p>强大的性能</p>\n</li>\n<li class=\"lvl-2\">\n<p>扩展能力</p>\n</li>\n</ul>\n<p><strong>Wazuh索引器</strong></p>\n<p>Wazuh-Indexer是Wazuh的OpenSearch的分叉版本，让我们能够做到这一点。它功能丰富的API还允许我们将其他工具插入Wazuh-Indexer堆栈，例如Grafana、Elastalert等。</p>\n<p><strong>可视化</strong></p>\n<p>存储日志只是一个开始，SOC分析师还需要能够轻松查看、调整、分类和搜索安全威胁或堆栈。大海捞针式的查询体验很快就会导致分析师们精神崩溃。</p>\n<p>因此，我们还需要整合可视化工具以便：</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>通过小部件/仪表板/等查看日志。</p>\n</li>\n<li class=\"lvl-2\">\n<p>快速搜索和查看数据。</p>\n</li>\n<li class=\"lvl-2\">\n<p>支持从多个日志存储（Wazuh-Indexer、csv文件、MySQL等）读取的能力。</p>\n</li>\n</ul>\n<p><img src=\"https://pic2.zhimg.com/80/v2-df7af0104189bc38699a78a19f29bf95_1440w.webp\" alt=\"\" /></p>\n<p><strong>Grafana</strong></p>\n<p>Grafana是值得推荐的可视化工具，速度快（与Kibana相比）、完全可定制、丰富的预构建小部件、强大的社区支持，并提供多租户支持！Grafana允许我们搭建一个“单屏”界面来查看所有的安全事件。</p>\n<p><strong>情报富化</strong></p>\n<p>除了分析日志之外，我们还需要一种方法来富化日志，以帮助分析师快速发现潜在的恶意活动。例如，与网站交互的某个IP地址是否恶意？我们需要一个具备如下功能的日志富化工具：</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>使用来自多个提供商的威胁情报富化采集到的日志。</p>\n</li>\n<li class=\"lvl-2\">\n<p>解析并存储选定的响应，以便仅存储关键数据。</p>\n</li>\n<li class=\"lvl-2\">\n<p>自动化，因此SOC分析师不必手动尝试富化收到的日志。</p>\n</li>\n</ul>\n<p><strong>OpenCTI</strong></p>\n<p>OpenCTI平台的首要目的是提供一个强大的知识管理数据库，该数据库具有一个专门为网络威胁情报和安全运营量身定制的强化模式。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-be66ea55f5bbcafdc3f2552a600f37e1_1440w.webp\" alt=\"\" /></p>\n<p><strong>MISP</strong></p>\n<p>MISP提供元数据标记、提要、可视化，甚至可与其他工具集成以进行进一步分析，这要归功于其开放的协议和数据格式。</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-41e4b7c8b0b4f66958d1b3d28d8d8784_1440w.webp\" alt=\"\" /></p>\n<p>这两种工具都提供了丰富的API，使我们能够及时自动执行威胁情报查找！</p>\n<p><strong>案例管理</strong></p>\n<p>随着SOC团队的壮大，我们需要提供一个平台，让他们能够协作、丰富和响应警报。为您的SOC分析师提供剧本、任务和程序将帮助指导他们完成检测到的警报，并让他们专注于关键警报。</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>用于查看和响应高严重性事件的平台。</p>\n</li>\n<li class=\"lvl-2\">\n<p>允许与多个SOC分析师协作。</p>\n</li>\n<li class=\"lvl-2\">\n<p>允许响应操作，以便分析师可以在其端点上触发事件。</p>\n</li>\n</ul>\n<p><img src=\"https://pic4.zhimg.com/80/v2-903a6f705e1302667b38cb38a2bd830f_1440w.webp\" alt=\"\" /></p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-e467a228968039f2db35aca7be901ff3_1440w.webp\" alt=\"\" /></p>\n<p><strong>TheHIVE/Cortex</strong></p>\n<p>TheHIVE使我们能够管理、组织、关联事件并自动化取证分析，同时利用强大的协作能力。</p>\n<p>而Cortex提供对来自第三方或遗留服务和自动主动响应的可观察数据（文件哈希、IP、域等）的调查。</p>\n<p><strong>自动化</strong></p>\n<p>随着采集的日志不断增加，我们需要一个可以自动执行许多任务的工具，例如：</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>案例创建</p>\n</li>\n<li class=\"lvl-2\">\n<p>网络钓鱼分析</p>\n</li>\n<li class=\"lvl-2\">\n<p>健康检查失败</p>\n</li>\n<li class=\"lvl-2\">\n<p>报告生成</p>\n</li>\n<li class=\"lvl-2\">\n<p>其他种种</p>\n</li>\n</ul>\n<p>这篇文章中提到的所有开源工具都自带API，我们可以将SOAR平台插入其中以自动化几乎所有任务！</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-b14a5467f17c017f22d3fbc4387acf48_1440w.webp\" alt=\"\" /></p>\n<p><strong>Shuffle</strong></p>\n<p>Shuffle是SOAR的开源实现，通过即插即用应用程序带来在整个企业中传输数据所需的所有功能，使每个人都可以使用自动化。它能消除团队中对编码器的需求（但仍然建议至少有一个），Shuffle能够在几分钟内（而不是几小时或几天）部署新的、复杂（或简单）的工作流程。</p>\n<p><strong>事件调查</strong></p>\n<p>接收警报只是成功的一半，我们必须让我们的SOC分析师能够通过可扩展的方式与受监控的端点快速交互来彻底调查警报。一些技术包括：</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>列出正在运行的进程</p>\n</li>\n<li class=\"lvl-2\">\n<p>枚举登录用户</p>\n</li>\n<li class=\"lvl-2\">\n<p>检测监听端口</p>\n</li>\n<li class=\"lvl-2\">\n<p>查看下载的文件</p>\n</li>\n<li class=\"lvl-2\">\n<p>隔离设备</p>\n</li>\n<li class=\"lvl-2\">\n<p>等等</p>\n</li>\n</ul>\n<p>如果没有上述功能，SOC分析师就很难快速评估警报的实际严重性。</p>\n<p><strong>Velociraptor</strong></p>\n<p>Velociraptor是一种先进的数字取证和事件响应工具，可增强对端点的可见性。只需按下（几个）按钮，我们就可以在所有端点上精准高效地同时进行有针对性的数字取证收集，其可靠的API支持在需要时自动化和触发证据收集。</p>\n<p><strong>健康监测</strong></p>\n<p>SIEM堆栈构建完成后，我们需要监控整个SIEM堆栈的运行状况，以确保顺利运行并将丢失警报的风险降至最低。我们通常将监控分为两个阶段：</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>端点资源（CPU、RAM、磁盘、进程等）</p>\n</li>\n<li class=\"lvl-2\">\n<p>WebUI正常运行时间</p>\n</li>\n</ul>\n<p>例如，也许Grafana服务运行良好，但如果防火墙更改禁止了用户访问Grafana WebUI，会导致分析师无法访问WebUI查看警报，并最终使Grafana无法使用。</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-a1ec26c48f9c6f36749136924cb3e7f6_1440w.webp\" alt=\"\" /></p>\n<p><strong>InfluxDB/Telegraf</strong></p>\n<p>InfluxDB与Telegraf代理相结合，使我们能够收集所有的端点指标，并在达到阈值或关键进程（例如wazuh-indexer）未运行时触发内置警报。这使工程团队能够在潜在问题产生严重影响之前主动应对。</p>\n<p><strong>Uptime Kuma</strong></p>\n<p>Uptime Kuma是一种监控工具，可用于实时监控网站和应用程序。特点包括：</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>监控HTTP(s)网站、TCP端口和Docker容器的正常运行时间，并检索DNS记录等信息。</p>\n</li>\n<li class=\"lvl-2\">\n<p>通过电子邮件(SMTP)、Telegram、Discord、Microsoft Teams、Slack、Promo SMS、Gotify和90多种通知服务发送通知。</p>\n</li>\n<li class=\"lvl-2\">\n<p>支持多种语言。</p>\n</li>\n<li class=\"lvl-2\">\n<p>提供多个状态页面。</p>\n</li>\n<li class=\"lvl-2\">\n<p>提供代理支持。</p>\n</li>\n<li class=\"lvl-2\">\n<p>显示SSL证书信息。</p>\n</li>\n<li class=\"lvl-2\">\n<p>将状态页面映射到域。</p>\n</li>\n</ul>\n<p><strong>结论</strong></p>\n<p>安全运营是一件高度复杂且费钱的事情，但企业也没必要为此破产。有大量开源工具可供我们以最低成本搭建我们自己的SIEM技术堆栈。开源的灵活性还允许我们根据自身的需求进行灵活定制。本文我们介绍的本地SOC开源工具，功能上可以媲美商业工具，如果您的团队有足够的人才和试错空间，那么尝试在本地自行搭建开源SOC方案未尝不是一个有趣的选择。</p>\n<p>本文介绍的开源SOC部署策略涉及的工具清单如下：</p>\n<p>1.Wazuh Indexer(OpenSearch)</p>\n<p>2.Wazuh Dashboards(OpenSearch Dashboards)</p>\n<p>3.Graylog</p>\n<p>4.Wazuh Manager/Agents</p>\n<p>5.Grafana</p>\n<p>6.MISP</p>\n<p>7.OpenCTI</p>\n<p>8.TheHIVE/Cortex</p>\n<p>9.Velociraptor/Agents</p>\n<p>10.Shuffle</p>\n<p>11.InfluxDB/Telegraf</p>\n<p>12.Uptime Kuma</p>\n","text":" 如何用开源软件搭建一个完整的SIEM方案 SIEM是企业安全运营中心的核心引擎，用于收集、分析和存储安全事件信息并为安全运营的各个流程提供决策信息。SIEM极为复杂，因此绝大多数企业都选择购买价格不菲的商业产品/服务。 但是，高企的价位和运营成本使SIEM成为大型企业才能享用的...","link":"","photos":[],"count_time":{"symbolsCount":"3.9k","symbolsTime":"4 mins."},"categories":[{"name":"安全","slug":"安全","count":38,"path":"api/categories/安全.json"}],"tags":[{"name":"SIEM","slug":"SIEM","count":2,"path":"api/tags/SIEM.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%A6%82%E4%BD%95%E7%94%A8%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84siem%E6%96%B9%E6%A1%88\"><span class=\"toc-text\"> 如何用开源软件搭建一个完整的SIEM方案</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"用于SIEM系统的通用签名格式","uid":"3b9db7fa138fa3362596403fa91e4809","slug":"sec/SIEM/用于SIEM系统的通用签名格式","date":"2024-03-14T07:45:09.057Z","updated":"2024-03-14T07:45:09.057Z","comments":true,"path":"api/articles/sec/SIEM/用于SIEM系统的通用签名格式.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" 用于SIEM系统的通用签名格式 一、什么是sigma Sigma是一种通用的开放签名格式，允许您以一种直接的方式描述相关的日志事件。规则格式非常灵活，易于编写，适用于任何类型的日志文件。该项目的主要目的是提供一种结构化的形式，在这种结构中，研究人员或分析人员可以描述他们曾经开发...","link":"","photos":[],"count_time":{"symbolsCount":680,"symbolsTime":"1 mins."},"categories":[{"name":"安全","slug":"安全","count":38,"path":"api/categories/安全.json"}],"tags":[{"name":"SIEM","slug":"SIEM","count":2,"path":"api/tags/SIEM.json"},{"name":"sigama","slug":"sigama","count":1,"path":"api/tags/sigama.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"OpenCTI创建报告","uid":"81a55a8deb4238544f7e1b98796e670b","slug":"sec/OpenCTI/OpenCTI创建报告","date":"2024-03-14T07:45:09.056Z","updated":"2024-03-14T07:45:09.056Z","comments":true,"path":"api/articles/sec/OpenCTI/OpenCTI创建报告.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" OpenCTI创建报告 一、介绍 如果您想要添加一个不在平台上的报告或源代码来分析它，您有两种可能性: 要么报告在数据库中，其中存在一个到OpenCTI的连接器。你只需要在这个数据库中找到你的报告，并按照程序导入它(例如，在MISP中，你必须标记它，以及在Zotero中)。之后...","link":"","photos":[],"count_time":{"symbolsCount":490,"symbolsTime":"1 mins."},"categories":[{"name":"安全","slug":"安全","count":38,"path":"api/categories/安全.json"}],"tags":[{"name":"OpenCTI","slug":"OpenCTI","count":4,"path":"api/tags/OpenCTI.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}