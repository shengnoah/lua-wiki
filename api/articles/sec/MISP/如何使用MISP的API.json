{"title":"如何使用MISP的API","uid":"33c279dddaa220a0eb336dbd68718677","slug":"sec/MISP/如何使用MISP的API","date":"2024-03-14T07:45:09.047Z","updated":"2024-03-14T07:45:09.048Z","comments":true,"path":"api/articles/sec/MISP/如何使用MISP的API.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":[],"content":"<h1>如何使用MISP的API</h1>\n<p>Welcome back to this series on using MISP for threat intelligence!</p>\n<p><a href=\"https://www.misp-project.org/\">MISP</a> (Malware Information Sharing Platform and Threat Sharing) is an open-source threat intelligence platform that allows you to share, collate, analyze, and distribute threat intelligence. It is used across industries and governments worldwide to share and analyze information about the latest threats. This series aims to give you the knowledge you need to get up and running with MISP as quickly as possible.</p>\n<p>If you have followed this series, you will now have events and attributes (IOCs) in your MISP instance and know how to search through them. However, this can be clunky using the MISP web interface. Thankfully, MISP exposes an API we can use to perform any action we can do in the web interface in code!</p>\n<p>Today, you learn to use this API to make the most of your MISP instance. You will see how to get statistics about your MISP instance, search for attributes and events, and visualize data you’ve added to your instance.</p>\n<p>Let’s jump in and start using the API!</p>\n<h2 id=\"What-is-an-API\">What is an API?</h2>\n<p>Before looking at MISP’s API, let’s have a quick refresher on what an API is and what it is used for.</p>\n<p>An Application Programming Interface (API) is a set of protocols, routines, and tools for building software applications. It defines a set of rules that allow software applications to interact with each other to exchange data and services. They are a bridge between two applications that allows them to communicate with each other in a standard way.</p>\n<p>APIs allow developers to access specific functionality or data from a service or application without requiring access to the underlying code. This makes it possible to integrate different software applications, databases, and services and build new applications on top of existing ones.</p>\n<p>The most common APIs you are likely to interact with are web APIs, which allow you to interact with a web-based application in a programmable manner. APIs can be public (which anyone can use) or private (which are only accessible by authorized parties). Again, most of the time, you will use APIs requiring some form of authorization (username and password, token, etc.), which is the case with MISP’s API.</p>\n<h2 id=\"The-Basics-of-the-MISP-API\">The Basics of the MISP API</h2>\n<p>MISP comes with a <a href=\"https://en.wikipedia.org/wiki/REST\">RESTful API</a>, which you can use to query your MISP instance for data about itself (e.g., statistics) or data about the intelligence it holds (e.g., events and attributes) using <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/GET\">HTTP GET requests</a>. This data is returned to you in either JSON or XML format so you can easily parse it into the form you want to work with. You can also use HTTP POST, PUT, and DELETE requests to add, edit, or remove data from your MISP instance programmatically.</p>\n<p>Interacting with your MISP instance through its API saves you from going through MISP’s web interface to retrieve this data and increases the efficiency of your operations through the power of code and automation.</p>\n<h3 id=\"Interacting-with-the-MISP-API\">Interacting with the MISP API</h3>\n<p>To interact with the MISP API, you must add an authentication key to authenticate your application with your MISP instance. You can do this by going to <em>Administration</em> in the top menu and selecting the <em>List Auth Keys</em> dropdown option.</p>\n<p><img src=\"https://kravensecurity.com/wp-content/uploads/2023/11/list-auth-keys-menu.jpg\" alt=\"MISP List Auth Keys Button\"></p>\n<p>You may not see this option if you do not have the appropriate privileges. To circumvent this, log in as the default admin user.</p>\n<p>This will bring you to the Authentication Key Index, where you can click the <em>Add authentication key</em> button to create a new API key.</p>\n<p><img src=\"https://kravensecurity.com/wp-content/uploads/2023/11/add-authentication-key-button.jpg\" alt=\"Add Authentication Key Button\"></p>\n<p>Clicking this button will bring up a popup window for you to fill out the details of the authentication key you are adding. Here, you can select the user account associated with the key, add a comment about what this key is used for, allowlist only specific IP addresses, and add an expiration date. All of these are optional. Click <em>Submit</em> when done.</p>\n<p><img src=\"https://kravensecurity.com/wp-content/uploads/2023/11/creating-auth-key.jpg\" alt=\"Creating API Authentication Key\"></p>\n<p>Make sure to save your authentication key in your password manager so you can use it later. This is very important. You won’t be able to see this key again in MISP, and you will have to generate a new one if you forget it. Click the <em>I have noted down my key, take me back now</em> button when done.</p>\n<p><img src=\"https://kravensecurity.com/wp-content/uploads/2023/11/auth-key-confirmation-screen.jpg\" alt=\"Auth Key Created Confirmation\"></p>\n<p>You will now see your authentication key appear on the Authentication Key Index page, and you can begin using it!</p>\n<p><img src=\"https://kravensecurity.com/wp-content/uploads/2023/11/auth-key-in-authentication-key-index.jpg\" alt=\"API Auth Key in Authentication Key Index\"></p>\n<h2 id=\"The-Best-Way-to-Use-the-MISP-API\">The Best Way to Use the MISP API</h2>\n<p>You can interact with the MISP API through direct web requests to the MISP API endpoint. For instance, making a GET request to <code>https://&lt;misp_ip&gt;/events</code> to retrieve information about an event or a POST request to <code>https://&lt;misp_ip&gt;/events/add</code> to add an event. However, if you know a little bit of Python, there is an easier way.</p>\n<p><a href=\"https://www.circl.lu/doc/misp/pymisp/\">PyMISP</a> is a Python library you can use to access MISP, make API requests, and automatically parse data returned into Python objects so you can manipulate them using standard Python methods and functions. You can install PyMISP using the <a href=\"https://pip.pypa.io/\">Python package manager pip</a> with the command <code>pip3 install pymisp</code> or use another installation method detailed on the <a href=\"https://github.com/MISP/PyMISP/tree/main\">PyMISP GitHub page</a>.</p>\n<p>Once installed, you can use PyMISP to create a Python script that acts as a wrapper for all your MISP API queries, allowing you to perform complex data analysis tasks easily. That said, skip the script. The best way to perform data analysis (and prototyping) is using a <a href=\"https://jupyter.org\">Jupyter Notebook</a>.</p>\n<p>A Jupyter Notebook can serve two main purposes:</p>\n<ol>\n<li class=\"lvl-3\">\n<p>Creating a mix of code and Markdown content that serves as “interactive documentation.” A user reads the Markdown content and executes the code as they work their way through the Notebook.</p>\n</li>\n<li class=\"lvl-3\">\n<p>For prototyping code that you are building into a larger and more complex tool.</p>\n</li>\n</ol>\n<p>You can use Jupyter Notebooks for prototyping as you interact with the MISP API through Python code. To follow along, see <a href=\"https://kravensecurity.com/python-threat-hunting-tools-jupyter-notebooks/\">Python Threat Hunting Tools: Part 10 — The Power of Jupyter Notebooks</a> to learn how to create a Jupyter Notebook. Then, use the code examples shown below in your Jupyter Notebook, replacing the variables I use with those of your MISP instance. Add documentation so you remember what each code example does using Markdown cells.</p>\n<h2 id=\"Authentication\">Authentication</h2>\n<p>You must first authenticate to send API requests to your MISP instance. You need two things to do this:</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>An authentication key to authenticate to the API (as discussed above).</p>\n</li>\n<li class=\"lvl-2\">\n<p>The IP address or URL of your MISP instance.</p>\n</li>\n</ul>\n<p>With these in hand, you can use the code below to authenticate to the MISP API using Python:</p>\n<p>Python</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># import PyMISP object from pymisp Python library</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> pymisp <span class=\"keyword\">import</span> PyMISP</span><br><span class=\"line\"><span class=\"comment\"># url or IP address of MISP instance</span></span><br><span class=\"line\">MISP_URL = <span class=\"string\">&#x27;&lt;misp_url&gt;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># your API authentication key, generated using your MISP instance</span></span><br><span class=\"line\">MISP_KEY = <span class=\"string\">&#x27;&lt;api_key&gt;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># create MISP instance to interact with using Python methods</span></span><br><span class=\"line\">misp = PyMISP(MISP_URL, MISP_KEY, ssl=<span class=\"literal\">False</span>, debug=<span class=\"literal\">False</span>)</span><br></pre></td></tr></table></figure>\n<p>You are now ready to begin interacting with the MISP API using Python. Let’s see how to retrieve statistics, search for attributes and events, and visualize data!</p>\n<p>The <code>ssl</code> and <code>debug</code> options have been set to false to avoid unnecessary error messages when prototyping.</p>\n<h2 id=\"Retrieving-Statistics\">Retrieving Statistics</h2>\n<p>You can get data from the MISP API about general statistics, tags, and attributes related to your MISP instance.</p>\n<h3 id=\"General-Statistics\">General Statistics</h3>\n<p>To retrieve general statistics, you can use the <code>user_statistics()</code> method associated with the <code>misp</code> object you created when authenticating.</p>\n<p>Python</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">response = misp.user_statistics()</span><br></pre></td></tr></table></figure>\n<p>This returns a Python dictionary, which you can query for information like total users, events, and attributes.</p>\n<p>Python</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">general_stats</span>():</span><br><span class=\"line\">  res = misp.user_statistics()</span><br><span class=\"line\">  <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Total users: <span class=\"subst\">&#123;res[<span class=\"string\">&#x27;stats&#x27;</span>][<span class=\"string\">&#x27;user_count&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\">  <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Total events: <span class=\"subst\">&#123;res[<span class=\"string\">&#x27;stats&#x27;</span>][<span class=\"string\">&#x27;event_count&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\">  <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Total attributes: <span class=\"subst\">&#123;res[<span class=\"string\">&#x27;stats&#x27;</span>][<span class=\"string\">&#x27;attribute_count&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">general_stats()</span><br></pre></td></tr></table></figure>\n<h3 id=\"Tag-Statistics\">Tag Statistics</h3>\n<p>To retrieve tag statistics, you can use the <code>tag_statistics()</code> method associated with the <code>misp</code> object you created.</p>\n<p>Python</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">response = misp.tag_statistics()</span><br></pre></td></tr></table></figure>\n<p>This returns a Python dictionary which you can query for information based on specific tags.</p>\n<p>Python</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">tag_stats</span>():</span><br><span class=\"line\">  res = misp.tag_statistics()</span><br><span class=\"line\">  <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Total reports: <span class=\"subst\">&#123;res[<span class=\"string\">&#x27;tags&#x27;</span>][<span class=\"string\">&#x27;cssa:origin=report&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\">  <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Total investigations: <span class=\"subst\">&#123;res[<span class=\"string\">&#x27;tags&#x27;</span>][<span class=\"string\">&#x27;cssa:origin=manual_investigation&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\">  <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Total purple team exercises: <span class=\"subst\">&#123;res[<span class=\"string\">&#x27;tags&#x27;</span>][<span class=\"string\">&#x27;custom:purple-team-exercise&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">general_stats()</span><br></pre></td></tr></table></figure>\n<h3 id=\"Attribute-Statistics\">Attribute Statistics</h3>\n<p>To retrieve statistics about attributes, you can use the <code>attribute_statistics()</code> method associated with the <code>misp</code> object you created.</p>\n<p>Python</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">response = misp.attribute_statistics()</span><br></pre></td></tr></table></figure>\n<p>This returns a Python dictionary, which you can query for information about specific attributes.</p>\n<p>Python</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">attribute_stats</span>():</span><br><span class=\"line\">  res = misp.attributes_statistics()</span><br><span class=\"line\">  <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Total MD5 hashes: <span class=\"subst\">&#123;res[<span class=\"string\">&#x27;md5&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\">  <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Total domains: <span class=\"subst\">&#123;res[<span class=\"string\">&#x27;domains&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\">  <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Total IP addresses: <span class=\"subst\">&#123;res[<span class=\"string\">&#x27;ip-dst&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\">  <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Total URLs: <span class=\"subst\">&#123;res[<span class=\"string\">&#x27;url&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\">  <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Total email addresses: <span class=\"subst\">&#123;res[<span class=\"string\">&#x27;email-src&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\">  </span><br><span class=\"line\">general_stats()</span><br></pre></td></tr></table></figure>\n<h2 id=\"Searching-for-Attributes-and-Events\">Searching for Attributes and Events</h2>\n<p>You can use the MISP API to search for Indicators of Compromise (IOCs) you uploaded to your MISP instance as attributes. Searching for them will return the MISP event they are associated with.</p>\n<p>To learn more about attributes and events in MISP, read <a href=\"https://kravensecurity.com/threat-intelligence-with-misp-part-3-creating-events/\">Threat Intelligence with MISP: Part 3 — Creating Events</a>.</p>\n<p>The code below searches for an <code>IOC</code> and uses the <code>misp</code> object’s <code>search()</code> method to query the MISP API for this IOC. MISP will search all the attributes it has stored in its database and return the event an attribute is associated with. The Python code saves the response returned by the API in a dictionary data structure and checks to see if it contains data using an <code>if</code> statement. If it does, this data is parsed using dictionary bracket notation to return key event information that is printed using <a href=\"https://www.geeksforgeeks.org/formatted-string-literals-f-strings-python/\">Python f strings</a>.</p>\n<p>Python</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">IOC = <span class=\"string\">&quot;oxcdntech.com&quot;</span></span><br><span class=\"line\">response = misp.search(value=IOC)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> response:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&quot;--- Matching Event ---&quot;</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Event ID: <span class=\"subst\">&#123;response[<span class=\"number\">0</span>][<span class=\"string\">&#x27;Event&#x27;</span>][<span class=\"string\">&#x27;id&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Event Info: <span class=\"subst\">&#123;response[<span class=\"number\">0</span>][<span class=\"string\">&#x27;Event&#x27;</span>][<span class=\"string\">&#x27;info&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Date Added: <span class=\"subst\">&#123;response[<span class=\"number\">0</span>][<span class=\"string\">&#x27;Event&#x27;</span>][<span class=\"string\">&#x27;date&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Tags: <span class=\"subst\">&#123;response[<span class=\"number\">0</span>][<span class=\"string\">&#x27;Event&#x27;</span>][<span class=\"string\">&#x27;date&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> tag <span class=\"keyword\">in</span> response[<span class=\"number\">0</span>][<span class=\"string\">&#x27;Event&#x27;</span>][<span class=\"string\">&#x27;Tag&#x27;</span>]:</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;- <span class=\"subst\">&#123;tag[<span class=\"string\">&#x27;name&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&quot;-&quot;</span> * <span class=\"number\">20</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;The IOC <span class=\"subst\">&#123;IOC&#125;</span> is not in MISP&quot;</span>)</span><br></pre></td></tr></table></figure>\n<p>The IOC in this example code is a domain name (<code>oxcdntech.com</code>). However, you can change this for any MISP attribute type, such as IP addresses, file hashes, hostnames, email addresses, etc.</p>\n<p>The MISP API provides a quick and easy way to <a href=\"https://kravensecurity.com/threat-intelligence-with-misp-part-5-searching-and-filtering/\" title=\"search your MISP instance\">search your MISP instance</a> for an IOC without going through the web interface. These searches can also be scripted, automated, and integrated into larger workflows. For instance, you can write a script to check an IOC against your MISP instance, VirusTotal, GreyNoise, and any other threat intelligence source that exposes an API for you to use, allowing you to produce a more complete picture.</p>\n<h2 id=\"Visualizing-Data\">Visualizing Data</h2>\n<p>The examples so far, returning statistics and searching for IOCs, have been basic. Let’s now look at a more complex example of using the MISP API to visualize the most common techniques, tactics, and procedures (TTPs) within your threat intelligence data.</p>\n<p>Whenever you upload a new threat intelligence report, incident, or piece of research to MISP, you can include additional context by adding a galaxy cluster on the <em>View Event</em> page. This additional context allows you to use shared threat intelligence frameworks or standardized lingo to describe your event, helping others understand and use it.</p>\n<p>Read <a href=\"https://kravensecurity.com/threat-intelligence-with-misp-part-3-creating-events/\">Threat Intelligence with MISP: Part 3 — Creating Events</a> to learn about galaxy clusters.</p>\n<p>Using the <em>Attacker Pattern</em> galaxy (under the <em>mitre-attack</em>), you can add data about the TTPs associated with an event. This is useful because it helps you track how threat actors attack systems and, by extension, how to defend against them.</p>\n<p><img src=\"https://kravensecurity.com/wp-content/uploads/2023/11/view-event-galaxy-information.jpg\" alt=\"MISP View Event Galaxy Information\"></p>\n<p>However, as defenders, our time and resources are usually limited, so we need to prioritize which TTPs we want to focus on defending against. A good starting point is finding what TTPs are most commonly used by threat actors targeting your organization and prioritizing those. You can use the MISP API to automate this by aggregating common TTPs and then visualizing the most common using the <a href=\"https://pandas.pydata.org/\">pandas Python data analysis library</a>.</p>\n<p>This approach is discussed in-depth in <a href=\"https://kravensecurity.com/threat-profiling-how-to-understand-hackers-and-their-ttps/\">Threat Profiling: How to Understand Hackers and Their TTPs</a>, where you can see how to perform common TTP aggregation and visualization manually using a spreadsheet.</p>\n<p>The Python code below does the following:</p>\n<ol>\n<li class=\"lvl-3\">\n<p>Returns all events in your MISP.</p>\n</li>\n<li class=\"lvl-3\">\n<p>Creates a Python dictionary containing MITRE ATT&amp;CK TTPs mapped to a count (redacted for brevity).</p>\n</li>\n<li class=\"lvl-3\">\n<p>Loops through all events and increases the count of the TTP in the dictionary. It uses dictionary bracket notation to parse galaxy cluster information.</p>\n</li>\n<li class=\"lvl-3\">\n<p>Transforms the Python dictionary into a pandas series object.</p>\n</li>\n<li class=\"lvl-3\">\n<p>Plots the series object using a horizontal bar graph so you can visualize the data. This code only plots TTPs that have a count greater than 9.</p>\n</li>\n</ol>\n<p>Python</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) get all events in MISP instance</span></span><br><span class=\"line\"><span class=\"built_in\">all</span> = misp.search(controller=<span class=\"string\">&quot;events&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\"># (2) create dictionary containing MITRE ATT&amp;CK TTPs mapped to a count</span></span><br><span class=\"line\">ttps = &#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;T1548&quot;</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  <span class=\"string\">&quot;T1220&quot;</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) loop through all events and increase count of a TTP in dictionary if an event has that TTP</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">all</span>:</span><br><span class=\"line\">    galaxies = i[<span class=\"string\">&#x27;Event&#x27;</span>][<span class=\"string\">&#x27;Galaxy&#x27;</span>]</span><br><span class=\"line\">    <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> galaxies:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> j[<span class=\"string\">&#x27;type&#x27;</span>] == <span class=\"string\">&#x27;mitre-attack-pattern&#x27;</span>:</span><br><span class=\"line\">            <span class=\"keyword\">for</span> k <span class=\"keyword\">in</span> j[<span class=\"string\">&#x27;GalaxyCluster&#x27;</span>]:</span><br><span class=\"line\">                ttp = k[<span class=\"string\">&#x27;meta&#x27;</span>][<span class=\"string\">&#x27;external_id&#x27;</span>][<span class=\"number\">0</span>]</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ttp <span class=\"keyword\">in</span> ttps:</span><br><span class=\"line\">                    ttps[ttp] += <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) creating a pandas series object</span></span><br><span class=\"line\">ttps_data = pd.Series(data=ttps, index=<span class=\"built_in\">list</span>(ttps.keys()))</span><br><span class=\"line\"><span class=\"comment\"># (5) plotting the data in a horizontal bar graph</span></span><br><span class=\"line\">(ttps_data</span><br><span class=\"line\">    [<span class=\"keyword\">lambda</span> s: s&gt;<span class=\"number\">9</span>]</span><br><span class=\"line\">    .plot.barh()</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<p>Once executed, you should see a nicely formatted horizontal bar graph in your Jupyter Notebook. This shows you the most common TTPs and, unlike a spreadsheet, will dynamically change when you add more events to your MISP instance.</p>\n<p><img src=\"https://kravensecurity.com/wp-content/uploads/2023/11/visualizing-common-ttps-graph.jpg\" alt=\"Visualizing Common TTPs Bar Graph\"></p>\n<p>Going a step further, you can also limit your collection of TTPs to specific MISP events. MISP allows you to add tags to events that allow you to classify and categorize your events. For instance, you could have a tag for external threat intelligence reports, a tag for incidents your organization has faced in the past, or a tag for research you’re performing.</p>\n<p>The code below limits the TTPs it aggregates and visualizes to those with the tag “software-research.” I created this custom tag to add data to MISP about threat actors and malware I was researching, including the TTPs they use. The code lets me see the common TTPs in this research data.</p>\n<p>Python</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TAG = <span class=\"string\">&quot;software-research&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># get all events in MISP instance</span></span><br><span class=\"line\"><span class=\"built_in\">all</span> = misp.search(controller=<span class=\"string\">&quot;events&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\"># create dictionary containing MITRE ATT&amp;CK TTPs mapped to a count</span></span><br><span class=\"line\">ttps = &#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;T1548&quot;</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  <span class=\"string\">&quot;T1220&quot;</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># loop through all events and increase count of a TTP in dictionary if an event has that TTP</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">all</span>:</span><br><span class=\"line\">    <span class=\"comment\"># check for a specific TAG</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> tag <span class=\"keyword\">in</span> i[<span class=\"string\">&#x27;Event&#x27;</span>][<span class=\"string\">&#x27;Tag&#x27;</span>]:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> tag[<span class=\"string\">&#x27;name&#x27;</span>] == TAG:</span><br><span class=\"line\">            galaxies = i[<span class=\"string\">&#x27;Event&#x27;</span>][<span class=\"string\">&#x27;Galaxy&#x27;</span>]</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            <span class=\"keyword\">continue</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> galaxies:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> j[<span class=\"string\">&#x27;type&#x27;</span>] == <span class=\"string\">&#x27;mitre-attack-pattern&#x27;</span>:</span><br><span class=\"line\">                <span class=\"keyword\">for</span> k <span class=\"keyword\">in</span> j[<span class=\"string\">&#x27;GalaxyCluster&#x27;</span>]:</span><br><span class=\"line\">                    ttp = k[<span class=\"string\">&#x27;meta&#x27;</span>][<span class=\"string\">&#x27;external_id&#x27;</span>][<span class=\"number\">0</span>]</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> ttp <span class=\"keyword\">in</span> ttps:</span><br><span class=\"line\">                        ttps[ttp] += <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># plotting data</span></span><br><span class=\"line\">ttps_data = pd.Series(data=ttps, index=<span class=\"built_in\">list</span>(ttps.keys()))</span><br><span class=\"line\">(ttps_data</span><br><span class=\"line\">    [<span class=\"keyword\">lambda</span> s: s&gt;<span class=\"number\">11</span>]</span><br><span class=\"line\">    .plot.barh()</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<h2 id=\"Summary\">Summary</h2>\n<p>Congrats! You now know the basics of the MISP API and how to leverage it to get statistics about your MISP instance, search for attributes and events, and visualize the threat intelligence you’ve added to it. The MISP API is an incredibly powerful tool that you should invest time into learning by building your own simple Python scripts and automations.</p>\n<p>If you were unable to follow along, don’t worry. I will add all these code examples to a Jupyter Notebook you can use. You can find it on my GitHub page, and I will write up how to use it in <a href=\"https://kravensecurity.com/python-threat-hunting-tools-jupyter-notebook-for-misp/\" title=\"Python Threat Hunting Tools: Part 11 — A Jupyter Notebook for MISP\">Python Threat Hunting Tools: Part 11 — A Jupyter Notebook for MISP</a>.</p>\n<p>The next installment in this series explores how to export attributes from your MISP instance as IOCs to use with your security solutions to detect and block the latest threats. You will see how to do this through the web interface and the MISP API. Stay tuned!</p>\n<p>Discover more in the <a href=\"https://kravensecurity.com/tag/threat-intelligence-with-misp/\">Threat Intelligence with MISP series</a>!</p>\n<p>![Back to top arrow](data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCA5NiA0ODAgMjgzIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Im00MyAzNzktNDMtNDMgMjQwLTI0MCAyNDAgMjQwLTQzIDQzLTE5Ny0xOTd6IiBmaWxsPSIjZmZmIi8+PC9zdmc+Cg==)</p>\n<p>Stay up-to-date whenever we release articles, tips, and guided tutorials. Don’t miss a thing and signup to get notified of new content.</p>\n<h2 id=\"Interesting-in-Learning-More\">Interesting in Learning More?</h2>\n<p><img src=\"https://kravensecurity.com/wp-content/uploads/2023/11/zero-point-security-logo-1.webp\" alt=\"\"></p>\n<h3 id=\"Learn-the-dark-arts-of-red-teaming\">Learn the dark arts of red teaming</h3>\n<p><a href=\"https://training.zeropointsecurity.co.uk/?ref=3e1b79\">Check out these courses offered by Zero-Point Security</a>. They will teach you all things red teaming from creating exploits, writing your own C2 framework, and emulating real-world threat actors.</p>\n<p>If you want more of a challenge, take on one of their certification exams and land your next job in cyber:</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://training.zeropointsecurity.co.uk/courses/red-team-ops?ref=3e1b79\">Red Team Ops</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://training.zeropointsecurity.co.uk/courses/red-team-ops-ii?ref=3e1b79\">Red Team Ops II</a></p>\n</li>\n</ul>\n<p><img src=\"https://kravensecurity.com/wp-content/uploads/2023/11/TCM-academy-logo-1.webp\" alt=\"\"></p>\n<h3 id=\"Learn-more-cyber-security-skills\">Learn more cyber security skills</h3>\n<p>Check out <a href=\"https://academy.tcm-sec.com/p/the-all-access-pass?affcode=770707_annz0hoj\">The All-Access Membership Pass by TCM Academy</a>. for courses on hacking/pentesting, malware analysis, digital forensics, programming/scripting, GRC, and more!</p>\n<p>If you’re looking to level up your skills even more, have a go at one of their certifications:</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p><a href=\"https://academy.tcm-sec.com/a/aff_28fg418j/external?affcode=770707_annz0hoj\">Practical Network Penetration Tester</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://academy.tcm-sec.com/a/aff_l0mcpyff/external?affcode=770707_annz0hoj\">Practical Junior Malware Researcher</a></p>\n</li>\n<li class=\"lvl-2\">\n<p><a href=\"https://academy.tcm-sec.com/a/aff_98zlvk7y/external?affcode=770707_annz0hoj\">Practical Career-Ready Professional</a><a href=\"https://medium.com/tag/threat-intelligence?source=post_page-----be857bba8e7---------------threat_intelligence-----------------\"></a></p>\n</li>\n</ul>\n","text":"如何使用MISP的API Welcome back to this series on using MISP for threat intelligence! MISP (Malware Information Sharing Platform and Threat Sharin...","link":"","photos":[],"count_time":{"symbolsCount":"19k","symbolsTime":"17 mins."},"categories":[{"name":"安全","slug":"安全","count":37,"path":"api/categories/安全.json"}],"tags":[{"name":"MISP","slug":"MISP","count":7,"path":"api/tags/MISP.json"},{"name":"API","slug":"API","count":1,"path":"api/tags/API.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\"><span class=\"toc-text\">如何使用MISP的API</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#What-is-an-API\"><span class=\"toc-text\">What is an API?</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#The-Basics-of-the-MISP-API\"><span class=\"toc-text\">The Basics of the MISP API</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Interacting-with-the-MISP-API\"><span class=\"toc-text\">Interacting with the MISP API</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#The-Best-Way-to-Use-the-MISP-API\"><span class=\"toc-text\">The Best Way to Use the MISP API</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Authentication\"><span class=\"toc-text\">Authentication</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Retrieving-Statistics\"><span class=\"toc-text\">Retrieving Statistics</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#General-Statistics\"><span class=\"toc-text\">General Statistics</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Tag-Statistics\"><span class=\"toc-text\">Tag Statistics</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Attribute-Statistics\"><span class=\"toc-text\">Attribute Statistics</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Searching-for-Attributes-and-Events\"><span class=\"toc-text\">Searching for Attributes and Events</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Visualizing-Data\"><span class=\"toc-text\">Visualizing Data</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Summary\"><span class=\"toc-text\">Summary</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Interesting-in-Learning-More\"><span class=\"toc-text\">Interesting in Learning More?</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Learn-the-dark-arts-of-red-teaming\"><span class=\"toc-text\">Learn the dark arts of red teaming</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Learn-more-cyber-security-skills\"><span class=\"toc-text\">Learn more cyber security skills</span></a></li></ol></li></ol></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"开源威胁情报共享平台MISP的安装与配置","uid":"96dd12ad2138af69b55623880d37b519","slug":"sec/MISP/开源威胁情报共享平台MISP的安装与配置","date":"2024-03-14T07:45:09.047Z","updated":"2024-03-14T07:45:09.047Z","comments":true,"path":"api/articles/sec/MISP/开源威胁情报共享平台MISP的安装与配置.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":[],"text":"开源威胁情报共享平台MISP的安装与配置 MISP是一个开源的威胁情报共享平台，官网定义如下： MISP威胁共享平台是一个免费的开源软件，帮助共享包括网络安全指标在内的威胁情报信息。 The MISP threat sharing platform is a free and o...","link":"","photos":[],"count_time":{"symbolsCount":"1.2k","symbolsTime":"1 mins."},"categories":[{"name":"安全","slug":"安全","count":37,"path":"api/categories/安全.json"}],"tags":[{"name":"MISP","slug":"MISP","count":7,"path":"api/tags/MISP.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Redis调用Lua代码测试","uid":"88a39baca0bf4d65eac517bd912a0a45","slug":"redis/Redis调用Lua代码测试","date":"2024-03-14T07:45:09.046Z","updated":"2024-03-14T07:45:09.046Z","comments":true,"path":"api/articles/redis/Redis调用Lua代码测试.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":null,"text":"Redis调用Lua代码测试 写一段用Redis执行Lua代码的例子 以下是一个使用Redis执行Lua代码的示例： 12345678910111213141516171819import redis# 连接到Redis服务器r = redis.Redis(host=&#x27;...","link":"","photos":[],"count_time":{"symbolsCount":"1.8k","symbolsTime":"2 mins."},"categories":[{"name":"Lua","slug":"Lua","count":3,"path":"api/categories/Lua.json"},{"name":"Redis","slug":"Lua/Redis","count":1,"path":"api/categories/Lua/Redis.json"}],"tags":[{"name":"Redis","slug":"Redis","count":1,"path":"api/tags/Redis.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}