{"title":"在redis中使用Lua脚本","uid":"da54462c562851f416c243978002e41a","slug":"zl/2016-01-01-593_在redis中使用Lua脚本","date":"2024-04-03T03:47:35.833Z","updated":"2024-04-03T03:47:35.833Z","comments":true,"path":"api/articles/zl/2016-01-01-593_在redis中使用Lua脚本.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<h2 id=\"脚本介绍\"><a href=\"#脚本介绍\" class=\"headerlink\" title=\"脚本介绍\"></a>脚本介绍</h2><p>Redis在2.6版本中推出了脚本功能,使用Lua语言(一种“卫星语言”,能够方便地嵌入到其他语言中使用)编写脚本传到Redis中执行。在Lua脚本中可以调用大部分的Redis命令,使用脚本的好处如下:<br/></p>\n<ul>\n<li><p>减少网络开销: 多个redis请求可以在一个脚本中一次发送一个请求,减少网络往返时延。</p>\n</li>\n<li><p>原子操作: Redis会将整个脚本作为一个整体执行，中间不会被其他命令插入。编写脚本的<br/>过程中无需担心会出现竞态条件,也就无需使用事务。事务可以完成的所有功能都可以用脚本实现。</p>\n</li>\n<li><p>复用: 客户端发送的脚本会永久存储在Redis中,其他语言开发的项目可以复用之。</p>\n</li>\n</ul>\n<h2 id=\"代码示例\"><a href=\"#代码示例\" class=\"headerlink\" title=\"代码示例\"></a>代码示例</h2><h3 id=\"1-访问频率限制\"><a href=\"#1-访问频率限制\" class=\"headerlink\" title=\"1.访问频率限制\"></a>1.访问频率限制</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"built_in\">local</span> <span class=\"built_in\">times</span> = redis.call(<span class=\"string\">&#39;incr&#39;</span>,KEYS[1])</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span> <span class=\"built_in\">times</span> == 1 <span class=\"keyword\">then</span> </div><div class=\"line\"></div><div class=\"line\">redis.call(<span class=\"string\">&#39;expire&#39;</span>,KEYS[1],ARGV[1])</div><div class=\"line\">end </div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span> <span class=\"built_in\">times</span> &gt; tonumber(ARGV[2]) <span class=\"keyword\">then</span>\t</div><div class=\"line\"><span class=\"built_in\">return</span> 0</div><div class=\"line\">end </div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">return</span> 1\t</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">#保存该脚本为test.lua,执行该脚本:</span></div><div class=\"line\"></div><div class=\"line\">redis-cli --eval /path/test.lua key1 , 10 2</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">#--eval参数是告诉redis-cli读取并运行后面的Lua脚本,/path/test.jua是脚本文件的路径,key1是要操作的键，在脚本中使用KEYS[1]获取,10和2是参数，在脚本中使用ARGV[1]和ARGV[2]获得值（每10秒最多访问3次),注意空格</span></div></pre></td></tr></tbody></table></figure>\n<h3 id=\"2-java代码示例\"><a href=\"#2-java代码示例\" class=\"headerlink\" title=\"2.java代码示例\"></a>2.java代码示例</h3><figure class=\"highlight java\"><table><tbody><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//redis lua 脚本</span></div><div class=\"line\"><span class=\"keyword\">static</span> String luaScript = <span class=\"string\">&#34;local timeValue = redis.call(&#39;get&#39;,KEYS[1]) if timeValue &lt; ARGV[1] then return  redis.call(&#39;mset&#39;,KEYS[1],ARGV[1],KEYS[2],ARGV[2]) end return nil&#34;</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//执行脚本</span></div><div class=\"line\">redisClient.executeLuaScript(luaScript,<span class=\"string\">&#34;key1&#34;</span>, <span class=\"string\">&#34;key2&#34;</span>, <span class=\"string\">&#34;value1&#34;</span>, <span class=\"string\">&#34;value2&#34;</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//executeLuaScript方法:</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"params\">(String script,String key1,String key2,String avg1,String avg2)</span> <span class=\"keyword\">throws</span> Exception </span>{</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.execution(<span class=\"keyword\">new</span> JedisResultTask() {</div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">protected</span> Object <span class=\"title\">doExecution</span><span class=\"params\">(Jedis jedis)</span> </span>{</div><div class=\"line\">                <span class=\"keyword\">return</span> jedis.eval(script,<span class=\"number\">2</span>,key1,key2,avg1,avg2);</div><div class=\"line\">            }</div><div class=\"line\">        });</div><div class=\"line\">    }</div></pre></td></tr></tbody></table></figure>\n<h3 id=\"3-解决抢红包高并发的问题\"><a href=\"#3-解决抢红包高并发的问题\" class=\"headerlink\" title=\"3.解决抢红包高并发的问题\"></a>3.解决抢红包高并发的问题</h3><blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<p><a href=\"http://blog.csdn.net/hengyunabc/article/details/19433779/\" target=\"_blank\" rel=\"external noopener noreferrer\">传送门</a></p>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>","text":"脚本介绍Redis在2.6版本中推出了脚本功能,使用Lua语言(一种“卫星语言”,能够方便地嵌入到其他语言中使用)编写脚本传到Redis中执行。在Lua脚本中可以调用大部分的Redis命令,使用脚本的好处如下: 减少网络开销: 多个redis请求可以在一个脚本中一次发送一个请求,...","link":"","photos":[],"count_time":{"symbolsCount":"1.4k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%84%9A%E6%9C%AC%E4%BB%8B%E7%BB%8D\"><span class=\"toc-text\">脚本介绍</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B\"><span class=\"toc-text\">代码示例</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-%E8%AE%BF%E9%97%AE%E9%A2%91%E7%8E%87%E9%99%90%E5%88%B6\"><span class=\"toc-text\">1.访问频率限制</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-java%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B\"><span class=\"toc-text\">2.java代码示例</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-%E8%A7%A3%E5%86%B3%E6%8A%A2%E7%BA%A2%E5%8C%85%E9%AB%98%E5%B9%B6%E5%8F%91%E7%9A%84%E9%97%AE%E9%A2%98\"><span class=\"toc-text\">3.解决抢红包高并发的问题</span></a></li></ol></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"150.Evaluate Reverse Polish Notation","uid":"822f2b75bb566ca0a24d71cff86dfdda","slug":"zl/2016-01-01-591_150.Evaluate Reverse Polish Notation","date":"2024-04-03T03:47:35.833Z","updated":"2024-04-03T03:47:35.833Z","comments":true,"path":"api/articles/zl/2016-01-01-591_150.Evaluate Reverse Polish Notation.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" Evaluate the value of an arithmetic expression in Reverse Polish Notation.Valid operators are +, -, *, /. Each operand may be an integer or...","link":"","photos":[],"count_time":{"symbolsCount":"1.1k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"tolua原理","uid":"56b3f0ea692e4bd7f2a5a1a768e3707f","slug":"zl/2016-01-01-592_tolua原理","date":"2024-04-03T03:47:35.833Z","updated":"2024-04-03T03:47:35.833Z","comments":true,"path":"api/articles/zl/2016-01-01-592_tolua原理.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"tolua++如何将c++对象导入到lua里？lua如何能够访问c++对象成员？创建一个 userdata ，存放 C/C++ 对象指针，然后给 userdata 添加元表，用index 和newindex 元方法映射 C/C++ 中的对象方法。 c++层新建一个元表作为类型（通...","link":"","photos":[],"count_time":{"symbolsCount":"6.8k","symbolsTime":"6 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}