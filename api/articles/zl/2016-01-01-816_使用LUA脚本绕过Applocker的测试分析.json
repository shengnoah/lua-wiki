{"title":"使用LUA脚本绕过Applocker的测试分析","uid":"a29901bd86e6f7143bffe0619b53a12b","slug":"zl/2016-01-01-816_使用LUA脚本绕过Applocker的测试分析","date":"2024-04-03T03:47:36.064Z","updated":"2024-04-03T03:47:36.065Z","comments":true,"path":"api/articles/zl/2016-01-01-816_使用LUA脚本绕过Applocker的测试分析.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<script src=\"assetsjsAPlayer.min.js\"> </script><h2 id=\"0x00-前言\"><a href=\"#0x00-前言\" class=\"headerlink\" title=\"0x00 前言\"></a>0x00 前言</h2><hr/>\n<p>在之前的文章《Bypass Windows AppLocker》曾对绕过Applocker的方法进行过学习，而最近看到一篇文章介绍了使用LUA脚本绕过Applocker的方法，学习之后产生了以下疑问：绕过原理是什么呢？能绕过哪种AppLocker的规则呢？适用条件又是什么呢？</p>\n<p>文章地址：</p>\n<p><a href=\"https://homjxi0e.wordpress.com/2018/03/02/whitelisting-bypassing-using-lua-lanuage-wlua-com/\" target=\"_blank\" rel=\"noopener noreferrer\">https://homjxi0e.wordpress.com/2018/03/02/whitelisting-bypassing-using-lua-lanuage-wlua-com/</a></p>\n<h2 id=\"0x01-简介\"><a href=\"#0x01-简介\" class=\"headerlink\" title=\"0x01 简介\"></a>0x01 简介</h2><hr/>\n<p>本文将要介绍以下内容：</p>\n<ul>\n<li>LUA脚本简介</li>\n<li>绕过测试</li>\n<li>绕过原理</li>\n<li>适用条件</li>\n<li>防御方法</li>\n</ul>\n<h2 id=\"0x02-LUA脚本简介\"><a href=\"#0x02-LUA脚本简介\" class=\"headerlink\" title=\"0x02 LUA脚本简介\"></a>0x02 LUA脚本简介</h2><hr/>\n<ul>\n<li>轻量小巧的脚本语言</li>\n<li>用标准C语言编写</li>\n<li>可以被C/C++ 代码调用</li>\n<li>可以调用C/C++的函数</li>\n<li>在目前所有脚本引擎中的速度最快</li>\n</ul>\n<h2 id=\"0x03-Windows系统下执行LUA脚本\"><a href=\"#0x03-Windows系统下执行LUA脚本\" class=\"headerlink\" title=\"0x03 Windows系统下执行LUA脚本\"></a>0x03 Windows系统下执行LUA脚本</h2><hr/>\n<p>1、安装Lua for Windows，下载地址：</p>\n<p><a href=\"http://files.luaforge.net/releases/luaforwindows/luaforwindows\" target=\"_blank\" rel=\"noopener noreferrer\">http://files.luaforge.net/releases/luaforwindows/luaforwindows</a></p>\n<p>2、输出hello world</p>\n<p>脚本内容：</p>\n<pre><code>print&#34;Hello,world!&#34;\n</code></pre><p>cmd：</p>\n<pre><code>lua.exe 1.txt\n</code></pre><p>如下图</p>\n<p><img src=\"https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-3-6/2-1.png\" alt=\"Alt text\"/></p>\n<p>3、调用Windows API</p>\n<p>脚本内容：</p>\n<pre><code>require &#34;alien&#34;\nMessageBox = alien.User32.MessageBoxA \nMessageBox:types&#123;ret =&#39;long&#39;,abi =&#39;stdcall&#39;,&#39;long&#39;,&#39;string&#39;,&#39;string&#39;,&#39;long&#39;&#125;\nMessageBox(0, &#34;title for test&#34;,&#34;LUA call windows api&#34;,0)\n</code></pre><p>执行如下图</p>\n<p><img src=\"https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-3-6/2-2.png\" alt=\"Alt text\"/></p>\n<p>4、c++执行LUA脚本</p>\n<p>参考代码如下：</p>\n<pre><code>extern &#34;C&#34; &#123;  \n#include &#34;lua.h&#34;    \n#include &lt;lauxlib.h&gt;     \n#include &lt;lualib.h&gt;     \n&#125; \nint main(int argc,char* argv[])\n&#123;\n    lua_State *L =  lua_open();\n    luaL_openlibs(L);\n    luaL_dofile(L, argv[1]);\n    lua_close(L);\n    return 0;\n&#125;\n</code></pre><p>工程需要做如下设置：</p>\n<p>(1)修改<code>VC++ 目录</code></p>\n<p><code>包含目录</code>，添加<code>C:Program FilesLua5.1include</code></p>\n<p><code>库目录</code>，添加<code>C:Program FilesLua5.1lib</code></p>\n<p>(2)<code>链接器</code> - <code>输入</code> - <code>附加依赖项</code>，添加</p>\n<pre><code>lua5.1.lib\nlua51.lib\n</code></pre><p>执行如下图</p>\n<p><img src=\"https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-3-6/3-1.png\" alt=\"Alt text\"/></p>\n<p>c++执行LUA脚本来调用Windows API，需要在同级目录添加支持文件，执行如下图</p>\n<p><img src=\"https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-3-6/3-2.png\" alt=\"Alt text\"/></p>\n<h2 id=\"0x04-测试使用LUA脚本绕过Applocker\"><a href=\"#0x04-测试使用LUA脚本绕过Applocker\" class=\"headerlink\" title=\"0x04 测试使用LUA脚本绕过Applocker\"></a>0x04 测试使用LUA脚本绕过Applocker</h2><hr/>\n<h3 id=\"测试一：\"><a href=\"#测试一：\" class=\"headerlink\" title=\"测试一：\"></a>测试一：</h3><p>测试系统： Win7x86</p>\n<p>安装Lua for Windows</p>\n<p>开启Applocker，配置默认规则</p>\n<p>使用lua.exe执行脚本：</p>\n<p>成功绕过Applocker的拦截</p>\n<p>如下图</p>\n<p><img src=\"https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-3-6/2-3.png\" alt=\"Alt text\"/></p>\n<h3 id=\"测试二：\"><a href=\"#测试二：\" class=\"headerlink\" title=\"测试二：\"></a>测试二：</h3><p>测试系统： Win7x86</p>\n<p>安装Lua for Windows</p>\n<p>开启Applocker，配置默认规则，添加规则： 拦截lua.exe</p>\n<p>未绕过Applocker的拦截</p>\n<p>如下图</p>\n<p><img src=\"https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-3-6/2-4.png\" alt=\"Alt text\"/></p>\n<p><strong>注：</strong></p>\n<p>还可以使用wlua.exe执行lua脚本</p>\n<h3 id=\"测试三：\"><a href=\"#测试三：\" class=\"headerlink\" title=\"测试三：\"></a>测试三：</h3><p>测试系统： Win7x64</p>\n<p>未安装Lua for Windows</p>\n<p>开启Applocker，配置默认规则，系统禁止执行脚本</p>\n<p>lua.exe同级目录放置lua5.1.dll(来自Lua for Windows安装路径)</p>\n<p>使用lua.exe执行脚本：</p>\n<p>未绕过Applocker的拦截</p>\n<p>如下图</p>\n<p><img src=\"https://raw.githubusercontent.com/3gstudent/BlogPic/master/2018-3-6/2-5.png\" alt=\"Alt text\"/></p>\n<p><strong>补充：</strong></p>\n<p>将lua.exe换成wlua.exe，脚本内容修改为POC内容，地址如下：</p>\n<p><a href=\"https://gist.githubusercontent.com/homjxi0e/fd023113bf8b1b6789afa05c3913157c/raw/6bf41cbd76e9df6d6d3edcc9e289191f898451dc/AppLockerBypassing.wlua\" target=\"_blank\" rel=\"noopener noreferrer\">https://gist.githubusercontent.com/homjxi0e/fd023113bf8b1b6789afa05c3913157c/raw/6bf41cbd76e9df6d6d3edcc9e289191f898451dc/AppLockerBypassing.wlua</a></p>\n<p>测试结果均相同</p>\n<h2 id=\"0x05-最终结论\"><a href=\"#0x05-最终结论\" class=\"headerlink\" title=\"0x05 最终结论\"></a>0x05 最终结论</h2><hr/>\n<p>经过以上测试，得出最终结论：</p>\n<p>使用LUA脚本，在一定程序上能绕过Applocker，但需要满足以下条件：</p>\n<ul>\n<li>当前系统已安装Lua for Windows</li>\n<li>Applocker的规则未禁止lua.exe和wlua.exe</li>\n</ul>\n<h2 id=\"0x06-小结\"><a href=\"#0x06-小结\" class=\"headerlink\" title=\"0x06 小结\"></a>0x06 小结</h2><hr/>\n<p>本文对LUA脚本的开发做了简要介绍，测试使用LUA脚本绕过Applocker的POC，得出最终结论</p>\n<hr/>\n<p><a href=\"https://github.com/3gstudent/feedback/issues/new\" target=\"_blank\" rel=\"noopener noreferrer\">LEAVE A REPLY</a></p>\n<p class=\"red-link-context\">\n    <a href=\"a99095d9.html\" rel=\"next\" title=\"利用Assembly Load &amp; LoadFile绕过Applocker的分析总结\">\n    上一篇：利用Assembly Load &amp; LoadFile绕过Applocker的分析总结\n  </a>\n</p>\n<p class=\"red-link-context\">\n    <a href=\"387c4b23.html\" rel=\"next\" title=\"Password Filter DLL在渗透测试中的应用\">\n    下一篇：Password Filter DLL在渗透测试中的应用\n  </a>\n</p>","text":" 0x00 前言 在之前的文章《Bypass Windows AppLocker》曾对绕过Applocker的方法进行过学习，而最近看到一篇文章介绍了使用LUA脚本绕过Applocker的方法，学习之后产生了以下疑问：绕过原理是什么呢？能绕过哪种AppLocker的规则呢？适用条...","link":"","photos":[],"count_time":{"symbolsCount":"2.2k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x00-%E5%89%8D%E8%A8%80\"><span class=\"toc-text\">0x00 前言</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x01-%E7%AE%80%E4%BB%8B\"><span class=\"toc-text\">0x01 简介</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x02-LUA%E8%84%9A%E6%9C%AC%E7%AE%80%E4%BB%8B\"><span class=\"toc-text\">0x02 LUA脚本简介</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x03-Windows%E7%B3%BB%E7%BB%9F%E4%B8%8B%E6%89%A7%E8%A1%8CLUA%E8%84%9A%E6%9C%AC\"><span class=\"toc-text\">0x03 Windows系统下执行LUA脚本</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x04-%E6%B5%8B%E8%AF%95%E4%BD%BF%E7%94%A8LUA%E8%84%9A%E6%9C%AC%E7%BB%95%E8%BF%87Applocker\"><span class=\"toc-text\">0x04 测试使用LUA脚本绕过Applocker</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%B5%8B%E8%AF%95%E4%B8%80%EF%BC%9A\"><span class=\"toc-text\">测试一：</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%B5%8B%E8%AF%95%E4%BA%8C%EF%BC%9A\"><span class=\"toc-text\">测试二：</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%B5%8B%E8%AF%95%E4%B8%89%EF%BC%9A\"><span class=\"toc-text\">测试三：</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x05-%E6%9C%80%E7%BB%88%E7%BB%93%E8%AE%BA\"><span class=\"toc-text\">0x05 最终结论</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x06-%E5%B0%8F%E7%BB%93\"><span class=\"toc-text\">0x06 小结</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Mac上搭建lua环境并连接mysql","uid":"80eaeb4f03e297865aa72cd0ce564033","slug":"zl/2016-01-01-819_Mac上搭建lua环境并连接mysql","date":"2024-04-03T03:47:36.065Z","updated":"2024-04-03T03:47:36.065Z","comments":true,"path":"api/articles/zl/2016-01-01-819_Mac上搭建lua环境并连接mysql.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。(以上摘抄自菜鸟教程) 鉴于Lua的诸多优势，我想在接下来的开发中应用Lua去完成一些需要脚本实现的工作。本文将记录我在Mac上搭建Lu...","link":"","photos":[],"count_time":{"symbolsCount":"2.3k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Lua 学习 chapter25","uid":"750a10f53a4ef67c79f4f67a9f9da4d0","slug":"zl/2016-01-01-815_Lua 学习 chapter25 ","date":"2024-04-03T03:47:36.060Z","updated":"2024-04-03T03:47:36.064Z","comments":true,"path":"api/articles/zl/2016-01-01-815_Lua 学习 chapter25 .json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"目录 自省机制 访问变量 钩子 调优 沙盒 只有疯狂过，你才知道自己究竟能不能成功。 自省机制 通过debug.getinfo(foo)，函数就会返回一个包含该函数有关的一些数据的表。 source: 该字段用于说明函数定义的位置。如果函数定义在一个字符串中（通过调用load），...","link":"","photos":[],"count_time":{"symbolsCount":"2.7k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}