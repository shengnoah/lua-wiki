{"title":"Lua 学习 chapter24","uid":"cf5937e763bc5a1dbfc0ffa5262e9048","slug":"zl/2016-01-01-403_Lua 学习 chapter24 ","date":"2024-04-03T03:47:35.693Z","updated":"2024-04-03T03:47:35.693Z","comments":true,"path":"api/articles/zl/2016-01-01-403_Lua 学习 chapter24 .json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<h3 id=\"目录\">目录</h3>\n<ol>\n  <li>协程</li>\n</ol>\n<blockquote>\n  <p>人人真真的生活过，学习过，改变过，努力过，才能创造出一个满意的自己。</p>\n</blockquote>\n<h2 id=\"协程\">协程</h2>\n<blockquote>\n  <p>协程是一系列的可执行语句，拥有自己的栈、局部变量和指令指针，同时协程又与其他协程共享了全局变量和其他几乎一切资源。线程和协程的主要区别在于，一个线程程序可以并行运行多个线程，而协程却需要彼此协作的运行，即任意指定时刻只能有一个协程运行。</p>\n</blockquote>\n<p>协程相关的函数都在coroutine表中，其中create为创建协程函数，参数为协程要执行的代码函数。它会返回一个thread类型的协程。\n一个协程拥有四种状态：挂起，运行，正常和死亡。\n当一个协程被创建的时候，它处于挂起状态。函数resume用于启动或再次启动一个协程的运行，并将其状态由挂起改为运行。协程函数执行完毕之后进入死亡状态。当使用协程A唤醒协程B的时候，协程A即不是挂起状态（因为不能唤醒协程A），也不是运行状态（因为B正在运行）。所以A此时的状态就被称为正常状态。</p>\n<p>lua语言一个非常有用的机制是通过一对resume-yield来交换数据，第一个resume函数（没有对应等待它的yield）会把所有额外参数传递给协程的主函数。\n在函数resume的返回之中，第一个返回值为true时表示没有错误，之后的返回值对应函数yield的参数。</p>\n<p>可以将唤醒协程的函数放在一个函数中，因为这种模式比较常见，所以lua语言专门提供了一个特殊的函数coroutine函数来完成这个功能。\n当执行wrap中的函数时候，就唤醒协程。</p>\n<div class=\"language-lua highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><table class=\"rouge-table\"><tbody><tr><td class=\"rouge-gutter gl\"><pre class=\"lineno\">1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n</pre></td><td class=\"rouge-code\"><pre><span class=\"n\">co</span> <span class=\"o\">=</span> <span class=\"nb\">coroutine.create</span><span class=\"p\">(</span><span class=\"k\">function</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">,</span> <span class=\"n\">c</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">a</span> <span class=\"o\">+</span> <span class=\"n\">b</span> <span class=\"o\">+</span> <span class=\"n\">c</span>\n<span class=\"k\">end</span><span class=\"p\">)</span>\n<p><span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"nb\">coroutine.resume</span><span class=\"p\">(</span><span class=\"n\">co</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">))</span> <span class=\"c1\">–&gt; true 6。执行状态和结果</span></p>\n<p><span class=\"n\">co</span> <span class=\"o\">=</span> <span class=\"nb\">coroutine.create</span><span class=\"p\">(</span><span class=\"k\">function</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">,</span> <span class=\"n\">c</span><span class=\"p\">)</span><br />\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"nb\">coroutine.yield</span><span class=\"p\">(</span><span class=\"n\">a</span> <span class=\"o\">+</span> <span class=\"n\">b</span><span class=\"p\">,</span> <span class=\"n\">b</span> <span class=\"o\">+</span> <span class=\"n\">c</span><span class=\"p\">))</span> <span class=\"c1\">–2 4 6,返回值是唤醒这个yield的参数值</span><br />\n<span class=\"k\">return</span> <span class=\"n\">a</span> <span class=\"o\">+</span> <span class=\"n\">b</span> <span class=\"o\">+</span> <span class=\"n\">c</span><br />\n<span class=\"k\">end</span><span class=\"p\">)</span></p>\n<p><span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"nb\">coroutine.resume</span><span class=\"p\">(</span><span class=\"n\">co</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">))</span> <span class=\"c1\">– true\t3\t5,返回yield的参数，是最开始传进来的参数</span><br />\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"nb\">coroutine.resume</span><span class=\"p\">(</span><span class=\"n\">co</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">6</span><span class=\"p\">))</span> <span class=\"c1\">– true\t6，返回结果，根据最开始传进来的参数</span><br />\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"nb\">coroutine.resume</span><span class=\"p\">(</span><span class=\"n\">co</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">6</span><span class=\"p\">))</span> <span class=\"c1\">–false\tcannot resume dead coroutine</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">permutations</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">)</span><br />\n<span class=\"k\">return</span> <span class=\"nb\">coroutine.wrap</span><span class=\"p\">(</span><span class=\"k\">function</span><span class=\"p\">()</span> <span class=\"n\">permgen</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">)</span> <span class=\"k\">end</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span><br />\n</pre></td></tr></tbody></table></code></pre></div></div></p>\n<p>生产者与消费者的例子：</p>\n<div class=\"language-lua highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><table class=\"rouge-table\"><tbody><tr><td class=\"rouge-gutter gl\"><pre class=\"lineno\">1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n</pre></td><td class=\"rouge-code\"><pre><span class=\"k\">function</span> <span class=\"nf\">receive</span><span class=\"p\">(</span><span class=\"n\">prod</span><span class=\"p\">)</span>\n    <span class=\"kd\">local</span> <span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"nb\">coroutine.resume</span><span class=\"p\">(</span><span class=\"n\">prod</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">value</span>\n<span class=\"k\">end</span>\n<p><span class=\"k\">function</span> <span class=\"nf\">send</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">)</span><br />\n<span class=\"nb\">coroutine.yield</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">producer</span><span class=\"p\">()</span><br />\n<span class=\"k\">return</span> <span class=\"nb\">coroutine.create</span><span class=\"p\">(</span><span class=\"k\">function</span><span class=\"p\">()</span><br />\n<span class=\"k\">while</span> <span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span> <span class=\"k\">do</span><br />\n<span class=\"kd\">local</span> <span class=\"n\">x</span> <span class=\"o\">=</span> <span class=\"nb\">io.read</span><span class=\"p\">()</span><br />\n<span class=\"n\">send</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span><br />\n<span class=\"k\">end</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">filter</span><span class=\"p\">(</span><span class=\"n\">prod</span><span class=\"p\">)</span><br />\n<span class=\"k\">return</span> <span class=\"nb\">coroutine.create</span><span class=\"p\">(</span><span class=\"k\">function</span><span class=\"p\">()</span><br />\n<span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"nb\">math.huge</span> <span class=\"k\">do</span><br />\n<span class=\"kd\">local</span> <span class=\"n\">x</span> <span class=\"o\">=</span> <span class=\"n\">receive</span><span class=\"p\">(</span><span class=\"n\">prod</span><span class=\"p\">)</span><br />\n<span class=\"n\">x</span> <span class=\"o\">=</span> <span class=\"nb\">string.format</span><span class=\"p\">(</span><span class=\"s2\">&quot;%5d %s&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span><br />\n<span class=\"n\">send</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span><br />\n<span class=\"k\">end</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">consumer</span><span class=\"p\">(</span><span class=\"n\">prod</span><span class=\"p\">)</span><br />\n<span class=\"k\">while</span> <span class=\"kc\">true</span> <span class=\"k\">do</span><br />\n<span class=\"kd\">local</span> <span class=\"n\">x</span> <span class=\"o\">=</span> <span class=\"n\">receive</span><span class=\"p\">(</span><span class=\"n\">prod</span><span class=\"p\">)</span><br />\n<span class=\"nb\">io.write</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"s2\">&quot;</span><span class=\"se\">n</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span><br />\n<span class=\"kd\">local</span> <span class=\"n\">exit</span> <span class=\"o\">=</span> <span class=\"nb\">string.match</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"s2\">&quot;%l+&quot;</span><span class=\"p\">)</span><br />\n<span class=\"k\">if</span> <span class=\"nb\">tostring</span><span class=\"p\">(</span><span class=\"n\">exit</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;q&quot;</span> <span class=\"k\">then</span><br />\n<span class=\"k\">break</span><br />\n<span class=\"k\">end</span><br />\n<span class=\"k\">end</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"n\">consumer</span><span class=\"p\">(</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">producer</span><span class=\"p\">()))</span><br />\n</pre></td></tr></tbody></table></code></pre></div></div></p>\n<pre><code>            &lt;hr style=&quot;visibility: hidden;&quot;/&gt;\n            \n            &lt;hr style=&quot;visibility: hidden;&quot;/&gt;\n</code></pre>\n","text":"目录 协程 人人真真的生活过，学习过，改变过，努力过，才能创造出一个满意的自己。 协程 协程是一系列的可执行语句，拥有自己的栈、局部变量和指令指针，同时协程又与其他协程共享了全局变量和其他几乎一切资源。线程和协程的主要区别在于，一个线程程序可以并行运行多个线程，而协程却需要彼此协...","link":"","photos":[],"count_time":{"symbolsCount":"2.1k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%9B%AE%E5%BD%95\"><span class=\"toc-text\">目录</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8D%8F%E7%A8%8B\"><span class=\"toc-text\">协程</span></a>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Lua源码阅读：虚拟机概述","uid":"ded0ecbc9cc716717b8e535e4c5bec2b","slug":"zl/2016-01-01-405_Lua源码阅读：虚拟机概述","date":"2024-04-03T03:47:35.697Z","updated":"2024-04-03T03:47:35.698Z","comments":true,"path":"api/articles/zl/2016-01-01-405_Lua源码阅读：虚拟机概述.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"Lua 虚拟机的执行过程。 Lua 执行过程概述：解释型脚本语言与编译型语言的区别如下： 由于每个脚本语言都有自己的一套字节码，与具体的硬件平台无关，所以不用修改脚本代码，就能运行在各个平台上。硬件、软件平台的差异都由语言自身的虚拟机解决。 由于脚本语言的字节码需要虚拟机执行，而...","link":"","photos":[],"count_time":{"symbolsCount":"9.4k","symbolsTime":"9 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Lua源码阅读：标准库","uid":"1607a98167353110709d7e74e3d69118","slug":"zl/2016-01-01-404_Lua源码阅读：标准库","date":"2024-04-03T03:47:35.693Z","updated":"2024-04-03T03:47:35.697Z","comments":true,"path":"api/articles/zl/2016-01-01-404_Lua源码阅读：标准库.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"Lua标准库中定义的一些函数及其实现方式。 lmathlib.c从一个简单的math.Abs()函数开始： 12345678910static int (lua_State *L) { if (lua_isinteger(L, 1)) { lua_Integer n = lua_...","link":"","photos":[],"count_time":{"symbolsCount":"1.2k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}