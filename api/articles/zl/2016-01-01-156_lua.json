{"title":"lua","uid":"df60e476b394b1dd4755ec96c53302ff","slug":"zl/2016-01-01-156_lua","date":"2024-04-03T03:47:33.047Z","updated":"2024-04-03T03:47:33.047Z","comments":true,"path":"api/articles/zl/2016-01-01-156_lua.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<head>\n  <meta charset=\"utf-8\"/>\n  <title>lua-coding-style | CloudKey Ocean</title>\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1\"/>\n<pre><code>&lt;meta name=&quot;keywords&quot; content=&quot;lua,&quot;/&gt;\n</code></pre>\n<p><meta name=\"description\" content=\"命名规范：\n文件名：  首字母大写驼峰型（第一个单词首字母也大写）\n常量：    由字母、数字、 构成，字母全大写，首字母必须为字母，单词之间使用”“相连\n函数名：  由字母、数字、 构成，字母全小写，首字母必须为字母，单词之间使用”“相连\n局部变量：由字母、数字、 构成，字母全小写，首字母必须为字母，单词之间使用”“相连\n全局变量：由字母、数字、 构成，字母全小写，必须为”g“开头，单词之间使用\"/><br />\n<meta property=\"og:type\" content=\"article\"/><br />\n<meta property=\"og:title\" content=\"lua-coding-style\"/><br />\n<meta property=\"og:url\" content=\"http://cloudkey.github.io/2015/11/15/lua-coding-style/index.html\"/><br />\n<meta property=\"og:site_name\" content=\"CloudKey Ocean\"/><br />\n<meta property=\"og:description\" content=\"命名规范：\n文件名：  首字母大写驼峰型（第一个单词首字母也大写）\n常量：    由字母、数字、 构成，字母全大写，首字母必须为字母，单词之间使用”“相连\n函数名：  由字母、数字、 构成，字母全小写，首字母必须为字母，单词之间使用”“相连\n局部变量：由字母、数字、 构成，字母全小写，首字母必须为字母，单词之间使用”“相连\n全局变量：由字母、数字、 构成，字母全小写，必须为”g“开头，单词之间使用\"/><br />\n<meta property=\"og:updated_time\" content=\"2017-01-21T12:16:32.000Z\"/><br />\n<meta name=\"twitter:card\" content=\"summary\"/><br />\n<meta name=\"twitter:title\" content=\"lua-coding-style\"/><br />\n<meta name=\"twitter:description\" content=\"命名规范：\n文件名：  首字母大写驼峰型（第一个单词首字母也大写）\n常量：    由字母、数字、 构成，字母全大写，首字母必须为字母，单词之间使用”“相连\n函数名：  由字母、数字、 构成，字母全小写，首字母必须为字母，单词之间使用”“相连\n局部变量：由字母、数字、 构成，字母全小写，首字母必须为字母，单词之间使用”“相连\n全局变量：由字母、数字、 构成，字母全小写，必须为”g“开头，单词之间使用\"/></p>\n<pre><code>&lt;link rel=&quot;icon&quot; href=&quot;/favicon.ico&quot;/&gt;\n</code></pre>\n  <link href=\"/css/styles.css?v=c114cbe6\" rel=\"stylesheet\"/>\n<pre><code>&lt;link rel=&quot;stylesheet&quot; href=&quot;/css/personal-style.css&quot;/&gt;\n</code></pre>\n<script type=\"text/javascript\">\n(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){\n(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),\nm=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)\n})(window,document,'script','//www.google-analytics.com/analytics.js','ga');\n\nga('create', 'UA-56303271-1', 'auto');\nga('send', 'pageview');\n\n</script>\n<pre><code>&lt;script async=&quot;&quot; src=&quot;https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js&quot;&gt;&lt;/script&gt;\n</code></pre>\n</head>\n<body>\n<pre><code>&lt;span id=&quot;toolbox-mobile&quot; class=&quot;toolbox-mobile&quot;&gt;盒子&lt;/span&gt;\n</code></pre>\n  <div class=\"post-header CENTER\">\n  <div class=\"toolbox\">\n    <a class=\"toolbox-entry\" href=\"/\">\n      <span class=\"toolbox-entry-text\">盒子</span>\n      <i class=\"icon-angle-down\"></i>\n      <i class=\"icon-home\"></i>\n    </a>\n    <ul class=\"list-toolbox\">\n<pre><code>    &lt;li class=&quot;item-toolbox&quot;&gt;\n      &lt;a class=&quot;ROUND_RECT&quot; href=&quot;/archives/&quot; rel=&quot;noopener noreferrer&quot; target=&quot;_self&quot;&gt;\n        博客\n      &lt;/a&gt;\n    &lt;/li&gt;\n  \n    &lt;li class=&quot;item-toolbox&quot;&gt;\n      &lt;a class=&quot;ROUND_RECT&quot; href=&quot;/category/&quot; rel=&quot;noopener noreferrer&quot; target=&quot;_self&quot;&gt;\n        分类\n      &lt;/a&gt;\n    &lt;/li&gt;\n  \n    &lt;li class=&quot;item-toolbox&quot;&gt;\n      &lt;a class=&quot;ROUND_RECT&quot; href=&quot;/tag/&quot; rel=&quot;noopener noreferrer&quot; target=&quot;_self&quot;&gt;\n        标签\n      &lt;/a&gt;\n    &lt;/li&gt;\n  \n    &lt;li class=&quot;item-toolbox&quot;&gt;\n      &lt;a class=&quot;ROUND_RECT&quot; href=&quot;/link/&quot; rel=&quot;noopener noreferrer&quot; target=&quot;_self&quot;&gt;\n        友链\n      &lt;/a&gt;\n    &lt;/li&gt;\n  \n    &lt;li class=&quot;item-toolbox&quot;&gt;\n      &lt;a class=&quot;ROUND_RECT&quot; href=&quot;/about/&quot; rel=&quot;noopener noreferrer&quot; target=&quot;_self&quot;&gt;\n        关于\n      &lt;/a&gt;\n    &lt;/li&gt;\n  \n    &lt;li class=&quot;item-toolbox&quot;&gt;\n      &lt;a class=&quot;ROUND_RECT&quot; href=&quot;/atom.xml&quot; rel=&quot;noopener noreferrer&quot; target=&quot;_blank&quot;&gt;\n        RSS\n      &lt;/a&gt;\n    &lt;/li&gt;\n  \n    &lt;li class=&quot;item-toolbox&quot;&gt;\n      &lt;a class=&quot;ROUND_RECT&quot; href=&quot;/search/&quot; rel=&quot;noopener noreferrer&quot; target=&quot;_self&quot;&gt;\n        搜索\n      &lt;/a&gt;\n    &lt;/li&gt;\n  \n&lt;/ul&gt;\n</code></pre>\n  </div>\n</div>\n  <div id=\"toc\" class=\"toc-article\">\n    <strong class=\"toc-title\">文章目录</strong>\n  </div>\n<div class=\"content content-post CENTER\">\n   <article id=\"post-lua-coding-style\" class=\"article article-type-post\" itemprop=\"blogPost\">\n  <div class=\"article-content\">\n<pre><code>  &lt;h2 id=&quot;命名规范：&quot;&gt;&lt;a href=&quot;#命名规范：&quot; class=&quot;headerlink&quot; title=&quot;命名规范：&quot;&gt;&lt;/a&gt;命名规范：&lt;/h2&gt;&lt;ul&gt;\n</code></pre>\n<li>文件名：  首字母大写驼峰型（第一个单词首字母也大写）</li>\n<li>常量：    由字母、数字、<em> 构成，字母全大写，首字母必须为字母，单词之间使用”</em>“相连</li>\n<li>函数名：  由字母、数字、<em> 构成，字母全小写，首字母必须为字母，单词之间使用”</em>“相连</li>\n<li>局部变量：由字母、数字、<em> 构成，字母全小写，首字母必须为字母，单词之间使用”</em>“相连</li>\n<li>全局变量：由字母、数字、<em> 构成，字母全小写，必须为”g</em>“开头，单词之间使用”_”相连，最好不用全局变量</li>\n<li>配置变量：由字母、数字、<em> 构成，由”Conf</em>“开头，单词首字母大写，单词之间使用”_”相连</li>\n</ul>\n<h2 id=\"代码组织：\"><a href=\"#代码组织：\" class=\"headerlink\" title=\"代码组织：\"></a>代码组织：</h2><ul>\n<li><p>文件开头加上功能描述；每个文件都加module限定词；导入的模块都加local限定词</p>\n</li>\n<li><p>所有函数都加注释：</p>\n<blockquote>\n<p>函数功能： @brief xxx<br/>param描述：@param xxx<br/>return：   @return xxx </p>\n</blockquote>\n</li>\n<li><p>合理的空行：函数之间、函数内部代码块之间</p>\n</li>\n<li><p>注释格式：单行注释使用”–”；多行注释使用–[[]]，其中在”]]”前面加”–”，如果要取消注释，只用在”–[[“前再加一个”-“就行</p>\n</li>\n<li><p>常量、消息号、枚举值行末都加上分号 ——？</p>\n</li>\n<li><p>函数内的临时变量、文件内的局部函数都加上 local 限定词</p>\n</li>\n<li><p>函数内部代码块尽量加注释</p>\n</li>\n<li><p>单个函数较长时（大于100行），尽量拆分成多个子函数</p>\n</li>\n<li><p>assert 函数开销不小，请慎用</p>\n</li>\n<li><p>lua类设计时，用元表来实现oop </p>\n<blockquote>\n<p>不要直接增加函数成员，因为直接增加函数成员会导致内存增加，并且在jit下执行效率和用元表方式无差异</p>\n</blockquote>\n</li>\n<li><p>空格符：</p>\n<blockquote>\n<p>运算符之间，如 s = a + b<br/>参数列表或数组元素之间，如 fuction my_sum(a, b)，{1, 2, 3}<br/>注意：函数参数列表中，左括号与第一个参数之间、右括号与最后一个参数之间，都不要加空格</p>\n</blockquote>\n</li>\n<li><p>单行超过80字符时，应该换行</p>\n<blockquote>\n<p>函数参数换行时，下一行与上一行的第一个参数对齐</p>\n</blockquote>\n</li>\n<li><p>运算较复杂时，使用小括号分割每个运算逻辑，增加可读性，同时避免运算符优先级顺序问题</p>\n</li>\n<li><p>4字符缩进</p>\n</li>\n<li><p>日志：</p>\n<blockquote>\n<p>1.明确的日志级别<br/>2.每个异常处必须有日志（warning、error）说明异常原因<br/>3.日志必须传一个参数，可以是string和table，如果是string，最好为[key:value]形式；如果是table，日志库会自动转成[key:value]形式，且第一个key为message(如果存在) </p>\n</blockquote>\n</li>\n<li><p>尽量减少表中的成员是另一个表的引用 ——？</p>\n</li>\n<li><p>取table的长度用#，不用table.getn</p>\n</li>\n<li><p>当table中的key是纯数字(不一定有序)的时候,求table长度不可以用#(错误),可以用Utils.tableCount(pairs遍历)函数;<br/>相同场景,打印table的内容,用Utils.simple_var_dump(table.concat实现);<br/>按照key大小顺序遍历的话,用pairsByKeys(this function get from [Programming In Lua])获取迭代器</p>\n</li>\n<li><p>尽量避免magic number</p>\n</li>\n</ul>\n<h2 id=\"lua的全局变量问题\"><a href=\"#lua的全局变量问题\" class=\"headerlink\" title=\"lua的全局变量问题\"></a>lua的全局变量问题</h2><ul>\n<li><p>之前使用ngx-lua实现一个类似proxy的项目时，发现使用长连接机制会导致 请求错乱(不同的连接数据发生混乱)的现象，经追查发现lua中全局变量使用如果不当会导致一些未可知的异常情况。</p>\n<blockquote>\n<p>类似的也有其他同学遇到过相似的困扰：</p>\n  <figure class=\"highlight lua\"><table><tbody><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">https://github.com/openresty/lua-nginx-<span class=\"built_in\">module</span>/issues/<span class=\"number\">150</span></div><div class=\"line\">http://wiki.nginx.org/HttpLuaModule#Data_Sharing_within_an_Nginx_Worker</div><div class=\"line\">http://zacharyhu.org/?p=<span class=\"number\">373</span></div></pre></td></tr></tbody></table></figure>\n<p>解决方案：<br/>  在用 ngx-releng 脚本check代码全量global变量之后，将所有global更改为local；同时对长连接建立失败或者读写超时的连接，进行close connection的处理。经验证上线之后数据错乱问题不再复现。</p>\n</blockquote>\n</li>\n<li>所以建议对自己的代码用ngx-releng脚本进行check，尽量使用local变量。</li>\n</ul>\n  </div>\n</article>\n  <div class=\"box-prev-next clearfix\">\n    <a class=\"show pull-left\" href=\"/2015/11/10/saucony-feel/\">\n<pre><code>&lt;/a&gt;\n</code></pre>\n  </div>\n</div>\n  <a id=\"backTop\" class=\"back-top\">\n    <i class=\"icon-angle-up\"></i>\n  </a>\n  <div class=\"modal\" id=\"modal\">\n  <span id=\"cover\" class=\"cover hide\"></span>\n  <div id=\"modal-dialog\" class=\"modal-dialog hide-dialog\">\n    <div class=\"modal-header\">\n      <span id=\"close\" class=\"btn-close\">关闭</span>\n    </div>\n    <hr/>\n  </div>\n</div>\n<pre><code>  &lt;div class=&quot;fexo-comments comments-post&quot;&gt;\n</code></pre>\n  <section class=\"disqus-comments\">\n  </section>\n  <script>\n    var disqus_shortname = 'cloudkey';\n    \n    var disqus_url = 'http://cloudkey.github.io/2015/11/15/lua-coding-style/';\n    \n    (function(){\n      var dsq = document.createElement('script');\n      dsq.type = 'text/javascript';\n      dsq.async = true;\n      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';\n      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);\n    })();\n  </script>\n  <script id=\"dsq-count-scr\" src=\"//cloudkey.disqus.com/count.js\" async=\"\"></script>\n  </div>\n  <script type=\"text/javascript\">\n  function loadScript(url, callback) {\n    var script = document.createElement('script')\n    script.type = 'text/javascript';\n\n    if (script.readyState) { //IE\n      script.onreadystatechange = function() {\n        if (script.readyState == 'loaded' ||\n          script.readyState == 'complete') {\n          script.onreadystatechange = null;\n          callback();\n        }\n      };\n    } else { //Others\n      script.onload = function() {\n        callback();\n      };\n    }\n\n    script.src = url;\n    document.getElementsByTagName('head')[0].appendChild(script);\n  }\n\n  window.onload = function() {\n    loadScript('/js/bundle.js?235683', function() {\n      // load success\n    });\n  }\n</script>\n</body>","text":" lua-coding-style | CloudKey Ocean &lt;meta name=&quot;keywords&quot; content=&quot;lua,&quot;/&gt; &lt;link rel=&quot;icon&quot; href=&quot...","link":"","photos":[],"count_time":{"symbolsCount":"5.7k","symbolsTime":"5 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87%EF%BC%9A\"><span class=\"toc-text\">代码组织：</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#lua%E7%9A%84%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E9%97%AE%E9%A2%98\"><span class=\"toc-text\">lua的全局变量问题</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"lua开发环境搭建","uid":"17aead462ca72ddeaf2b3a3c42d496ca","slug":"zl/2016-01-01-155_lua开发环境搭建","date":"2024-04-03T03:47:33.047Z","updated":"2024-04-03T03:47:33.047Z","comments":true,"path":"api/articles/zl/2016-01-01-155_lua开发环境搭建.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"Lua的官方网站：www.lua.orgwin下lua源码编译：进入源码src目录下，执行make mingw（前提已经安装了MinGW） -lua直接执行脚本文件 lua file_name -lua将脚本文件编译成字节码文件 luac -o out_fil file_name...","link":"","photos":[],"count_time":{"symbolsCount":340,"symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"UtraEdit 支持Lua高亮","uid":"8ceb0c7065c3ad0a13f5f37e6d9d02b4","slug":"zl/2016-01-01-157_UtraEdit 支持Lua高亮","date":"2024-04-03T03:47:33.047Z","updated":"2024-04-03T03:47:33.050Z","comments":true,"path":"api/articles/zl/2016-01-01-157_UtraEdit 支持Lua高亮.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"UtraEdit 支持Lua高亮，网上已经有很多方法，但是都是基于相对老一点的 UE，在15.10版本中，UE支持Lua高亮的方法如下： 从网上Down下支持Lua的wordfiles，lua.uew 新建一个目录如D:wordfiles， 将UE安装目录下的所有wordfile...","link":"","photos":[],"count_time":{"symbolsCount":"2.9k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}