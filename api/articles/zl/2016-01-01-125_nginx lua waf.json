{"title":"nginx lua waf","uid":"b7629b20ac900d8f1fafabf105306db6","slug":"zl/2016-01-01-125_nginx lua waf","date":"2024-04-03T03:47:33.031Z","updated":"2024-04-03T03:47:33.031Z","comments":true,"path":"api/articles/zl/2016-01-01-125_nginx lua waf.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<h2 id=\"ngx-lua-waf是一个基于lua-nginx-module-openresty-的web应用防火墙\"><a href=\"#ngx-lua-waf是一个基于lua-nginx-module-openresty-的web应用防火墙\" class=\"headerlink\" title=\"ngx_lua_waf是一个基于lua-nginx-module(openresty)的web应用防火墙\"></a><a href=\"https://github.com/loveshell/ngx_lua_waf\" target=\"_blank\" rel=\"external noopener noreferrer\">ngx_lua_waf是一个基于lua-nginx-module(openresty)的web应用防火墙</a></h2><p>###用途：</p>\n<pre><code>防止sql注入，本地包含，部分溢出，fuzzing测试，xss,SSRF等web攻击\n防止svn/备份之类文件泄漏\n防止ApacheBench之类压力测试工具的攻击\n屏蔽常见的扫描黑客工具，扫描器\n屏蔽异常的网络请求\n屏蔽图片附件类目录php执行权限\n防止webshell上传\n</code></pre><p>###推荐安装:</p>\n<p>推荐使用lujit2.1做lua支持</p>\n<p>ngx_lua如果是0.9.2以上版本，建议正则过滤函数改为ngx.re.find，匹配效率会提高三倍左右。</p>\n<p>###使用说明：</p>\n<p>nginx安装路径假设为:/usr/local/nginx/conf/</p>\n<p>把ngx_lua_waf下载到conf目录下,解压命名为waf</p>\n<p>在nginx.conf的http段添加</p>\n<pre><code>lua_package_path &#34;/usr/local/nginx/conf/waf/?.lua&#34;;\nlua_shared_dict limit 10m;\ninit_by_lua_file  /usr/local/nginx/conf/waf/init.lua; \naccess_by_lua_file /usr/local/nginx/conf/waf/waf.lua;\n</code></pre><p>配置config.lua里的waf规则目录(一般在waf/conf/目录下)</p>\n<pre><code>RulePath = &#34;/usr/local/nginx/conf/waf/wafconf/&#34;\n</code></pre><p>绝对路径如有变动，需对应修改</p>\n<p>然后重启nginx即可</p>\n<p>###配置文件详细说明：</p>\n<pre><code>RulePath = &#34;/usr/local/nginx/conf/waf/wafconf/&#34;\n--规则存放目录\nattacklog = &#34;off&#34;\n--是否开启攻击信息记录，需要配置logdir\nlogdir = &#34;/usr/local/nginx/logs/hack/&#34;\n--log存储目录，该目录需要用户自己新建，切需要nginx用户的可写权限\nUrlDeny=&#34;on&#34;\n--是否拦截url访问\nRedirect=&#34;on&#34;\n--是否拦截后重定向\nCookieMatch = &#34;on&#34;\n--是否拦截cookie攻击\npostMatch = &#34;on&#34; \n--是否拦截post攻击\nwhiteModule = &#34;on&#34; \n--是否开启URL白名单\nblack_fileExt=&#123;&#34;php&#34;,&#34;jsp&#34;&#125;\n--填写不允许上传文件后缀类型\nipWhitelist=&#123;&#34;127.0.0.1&#34;&#125;\n--ip白名单，多个ip用逗号分隔\nipBlocklist=&#123;&#34;1.0.0.1&#34;&#125;\n--ip黑名单，多个ip用逗号分隔\nCCDeny=&#34;on&#34;\n--是否开启拦截cc攻击(需要nginx.conf的http段增加lua_shared_dict limit 10m;)\nCCrate = &#34;100/60&#34;\n--设置cc攻击频率，单位为秒.\n--默认1分钟同一个IP只能请求同一个地址100次\nhtml=[[Please go away~~]]\n--警告内容,可在中括号内自定义\n备注:不要乱动双引号，区分大小写\n</code></pre><p>###检查规则是否生效</p>\n<p>部署完毕可以尝试如下命令：        </p>\n<pre><code>curl http://xxxx/test.php?id=../etc/passwd\n返回&#34;Please go away~~&#34;字样，说明规则生效。\n</code></pre><p>注意:默认，本机在白名单不过滤，可自行调整config.lua配置</p>\n<p>###效果图如下：</p>\n<p><img src=\"https://himle.github.io/images/nginx-lua-waf.png\" alt=\"sec\"/></p>\n<p>###规则更新：</p>\n<p>考虑到正则的缓存问题，动态规则会影响性能，所以暂没用共享内存字典和redis之类东西做动态管理。</p>\n<p>规则更新可以把规则文件放置到其他服务器，通过crontab任务定时下载来更新规则，nginx reload即可生效。以保障ngx lua waf的高性能。</p>\n<p>只记录过滤日志，不开启过滤，在代码里在check前面加上–注释即可，如果需要过滤，反之</p>\n<p>###一些说明：</p>\n<pre><code>过滤规则在wafconf下，可根据需求自行调整，每条规则需换行,或者用|分割\n<pre><code>args里面的规则get参数进行过滤的\nurl是只在get请求url过滤的规则        \npost是只在post请求过滤的规则        \nwhitelist是白名单，里面的url匹配到不做过滤        \nuser-agent是对user-agent的过滤规则\n</code></pre>\n<p>默认开启了get和post过滤，需要开启cookie过滤的，编辑waf.lua取消部分–注释即可</p>\n<p>日志文件名称格式如下:虚拟主机名_sec.log<br />\n</code></pre></p>\n","text":"ngx_lua_waf是一个基于lua-nginx-module(openresty)的web应用防火墙###用途： 防止sql注入，本地包含，部分溢出，fuzzing测试，xss,SSRF等web攻击 防止svn/备份之类文件泄漏 防止ApacheBench之类压力测试工具的攻...","link":"","photos":[],"count_time":{"symbolsCount":"2.1k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#ngx-lua-waf%E6%98%AF%E4%B8%80%E4%B8%AA%E5%9F%BA%E4%BA%8Elua-nginx-module-openresty-%E7%9A%84web%E5%BA%94%E7%94%A8%E9%98%B2%E7%81%AB%E5%A2%99\"><span class=\"toc-text\">ngx_lua_waf是一个基于lua-nginx-module(openresty)的web应用防火墙</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Table内部实现","uid":"3923f57b9545e582cf01153ed3469253","slug":"zl/2016-01-01-129_[Lua] Table内部实现","date":"2024-04-03T03:47:33.032Z","updated":"2024-04-03T03:47:33.032Z","comments":true,"path":"api/articles/zl/2016-01-01-129_[Lua] Table内部实现.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"Table 结构定义 Lua 的Table是由数组、哈希表一起实现的。 所以如果不清楚哈希表，建议先看看哈希表。 http://mdgsf.github.io/c/2016/07/01/c-hashtable.html typedef unsigned char lu_byte;...","link":"","photos":[],"count_time":{"symbolsCount":"9.5k","symbolsTime":"9 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"spark rdd, pipeline, lazyevaluation","uid":"dee1c28d2a4573e95dc2faf24be94678","slug":"zl/2016-01-01-126_spark rdd, pipeline, lazyevaluation","date":"2024-04-03T03:47:33.031Z","updated":"2024-04-03T03:47:33.031Z","comments":true,"path":"api/articles/zl/2016-01-01-126_spark rdd, pipeline, lazyevaluation.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"一直以来写代码不求甚解，感觉这样不好，从今天开始起读各数据框架的源代码，学习学习再学习 今天看的是pyspark里lazy evaluation的处理，python和scala不同不是函数式的。那这是怎么办到的呢？ 首先所有的数据集在spark内部都叫做rdd，这在pyspark...","link":"","photos":[],"count_time":{"symbolsCount":"5.2k","symbolsTime":"5 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}