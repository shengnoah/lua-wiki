{"title":"LUAWAF","uid":"8733a9f0389c2b32eac15c996ea8e211","slug":"zl/2016-01-01-728_LUAWAF","date":"2024-04-03T03:47:35.970Z","updated":"2024-04-03T03:47:35.971Z","comments":true,"path":"api/articles/zl/2016-01-01-728_LUAWAF.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<h2 id=\"LUAWAF\"><a href=\"#LUAWAF\" class=\"headerlink\" title=\"LUAWAF\"></a>LUAWAF</h2><p><a href=\"https://github.com/MissError/WAF\" target=\"_blank\" rel=\"noopener noreferrer\">LUAWAF</a>是我编写的一个针对Nginx的Web应用提供安全防护的Web应用防火墙。</p>\n<h2 id=\"支持平台\"><a href=\"#支持平台\" class=\"headerlink\" title=\"支持平台\"></a>支持平台</h2><p>目前<a href=\"https://github.com/MissError/WAF\" target=\"_blank\" rel=\"noopener noreferrer\">WAF</a>只支持Windows平台</p>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>1，使用本软件最好直接在OpenResty官网下载OpenResty，OpenResty自身带有Nginx</p>\n<p>2，将该<a href=\"https://github.com/MissError/WAF\" target=\"_blank\" rel=\"noopener noreferrer\">WAF</a>下载到OpenResty的lua目录下，解压即可</p>\n<p>3，日志读写的文件必须给与相应的权限</p>\n<h2 id=\"使用说明\"><a href=\"#使用说明\" class=\"headerlink\" title=\"使用说明\"></a>使用说明</h2><p>1，需要在nginx.conf文件中包含WAF解压出来的conf中的waf.conf文件</p>\n<p>2，需要在waf/conf路径下的config.lua文件中修改日志存储位置以及规则存储位置</p>\n<h2 id=\"配置说明\"><a href=\"#配置说明\" class=\"headerlink\" title=\"配置说明\"></a>配置说明</h2><pre><code>是否开启白名单IP检查\n_M.IPWhiteCheck = &#34;on&#34;\n<p>是否开启黑名单IP检查<br />\n_M.IPBlockCheck = &quot;on&quot;</p>\n<p>是否开启白名单URl检查<br />\n_M.WhiteUrlCheck = &quot;on&quot;</p>\n<p>是否开启黑名单URl检查<br />\n_M.BlockUrlCheck = &quot;on&quot;</p>\n<p>是否开启参数检查<br />\n_M.ArgCheck = &quot;on&quot;</p>\n<p>是否开启useragent检查<br />\n_M.UserAgentCheck = &quot;on&quot;</p>\n<p>是否开启cookie检查<br />\n_M.CookieCheck = &quot;on&quot;</p>\n<p>是否开启CC攻击防御<br />\n_M.CCDenyCheck = &quot;on&quot;</p>\n<p>是否开启POST上传检查<br />\n_M.PostCheck = &quot;on&quot;</p>\n<p>CC攻击的速率（次数/秒）<br />\n_M.CCRate = &quot;100/60&quot;</p>\n<p>IP访问的速率（次数/秒）<br />\n_M.Count = &quot;100/60&quot;</p>\n<p>是否开启日志记录<br />\n_M.LogCheck = &quot;on&quot;</p>\n<p>疑似对攻击网站的行为的封禁时间(单位：秒)<br />\n_M.BlockTime = &quot;1800&quot;</p>\n<p>是否开启错误页面重定向<br />\n_M.Redirect = &quot;on&quot;</p>\n<p>是否开启某些关键路径只有某些IP可以访问<br />\n_M.AccessControl = &quot;on&quot;</p>\n<p>是否开启XSS检测<br />\n_M.XSSCheck = &quot;on&quot;</p>\n<p>是否开启数据库存储<br />\n_M.MysqlLog = &quot;on&quot;<br />\n</code></pre><p>以上处于waf/conf/config.lua配置文件中，若是配置文件中问on的表示该功能启用，网站禁止访问时间以秒为单位，可以根据自己的需求进行设置，同样的检测CC攻击和IP访问频率也可以根据（次数/秒）设置</p></p>\n<h2 id=\"规则说明\"><a href=\"#规则说明\" class=\"headerlink\" title=\"规则说明\"></a>规则说明</h2><p>LUAWAF采用的匹配规则大部分是<a href=\"https://github.com/SpiderLabs/owasp-modsecurity-crs\" target=\"_blank\" rel=\"noopener noreferrer\">OWASP ModSecurity Core Rule Set (CRS) Project (Official Repository) </a>中的规则，同时还借鉴了<a href=\"https://github.com/loveshell/ngx_lua_waf\" target=\"_blank\" rel=\"noopener noreferrer\">@loveshell</a>的ngx_lua_waf中的规则</p>\n<pre><code>规则配置文件在waf/rule文件夹下\n<p>args.rulel里面的规则用于GET请求时检查参数和参数名是否正确<br />\nblock.rule里面的规则用于检测GET请求时用户访问的URL是否是敏感信息<br />\ncookies.rule里面的规则用于检测在请求头中的cookie是否包含的扫描器特征值<br />\nfilenameExt.rule里面的规则用于检测上传的文件扩展名是否合法<br />\nIPBlocklist.rule里面的规则是禁止访问的IP<br />\nIPWhitelist.rule里面的规则是可以不需要进行权限控制和黑名单检测的IP<br />\nmanage_IP.json里面的规则用于权限管理检测<br />\npost.rule里面的规则用于检测POST请求中的数据<br />\nuseragents.rule里面的规则用于检测在请求头中的useragent是否包含的扫描器特征值<br />\nWhite.rule里面的规则不需要进行过滤<br />\nxss.rule里面的规则用于检测XSS攻击</p>\n<p>默认开启了WAF的所有功能，若是需要关掉某些功能，只需要在access.lua文件中使用“–”对相应的功能注释<br />\n</code></pre><h2 id=\"日志记录\"><a href=\"#日志记录\" class=\"headerlink\" title=\"日志记录\"></a>日志记录</h2><pre><code>日志记录提供两种方式：本地日志记录和数据库记录</p>\n<p>本地日志记录的日志文件名称格式如下:虚拟主机名_sec.log<br />\n本地日志记录的日志文件中的数据以JSON格式存储，方便Web应用管理员通过日志对Web的日志进行分析</p>\n<p>数据库记录需要手动建立一个waflog的数据库，并且需要在config.lua文件中配置数据库的相关配置<br />\n</code></pre><h3 id=\"本地日志记录结果：\"><a href=\"#本地日志记录结果：\" class=\"headerlink\" title=\"本地日志记录结果：\"></a>本地日志记录结果：</h3><p><img src=\"https://i.loli.net/2018/10/23/5bced6ad06817.jpg\" alt=\"22190235.jpg\"/></p></p>\n<h3 id=\"数据库记录结果：\"><a href=\"#数据库记录结果：\" class=\"headerlink\" title=\"数据库记录结果：\"></a>数据库记录结果：</h3><p><img src=\"https://i.loli.net/2018/10/23/5bced6d3a9c50.jpg\" alt=\"20330746.jpg\"/></p>\n<h2 id=\"WAF的功能\"><a href=\"#WAF的功能\" class=\"headerlink\" title=\"WAF的功能\"></a>WAF的功能</h2><pre><code>防御sql注入，xss等web攻击\n防止svn、数据库和网站备份等敏感信息文件泄漏\n防止ApacheBench之类压力测试工具的攻击\n屏蔽常见像SQLMAP、netsparkerd等黑客扫描工具\n屏蔽异常的网络请求\n禁止图片附件类目录php执行权限\n防止webshell上传\n提供对HTTP请求头中的useragent、cookie和referrer进行检测\n提供对Web应用后台只允许特定的IP进行访问\n</code></pre><h2 id=\"感谢\"><a href=\"#感谢\" class=\"headerlink\" title=\"感谢\"></a>感谢</h2><p>感谢OpenResty的开发者<a href=\"https://github.com/agentzh/\" target=\"_blank\" rel=\"noopener noreferrer\">@agentzh</a></p>\n<p>LUAWAF感谢<a href=\"https://github.com/loveshell/ngx_lua_waf\" target=\"_blank\" rel=\"noopener noreferrer\">@loveshell</a>的ngx_lua_waf所提供的思路</p>","text":"LUAWAFLUAWAF是我编写的一个针对Nginx的Web应用提供安全防护的Web应用防火墙。 支持平台目前WAF只支持Windows平台 安装1，使用本软件最好直接在OpenResty官网下载OpenResty，OpenResty自身带有Nginx 2，将该WAF下载到Ope...","link":"","photos":[],"count_time":{"symbolsCount":"2.2k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#LUAWAF\"><span class=\"toc-text\">LUAWAF</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%94%AF%E6%8C%81%E5%B9%B3%E5%8F%B0\"><span class=\"toc-text\">支持平台</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85\"><span class=\"toc-text\">安装</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E\"><span class=\"toc-text\">使用说明</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E\"><span class=\"toc-text\">配置说明</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%A7%84%E5%88%99%E8%AF%B4%E6%98%8E\"><span class=\"toc-text\">规则说明</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95\"><span class=\"toc-text\">日志记录</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%9C%AC%E5%9C%B0%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E7%BB%93%E6%9E%9C%EF%BC%9A\"><span class=\"toc-text\">本地日志记录结果：</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%B0%E5%BD%95%E7%BB%93%E6%9E%9C%EF%BC%9A\"><span class=\"toc-text\">数据库记录结果：</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#WAF%E7%9A%84%E5%8A%9F%E8%83%BD\"><span class=\"toc-text\">WAF的功能</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%84%9F%E8%B0%A2\"><span class=\"toc-text\">感谢</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"nginx编译安装lua模块","uid":"eb06e9f2ad672616c91271c05869f3c6","slug":"zl/2016-01-01-729_nginx编译安装lua模块","date":"2024-04-03T03:47:35.971Z","updated":"2024-04-03T03:47:35.972Z","comments":true,"path":"api/articles/zl/2016-01-01-729_nginx编译安装lua模块.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"1. 获取nginx源代码1git clone https://github.com/nginx/nginx.git nginx-release 2. 下载安装LuaJIT1234git clone https://github.com/LuaJIT/LuaJIT.gitcd L...","link":"","photos":[],"count_time":{"symbolsCount":"1.1k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"lua简明教程","uid":"3dd51d89d6a793aade0255d4266d1794","slug":"zl/2016-01-01-727_lua简明教程","date":"2024-04-03T03:47:35.965Z","updated":"2024-04-03T03:47:35.970Z","comments":true,"path":"api/articles/zl/2016-01-01-727_lua简明教程.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"前言lua是一种轻量小巧的脚本语言。 lua特性1.轻量级，编译后不过200K2.可扩展性3.自动内存管理4.支持面向过程编程和函数式编程…… lua应用场景1.游戏开发2.独立应用脚本3.web应用脚本4.扩展和数据库插件5.安全系统 安装使用安装问题1.编译lua时，提示1l...","link":"","photos":[],"count_time":{"symbolsCount":"2.2k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}