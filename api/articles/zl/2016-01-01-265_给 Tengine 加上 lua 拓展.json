{"title":"给 Tengine 加上 lua 拓展","uid":"6224a2d92b8e1402c742058a9d03bd16","slug":"zl/2016-01-01-265_给 Tengine 加上 lua 拓展","date":"2024-04-03T03:47:33.128Z","updated":"2024-04-03T03:47:33.129Z","comments":true,"path":"api/articles/zl/2016-01-01-265_给 Tengine 加上 lua 拓展.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<pre><code>    &lt;p&gt;Tengine 能动态加载第三方模块，成为我们青睐的选择，我们可以编译动态链接文档，而不需要重新安装 Nginx, 这对在线增强 webservice 很有帮助.&lt;br&gt;感谢 agentzh, &lt;a href=&quot;https://github.com/openresty/lua-nginx-module&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;&gt;lua-nginx-module&lt;/a&gt;, 可以让我们使用 lua 增强nginx的功能, 不言而喻，我们必须现有 Lua 的环境，才能运行 ngx_lua;&lt;/p&gt;\n</code></pre>\n<h2 id=\"编译-nginx-lua\"><a href=\"https://zheng-ji.github.io/#%E7%BC%96%E8%AF%91-nginx-lua\" class=\"headerlink\" title=\"编译 nginx_lua\"></a>编译 nginx_lua</h2><p>官方推荐使用LuaJit,虽然也可以使用Lua，但是即时编译(Just-In-Time Compiler)混合了动态编译和静态编译，一句一句编译源代码，但是会将翻译过的代码缓存起来以降低性能损耗。</p>\n<ul>\n<li>下载安装</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://luajit.org/download/LuaJIT-2.0.4.tar.gz</span><br><span class=\"line\">tar zxvf LuaJIT-2.0.4.tar.gz</span><br><span class=\"line\">cd LuaJIT-2.0.4</span><br><span class=\"line\">make</span><br><span class=\"line\">make install</span><br></pre></td></tr></table></figure>\n<ul>\n<li>设置环境变量</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export LUAJIT_LIB=/usr/local/lib</span><br><span class=\"line\">export LUAJIT_INC=/usr/local/include/luajit-2.0</span><br></pre></td></tr></table></figure>\n<ul>\n<li>然后编译ngx-lua-module.so</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/local/share/dso_tool/ --path=/Path/To/Lua-Nginx-module</span><br></pre></td></tr></table></figure>\n<ul>\n<li>设置动态库</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; echo \"/usr/local/lib\" &gt; /etc/ld.so.conf.d/usr_local_lib.conf</span><br><span class=\"line\">&gt; ldconfig</span><br></pre></td></tr></table></figure>\n<h3 id=\"在-Tengine-中启用\"><a href=\"https://zheng-ji.github.io/#%E5%9C%A8-Tengine-%E4%B8%AD%E5%90%AF%E7%94%A8\" class=\"headerlink\" title=\"在 Tengine 中启用\"></a>在 Tengine 中启用</h3><p><code>nginx.conf</code> 中先加载动态库</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dso {</span><br><span class=\"line\">    load ngx_load_module;</span><br><span class=\"line\">}</span><br></pre></td></tr></table></figure>\n<p>在 nginx.conf 中添加</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lua_code_cache on/off;</span><br></pre></td></tr></table></figure>\n<p>来开启是否将代码缓存，所以每次变更 “*.lua” 文档时，必须重启 nginx 才可生效.</p>\n<h3 id=\"使用-ngx-lua-waf\"><a href=\"https://zheng-ji.github.io/#%E4%BD%BF%E7%94%A8-ngx-lua-waf\" class=\"headerlink\" title=\"使用 ngx_lua_waf\"></a>使用 ngx_lua_waf</h3><p>有了基础环境，我们要开始发挥 ngx lua 的优点了, 我用他安装了 waf (web application firework)<br><a href=\"https://github.com/loveshell/ngx_lua_waf\" target=\"_blank\" rel=\"noopener noreferrer\">ngx_lua_waf</a>，这是一个通过 ngx_lua 编写的 web 应用防火墙, 在使用过程中也发现了 ngx_lua_waf 一个bug，给他提了一个<a href=\"https://github.com/loveshell/ngx_lua_waf/pull/70\" target=\"_blank\" rel=\"noopener noreferrer\">Pull Request</a>, 码农生涯第一个 PR.</p>\n<p>注：<br>静态编译的进程在执行前全部被翻译为机器码，而动态直译执行的则是一句一句边运行边翻译。</p>","text":" &lt;p&gt;Tengine 能动态加载第三方模块，成为我们青睐的选择，我们可以编译动态链接文档，而不需要重新安装 Nginx, 这对在线增强 webservice 很有帮助.&lt;br&gt;感谢 agentzh, &lt;a href=&quot;https://gi...","link":"","photos":[],"count_time":{"symbolsCount":"1.2k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%BC%96%E8%AF%91-nginx-lua\"><span class=\"toc-text\">编译 nginx_lua</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%9C%A8-Tengine-%E4%B8%AD%E5%90%AF%E7%94%A8\"><span class=\"toc-text\">在 Tengine 中启用</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8-ngx-lua-waf\"><span class=\"toc-text\">使用 ngx_lua_waf</span></a></li></ol></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"浅析android手游lua脚本的加密与解密","uid":"1dd14efa2a89c5b5b29bd9942491d3c2","slug":"zl/2016-01-01-264_浅析android手游lua脚本的加密与解密","date":"2024-04-03T03:47:33.128Z","updated":"2024-04-03T03:47:33.128Z","comments":true,"path":"api/articles/zl/2016-01-01-264_浅析android手游lua脚本的加密与解密.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" &lt;p&gt; 博客刚刚弄完善，把去年发在看雪的一篇精华帖转了过来，文章稍微修改了下，并且增加了后续&lt;a href=&quot;https://litna.top/2018/07/08/%E6%B5%85%E6%9E%90android%E6%89%8B%E6%B8%...","link":"","photos":[],"count_time":{"symbolsCount":"11k","symbolsTime":"10 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"399 Evaluate Division","uid":"d52806f532a05cde407ce40f8a15f379","slug":"zl/2016-01-01-262_399 Evaluate Division","date":"2024-04-03T03:47:33.123Z","updated":"2024-04-03T03:47:33.123Z","comments":true,"path":"api/articles/zl/2016-01-01-262_399 Evaluate Division.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"Equations are given in the format A / B = k, where A and B are variables represented as strings, and k is a real number (floating point numb...","link":"","photos":[],"count_time":{"symbolsCount":"6.3k","symbolsTime":"6 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}