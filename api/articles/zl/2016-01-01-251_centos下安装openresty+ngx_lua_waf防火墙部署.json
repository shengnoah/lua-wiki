{"title":"centos下安装openresty+ngx_lua_waf防火墙部署","uid":"0bbecffdbf888a921316fd4ef393eaaa","slug":"zl/2016-01-01-251_centos下安装openresty+ngx_lua_waf防火墙部署","date":"2024-04-03T03:47:33.118Z","updated":"2024-04-03T03:47:33.118Z","comments":true,"path":"api/articles/zl/2016-01-01-251_centos下安装openresty+ngx_lua_waf防火墙部署.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<pre><code>    &lt;p&gt;全文默认安装路径：/usr/local/src&lt;/p&gt;\n</code></pre>\n<h3 id=\"1、安装Luagit\"><a href=\"https://stepwen.github.io/#1%E3%80%81%E5%AE%89%E8%A3%85Luagit\" class=\"headerlink\" title=\"1、安装Luagit:\"></a>1、安装Luagit:</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># cd /usr/local/src</span><br><span class=\"line\"># wget http://luajit.org/download/LuaJIT-2.1.0-beta3.tar.gz</span><br><span class=\"line\"># tar -zxvf LuaJIT-2.1.0-beta3.tar.gz</span><br><span class=\"line\"># cd LuaJIT-2.1.0-beta3</span><br><span class=\"line\"># make</span><br><span class=\"line\"># make install</span><br><span class=\"line\">#ln -sf luajit-2.1.0-beta3 /usr/local/bin/luajit</span><br></pre></td></tr></table></figure>\n<h3 id=\"2、安装openresty\"><a href=\"https://stepwen.github.io/#2%E3%80%81%E5%AE%89%E8%A3%85openresty\" class=\"headerlink\" title=\"2、安装openresty:\"></a>2、安装openresty:</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># cd /usr/local/src</span><br><span class=\"line\"># wget http://openresty.org/download/ngx_openresty-1.13.6.2.tar.gz</span><br><span class=\"line\"># wget https://sourceforge.net/projects/pcre/files/pcre/8.42/pcre-8.42.tar.gz</span><br><span class=\"line\"># tar -zvxf pcre-8.42.tar.gz</span><br><span class=\"line\"># tar -zvxf ngx_openresty-1.13.6.2.tar.gz</span><br><span class=\"line\"># cd ngx_openresty-1.13.6.2.tar.gz</span><br><span class=\"line\"># ./configure --prefix=/usr/local/openresty --with-luajit --with-pcre=/usr/local/src/pcre-8.42/ --with-http_stub_status_module --with-http_gzip_static_module --with-http_ssl_module</span><br><span class=\"line\"># gmake &amp;&amp; gmake install</span><br></pre></td></tr></table></figure>\n<h3 id=\"3、下载ngx-lua-waf\"><a href=\"https://stepwen.github.io/#3%E3%80%81%E4%B8%8B%E8%BD%BDngx-lua-waf\" class=\"headerlink\" title=\"3、下载ngx_lua_waf\"></a>3、下载ngx_lua_waf</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># cd /usr/local/openresty/nginx/</span><br><span class=\"line\"># git clone https://github.com/loveshell/ngx_lua_waf.git</span><br></pre></td></tr></table></figure>\n<h3 id=\"4、修改nginx添加配置，支持lua脚本地址，在http段位置：\"><a href=\"https://stepwen.github.io/#4%E3%80%81%E4%BF%AE%E6%94%B9nginx%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%EF%BC%8C%E6%94%AF%E6%8C%81lua%E8%84%9A%E6%9C%AC%E5%9C%B0%E5%9D%80%EF%BC%8C%E5%9C%A8http%E6%AE%B5%E4%BD%8D%E7%BD%AE%EF%BC%9A\" class=\"headerlink\" title=\"4、修改nginx添加配置，支持lua脚本地址，在http段位置：\"></a>4、修改nginx添加配置，支持lua脚本地址，在http段位置：</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">###相关项目存放地址</span><br><span class=\"line\">lua_package_path \"/usr/local/openresty/nginx/ngx_lua_waf/?.lua\";</span><br><span class=\"line\">###存放limit表的大小</span><br><span class=\"line\">lua_shared_dict limit 10m;</span><br><span class=\"line\">###相应地址</span><br><span class=\"line\">init_by_lua_file  /usr/local/openresty/nginx/ngx_lua_waf/init.lua;</span><br><span class=\"line\">access_by_lua_file /usr/local/openresty/nginx/ngx_lua_waf/waf.lua;</span><br></pre></td></tr></table></figure>\n<h3 id=\"5、修改ngx-lua-waf相关配置：\"><a href=\"https://stepwen.github.io/#5%E3%80%81%E4%BF%AE%E6%94%B9ngx-lua-waf%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%EF%BC%9A\" class=\"headerlink\" title=\"5、修改ngx_lua_waf相关配置：\"></a>5、修改ngx_lua_waf相关配置：</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RulePath = \"/usr/local/openresty/nginx/ngx_lua_waf/wafconf/\"   ##指定相应位置</span><br><span class=\"line\">attacklog = \"on\"                            ##开启日志</span><br><span class=\"line\">logdir = \"/usr/local/openresty/nginx/logs/hack/\"           ##日志存放位置</span><br><span class=\"line\">UrlDeny=\"on\"                              ##是否开启URL防护</span><br><span class=\"line\">Redirect=\"on\"                             ##地址重定向</span><br><span class=\"line\">CookieMatch=\"on\"                           ##cookie拦截</span><br><span class=\"line\">postMatch=\"on\"                            ##post拦截</span><br><span class=\"line\">whiteModule=\"on\"                           ##白名单</span><br><span class=\"line\">black_fileExt={\"php\",\"jsp\"}                        </span><br><span class=\"line\">ipWhitelist={\"127.0.0.1\"}                    ##白名单IP</span><br><span class=\"line\">ipBlocklist={\"1.0.0.1\"}                     ##黑名单IP</span><br><span class=\"line\">CCDeny=\"on\"                             ##开启CC防护        </span><br><span class=\"line\">CCrate=\"100/60\"                          ##60秒内允许同一个IP访问100次</span><br></pre></td></tr></table></figure>\n<h3 id=\"6、创建日志存放目录：\"><a href=\"https://stepwen.github.io/#6%E3%80%81%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E5%AD%98%E6%94%BE%E7%9B%AE%E5%BD%95%EF%BC%9A\" class=\"headerlink\" title=\"6、创建日志存放目录：\"></a>6、创建日志存放目录：</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># mkdir /usr/local/openresty/nginx/logs/hack/</span><br><span class=\"line\"># chown -R nobody:nobody /usr/local/openresty/nginx/logs/hack/</span><br></pre></td></tr></table></figure>\n<h3 id=\"7、启动nginx-测试\"><a href=\"https://stepwen.github.io/#7%E3%80%81%E5%90%AF%E5%8A%A8nginx-%E6%B5%8B%E8%AF%95\" class=\"headerlink\" title=\"7、启动nginx 测试\"></a>7、启动nginx 测试</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># cd /usr/local/openresty/nginx/sbin</span><br><span class=\"line\"># ./nginx</span><br></pre></td></tr></table></figure>","text":" &lt;p&gt;全文默认安装路径：/usr/local/src&lt;/p&gt; 1、安装Luagit:1234567# cd /usr/local/src# wget http://luajit.org/download/LuaJIT-2.1.0-beta3.tar.gz...","link":"","photos":[],"count_time":{"symbolsCount":"2.1k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1%E3%80%81%E5%AE%89%E8%A3%85Luagit\"><span class=\"toc-text\">1、安装Luagit:</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2%E3%80%81%E5%AE%89%E8%A3%85openresty\"><span class=\"toc-text\">2、安装openresty:</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3%E3%80%81%E4%B8%8B%E8%BD%BDngx-lua-waf\"><span class=\"toc-text\">3、下载ngx_lua_waf</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#4%E3%80%81%E4%BF%AE%E6%94%B9nginx%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%EF%BC%8C%E6%94%AF%E6%8C%81lua%E8%84%9A%E6%9C%AC%E5%9C%B0%E5%9D%80%EF%BC%8C%E5%9C%A8http%E6%AE%B5%E4%BD%8D%E7%BD%AE%EF%BC%9A\"><span class=\"toc-text\">4、修改nginx添加配置，支持lua脚本地址，在http段位置：</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5%E3%80%81%E4%BF%AE%E6%94%B9ngx-lua-waf%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%EF%BC%9A\"><span class=\"toc-text\">5、修改ngx_lua_waf相关配置：</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#6%E3%80%81%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E5%AD%98%E6%94%BE%E7%9B%AE%E5%BD%95%EF%BC%9A\"><span class=\"toc-text\">6、创建日志存放目录：</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#7%E3%80%81%E5%90%AF%E5%8A%A8nginx-%E6%B5%8B%E8%AF%95\"><span class=\"toc-text\">7、启动nginx 测试</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"lua学习笔记（一）","uid":"e8058bc58a0d4fd63c47f20b7d5cde34","slug":"zl/2016-01-01-253_lua学习笔记（一）","date":"2024-04-03T03:47:33.119Z","updated":"2024-04-03T03:47:33.119Z","comments":true,"path":"api/articles/zl/2016-01-01-253_lua学习笔记（一）.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" &lt;h2 id=&quot;注释&quot;&gt;&lt;a href=&quot;https://Jaxes.github.io/#%E6%B3%A8%E9%87%8A&quot; class=&quot;headerlink&quot; title=&quot;注释&...","link":"","photos":[],"count_time":{"symbolsCount":"4.4k","symbolsTime":"4 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"lua c api","uid":"a088e52eeedd5a2e08a78395ae73ef54","slug":"zl/2016-01-01-252_lua c api ","date":"2024-04-03T03:47:33.118Z","updated":"2024-04-03T03:47:33.119Z","comments":true,"path":"api/articles/zl/2016-01-01-252_lua c api .json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" 一 概述 在 C 中使用 API 通过栈操作表或数组类型的数据，本篇使用示例来演示如果通过栈来操作表。 二 渠道秘钥更新 set_channel_key 函数接收一个 table 作为参数，从 table 中获取 channel_name 的值作为 key，之后从动态库的全局渠...","link":"","photos":[],"count_time":{"symbolsCount":"3.6k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}