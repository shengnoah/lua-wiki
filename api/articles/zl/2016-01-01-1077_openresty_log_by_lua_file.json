{"title":"openresty_log_by_lua_file","uid":"016f37d344bf162f67db745edb226e62","slug":"zl/2016-01-01-1077_openresty_log_by_lua_file","date":"2024-04-03T03:47:32.992Z","updated":"2024-04-03T03:47:32.992Z","comments":true,"path":"api/articles/zl/2016-01-01-1077_openresty_log_by_lua_file.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<h3 id=\"set-the-log-in-nginx-conf\"><a href=\"#set-the-log-in-nginx-conf\" class=\"headerlink\" title=\"set the log in nginx.conf\"></a>set the log in nginx.conf</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/><span class=\"line\">13</span><br/><span class=\"line\">14</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br/><span class=\"line\">location /docs {</span><br/><span class=\"line\">\tkeepalive_timeout 0;</span><br/><span class=\"line\">\tdefault_type <span class=\"string\">&#39;text/html&#39;</span>;</span><br/><span class=\"line\">\t<span class=\"built_in\">set</span> <span class=\"variable\">$res</span> <span class=\"string\">&#34;&#34;</span>;</span><br/><span class=\"line\">\tset_by_lua_file <span class=\"variable\">$res</span> /opt/openresty/set_by.lua;</span><br/><span class=\"line\">\trewrite_by_lua_file /opt/openresty/rewrite.lua;</span><br/><span class=\"line\">\taccess_by_lua_file /opt/openresty/access.lua;</span><br/><span class=\"line\">\tcontent_by_lua_file /opt/openresty/content.lua;</span><br/><span class=\"line\">\theader_filter_by_lua_file /opt/openresty/header_filter.lua;</span><br/><span class=\"line\">\tbody_filter_by_lua_file /opt/openresty/body_filter.lua;</span><br/><span class=\"line\">\tlog_by_lua_file /opt/openresty/base/log.lua;</span><br/><span class=\"line\">\tproxy_pass http://default_doc_upstream;</span><br/><span class=\"line\">}</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"log-by-lua-file\"><a href=\"#log-by-lua-file\" class=\"headerlink\" title=\"log_by_lua_file\"></a>log_by_lua_file</h3><figure class=\"highlight lua\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/><span class=\"line\">13</span><br/><span class=\"line\">14</span><br/><span class=\"line\">15</span><br/><span class=\"line\">16</span><br/><span class=\"line\">17</span><br/><span class=\"line\">18</span><br/><span class=\"line\">19</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">local</span> cjson = <span class=\"built_in\">require</span>(<span class=\"string\">&#34;cjson&#34;</span>);</span><br/><span class=\"line\"></span><br/><span class=\"line\"><span class=\"keyword\">local</span> upstream_addr = <span class=\"literal\">nil</span>;</span><br/><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"literal\">nil</span> ~= ngx.var.upstream_addr <span class=\"keyword\">then</span></span><br/><span class=\"line\">    upstream_addr = ngx.var.upstream_addr;</span><br/><span class=\"line\"><span class=\"keyword\">else</span></span><br/><span class=\"line\">    upstream_addr = <span class=\"literal\">nil</span>;</span><br/><span class=\"line\"><span class=\"keyword\">end</span></span><br/><span class=\"line\"></span><br/><span class=\"line\">ngx.<span class=\"built_in\">log</span>(ngx.INFO, <span class=\"string\">&#34;upstream_addr=&#34;</span>..upstream_addr);</span><br/><span class=\"line\"></span><br/><span class=\"line\"><span class=\"comment\">--</span></span><br/><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"literal\">nil</span> ~= ngx.var.upstream_response_time <span class=\"keyword\">and</span> <span class=\"string\">&#39;number&#39;</span> == <span class=\"built_in\">type</span>(ngx.var.upstream_response_time) <span class=\"keyword\">then</span></span><br/><span class=\"line\">    <span class=\"keyword\">local</span> resp_time_so_far = ngx.now() - <span class=\"built_in\">tonumber</span>(ngx.var.upstream_response_time);</span><br/><span class=\"line\">    <span class=\"comment\">-- 1s</span></span><br/><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">tonumber</span>(ngx.var.upstream_response_time) &gt;= <span class=\"number\">1</span> <span class=\"keyword\">then</span></span><br/><span class=\"line\">        ngx.<span class=\"built_in\">log</span>(ngx.WARN, <span class=\"string\">&#34;[SLOW] request_time=&#34;</span>..ngx.var.request_time..<span class=\"string\">&#34; upstream_response_time=&#34;</span>..ngx.var.upstream_response_time..<span class=\"string\">&#34;, upstream_addr=&#34;</span>..upstream_addr);</span><br/><span class=\"line\">    <span class=\"keyword\">end</span></span><br/><span class=\"line\"><span class=\"keyword\">end</span></span><br/></pre></td></tr></tbody></table></figure>","text":"set the log in nginx.conf1234567891011121314location /docs { keepalive_timeout 0; default_type &#39;text/html&#39;; set $res &#34;&#34;; set...","link":"","photos":[],"count_time":{"symbolsCount":"1.3k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#set-the-log-in-nginx-conf\"><span class=\"toc-text\">set the log in nginx.conf</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#log-by-lua-file\"><span class=\"toc-text\">log_by_lua_file</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"openresty_balancer_by_lua_file","uid":"a2411ddd503448beb656773fa1e82fb8","slug":"zl/2016-01-01-1078_openresty_balancer_by_lua_file","date":"2024-04-03T03:47:32.992Z","updated":"2024-04-03T03:47:32.993Z","comments":true,"path":"api/articles/zl/2016-01-01-1078_openresty_balancer_by_lua_file.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"set the balancer in nginx.conf12345678910upstream default_doc_upstream { server 192.168.1.170:8081; # tomcat-8 server 192.168.1.170:8082; # ...","link":"","photos":[],"count_time":{"symbolsCount":"2.9k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"编译安装lua","uid":"bce7c50ca61914966878eeb88c899eb1","slug":"zl/2016-01-01-1074_编译安装lua","date":"2024-04-03T03:47:32.991Z","updated":"2024-04-03T03:47:32.991Z","comments":true,"path":"api/articles/zl/2016-01-01-1074_编译安装lua.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"下载: build $ wget https://www.lua.org/ftp/lua-5.1.5.tar.gz 解压: build $ tar xf lua-5.1.5.tar.gz make: lua-5.1.5 $ make linux 安装: lua-5.1.5 $ s...","link":"","photos":[],"count_time":{"symbolsCount":160,"symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}