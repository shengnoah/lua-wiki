{"title":"Lua数据结构 — lua_State（六）","uid":"46bcada2c326dc8ce4bff264b9dd7b9e","slug":"zl/2016-01-01-738_Lua数据结构 — lua_State（六）","date":"2024-04-03T03:47:35.985Z","updated":"2024-04-03T03:47:35.985Z","comments":true,"path":"api/articles/zl/2016-01-01-738_Lua数据结构 — lua_State（六）.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<p>前面各种Lua的数据类型基本都说得差不多了，剩下最后一个数据类型：<strong>lua_State</strong>，我们可以认为是<strong>”脚本上下文”</strong>，主要是包括当前脚本环境的运行状态信息，还会有gc相关的信息。</p>\n<p>Lua这门语言考虑了多线程的情况，在脚本空间中能够开多个线程相关脚本上下文，而大家会共用一个全局脚本状态数据，如下：</p>\n<p><img src=\"https://keepmovingxin.github.io//images/luaState/lua-state-01.png\" alt=\"\"/></p>\n<p>全局数据global_state的数据结构如下：</p>\n<p><img src=\"https://keepmovingxin.github.io//images/luaState/lua-state-02.png\" alt=\"\"/></p>\n<p>global_state主要是用于GC的数据链表，下面简要说明几个:</p>\n<ol>\n<li>stringtable strt：这个是在TString那章说到的全局字符串哈希表</li>\n<li>TValue lregistry：对应LUAREGISTRYINDEX的全局table.</li>\n<li>TString *tmname[TM_N]：元方法的名称字符串。</li>\n<li>Table *mt[NUM_TAGS]：基本类型的元表，这是Lua5.0的特性。</li>\n</ol>\n<p>mt成员在作者介绍文章中说到:</p>\n<p><img src=\"https://keepmovingxin.github.io//images/luaState/lua-state-03.png\" alt=\"\"/></p>\n<p>在上面代码中，我们看到a支持一个tostring的方法，a是数值类型，我们可以为数值类型添加任意的方法。Lua文章中说到一个用途，就是对于unicode和gbk的字符串的len方法能自己实现。</p>\n<p>其它成员就不一一介绍了，下面来介绍与线程相关的脚本上下文lua_State：</p>\n<p><img src=\"https://keepmovingxin.github.io//images/luaState/lua-state-04.png\" alt=\"\"/></p>\n<p>我们看到，luaState也带有CommonHeader头，在第一章中也提到了GCObject中有luaState th这个成员，由此可见lua_State也会是被回收的对象之一。</p>\n<p>考虑回一个线程中的脚本上下文，我们再来逐个分析每个成员：</p>\n<ul>\n<li>lu_byte status：线程脚本的状态，线程可选状态如下：</li>\n</ul>\n<p><img src=\"https://keepmovingxin.github.io//images/luaState/lua-state-05.png\" alt=\"\"/></p>\n<ul>\n<li>StkId top：指向当前线程栈的栈顶指针，typedef TValue *StkId</li>\n<li><p>StkId base：指向当前函数运行的相对基位置，具体可参考第四章的闭包</p>\n</li>\n<li><p>globalState *lG：指向全局状态的指针</p>\n</li>\n<li>CallInfo *ci：当前线程运行的函数调用信息</li>\n<li>const Instruction *savedpc：函数调用前，记录上一个函数的pc位置</li>\n<li>StkId stack_last：栈的实际最后一个位置（栈的长度是动态增长的）</li>\n<li>StkId stack：栈底</li>\n<li>CallInfo *end_ci：指向函数调用栈的栈顶</li>\n<li>CallInfo *base_ci：指向函数调用栈的栈底</li>\n<li>int stacksize：栈的大小</li>\n<li>int size_ci：函数调用栈的大小</li>\n<li>unsigned short nCcalls：当前C函数的调用的深度</li>\n<li>unsigned short baseCcalls：用于记录每个线程状态的C函数调用深度的辅助成员</li>\n<li>lu_byte hookmask：支持哪些hook能力，有下列可选的</li>\n</ul>\n<p><img src=\"https://keepmovingxin.github.io//images/luaState/lua-state-06.png\" alt=\"\"/></p>\n<ul>\n<li>lu_byte allowhook：是否允许hook</li>\n<li>int basehookcount：用户设置的执行指令数(LUA_MASKCOUNT下有效)</li>\n<li>int hookcount：运行时，跑了多少条指令（LUA_MASKCOUNT下有效）</li>\n<li>lua_Hook：用户注册的hook回调函数</li>\n<li>TValue l_gt：当前线程的全局的环境表</li>\n<li>TValue env：当前运行的环境表</li>\n<li>GCObject *openupval、gclist：用于gc，详细将会在GC一章细说</li>\n<li>struct lua_longjmp *errorJmp：发生错误的长跳转位置，用于记录当函数发生错误时跳转出去的位置。</li>\n</ul>\n<p><img src=\"https://keepmovingxin.github.io//images/luaState/lua-state-07.png\" alt=\"\"/></p>\n<p>本系列总结：</p>\n<p>整个系列文章回答了我们对Lua中最基本的一个问题：“一个Lua变量究竟是什么？”。由此我们深入并引申出各种知识，在脚本中我们觉得弱类型变量用起来很痛快，而其实它的内部实现其实是如此的复杂。</p>\n<p>对于实现一门脚本语言，必须实现的是解释器、虚拟机、上下文数据3大部分：</p>\n<p><img src=\"https://keepmovingxin.github.io//images/luaState/lua-state-08.png\" alt=\"\"/></p>\n<p>上下文数据这一层是脚本最基础，最底层的东西，它决定了这门脚本究竟能做什么。抛开解释器和虚拟机，我们依然可以单纯地通过C接口，在C++这一层就能操作脚本的上下文数据。</p>\n<p>有空再研究一下Lua的GC，解释器等等。</p>\n<p><strong>Lua数据结构</strong>系列转自阿里云博客，作者是<strong>罗日健</strong>。<br/>原文链接：<a href=\"http://blog.aliyun.com/795\" target=\"_blank\" rel=\"external noopener noreferrer\">http://blog.aliyun.com/795</a></p>\n<hr/>\n<p>扫描二维码或在微信中搜索 KeepMovingXin<br/><img src=\"https://keepmovingxin.github.io//images/qrcode.jpg\" alt=\"欢迎关注微信公众号！\"/></p>","text":"前面各种Lua的数据类型基本都说得差不多了，剩下最后一个数据类型：lua_State，我们可以认为是”脚本上下文”，主要是包括当前脚本环境的运行状态信息，还会有gc相关的信息。 Lua这门语言考虑了多线程的情况，在脚本空间中能够开多个线程相关脚本上下文，而大家会共用一个全局脚本状...","link":"","photos":[],"count_time":{"symbolsCount":"1.8k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"LuCI的uci使用（lua）","uid":"307dd1de8967bd9b98bf15acd11e3afd","slug":"zl/2016-01-01-737_LuCI的uci使用（lua）","date":"2024-04-03T03:47:35.985Z","updated":"2024-04-03T03:47:35.985Z","comments":true,"path":"api/articles/zl/2016-01-01-737_LuCI的uci使用（lua）.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"add123local uci = require(&#34;luci.model.uci&#34;).cursor()uci:add(&#34;wireless&#34;, &#34;wifi-iface&#34;)uci:commit(&#34;wireless&#34;) ...","link":"","photos":[],"count_time":{"symbolsCount":"4k","symbolsTime":"4 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"2000 HUB5 English Evaluation Transcripts语音数据集","uid":"85fc271a981e30a8b17a330d958ec5be","slug":"zl/2016-01-01-739_2000 HUB5 English Evaluation Transcripts语音数据集","date":"2024-04-03T03:47:35.985Z","updated":"2024-04-03T03:47:35.985Z","comments":true,"path":"api/articles/zl/2016-01-01-739_2000 HUB5 English Evaluation Transcripts语音数据集.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"提供者：杜成玉下载地址：https://catalog.ldc.upenn.edu/LDC2002S09 数据来源：https://www.zhihu.com/question/63383992/answer/222718972该数据集由NIST（国家标准与技术研究院）2000年...","link":"","photos":[],"count_time":{"symbolsCount":"1.1k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}