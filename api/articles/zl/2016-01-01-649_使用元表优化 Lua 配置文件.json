{"title":"使用元表优化 Lua 配置文件","uid":"d1bdeff7322e20d503cfc9f8f1831c97","slug":"zl/2016-01-01-649_使用元表优化 Lua 配置文件","date":"2024-04-03T03:47:35.870Z","updated":"2024-04-03T03:47:35.871Z","comments":true,"path":"api/articles/zl/2016-01-01-649_使用元表优化 Lua 配置文件.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<div class=\"main-content-wrap\">\n<h2 id=\"配置文件\">配置文件</h2>\n<p>在游戏工程中，通常有大量配置是由策划提供，再转换成程序方便读取的格式添加到工程中。</p>\n<p>在我参与的<code>Cocos2dx-Lua</code>工程中，策划通常在<code>Excel</code>中配置，再通过脚本转换为<code>Lua-Table</code>的文件。</p>\n<p>比如常见的道具表转换后：</p>\n<div class=\"highlight\"><pre class=\"chroma\"><code class=\"language-Lua\" data-lang=\"Lua\"><span class=\"c1\">-- PropModel.lua</span>\n<span class=\"n\">PropModel</span> <span class=\"o\">=</span> <span class=\"p\">&#123;</span>\n    <span class=\"p\">[</span><span class=\"mi\">1001</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">&#123;</span>\n        <span class=\"n\">ID</span>          <span class=\"o\">=</span> <span class=\"mi\">1001</span><span class=\"p\">,</span>\n        <span class=\"n\">name</span>        <span class=\"o\">=</span> <span class=\"s2\">&#34;道具1001&#34;</span><span class=\"p\">,</span>\n        <span class=\"n\">desc</span>        <span class=\"o\">=</span> <span class=\"s2\">&#34;道具1001描述&#34;</span><span class=\"p\">,</span>\n        <span class=\"n\">colorLv</span>     <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">,</span>    <span class=\"c1\">-- 颜色等级</span>\n        <span class=\"n\">ifSell</span>      <span class=\"o\">=</span> <span class=\"kc\">true</span><span class=\"p\">,</span> <span class=\"c1\">-- 是否可以出售</span>\n        <span class=\"n\">ifUse</span>       <span class=\"o\">=</span> <span class=\"kc\">true</span><span class=\"p\">,</span> <span class=\"c1\">-- 是否可以使用</span>\n        <span class=\"n\">useExtraStr</span> <span class=\"o\">=</span> <span class=\"s2\">&#34;&#34;</span><span class=\"p\">,</span>   <span class=\"c1\">-- 使用时额外消耗的资源</span>\n        <span class=\"n\">useNeedNum</span>  <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">,</span>    <span class=\"c1\">-- 使用消耗数量</span>\n        <span class=\"n\">maxNum</span>      <span class=\"o\">=</span> <span class=\"mi\">99</span><span class=\"p\">,</span>   <span class=\"c1\">-- 最大堆叠数量</span>\n        <span class=\"p\">...</span>\n    <span class=\"p\">&#125;,</span>\n    <span class=\"p\">[</span><span class=\"mi\">1002</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">&#123;</span>\n        <span class=\"n\">ID</span>          <span class=\"o\">=</span> <span class=\"mi\">1002</span><span class=\"p\">,</span>\n        <span class=\"n\">name</span>        <span class=\"o\">=</span> <span class=\"s2\">&#34;道具1002&#34;</span><span class=\"p\">,</span>\n        <span class=\"n\">desc</span>        <span class=\"o\">=</span> <span class=\"s2\">&#34;道具1002描述&#34;</span><span class=\"p\">,</span>\n        <span class=\"n\">colorLv</span>     <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">,</span>    <span class=\"c1\">-- 颜色等级</span>\n        <span class=\"n\">ifSell</span>      <span class=\"o\">=</span> <span class=\"kc\">true</span><span class=\"p\">,</span> <span class=\"c1\">-- 是否可以出售</span>\n        <span class=\"n\">ifUse</span>       <span class=\"o\">=</span> <span class=\"kc\">true</span><span class=\"p\">,</span> <span class=\"c1\">-- 是否可以使用</span>\n        <span class=\"n\">useExtraStr</span> <span class=\"o\">=</span> <span class=\"s2\">&#34;&#34;</span><span class=\"p\">,</span>   <span class=\"c1\">-- 使用时额外消耗的资源</span>\n        <span class=\"n\">useNeedNum</span>  <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">,</span>    <span class=\"c1\">-- 使用消耗数量</span>\n        <span class=\"n\">maxNum</span>      <span class=\"o\">=</span> <span class=\"mi\">99</span><span class=\"p\">,</span>   <span class=\"c1\">-- 最大堆叠数量</span>\n        <span class=\"p\">...</span>\n    <span class=\"p\">&#125;,</span>\n    <span class=\"p\">...</span>\n<span class=\"p\">&#125;</span></code></pre></div>\n<p><code>Excel</code>配置中每一行数据经过转换后对应<code>Lua-Table</code>的一个<code>item</code>。</p>\n<p>通过观察可以发现其中有部分字段很容易重复，如：<code>colorLv</code>、<code>ifUse</code>、<code>useNeedNum</code>等，\n这些字段通常为枚举或者有固定的分类，只有几个不同的值，然而配置表中每个<code>item</code>都需要为这些内容创建一个字段。</p>\n<h2 id=\"优化\">优化</h2>\n<p>有了这些重复的字段，就给了我们优化的空间。\n通过使用<code>Lua</code>的元表，可以让每个<code>item</code>拥有共同的字段而非每个<code>item</code>去创建一个字段。\n从而节省内存开销。</p>\n<p>如优化之后：</p>\n<div class=\"highlight\"><pre class=\"chroma\"><code class=\"language-Lua\" data-lang=\"Lua\"><span class=\"n\">PropModel</span> <span class=\"o\">=</span> <span class=\"p\">&#123;</span>\n    <span class=\"p\">[</span><span class=\"mi\">1001</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">&#123;</span>\n        <span class=\"n\">ID</span>          <span class=\"o\">=</span> <span class=\"mi\">1001</span><span class=\"p\">,</span>\n        <span class=\"n\">name</span>        <span class=\"o\">=</span> <span class=\"s2\">&#34;道具1001&#34;</span><span class=\"p\">,</span>\n        <span class=\"n\">desc</span>        <span class=\"o\">=</span> <span class=\"s2\">&#34;道具1001描述&#34;</span><span class=\"p\">,</span>\n        <span class=\"p\">...</span>\n    <span class=\"p\">&#125;,</span>\n    <span class=\"p\">[</span><span class=\"mi\">1002</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">&#123;</span>\n        <span class=\"n\">ID</span>          <span class=\"o\">=</span> <span class=\"mi\">1002</span><span class=\"p\">,</span>\n        <span class=\"n\">name</span>        <span class=\"o\">=</span> <span class=\"s2\">&#34;道具1002&#34;</span><span class=\"p\">,</span>\n        <span class=\"n\">desc</span>        <span class=\"o\">=</span> <span class=\"s2\">&#34;道具1002描述&#34;</span><span class=\"p\">,</span>\n        <span class=\"p\">...</span>\n    <span class=\"p\">&#125;,</span>\n    <span class=\"p\">...</span>\n<span class=\"p\">&#125;</span>\n<p><span class=\"c1\">– 将重复内容提取为默认item</span><br />\n<span class=\"kd\">local</span> <span class=\"n\">default__</span> <span class=\"o\">=</span> <span class=\"p\">&#123;</span><br />\n<span class=\"n\">colorLv</span>     <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">,</span><br />\n<span class=\"n\">ifSell</span>      <span class=\"o\">=</span> <span class=\"kc\">true</span><span class=\"p\">,</span><br />\n<span class=\"n\">ifUse</span>       <span class=\"o\">=</span> <span class=\"kc\">true</span><span class=\"p\">,</span><br />\n<span class=\"n\">useExtraStr</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span><br />\n<span class=\"n\">useNeedNum</span>  <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">,</span><br />\n<span class=\"n\">maxNum</span>      <span class=\"o\">=</span> <span class=\"mi\">99</span><span class=\"p\">,</span><br />\n<span class=\"p\">&#125;</span></p>\n<p><span class=\"kd\">local</span> <span class=\"n\">base</span> <span class=\"o\">=</span> <span class=\"p\">&#123;</span><br />\n<span class=\"n\"><strong>index</span> <span class=\"o\">=</span> <span class=\"n\">default</strong></span><span class=\"p\">,</span><br />\n<span class=\"p\">&#125;</span><br />\n<span class=\"kr\">for</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">v</span> <span class=\"kr\">in</span> <span class=\"n\">pairs</span><span class=\"p\">(</span><span class=\"n\">PropModel</span><span class=\"p\">)</span> <span class=\"kr\">do</span><br />\n<span class=\"n\">setmetatable</span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">,</span> <span class=\"n\">base</span><span class=\"p\">)</span><br />\n<span class=\"kr\">end</span></code></pre></div></p>\n<p>这样为每个<code>item</code>设置元表后，<code>item</code>中的字段数量大幅缩减。</p>\n<p>在实际生产中，这步优化被直接放在脚本中进行。在<code>Excel</code>到<code>Lua-Table</code>的过程中直接完成。</p>\n<h2 id=\"缺点\">缺点</h2>\n<p>可读性变差。开发人员人工检查时需要把数据对应的<code>item</code>和<code>default__</code>组合起来看才能得到当前<code>item</code>的数据。</p>\n</div>","text":" 配置文件 在游戏工程中，通常有大量配置是由策划提供，再转换成程序方便读取的格式添加到工程中。 在我参与的Cocos2dx-Lua工程中，策划通常在Excel中配置，再通过脚本转换为Lua-Table的文件。 比如常见的道具表转换后： -- PropModel.lua PropM...","link":"","photos":[],"count_time":{"symbolsCount":"1.9k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6\"><span class=\"toc-text\">配置文件</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BC%98%E5%8C%96\"><span class=\"toc-text\">优化</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%BC%BA%E7%82%B9\"><span class=\"toc-text\">缺点</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"cocos2dx lua —— Http请求总结与实战(封装)","uid":"dcb7ce12f00b8209eff197aa80b46963","slug":"zl/2016-01-01-648_cocos2dx lua —— Http请求总结与实战(封装)","date":"2024-04-03T03:47:35.870Z","updated":"2024-04-03T03:47:35.870Z","comments":true,"path":"api/articles/zl/2016-01-01-648_cocos2dx lua —— Http请求总结与实战(封装).json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"今天的主题是关于cocos2dx lua实现短链接网络请求，使用Http实现基本的服务器网络数据获取，关于长链接（socket后续文件或者遇到需要的时候回特别实现与处理） 关于Http这里就不多做介绍了，不过，作为一个程序员，网络请求是开发中最多也是最重要的一环节，这里比较建议，...","link":"","photos":[],"count_time":{"symbolsCount":"9.8k","symbolsTime":"9 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"开个坑学习一下lua","uid":"3270226bf36cd89ed96cd016a1a8b3ac","slug":"zl/2016-01-01-647_开个坑学习一下lua","date":"2024-04-03T03:47:35.869Z","updated":"2024-04-03T03:47:35.870Z","comments":true,"path":"api/articles/zl/2016-01-01-647_开个坑学习一下lua.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"再次好久没有更新blog，主要是感觉没有什么记录的东西。最近通读了云风大神的blog，只能感叹人与人差距之大，有时确实难以企及，但仍希望能有一丝靠近。 在工作中对lua有一些接触，开个坑mark一下，准备用一段时间通读一下lua的代码，大概20k行左右，对于一门语言来说确实足够精...","link":"","photos":[],"count_time":{"symbolsCount":153,"symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}