{"title":"搭建ngx_lua_waf","uid":"5b06da96654ab629a54d2007eebfe28b","slug":"zl/2016-01-01-67_搭建ngx_lua_waf [ Hexo ]","date":"2024-04-03T03:47:35.912Z","updated":"2024-04-03T03:47:35.912Z","comments":true,"path":"api/articles/zl/2016-01-01-67_搭建ngx_lua_waf [ Hexo ].json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<p class=\"page-title-sub\">\n      <span id=\"post-title-date\">Created at 2019-05-26</span>\n<pre><code>    &lt;span id=&quot;post-title-updated&quot;&gt;Updated at 2019-08-15&lt;/span&gt;\n  \n  \n  &lt;span id=&quot;post-title-categories&quot;&gt;Category\n  \n  \n    \n    \n    &lt;a href=&quot;/categories/搭建服务/&quot;&gt;搭建服务&lt;/a&gt;\n  \n  &lt;/span&gt;\n  \n  \n  &lt;span id=&quot;post-title-tags&quot;&gt;\n  Tag\n  \n  \n    \n    \n    &lt;a href=&quot;/tags/搭建ngx-lua-waf/&quot;&gt;搭建ngx_lua_waf&lt;/a&gt;\n  \n  &lt;/span&gt;\n  \n&lt;/p&gt;\n\n&lt;hr/&gt;\n</code></pre>\n<h1 id=\"搭建ngx-lua-waf\"><a href=\"#搭建ngx-lua-waf\" class=\"headerlink\" title=\"搭建ngx_lua_waf\"></a>搭建ngx_lua_waf</h1><p>工作环境：centos7<br/> <br/>1.下载nginx源文件<br/>下载地址 ： <a href=\"http://nginx.org/en/download.html\" target=\"_blank\" rel=\"noopener noreferrer\">http://nginx.org/en/download.html</a><br/>cd /usr/local/src<br/>wget <a href=\"http://nginx.org/download/nginx-1.12.2.tar.gz\" target=\"_blank\" rel=\"noopener noreferrer\">http://nginx.org/download/nginx-1.12.2.tar.gz</a><br/>tar -xvf nginx-1.12.2.tar.gz<br/> <br/> <br/>2.下载安装LuaJIT<br/>下载地址：<a href=\"http://luajit.org/download.html\" target=\"_blank\" rel=\"noopener noreferrer\">http://luajit.org/download.html</a><br/>cd /usr/local/src<br/>wget <a href=\"http://luajit.org/download/LuaJIT-2.1.0-beta3.tar.gz\" target=\"_blank\" rel=\"noopener noreferrer\">http://luajit.org/download/LuaJIT-2.1.0-beta3.tar.gz</a><br/>tar -zxf LuaJIT-2.1.0-beta3.tar.gz<br/>cd LuaJIT-2.1.0-beta3<br/>make PREFIX=/usr/local/src/luajit<br/>make install PREFIX=/usr/local/src/luajit<br/> <br/> <br/>3.下载ngx_devel_kit（NDK）模块<br/>下载地址：<a href=\"https://github.com/simplresty/ngx_devel_kit/tags\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/simplresty/ngx_devel_kit/tags</a><br/>cd /usr/local/src<br/>wget <a href=\"https://github.com/simplresty/ngx_devel_kit/archive/v0.3.0.tar.gz\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/simplresty/ngx_devel_kit/archive/v0.3.0.tar.gz</a><br/>tar -xvf v0.3.0.tar.gz<br/> <br/> <br/>4.下载lua-nginx-module模块<br/>下载地址：<a href=\"https://github.com/openresty/lua-nginx-module/tags\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/openresty/lua-nginx-module/tags</a><br/>cd /usr/local/src<br/>wget <a href=\"https://github.com/openresty/lua-nginx-module/archive/v0.10.11.tar.gz\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/openresty/lua-nginx-module/archive/v0.10.11.tar.gz</a><br/>tar -xvf v0.10.11.tar.gz<br/> <br/> <br/>5.编译安装Nginx<br/>cd /usr/local/src/nginx-1.12.2<br/>1.切换到Nginx源文件目录，设置环境变量<br/>export LUAJIT_LIB=/usr/local/src/luajit/lib<br/>export LUAJIT_INC=/usr/local/src/luajit/include/luajit-2.1<br/> <br/> <br/>2.编译<br/>./configure <br/>–prefix=/data/server/nginx <br/>–error-log-path=/data/server/nginx/error.log <br/>–http-log-path=/data/server/nginx/access.log <br/>–with-http_ssl_module <br/>–with-http_v2_module <br/>–with-http_realip_module <br/>–with-http_addition_module <br/>–with-http_image_filter_module <br/>–with-http_geoip_module <br/>–with-http_sub_module <br/>–with-http_dav_module <br/>–with-http_flv_module <br/>–with-http_mp4_module <br/>–with-http_gunzip_module <br/>–with-http_gzip_static_module <br/>–with-http_random_index_module <br/>–with-http_secure_link_module <br/>–with-http_degradation_module <br/>–with-http_slice_module <br/>–with-http_stub_status_module <br/>–with-pcre <br/>–with-pcre-jit <br/>–with-stream <br/>–with-stream_ssl_module <br/>–with-debug <br/>–add-module=/usr/local/src/ngx_devel_kit-0.3.0 <br/>–add-module=/usr/local/src/lua-nginx-module-0.10.11 <br/>–with-ld-opt=”-Wl,-rpath,$LUAJIT_LIB” ;<br/>make &amp;&amp; make install<br/> <br/> <br/>6.安装ngx_lua_waf模块<br/>下载地址：<a href=\"https://github.com/loveshell/ngx_lua_waf/tree/master\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/loveshell/ngx_lua_waf/tree/master</a><br/><a href=\"https://imgchr.com/i/mkNvrV\" target=\"_blank\" rel=\"noopener noreferrer\"><img src=\"https://s2.ax1x.com/2019/08/14/mkNvrV.png\" alt=\"mkNvrV.png\"/></a><br/>克隆<br/>cd /usr/local/src/<br/>git clone <a href=\"https://github.com/loveshell/ngx_lua_waf.git\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/loveshell/ngx_lua_waf.git</a><br/>mv ngx_lua_waf waf<br/>mv waf /data/server/nginx/conf/<br/>修改waf的模块的规则配置路径<br/>vi /data/server/nginx/conf/waf/config.lua<br/>修改为下图所示页面(主要修改路径)<br/><a href=\"https://imgchr.com/i/mkUkx1\" target=\"_blank\" rel=\"noopener noreferrer\"><img src=\"https://s2.ax1x.com/2019/08/14/mkUkx1.png\" alt=\"mkUkx1.png\"/></a><br/>7.修改nginx的配置文件，使其加载waf功能模块<br/>vi /data/server/nginx/conf/nginx.conf<br/>添加以下内容<br/>    lua_package_path “/data/server/nginx/conf/waf/?.lua”;<br/>    lua_shared_dict limit 10m;<br/>    init_by_lua_file  /data/server/nginx/conf/waf/init.lua;<br/>    access_by_lua_file /data/server/nginx/conf/waf/waf.lua;<br/> <br/> <br/><a href=\"https://imgchr.com/i/mkUosx\" target=\"_blank\" rel=\"noopener noreferrer\"><img src=\"https://s2.ax1x.com/2019/08/14/mkUosx.png\" alt=\"mkUosx.png\"/></a><br/> <br/> <br/>8、关闭防火墙、SELINUX，启动<br/>systemctl stop firewalld<br/>setenforce 0<br/>/data/server/nginx/sbin/nginx<br/>访问：192.168.43.198出现nginx页面<br/> <br/> <br/><a href=\"https://imgchr.com/i/mkUOFe\" target=\"_blank\" rel=\"noopener noreferrer\"><img src=\"https://s2.ax1x.com/2019/08/14/mkUOFe.png\" alt=\"mkUOFe.png\"/></a><br/>访问：<a href=\"http://192.168.43.198/test.php?id=../etc/passwd\" target=\"_blank\" rel=\"noopener noreferrer\">http://192.168.43.198/test.php?id=../etc/passwd</a><br/> <br/> <br/><a href=\"https://imgchr.com/i/mkwtZ6\" target=\"_blank\" rel=\"noopener noreferrer\"><img src=\"https://s2.ax1x.com/2019/08/14/mkwtZ6.png\" alt=\"mkwtZ6.png\"/></a></p>","text":" Created at 2019-05-26 &lt;span id=&quot;post-title-updated&quot;&gt;Updated at 2019-08-15&lt;/span&gt; &lt;span id=&quot;post-title-categor...","link":"","photos":[],"count_time":{"symbolsCount":"3k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%90%AD%E5%BB%BAngx-lua-waf\"><span class=\"toc-text\">搭建ngx_lua_waf</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Lua的元表","uid":"74fdff3e8ba6e278fa488790b194fb21","slug":"zl/2016-01-01-681_Lua的元表","date":"2024-04-03T03:47:35.913Z","updated":"2024-04-03T03:47:35.917Z","comments":true,"path":"api/articles/zl/2016-01-01-681_Lua的元表.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"在 Lua 5.1 语言中，元表 (metatable) 的表现行为类似于 C++ 语言中的操作符重载，例如我们可以重载 “__add” 元方法 (metamethod)，来计算两个 Lua 数组的并集；或者重载 “__index” 方法，来定义我们自己的 Hash 函数。Lua...","link":"","photos":[],"count_time":{"symbolsCount":"3.4k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"ulua学习笔记1","uid":"aaff2d552cd8f01832adc372fb61fa84","slug":"zl/2016-01-01-678_ulua学习笔记1","date":"2024-04-03T03:47:35.911Z","updated":"2024-04-03T03:47:35.911Z","comments":true,"path":"api/articles/zl/2016-01-01-678_ulua学习笔记1.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"本文为bbbbbbion（可以叫我六饼）原创总结，如有疏漏请各位拍砖留言。转载请尊重原作者成果，保留出处。这一系列用于记录笔者学习ulua热更新的过程。首先来看Windows下lua环境的搭建。 环境：lua for windows (lfW)主页：http://luaforwi...","link":"","photos":[],"count_time":{"symbolsCount":"6k","symbolsTime":"5 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}