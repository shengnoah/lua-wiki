{"title":"Nginx+lua组建基础waf防火墙","uid":"ddb5e4c9c3c745d9ecc07c0486b685e8","slug":"zl/2016-01-01-341_Nginx+lua组建基础waf防火墙","date":"2024-04-03T03:47:35.617Z","updated":"2024-04-03T03:47:35.621Z","comments":true,"path":"api/articles/zl/2016-01-01-341_Nginx+lua组建基础waf防火墙.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<h2 id=\"一、nginx-Lua环境部署\"><a href=\"#一、nginx-Lua环境部署\" class=\"headerlink\" title=\"一、nginx+Lua环境部署\"></a>一、nginx+Lua环境部署</h2><h3 id=\"1、系统基础信息\"><a href=\"#1、系统基础信息\" class=\"headerlink\" title=\"1、系统基础信息\"></a>1、系统基础信息</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br/><span class=\"line\">192.168.83.129</span><br/><span class=\"line\"><span class=\"comment\"># cat /etc/redhat-release</span></span><br/><span class=\"line\">CentOS release 6.5 (Final)</span><br/><span class=\"line\"><span class=\"comment\"># uname -r</span></span><br/><span class=\"line\">2.6.32-431.el6.x86_64</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"2、安装基础库\"><a href=\"#2、安装基础库\" class=\"headerlink\" title=\"2、安装基础库\"></a>2、安装基础库</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">yum -y install gcc gcc-c++</span><br/><span class=\"line\">yum -y install openssl openssl-devel</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"3、创建Nginx运行的普通用户\"><a href=\"#3、创建Nginx运行的普通用户\" class=\"headerlink\" title=\"3、创建Nginx运行的普通用户\"></a>3、创建Nginx运行的普通用户</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">useradd -s /sbin/nologin -M www</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"4、下载需要的程序并安装\"><a href=\"#4、下载需要的程序并安装\" class=\"headerlink\" title=\"4、下载需要的程序并安装\"></a>4、下载需要的程序并安装</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/src/</span><br/><span class=\"line\">wget http://nginx.org/download/nginx-1.9.4.tar.gz</span><br/><span class=\"line\">wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.38.tar.gz</span><br/><span class=\"line\">wget -c http://luajit.org/download/LuaJIT-2.0.4.tar.gz</span><br/><span class=\"line\">wget https://github.com/simpl/ngx_devel_kit/archive/v0.2.19.tar.gz</span><br/><span class=\"line\">wget https://github.com/openresty/lua-nginx-module/archive/v0.9.16.tar.gz</span><br/><span class=\"line\">tar zxvf ngx_devel_kit-0.2.19.tar.gz</span><br/><span class=\"line\">tar zxvf lua-nginx-module-0.9.16.tar.gz</span><br/><span class=\"line\">tar zxvf pcre-8.38.tar.gz</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"5、安装LuaJIT-Luajit是Lua即时编译器\"><a href=\"#5、安装LuaJIT-Luajit是Lua即时编译器\" class=\"headerlink\" title=\"5、安装LuaJIT Luajit是Lua即时编译器\"></a>5、安装LuaJIT Luajit是Lua即时编译器</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">tar zxvf LuaJIT-2.0.4.tar.gz</span><br/><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/src/LuaJIT-2.0.4</span><br/><span class=\"line\">make &amp;&amp; make install</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"6、安装nginx并加载模块\"><a href=\"#6、安装nginx并加载模块\" class=\"headerlink\" title=\"6、安装nginx并加载模块\"></a>6、安装nginx并加载模块</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> nginx-1.9.4/</span><br/><span class=\"line\"><span class=\"built_in\">export</span> LUAJIT_LIB=/usr/<span class=\"built_in\">local</span>/lib</span><br/><span class=\"line\"><span class=\"built_in\">export</span> LUAJIT_INC=/usr/<span class=\"built_in\">local</span>/include/luajit-2.0/</span><br/><span class=\"line\">./configure --prefix=/usr/<span class=\"built_in\">local</span>/nginx --user=www --group=www     --with-http_ssl_module --with-http_stub_status_module --with-file-aio --with-http_dav_module --add-module=../ngx_devel_kit-0.2.19/ --add-module=../lua-nginx-module-0.9.16/ --with-pcre=/usr/<span class=\"built_in\">local</span>/src/pcre-8.38/</span><br/><span class=\"line\">make -j2 &amp;&amp; make install</span><br/><span class=\"line\">ln -s /usr/<span class=\"built_in\">local</span>/lib/libluajit-5.1.so.2 /lib64/libluajit-5.1.so.2</span><br/></pre></td></tr></tbody></table></figure>\n<p>安装完毕后，下面可以测试安装了，修改nginx.conf 增加第一个配置<br/></p><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/><span class=\"line\">13</span><br/><span class=\"line\">14</span><br/><span class=\"line\">15</span><br/><span class=\"line\">16</span><br/><span class=\"line\">17</span><br/><span class=\"line\">18</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">   server {</span><br/><span class=\"line\">       listen       80;</span><br/><span class=\"line\">       server_name  localhost;</span><br/><span class=\"line\">    </span><br/><span class=\"line\">       <span class=\"comment\">#charset koi8-r;</span></span><br/><span class=\"line\">    </span><br/><span class=\"line\">       <span class=\"comment\">#access_log  logs/host.access.log  main;</span></span><br/><span class=\"line\">    </span><br/><span class=\"line\">        location /hello {</span><br/><span class=\"line\">               default_type <span class=\"string\">&#39;text/plain&#39;</span>;</span><br/><span class=\"line\">               content_by_lua <span class=\"string\">&#39;ngx.say(&#34;hello,lua&#34;)&#39;</span>;</span><br/><span class=\"line\">       }</span><br/><span class=\"line\">       </span><br/><span class=\"line\">       error_page   500 502 503 504  /50x.html;</span><br/><span class=\"line\">       location = /50x.html {</span><br/><span class=\"line\">       root   html;</span><br/><span class=\"line\">   \t}</span><br/><span class=\"line\">}</span><br/></pre></td></tr></tbody></table></figure><p></p>\n<p>启动nginx<br/></p><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/<span class=\"built_in\">local</span>/nginx/sbin/nginx -t</span><br/><span class=\"line\">    nginx: the configuration file /usr/<span class=\"built_in\">local</span>/nginx/conf/nginx.conf syntax is ok</span><br/><span class=\"line\">    nginx: configuration file /usr/<span class=\"built_in\">local</span>/nginx/conf/nginx.conf <span class=\"built_in\">test</span> is successful</span><br/><span class=\"line\">/usr/<span class=\"built_in\">local</span>/nginx/sbin/nginx</span><br/></pre></td></tr></tbody></table></figure><p></p>\n<h3 id=\"7、测试看lua环境是否正常\"><a href=\"#7、测试看lua环境是否正常\" class=\"headerlink\" title=\"7、测试看lua环境是否正常\"></a>7、测试看lua环境是否正常</h3><p><img src=\"https://francisblogstatic.oss-cn-shanghai.aliyuncs.com/images/20181210013.png\" alt=\"Alt text\"/></p>\n<h2 id=\"二、openresty实现WAF功能\"><a href=\"#二、openresty实现WAF功能\" class=\"headerlink\" title=\"二、openresty实现WAF功能\"></a>二、openresty实现WAF功能</h2><h3 id=\"1、系统基础信息-1\"><a href=\"#1、系统基础信息-1\" class=\"headerlink\" title=\"1、系统基础信息\"></a>1、系统基础信息</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br/><span class=\"line\">192.168.83.129</span><br/><span class=\"line\"><span class=\"comment\"># cat /etc/redhat-release</span></span><br/><span class=\"line\">CentOS release 6.5 (Final)</span><br/><span class=\"line\"><span class=\"comment\"># uname -r</span></span><br/><span class=\"line\">2.6.32-431.el6.x86_64</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"2、安装基础依赖包\"><a href=\"#2、安装基础依赖包\" class=\"headerlink\" title=\"2、安装基础依赖包\"></a>2、安装基础依赖包</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y readline-devel pcre-devel openssl-devel</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"3、下载并编译安装openresty\"><a href=\"#3、下载并编译安装openresty\" class=\"headerlink\" title=\"3、下载并编译安装openresty\"></a>3、下载并编译安装openresty</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/src/</span><br/><span class=\"line\">wget https://openresty.org/download/ngx_openresty-1.9.3.2.tar.gz</span><br/><span class=\"line\">tar zxvf ngx_openresty-1.9.3.2.tar.gz</span><br/><span class=\"line\"><span class=\"built_in\">cd</span> ngx_openresty-1.9.3.2</span><br/><span class=\"line\">./configure --prefix=/usr/<span class=\"built_in\">local</span>/openresty-1.9.3.2 --with-luajit --with-http_stub_status_module --with-pcre --with-pcre-jit</span><br/><span class=\"line\">gmake &amp;&amp; gmake install</span><br/><span class=\"line\">ln -s /usr/<span class=\"built_in\">local</span>/openresty-1.9.3.2/ /usr/<span class=\"built_in\">local</span>/openresty</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"4、测试openresty安装\"><a href=\"#4、测试openresty安装\" class=\"headerlink\" title=\"4、测试openresty安装\"></a>4、测试openresty安装</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/><span class=\"line\">13</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /usr/local/openresty/nginx/conf/nginx.conf</span></span><br/><span class=\"line\">    server {</span><br/><span class=\"line\">        location /hello {</span><br/><span class=\"line\">                default_type text/html;</span><br/><span class=\"line\">                content_by_lua_block {</span><br/><span class=\"line\">                    ngx.say(<span class=\"string\">&#34;HelloWorld&#34;</span>)</span><br/><span class=\"line\">                }</span><br/><span class=\"line\">            }</span><br/><span class=\"line\">    }</span><br/><span class=\"line\"><span class=\"comment\"># /usr/local/openresty/nginx/sbin/nginx -t</span></span><br/><span class=\"line\">    nginx: the configuration file /usr/<span class=\"built_in\">local</span>/openresty-1.9.3.2/nginx/conf/nginx.conf syntax is ok</span><br/><span class=\"line\">    nginx: configuration file /usr/<span class=\"built_in\">local</span>/openresty-1.9.3.2/nginx/conf/nginx.conf <span class=\"built_in\">test</span> is successful</span><br/><span class=\"line\"><span class=\"comment\"># /usr/local/openresty/nginx/sbin/nginx</span></span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"5、WAF部署：在github上克隆下代码\"><a href=\"#5、WAF部署：在github上克隆下代码\" class=\"headerlink\" title=\"5、WAF部署：在github上克隆下代码\"></a>5、WAF部署：在github上克隆下代码</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">yum -y install git</span><br/><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/openresty/nginx/conf/</span><br/><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/unixhot/waf.git</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"6、修改Nginx的配置文件，加入（http字段）以下配置。注意路径，同时WAF日志默认存放在-tmp-日期-waf-log\"><a href=\"#6、修改Nginx的配置文件，加入（http字段）以下配置。注意路径，同时WAF日志默认存放在-tmp-日期-waf-log\" class=\"headerlink\" title=\"6、修改Nginx的配置文件，加入（http字段）以下配置。注意路径，同时WAF日志默认存放在/tmp/日期_waf.log\"></a>6、修改Nginx的配置文件，加入（http字段）以下配置。注意路径，同时WAF日志默认存放在/tmp/日期_waf.log</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/><span class=\"line\">13</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /usr/local/openresty/nginx/conf/nginx.conf</span></span><br/><span class=\"line\">    http {</span><br/><span class=\"line\">        include       mime.types;</span><br/><span class=\"line\">        default_type  application/octet-stream;</span><br/><span class=\"line\">    <span class=\"comment\">#WAF</span></span><br/><span class=\"line\">        lua_shared_dict <span class=\"built_in\">limit</span> 50m;</span><br/><span class=\"line\">        lua_package_path <span class=\"string\">&#34;/usr/local/openresty/nginx/conf/waf/?.lua&#34;</span>;</span><br/><span class=\"line\">        init_by_lua_file <span class=\"string\">&#34;/usr/local/openresty/nginx/conf/waf/init.lua&#34;</span>;</span><br/><span class=\"line\">        access_by_lua_file <span class=\"string\">&#34;/usr/local/openresty/nginx/conf/waf/access.lua&#34;</span>;</span><br/><span class=\"line\"><span class=\"comment\"># /usr/local/openresty/nginx/sbin/nginx -t</span></span><br/><span class=\"line\">    nginx: the configuration file /usr/<span class=\"built_in\">local</span>/openresty-1.9.3.2/nginx/conf/nginx.conf syntax is ok</span><br/><span class=\"line\">    nginx: configuration file /usr/<span class=\"built_in\">local</span>/openresty-1.9.3.2/nginx/conf/nginx.conf <span class=\"built_in\">test</span> is successful</span><br/><span class=\"line\"><span class=\"comment\"># /usr/local/openresty/nginx/sbin/nginx -s reload</span></span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"7、根据日志记录位置，创建日志目录\"><a href=\"#7、根据日志记录位置，创建日志目录\" class=\"headerlink\" title=\"7、根据日志记录位置，创建日志目录\"></a>7、根据日志记录位置，创建日志目录</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># mkdir /tmp/waf_logs</span></span><br/><span class=\"line\"><span class=\"comment\"># chown www.www /tmp/waf_logs</span></span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"8、配置信息与注释\"><a href=\"#8、配置信息与注释\" class=\"headerlink\" title=\"8、配置信息与注释\"></a>8、配置信息与注释</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/><span class=\"line\">13</span><br/><span class=\"line\">14</span><br/><span class=\"line\">15</span><br/><span class=\"line\">16</span><br/><span class=\"line\">17</span><br/><span class=\"line\">18</span><br/><span class=\"line\">19</span><br/><span class=\"line\">20</span><br/><span class=\"line\">21</span><br/><span class=\"line\">22</span><br/><span class=\"line\">23</span><br/><span class=\"line\">24</span><br/><span class=\"line\">25</span><br/><span class=\"line\">26</span><br/><span class=\"line\">27</span><br/><span class=\"line\">28</span><br/><span class=\"line\">29</span><br/><span class=\"line\">30</span><br/><span class=\"line\">31</span><br/><span class=\"line\">32</span><br/><span class=\"line\">33</span><br/><span class=\"line\">34</span><br/><span class=\"line\">35</span><br/><span class=\"line\">36</span><br/><span class=\"line\">37</span><br/><span class=\"line\">38</span><br/><span class=\"line\">39</span><br/><span class=\"line\">40</span><br/><span class=\"line\">41</span><br/><span class=\"line\">42</span><br/><span class=\"line\">43</span><br/><span class=\"line\">44</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cat /usr/local/openresty/nginx/conf/waf/config.lua</span></span><br/><span class=\"line\">--WAF config file,<span class=\"built_in\">enable</span> = <span class=\"string\">&#34;on&#34;</span>,<span class=\"built_in\">disable</span> = <span class=\"string\">&#34;off&#34;</span> </span><br/><span class=\"line\"> --waf status    </span><br/><span class=\"line\"> config_waf_enable = <span class=\"string\">&#34;on&#34;</span>   <span class=\"comment\">#是否开启配置</span></span><br/><span class=\"line\"> --<span class=\"built_in\">log</span> dir </span><br/><span class=\"line\"> config_log_dir = <span class=\"string\">&#34;/tmp/waf_logs&#34;</span>    <span class=\"comment\">#日志记录地址</span></span><br/><span class=\"line\"> --rule setting </span><br/><span class=\"line\"> config_rule_dir = <span class=\"string\">&#34;/usr/local/nginx/conf/waf/rule-config&#34;</span>        <span class=\"comment\">#匹配规则缩放地址</span></span><br/><span class=\"line\"> --<span class=\"built_in\">enable</span>/<span class=\"built_in\">disable</span> white url </span><br/><span class=\"line\"> config_white_url_check = <span class=\"string\">&#34;on&#34;</span>  <span class=\"comment\">#是否开启url检测</span></span><br/><span class=\"line\"> --<span class=\"built_in\">enable</span>/<span class=\"built_in\">disable</span> white ip </span><br/><span class=\"line\"> config_white_ip_check = <span class=\"string\">&#34;on&#34;</span>   <span class=\"comment\">#是否开启IP白名单检测</span></span><br/><span class=\"line\"> --<span class=\"built_in\">enable</span>/<span class=\"built_in\">disable</span> block ip </span><br/><span class=\"line\"> config_black_ip_check = <span class=\"string\">&#34;on&#34;</span>   <span class=\"comment\">#是否开启ip黑名单检测</span></span><br/><span class=\"line\"> --<span class=\"built_in\">enable</span>/<span class=\"built_in\">disable</span> url filtering </span><br/><span class=\"line\"> config_url_check = <span class=\"string\">&#34;on&#34;</span>      <span class=\"comment\">#是否开启url过滤</span></span><br/><span class=\"line\"> --enalbe/<span class=\"built_in\">disable</span> url args filtering </span><br/><span class=\"line\"> config_url_args_check = <span class=\"string\">&#34;on&#34;</span>   <span class=\"comment\">#是否开启参数检测</span></span><br/><span class=\"line\"> --<span class=\"built_in\">enable</span>/<span class=\"built_in\">disable</span> user agent filtering </span><br/><span class=\"line\"> config_user_agent_check = <span class=\"string\">&#34;on&#34;</span>  <span class=\"comment\">#是否开启ua检测</span></span><br/><span class=\"line\"> --<span class=\"built_in\">enable</span>/<span class=\"built_in\">disable</span> cookie deny filtering </span><br/><span class=\"line\"> config_cookie_check = <span class=\"string\">&#34;on&#34;</span>    <span class=\"comment\">#是否开启cookie检测</span></span><br/><span class=\"line\"> --<span class=\"built_in\">enable</span>/<span class=\"built_in\">disable</span> cc filtering </span><br/><span class=\"line\"> config_cc_check = <span class=\"string\">&#34;on&#34;</span>   <span class=\"comment\">#是否开启防cc攻击</span></span><br/><span class=\"line\"> --cc rate the xxx of xxx seconds </span><br/><span class=\"line\"> config_cc_rate = <span class=\"string\">&#34;10/60&#34;</span>   <span class=\"comment\">#允许一个ip60秒内只能访问10此</span></span><br/><span class=\"line\"> --<span class=\"built_in\">enable</span>/<span class=\"built_in\">disable</span> post filtering </span><br/><span class=\"line\"> config_post_check = <span class=\"string\">&#34;on&#34;</span>   <span class=\"comment\">#是否开启post检测</span></span><br/><span class=\"line\"> --config waf output redirect/html </span><br/><span class=\"line\"> config_waf_output = <span class=\"string\">&#34;html&#34;</span>  <span class=\"comment\">#action一个html页面，也可以选择跳转</span></span><br/><span class=\"line\"> --<span class=\"keyword\">if</span> config_waf_output ,setting url </span><br/><span class=\"line\"> config_waf_redirect_url = <span class=\"string\">&#34;http://www.baidu.com&#34;</span> </span><br/><span class=\"line\"> config_output_html=[[  <span class=\"comment\">#下面是html的内容</span></span><br/><span class=\"line\"> \t&lt;html&gt; </span><br/><span class=\"line\"> &lt;head&gt; </span><br/><span class=\"line\"> &lt;meta http-equiv=<span class=\"string\">&#34;Content-Type&#34;</span> content=<span class=\"string\">&#34;text/html; charset=utf-8&#34;</span> /&gt; </span><br/><span class=\"line\"> &lt;meta http-equiv=<span class=\"string\">&#34;Content-Language&#34;</span> content=<span class=\"string\">&#34;zh-cn&#34;</span> /&gt; </span><br/><span class=\"line\"> &lt;title&gt;网站防火墙&lt;/title&gt; </span><br/><span class=\"line\"> &lt;/head&gt; </span><br/><span class=\"line\"> &lt;body&gt; </span><br/><span class=\"line\"> &lt;h1 align=<span class=\"string\">&#34;center&#34;</span>&gt; <span class=\"comment\"># 您的行为已违反本网站相关规定，注意操作规范。 </span></span><br/><span class=\"line\"> &lt;/body&gt; </span><br/><span class=\"line\"> &lt;/html&gt; </span><br/><span class=\"line\"> ]]</span><br/></pre></td></tr></tbody></table></figure>\n<h2 id=\"三、启用waf并做测试\"><a href=\"#三、启用waf并做测试\" class=\"headerlink\" title=\"三、启用waf并做测试\"></a>三、启用waf并做测试</h2><h3 id=\"1、模拟sql注入即url攻击\"><a href=\"#1、模拟sql注入即url攻击\" class=\"headerlink\" title=\"1、模拟sql注入即url攻击\"></a>1、模拟sql注入即url攻击</h3><p><img src=\"https://francisblogstatic.oss-cn-shanghai.aliyuncs.com/images/20181210014.png\" alt=\"Alt text\"/><br/>日志显示如下,记录了UA，匹配规则，URL，客户端类型，攻击的类型，请求的数据<br/></p><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># tail -f /tmp/2018-07-30_waf.log</span></span><br/><span class=\"line\">{<span class=\"string\">&#34;user_agent&#34;</span>:<span class=\"string\">&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36&#34;</span>,<span class=\"string\">&#34;rule_tag&#34;</span>:<span class=\"string\">&#34;\\.(bak|inc|old|mdb|sql|backup|java|class|tgz|gz|tar|zip)$&#34;</span>,<span class=\"string\">&#34;req_url&#34;</span>:<span class=\"string\">&#34;/eastmonet.sql&#34;</span>,<span class=\"string\">&#34;client_ip&#34;</span>:<span class=\"string\">&#34;192.168.83.1&#34;</span>,<span class=\"string\">&#34;local_time&#34;</span>:<span class=\"string\">&#34;2018-07-30 10:46:52&#34;</span>,<span class=\"string\">&#34;attack_method&#34;</span>:<span class=\"string\">&#34;Deny_URL&#34;</span>,<span class=\"string\">&#34;req_data&#34;</span>:<span class=\"string\">&#34;-&#34;</span>,<span class=\"string\">&#34;server_name&#34;</span>:<span class=\"string\">&#34;localhost&#34;</span>}</span><br/></pre></td></tr></tbody></table></figure><p></p>\n<h3 id=\"2、使用ab压力测试工具模拟防CC攻击\"><a href=\"#2、使用ab压力测试工具模拟防CC攻击\" class=\"headerlink\" title=\"2、使用ab压力测试工具模拟防CC攻击\"></a>2、使用ab压力测试工具模拟防CC攻击</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br/><span class=\"line\">192.168.83.131</span><br/></pre></td></tr></tbody></table></figure>\n<p><img src=\"https://francisblogstatic.oss-cn-shanghai.aliyuncs.com/images/20181210015.png\" alt=\"Alt text\" title=\"Francis&#39;Blog\"/><br/>将对方IP放入黑名单<br/></p><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># echo 192.168.83.131 &gt;&gt; /usr/local/openresty/nginx/conf/waf/rule-config/blackip.rule</span></span><br/><span class=\"line\"><span class=\"comment\"># /usr/local/openresty/nginx/sbin/nginx -s reload</span></span><br/></pre></td></tr></tbody></table></figure><p></p>\n<p>再拿192.168.83.131访问的时候就提示403了<br/><img src=\"https://francisblogstatic.oss-cn-shanghai.aliyuncs.com/images/20181210016.png\" alt=\"Alt text\" title=\"Francis&#39;Blog\"/><br/>将对方IP放入白名单<br/></p><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tiejiang-src1 ~]<span class=\"comment\"># echo 192.168.83.131 &gt;&gt; /usr/local/openresty/nginx/conf/waf/rule-config/whiteip.rule</span></span><br/><span class=\"line\">[root@tiejiang-src1 ~]<span class=\"comment\"># /usr/local/openresty/nginx/sbin/nginx -s reload</span></span><br/></pre></td></tr></tbody></table></figure><p></p>\n<p>此时将不对此ip进行任何防护措施，所以sql注入时应该返回404<br/><img src=\"https://francisblogstatic.oss-cn-shanghai.aliyuncs.com/images/20181210017.png\" alt=\"Alt text\" title=\"Francis&#39;Blog\"/><br/>目录：</p>\n<ul>\n<li>waf目录：/usr/local/openresty/nginx/conf/waf</li>\n<li>配置文件：/usr/local/openresty/nginx/conf/waf/config.lua</li>\n<li>Waf的ip黑名单：/usr/local/openresty/nginx/conf/waf/rule-config/blackip.rule</li>\n<li>Waf的ip白名单：/usr/local/openresty/nginx/conf/waf/rule-config/whiteip.rule</li>\n</ul>","text":"一、nginx+Lua环境部署1、系统基础信息123456192.168.83.129# cat /etc/redhat-releaseCentOS release 6.5 (Final)# uname -r2.6.32-431.el6.x86_64 2、安装基础库12yum -...","link":"","photos":[],"count_time":{"symbolsCount":"7.2k","symbolsTime":"7 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%B8%80%E3%80%81nginx-Lua%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2\"><span class=\"toc-text\">一、nginx+Lua环境部署</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1%E3%80%81%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E4%BF%A1%E6%81%AF\"><span class=\"toc-text\">1、系统基础信息</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2%E3%80%81%E5%AE%89%E8%A3%85%E5%9F%BA%E7%A1%80%E5%BA%93\"><span class=\"toc-text\">2、安装基础库</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3%E3%80%81%E5%88%9B%E5%BB%BANginx%E8%BF%90%E8%A1%8C%E7%9A%84%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7\"><span class=\"toc-text\">3、创建Nginx运行的普通用户</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#4%E3%80%81%E4%B8%8B%E8%BD%BD%E9%9C%80%E8%A6%81%E7%9A%84%E7%A8%8B%E5%BA%8F%E5%B9%B6%E5%AE%89%E8%A3%85\"><span class=\"toc-text\">4、下载需要的程序并安装</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5%E3%80%81%E5%AE%89%E8%A3%85LuaJIT-Luajit%E6%98%AFLua%E5%8D%B3%E6%97%B6%E7%BC%96%E8%AF%91%E5%99%A8\"><span class=\"toc-text\">5、安装LuaJIT Luajit是Lua即时编译器</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#6%E3%80%81%E5%AE%89%E8%A3%85nginx%E5%B9%B6%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97\"><span class=\"toc-text\">6、安装nginx并加载模块</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#7%E3%80%81%E6%B5%8B%E8%AF%95%E7%9C%8Blua%E7%8E%AF%E5%A2%83%E6%98%AF%E5%90%A6%E6%AD%A3%E5%B8%B8\"><span class=\"toc-text\">7、测试看lua环境是否正常</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BA%8C%E3%80%81openresty%E5%AE%9E%E7%8E%B0WAF%E5%8A%9F%E8%83%BD\"><span class=\"toc-text\">二、openresty实现WAF功能</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1%E3%80%81%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E4%BF%A1%E6%81%AF-1\"><span class=\"toc-text\">1、系统基础信息</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2%E3%80%81%E5%AE%89%E8%A3%85%E5%9F%BA%E7%A1%80%E4%BE%9D%E8%B5%96%E5%8C%85\"><span class=\"toc-text\">2、安装基础依赖包</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3%E3%80%81%E4%B8%8B%E8%BD%BD%E5%B9%B6%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85openresty\"><span class=\"toc-text\">3、下载并编译安装openresty</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#4%E3%80%81%E6%B5%8B%E8%AF%95openresty%E5%AE%89%E8%A3%85\"><span class=\"toc-text\">4、测试openresty安装</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5%E3%80%81WAF%E9%83%A8%E7%BD%B2%EF%BC%9A%E5%9C%A8github%E4%B8%8A%E5%85%8B%E9%9A%86%E4%B8%8B%E4%BB%A3%E7%A0%81\"><span class=\"toc-text\">5、WAF部署：在github上克隆下代码</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#6%E3%80%81%E4%BF%AE%E6%94%B9Nginx%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%8C%E5%8A%A0%E5%85%A5%EF%BC%88http%E5%AD%97%E6%AE%B5%EF%BC%89%E4%BB%A5%E4%B8%8B%E9%85%8D%E7%BD%AE%E3%80%82%E6%B3%A8%E6%84%8F%E8%B7%AF%E5%BE%84%EF%BC%8C%E5%90%8C%E6%97%B6WAF%E6%97%A5%E5%BF%97%E9%BB%98%E8%AE%A4%E5%AD%98%E6%94%BE%E5%9C%A8-tmp-%E6%97%A5%E6%9C%9F-waf-log\"><span class=\"toc-text\">6、修改Nginx的配置文件，加入（http字段）以下配置。注意路径，同时WAF日志默认存放在&#x2F;tmp&#x2F;日期_waf.log</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#7%E3%80%81%E6%A0%B9%E6%8D%AE%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E4%BD%8D%E7%BD%AE%EF%BC%8C%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E7%9B%AE%E5%BD%95\"><span class=\"toc-text\">7、根据日志记录位置，创建日志目录</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#8%E3%80%81%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E4%B8%8E%E6%B3%A8%E9%87%8A\"><span class=\"toc-text\">8、配置信息与注释</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%B8%89%E3%80%81%E5%90%AF%E7%94%A8waf%E5%B9%B6%E5%81%9A%E6%B5%8B%E8%AF%95\"><span class=\"toc-text\">三、启用waf并做测试</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1%E3%80%81%E6%A8%A1%E6%8B%9Fsql%E6%B3%A8%E5%85%A5%E5%8D%B3url%E6%94%BB%E5%87%BB\"><span class=\"toc-text\">1、模拟sql注入即url攻击</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2%E3%80%81%E4%BD%BF%E7%94%A8ab%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7%E6%A8%A1%E6%8B%9F%E9%98%B2CC%E6%94%BB%E5%87%BB\"><span class=\"toc-text\">2、使用ab压力测试工具模拟防CC攻击</span></a></li></ol></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Redis lua 脚本简述","uid":"cbe59be328103b88b33e74beb07f1009","slug":"zl/2016-01-01-342_Redis lua 脚本简述","date":"2024-04-03T03:47:35.621Z","updated":"2024-04-03T03:47:35.622Z","comments":true,"path":"api/articles/zl/2016-01-01-342_Redis lua 脚本简述.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"前言从2.6.0版开始，Redis增加了对Lua运行环境的支持。在了解Redis lua 脚本使用前，最好能够了解 lua 的语言基础。 本篇包含如下 lua 脚本内容： Redis加载（初始化lua运行环境） Lua与Redis数据类型的转换 脚本命令执行分析 脚本执行过程分析...","link":"","photos":[],"count_time":{"symbolsCount":"8.3k","symbolsTime":"8 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"lua表访问跟踪","uid":"e030a4ac09fbb79af10ae1308131b316","slug":"zl/2016-01-01-33_lua表访问跟踪","date":"2024-04-03T03:47:35.616Z","updated":"2024-04-03T03:47:35.616Z","comments":true,"path":"api/articles/zl/2016-01-01-33_lua表访问跟踪.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"当访问一个 table 或者更新 table 中的某个元素时，lua 首先会在 table 查找是否存在该元素，如果没有，就会查找 table 是否存在 index(访问) 或者 newindex(更新) 原方法。以访问为例，首先在 table 中查找某个字段，如果不存在，解释器...","link":"","photos":[],"count_time":{"symbolsCount":"1.3k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}