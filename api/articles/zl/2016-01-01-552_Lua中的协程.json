{"title":"Lua中的协程","uid":"4d0a91799dda866fbb32a60943831f1f","slug":"zl/2016-01-01-552_Lua中的协程","date":"2024-04-03T03:47:35.818Z","updated":"2024-04-03T03:47:35.818Z","comments":true,"path":"api/articles/zl/2016-01-01-552_Lua中的协程.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<p>Lua中的协程和其他变量一样，都是第一类值（first-class alue），可以被保存在变量中，可以被作为参数传递，可以被函数返回。<br/>\n协程有4种状态：挂起（suspended），运行（running），死亡（dead）和正常（normal）。\nLua为协程提供了3个基础接口：create，resume和yield。</p>\n<p>#coroutine.create</p>\n<ul>\n  <li>创建一个新的协程，并为它的运行分配一个独立的栈</li>\n  <li>协程处于挂起状态（suspended）</li>\n  <li>接受一个函数作为参数，这个函数就是协程的主程序块</li>\n  <li>返回这个协程</li>\n  <li>挂起点被设置为主程序块的第一句</li>\n</ul>\n<p>#coroutine.resume</p>\n<ul>\n  <li>启动一个协程（第一次启动或从暂停状态启动）</li>\n  <li>自身（如果是协程的话）处于正常状态，被启动的协程处于运行状态</li>\n  <li>第一个参数为所要启动的协程</li>\n  <li>协程从它的挂起点开始执行</li>\n  <li>一直执行到被挂起或终止</li>\n  <li>导致协程终止的情况有两种：它的主程序块正常返回、运行过程中出错</li>\n  <li>执行结束后，控制权递交给此协程被激活的地方</li>\n</ul>\n<p>#coroutine.yield</p>\n<ul>\n  <li>挂起一个协程</li>\n  <li>协程处于挂起状态</li>\n  <li>协程的运行状态被记录</li>\n  <li>激活它的那个coroutine.resume返回</li>\n</ul>\n<hr/>\n<p>#协程间通信</p>\n<ul>\n  <li>协程第一次被启动时，传递给coroutine.resume的参数将传递给协程的主程序</li>\n  <li>协程挂起时，传递给coroutine.yield的参数将作为上次启动它的coroutine.resume的返回值返回</li>\n  <li>协程被再次启动时，传递给coroutine.resume的参数将作为上次挂起它的coroutine.yield的返回值返回</li>\n  <li>协程死亡时，主程序返回的值将作为上次启动它的coroutine.resume的返回值返回</li>\n</ul>\n<hr/>\n<p>#实验</p>\n<p>##状态</p>\n<figure class=\"highlight\"><pre><code class=\"language-lua\" data-lang=\"lua\"><span class=\"kd\">local</span> <span class=\"k\">function</span> <span class=\"nf\">status</span><span class=\"p\">(</span><span class=\"n\">str</span><span class=\"p\">,</span> <span class=\"n\">c</span><span class=\"p\">)</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">str</span><span class=\"p\">,</span> <span class=\"nb\">coroutine.status</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">))</span>\n<span class=\"k\">end</span>\n<p><span class=\"kd\">local</span> <span class=\"n\">c1</span><span class=\"p\">,</span><span class=\"n\">c2</span><br />\n<span class=\"n\">c1</span> <span class=\"o\">=</span> <span class=\"nb\">coroutine.create</span><span class=\"p\">(</span><span class=\"k\">function</span><span class=\"p\">()</span><br />\n<span class=\"n\">status</span><span class=\"p\">(</span><span class=\"s2\">&quot;&lt;c2&gt;&quot;</span><span class=\"p\">,</span> <span class=\"n\">c2</span><span class=\"p\">)</span><br />\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;before c1 yield&quot;</span><span class=\"p\">)</span><br />\n<span class=\"nb\">coroutine.yield</span><span class=\"p\">()</span><br />\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;after c1 yield&quot;</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span><span class=\"p\">)</span><br />\n<span class=\"n\">c2</span> <span class=\"o\">=</span> <span class=\"nb\">coroutine.create</span><span class=\"p\">(</span><span class=\"k\">function</span><span class=\"p\">()</span><br />\n<span class=\"n\">status</span><span class=\"p\">(</span><span class=\"s2\">&quot;&lt;c2&gt;&quot;</span><span class=\"p\">,</span> <span class=\"n\">c2</span><span class=\"p\">)</span><br />\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;before c2 resume c1&quot;</span><span class=\"p\">)</span><br />\n<span class=\"nb\">coroutine.resume</span><span class=\"p\">(</span><span class=\"n\">c1</span><span class=\"p\">)</span><br />\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;after c2 resume c1&quot;</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span><span class=\"p\">)</span></p>\n<p><span class=\"n\">status</span><span class=\"p\">(</span><span class=\"s2\">&quot;&lt;c2&gt;&quot;</span><span class=\"p\">,</span> <span class=\"n\">c2</span><span class=\"p\">)</span><br />\n<span class=\"nb\">coroutine.resume</span><span class=\"p\">(</span><span class=\"n\">c2</span><span class=\"p\">)</span><br />\n<span class=\"n\">status</span><span class=\"p\">(</span><span class=\"s2\">&quot;&lt;c1&gt;&quot;</span><span class=\"p\">,</span> <span class=\"n\">c1</span><span class=\"p\">)</span><br />\n<span class=\"n\">status</span><span class=\"p\">(</span><span class=\"s2\">&quot;&lt;c2&gt;&quot;</span><span class=\"p\">,</span> <span class=\"n\">c2</span><span class=\"p\">)</span><br />\n<span class=\"nb\">coroutine.resume</span><span class=\"p\">(</span><span class=\"n\">c1</span><span class=\"p\">)</span><br />\n<span class=\"n\">status</span><span class=\"p\">(</span><span class=\"s2\">&quot;&lt;c1&gt;&quot;</span><span class=\"p\">,</span> <span class=\"n\">c1</span><span class=\"p\">)</span></code></pre></figure></p>\n<p>输出：</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>outsky@x201:~/tmp$ lua test.lua \n&lt;c2&gt;\tsuspended\n&lt;c2&gt;\trunning\nbefore c2 resume c1\n&lt;c2&gt;\tnormal\nbefore c1 yield\nafter c2 resume c1\n&lt;c1&gt;\tsuspended\n&lt;c2&gt;\tdead\nafter c1 yield\n&lt;c1&gt;\tdead\n</code></pre></div></div>\n<hr/>\n<p>##通信</p>\n<figure class=\"highlight\"><pre><code class=\"language-lua\" data-lang=\"lua\"><span class=\"kd\">local</span> <span class=\"n\">c</span> <span class=\"o\">=</span> <span class=\"nb\">coroutine.create</span><span class=\"p\">(</span><span class=\"k\">function</span><span class=\"p\">(</span><span class=\"o\">...</span><span class=\"p\">)</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&#34;c start:&#34;</span><span class=\"p\">,</span> <span class=\"o\">...</span><span class=\"p\">)</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&#34;c yield return:&#34;</span><span class=\"p\">,</span> <span class=\"nb\">coroutine.yield</span><span class=\"p\">(</span><span class=\"s2\">&#34;c yield&#34;</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"s2\">&#34;c dead&#34;</span>\n<span class=\"k\">end</span><span class=\"p\">)</span>\n<p><span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;main start c&quot;</span><span class=\"p\">)</span><br />\n<span class=\"kd\">local</span> <span class=\"n\">_</span><span class=\"p\">,</span><span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"nb\">coroutine.resume</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">,</span> <span class=\"s2\">&quot;main start c&quot;</span><span class=\"p\">)</span><br />\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;main resume return:&quot;</span><span class=\"p\">,</span> <span class=\"n\">r</span><span class=\"p\">)</span></p>\n<p><span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;--------&quot;</span><span class=\"p\">)</span></p>\n<p><span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;main resume c&quot;</span><span class=\"p\">)</span><br />\n<span class=\"n\">_</span><span class=\"p\">,</span><span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"nb\">coroutine.resume</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">,</span> <span class=\"s2\">&quot;main resume c&quot;</span><span class=\"p\">)</span><br />\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;main resume return again:&quot;</span><span class=\"p\">,</span> <span class=\"n\">r</span><span class=\"p\">)</span></code></pre></figure></p>\n<p>输出：</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>outsky@x201:~/tmp$ lua test.lua \nmain start c\nc start:\tmain start c\nmain resume return:\tc yield\n--------\nmain resume c\nc yield return:\tmain resume c\nmain resume return again:\tc dead\n</code></pre></div></div>","text":"Lua中的协程和其他变量一样，都是第一类值（first-class alue），可以被保存在变量中，可以被作为参数传递，可以被函数返回。 协程有4种状态：挂起（suspended），运行（running），死亡（dead）和正常（normal）。 Lua为协程提供了3个基础接口：...","link":"","photos":[],"count_time":{"symbolsCount":"2.3k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Lua特别之处笔记","uid":"1a1cf82db3f5dba4b69966eabcf53cea","slug":"zl/2016-01-01-557_Lua特别之处笔记","date":"2024-04-03T03:47:35.819Z","updated":"2024-04-03T03:47:35.819Z","comments":true,"path":"api/articles/zl/2016-01-01-557_Lua特别之处笔记.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" &lt;a href=&quot;/2015/02/02/gdb_tutorial/&quot; rel=&quot;next&quot; title=&quot;GDB基础教程&quot;&gt; &lt;i class=&quot;fa fa-chevron-left&qu...","link":"","photos":[],"count_time":{"symbolsCount":"3.2k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Lua与C的交互","uid":"9885ce906fc09579da0955971d8ccae9","slug":"zl/2016-01-01-553_Lua与C的交互","date":"2024-04-03T03:47:35.818Z","updated":"2024-04-03T03:47:35.818Z","comments":true,"path":"api/articles/zl/2016-01-01-553_Lua与C的交互.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"Lua与C的交互 Lua是一个嵌入式的语言，它不仅可以是一个独立运行的程序，也可以是一个用来嵌入其它应用的程序库。 C API是一个C代码与Lua进行交互的函数集，它由以下几部分构成： 1、 读写Lua全局变量的函数； 2、 调用Lua函数的函数； 3、 运行Lua代码片段的函数...","link":"","photos":[],"count_time":{"symbolsCount":"1.1k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}