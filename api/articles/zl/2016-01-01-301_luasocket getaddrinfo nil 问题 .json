{"title":"luasocket getaddrinfo nil 问题","uid":"f597dc45b4c99d9cbe30780591e468ce","slug":"zl/2016-01-01-301_luasocket getaddrinfo nil 问题 ","date":"2024-04-03T03:47:35.576Z","updated":"2024-04-03T03:47:35.577Z","comments":true,"path":"api/articles/zl/2016-01-01-301_luasocket getaddrinfo nil 问题 .json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<p>使用 luarocks 安装 luasocket，在调用 bind 时，报：</p>\n<blockquote>\n  <p>socket.lua:29: attempt to call field ‘getaddrinfo’ (a nil value)</p>\n</blockquote>\n<p>继续执行以下 lua 代码片段：</p>\n<div class=\"language-lua highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"n\">Lua</span> <span class=\"mi\">5</span><span class=\"p\">.</span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"mi\">4</span>  <span class=\"n\">Copyright</span> <span class=\"p\">(</span><span class=\"n\">C</span><span class=\"p\">)</span> <span class=\"mi\">1994</span><span class=\"o\">-</span><span class=\"mi\">2008</span> <span class=\"n\">Lua</span><span class=\"p\">.</span><span class=\"n\">org</span><span class=\"p\">,</span> <span class=\"n\">PUC</span><span class=\"o\">-</span><span class=\"n\">Rio</span>\n<span class=\"o\">&gt;</span>\n<span class=\"o\">&gt;</span> <span class=\"k\">do</span>\n<span class=\"o\">&gt;&gt;</span>   <span class=\"kd\">local</span> <span class=\"n\">socket</span> <span class=\"o\">=</span> <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"s2\">&#34;socket&#34;</span><span class=\"p\">)</span>\n<span class=\"o\">&gt;&gt;</span>   <span class=\"k\">for</span> <span class=\"n\">k</span><span class=\"p\">,</span><span class=\"n\">v</span> <span class=\"k\">in</span> <span class=\"nb\">pairs</span><span class=\"p\">(</span><span class=\"n\">socket</span><span class=\"p\">.</span><span class=\"n\">dns</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n<span class=\"o\">&gt;&gt;</span>     <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"p\">,</span><span class=\"n\">v</span><span class=\"p\">)</span>\n<span class=\"o\">&gt;&gt;</span>   <span class=\"k\">end</span>\n<span class=\"o\">&gt;&gt;</span> <span class=\"k\">end</span>\n<span class=\"n\">gethostname</span>\t<span class=\"k\">function</span><span class=\"err\">:</span> <span class=\"err\">0</span><span class=\"nf\">xc774f0</span>\n<span class=\"n\">toip</span>\t<span class=\"k\">function</span><span class=\"err\">:</span> <span class=\"err\">0</span><span class=\"nf\">xc77ea0</span>\n<span class=\"n\">tohostname</span>\t<span class=\"k\">function</span><span class=\"err\">:</span> <span class=\"err\">0</span><span class=\"nf\">xc77f00</span>\n<span class=\"o\">&gt;</span>\n<span class=\"o\">&gt;</span>\n</code></pre></div></div>\n<p>发现确实没有加载进来，而 <code class=\"highlighter-rouge\">getaddrinfo</code> 是一个标准的 posix 系统调用，所以基本可以确定是安装的问题了。。</p>\n<p>于是从 github 拉下最新的 luasocket v3.0-rc1 手动编译完成后，可以 bind，可以看到加载进来了：</p>\n<div class=\"language-lua highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"o\">&gt;</span>\n<span class=\"o\">&gt;&gt;</span> <span class=\"k\">do</span>\n<span class=\"o\">&gt;&gt;</span>   <span class=\"kd\">local</span> <span class=\"n\">socket</span> <span class=\"o\">=</span> <span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"s2\">&#34;socket&#34;</span><span class=\"p\">)</span>\n<span class=\"o\">&gt;&gt;</span>   <span class=\"k\">for</span> <span class=\"n\">k</span><span class=\"p\">,</span><span class=\"n\">v</span> <span class=\"k\">in</span> <span class=\"nb\">pairs</span><span class=\"p\">(</span><span class=\"n\">socket</span><span class=\"p\">.</span><span class=\"n\">dns</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n<span class=\"o\">&gt;&gt;</span>     <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"p\">,</span><span class=\"n\">v</span><span class=\"p\">)</span>\n<span class=\"o\">&gt;&gt;</span>   <span class=\"k\">end</span>\n<span class=\"o\">&gt;&gt;</span> <span class=\"k\">end</span>\n<span class=\"n\">getnameinfo</span>\t<span class=\"k\">function</span><span class=\"err\">:</span> <span class=\"err\">0</span><span class=\"nf\">xc77490</span>\n<span class=\"n\">getaddrinfo</span>\t<span class=\"k\">function</span><span class=\"err\">:</span> <span class=\"err\">0</span><span class=\"nf\">xc77380</span>\n<span class=\"n\">gethostname</span>\t<span class=\"k\">function</span><span class=\"err\">:</span> <span class=\"err\">0</span><span class=\"nf\">xc774f0</span>\n<span class=\"n\">toip</span>\t<span class=\"k\">function</span><span class=\"err\">:</span> <span class=\"err\">0</span><span class=\"nf\">xc77ea0</span>\n<span class=\"n\">tohostname</span>\t<span class=\"k\">function</span><span class=\"err\">:</span> <span class=\"err\">0</span><span class=\"nf\">xc77f00</span>\n<span class=\"o\">&gt;</span>\n<span class=\"o\">&gt;</span>\n</code></pre></div></div>\n<p>所以结论已经出来了，是 luarocks 安装 luasocket 的问题了。那我们继续追踪问题的根源，使用 <code class=\"highlighter-rouge\">luarocks install luasocket</code> 可以看到 luasocket 的编译参数为：</p>\n<div class=\"language-sh highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gcc <span class=\"nt\">-O2</span> <span class=\"nt\">-fPIC</span> <span class=\"nt\">-I</span>/usr/include <span class=\"nt\">-c</span> src/mime.c <span class=\"nt\">-o</span> src/mime.o <span class=\"nt\">-DLUA_COMPAT_APIINTCASTS</span> <span class=\"nt\">-DLUASOCKET_DEBUG</span> <span class=\"nt\">-DLUASOCKET_API</span><span class=\"o\">=</span>__attribute__<span class=\"o\">((</span>visibility<span class=\"o\">(</span><span class=\"s2\">&#34;default&#34;</span><span class=\"o\">)))</span> <span class=\"nt\">-DUNIX_API</span><span class=\"o\">=</span>__attribute__<span class=\"o\">((</span>visibility<span class=\"o\">(</span><span class=\"s2\">&#34;default&#34;</span><span class=\"o\">)))</span> <span class=\"nt\">-DMIME_API</span><span class=\"o\">=</span>__attribute__<span class=\"o\">((</span>visibility<span class=\"o\">(</span><span class=\"s2\">&#34;default&#34;</span><span class=\"o\">)))</span>\n</code></pre></div></div>\n<p>而我自己手动编译时，默认参数为：</p>\n<div class=\"language-sh highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>gcc <span class=\"nt\">-I</span>/usr/local/lua/include/lua/5.1 <span class=\"nt\">-DLUASOCKET_NODEBUG</span> <span class=\"nt\">-DLUA_NOCOMPAT_MODULE</span> <span class=\"nt\">-DLUASOCKET_API</span><span class=\"o\">=</span><span class=\"s1\">&#39;__attribute__((visibility(&#34;default&#34;)))&#39;</span> <span class=\"nt\">-DUNIX_API</span><span class=\"o\">=</span><span class=\"s1\">&#39;__attribute__((visibility(&#34;default&#34;)))&#39;</span> <span class=\"nt\">-DMIME_API</span><span class=\"o\">=</span><span class=\"s1\">&#39;__attribute__((visibility(&#34;default&#34;)))&#39;</span> <span class=\"nt\">-pedantic</span> <span class=\"nt\">-Wall</span> <span class=\"nt\">-Wshadow</span> <span class=\"nt\">-Wextra</span> <span class=\"nt\">-Wimplicit</span> <span class=\"nt\">-O2</span> <span class=\"nt\">-ggdb3</span> <span class=\"nt\">-fpic</span> <span class=\"nt\">-fvisibility</span><span class=\"o\">=</span>hidden   <span class=\"nt\">-c</span> <span class=\"nt\">-o</span> mime.o mime.c\n</code></pre></div></div>\n<p>嗯。。。问题似乎已经很明确了，没错，就是几个宏的引用问题：</p>\n<div class=\"language-sh highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nt\">-DLUA_COMPAT_APIINTCASTS</span> <span class=\"nt\">-DLUASOCKET_DEBUG</span>\n</code></pre></div></div>\n<p>而我们手动编译是启用的这几个宏：</p>\n<div class=\"language-sh highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nt\">-DLUASOCKET_NODEBUG</span> <span class=\"nt\">-DLUA_NOCOMPAT_MODULE</span>\n</code></pre></div></div>\n<p>当然如果你嫌手动编译麻烦，也可以用 luarocks 安装 2.0.2 的版本，这个是没有问题的：</p>\n<div class=\"language-sh highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>luarocks install luasocket 2.0.2-6\n</code></pre></div></div>\n<p>另，在调查这个问题的原因时，新发现个 luarocks pack 的使用技巧，pack 就是可以将我们安装过后的 rock 重新生成 rock 文件，之后我们将其上传到需要安装的其他机器，执行 <code class=\"highlighter-rouge\">luarocks install ***.rock</code> 即可：</p>\n<div class=\"language-sh highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>luarocks pack luasocket\n<span class=\"c\"># 接下来拷贝 luasocket-3.0rc1-2.linux-x86_64.rock 至目标机器并执行以下命令</span>\n<span class=\"c\"># 就可以离线安装 luasocket 了</span>\nluarocks install luasocket-3.0rc1-2.linux-x86_64.rock\n</code></pre></div></div>\n<pre><code>            &lt;hr style=&quot;visibility: hidden;&quot;/&gt;\n</code></pre>\n","text":"使用 luarocks 安装 luasocket，在调用 bind 时，报： socket.lua:29: attempt to call field ‘getaddrinfo’ (a nil value) 继续执行以下 lua 代码片段： Lua 5.1.4 Copyright...","link":"","photos":[],"count_time":{"symbolsCount":"2.2k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Lua学习笔记","uid":"d112c00bf05f368c0020529ea6c8efaf","slug":"zl/2016-01-01-302_Lua学习笔记","date":"2024-04-03T03:47:35.578Z","updated":"2024-04-03T03:47:35.578Z","comments":true,"path":"api/articles/zl/2016-01-01-302_Lua学习笔记.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" LUA读书笔记 What’s in a name? Why choose Lua? LuaJIT-Lua即时编译器 下载源码 INSTALL LUA读书笔记 在Lua中，一切都是变量，除了关键字。请记住这句话。 语句块在C++中是用”{“和”}”括起来的，在Lua中，它是用do...","link":"","photos":[],"count_time":{"symbolsCount":"1.5k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"lua用法","uid":"df9754f22ae84a5478ce5d4d534e5759","slug":"zl/2016-01-01-300_lua用法","date":"2024-04-03T03:47:35.574Z","updated":"2024-04-03T03:47:35.575Z","comments":true,"path":"api/articles/zl/2016-01-01-300_lua用法.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"从给定的字符串得到块(函数)。lua5.3使用load()替换loadstring(). 一般如下用法：assert(loadstring(script))()f = loadstring(&#34;a = 1&#34;)语义上相当于：f = loadstring(&#34;fu...","link":"","photos":[],"count_time":{"symbolsCount":"3.1k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}