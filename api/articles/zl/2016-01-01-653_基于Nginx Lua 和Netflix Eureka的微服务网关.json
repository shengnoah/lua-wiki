{"title":"基于Nginx Lua 和Netflix Eureka的微服务网关","uid":"8e32dba5b3f21244d1fa5adf8939b7d6","slug":"zl/2016-01-01-653_基于Nginx Lua 和Netflix Eureka的微服务网关","date":"2024-04-03T03:47:35.873Z","updated":"2024-04-03T03:47:35.873Z","comments":true,"path":"api/articles/zl/2016-01-01-653_基于Nginx Lua 和Netflix Eureka的微服务网关.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<p>依赖：lua-resty-http\n基于Nginx&amp;Lua 和Netflix Eureka的微服务网关。</p>\n<p>重新架构了内部组件，采用插件模式。</p>\n<ul>\n<li>服务发现\n<ul>\n<li>Eureka Discovery</li>\n<li>抽象discovery，用来支持多种服务发现？规划中…</li>\n</ul></li>\n<li>动态路由</li>\n<li>负载均衡\n<ul>\n<li>加权轮询</li>\n<li>基于响应时间的动态权重轮询？开发中…</li>\n</ul></li>\n<li>简单监控</li>\n<li>隔离降级</li>\n<li>限流</li>\n<li>metrics</li>\n<li>认证安全？规划中。。。</li>\n<li>监控页面？开发中…</li>\n</ul>\n<h2 id=\"架构图\">架构图：</h2>\n<p><img src=\"https://github.com/tietang/ngx-lua-zuul/raw/_dev_pilot/doc/arch.png\" alt=\"img\"/></p>\n<h2 id=\"使用方法\">使用方法</h2>\n<p>基于Nginx和Lua module。需要<a href=\"https://www.jianshu.com/p/7c320140c6aa\">安装Nginx Lua环境</a>或者直接下载<a href=\"https://link.jianshu.com/?t=http://openresty.org/en/download.html\">openresty</a>编译安装。</p>\n<h2 id=\"安装和配置ngx-lua-zuul\">安装和配置ngx-lua-zuul</h2>\n<h3 id=\"下载代码到-path-to-nginx-lua-lib\">下载代码到/path/to/nginx/lua/lib/</h3>\n<blockquote>\n<p>git clone <a href=\"https://link.jianshu.com/?t=http://github.com/tietang/ngx-lua-zuul\">http://github.com/tietang/ngx-lua-zuul</a> –depth=1</p>\n</blockquote>\n<h2 id=\"例子eureka-服务\">例子Eureka 服务</h2>\n<p>如果没有Eureka环境，也可以编译安装本例子中的EurekaDemo服务，参考<a href=\"https://link.jianshu.com/?t=run-eureka-demo.md\">编译和运行eureka-demo服务</a>中的相关内容。</p>\n<h3 id=\"部署dicovery例子服务\">部署dicovery例子服务：</h3>\n<p>下载代码后：</p>\n<blockquote>\n<p>cd /path/to/ngx_lua-zuul/demo/java\nmvn clean install</p>\n</blockquote>\n<p>将下载的代码中的lua文件夹放到部署目录<code>/path/to/nginx</code>，修改<code>/path/to/nginx/lua/ngx_conf/lua.ngx_conf</code>文件中的<code>lua_package_path</code>为你的真实路径：\n<code>lua_package_path &#34;/path/to/nginx/lua/lib/?.lua;;&#34;;</code></p>\n<h3 id=\"修改-path-to-nginx-conf-nginx-conf-文件\">修改<code>/path/to/nginx/conf/nginx.conf</code>文件</h3>\n<p><strong>http 节点中添加</strong></p>\n<div class=\"highlight\"><div class=\"chroma\">\n<table class=\"lntable\"><tbody><tr><td class=\"lntd\">\n<pre class=\"chroma\"><span class=\"lnt\">1\n</span></pre></td>\n<td class=\"lntd\">\n<pre class=\"chroma\">include &#34;/path/to/lua/ngx_conf/ngx_inlude_http.conf&#34;;</pre></td></tr></tbody></table>\n</div>\n</div>\n<p><strong>server节点中添加</strong></p>\n<div class=\"highlight\"><div class=\"chroma\">\n<table class=\"lntable\"><tbody><tr><td class=\"lntd\">\n<pre class=\"chroma\"><span class=\"lnt\">1\n</span></pre></td>\n<td class=\"lntd\">\n<pre class=\"chroma\">include &#34;/path/to/nginx/lua/ngx_conf/ngx_inlude_server.conf&#34;;</pre></td></tr></tbody></table>\n</div>\n</div>\n<h2 id=\"参考配置\">参考配置</h2>\n<div class=\"highlight\"><div class=\"chroma\">\n<table class=\"lntable\"><tbody><tr><td class=\"lntd\">\n<pre class=\"chroma\"><span class=\"lnt\"> 1\n</span><span class=\"lnt\"> 2\n</span><span class=\"lnt\"> 3\n</span><span class=\"lnt\"> 4\n</span><span class=\"lnt\"> 5\n</span><span class=\"lnt\"> 6\n</span><span class=\"lnt\"> 7\n</span><span class=\"lnt\"> 8\n</span><span class=\"lnt\"> 9\n</span><span class=\"lnt\">10\n</span><span class=\"lnt\">11\n</span><span class=\"lnt\">12\n</span><span class=\"lnt\">13\n</span><span class=\"lnt\">14\n</span><span class=\"lnt\">15\n</span><span class=\"lnt\">16\n</span><span class=\"lnt\">17\n</span><span class=\"lnt\">18\n</span><span class=\"lnt\">19\n</span><span class=\"lnt\">20\n</span><span class=\"lnt\">21\n</span><span class=\"lnt\">22\n</span><span class=\"lnt\">23\n</span><span class=\"lnt\">24\n</span><span class=\"lnt\">25\n</span><span class=\"lnt\">26\n</span><span class=\"lnt\">27\n</span><span class=\"lnt\">28\n</span><span class=\"lnt\">29\n</span><span class=\"lnt\">30\n</span><span class=\"lnt\">31\n</span><span class=\"lnt\">32\n</span><span class=\"lnt\">33\n</span><span class=\"lnt\">34\n</span><span class=\"lnt\">35\n</span><span class=\"lnt\">36\n</span><span class=\"lnt\">37\n</span><span class=\"lnt\">38\n</span><span class=\"lnt\">39\n</span><span class=\"lnt\">40\n</span><span class=\"lnt\">41\n</span><span class=\"lnt\">42\n</span><span class=\"lnt\">43\n</span><span class=\"lnt\">44\n</span><span class=\"lnt\">45\n</span><span class=\"lnt\">46\n</span><span class=\"lnt\">47\n</span><span class=\"lnt\">48\n</span><span class=\"lnt\">49\n</span><span class=\"lnt\">50\n</span><span class=\"lnt\">51\n</span><span class=\"lnt\">52\n</span><span class=\"lnt\">53\n</span><span class=\"lnt\">54\n</span><span class=\"lnt\">55\n</span><span class=\"lnt\">56\n</span><span class=\"lnt\">57\n</span><span class=\"lnt\">58\n</span><span class=\"lnt\">59\n</span><span class=\"lnt\">60\n</span><span class=\"lnt\">61\n</span></pre></td>\n<td class=\"lntd\">\n<pre class=\"chroma\"> #user  nobody;\nworker_processes  2;\n<p>#error_log  logs/error.log;<br />\n#error_log  logs/error.log  notice;<br />\n#error_log  logs/error.log  info;</p>\n<p>#pid        logs/nginx.pid;</p>\n<p>events {<br />\nworker_connections  1024;<br />\n}</p>\n<p>http {<br />\ninclude       mime.types;<br />\ndefault_type  application/octet-stream;</p>\n<pre><code>#log_format  main  &amp;#39;$remote_addr - $remote_user [$time_local] &amp;#34;$request&amp;#34; &amp;#39;\n#                  &amp;#39;$status $body_bytes_sent &amp;#34;$http_referer&amp;#34; &amp;#39;\n#                  &amp;#39;&amp;#34;$http_user_agent&amp;#34; &amp;#34;$http_x_forwarded_for&amp;#34;&amp;#39;;\n\n#access_log  logs/access.log  main;\n\nsendfile        on;\n#tcp_nopush     on;\n\n#keepalive_timeout  0;\nkeepalive_timeout  65;\n\n#gzip  on;\ninclude &amp;#34;/Users/tietang/nginx/nginx/lua/ngx_conf/ngx_inlude_http.conf&amp;#34;;\n\n\nserver &#123;\n\n    include &amp;#34;/Users/tietang/nginx/nginx/lua/ngx_conf/ngx_inlude_server.conf&amp;#34;;\n    #error_page  404              /404.html;\n\n    # redirect server error pages to the static page /50x.html\n    #\n\n    location = / &#123;\n        set $dir $document_root;\n        root   $dir/html;\n        index  index.html index.htm;\n    &#125;\n\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html &#123;\n        root   html;\n    &#125;\n\n    \n&#125;\n</code></pre>\n<p>}</pre></td></tr></tbody></table></p>\n</div>\n</div>\n<h3 id=\"运行测试\">运行测试</h3>\n<p>启动所有的demo服务：discovery,api,zuul；</p>\n<p>启动nginx；</p>\n<p>打开浏览器：<a href=\"https://link.jianshu.com/?t=http://127.0.0.1:8000/api/test/0/0\">http://127.0.0.1:8000/api/test/0/0</a></p>\n<p>其测试api参考<a href=\"https://link.jianshu.com/?t=run-eureka-demo.md\">编译和运行eureka-demo服务</a>中的相关内容。</p>","text":"依赖：lua-resty-http 基于Nginx&amp;Lua 和Netflix Eureka的微服务网关。 重新架构了内部组件，采用插件模式。 服务发现 Eureka Discovery 抽象discovery，用来支持多种服务发现？规划中… 动态路由 负载均衡 加权轮询 ...","link":"","photos":[],"count_time":{"symbolsCount":"2.5k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%9E%B6%E6%9E%84%E5%9B%BE\"><span class=\"toc-text\">架构图：</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95\"><span class=\"toc-text\">使用方法</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AEngx-lua-zuul\"><span class=\"toc-text\">安装和配置ngx-lua-zuul</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%B8%8B%E8%BD%BD%E4%BB%A3%E7%A0%81%E5%88%B0-path-to-nginx-lua-lib\"><span class=\"toc-text\">下载代码到&#x2F;path&#x2F;to&#x2F;nginx&#x2F;lua&#x2F;lib&#x2F;</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BE%8B%E5%AD%90eureka-%E6%9C%8D%E5%8A%A1\"><span class=\"toc-text\">例子Eureka 服务</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%83%A8%E7%BD%B2dicovery%E4%BE%8B%E5%AD%90%E6%9C%8D%E5%8A%A1\"><span class=\"toc-text\">部署dicovery例子服务：</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BF%AE%E6%94%B9-path-to-nginx-conf-nginx-conf-%E6%96%87%E4%BB%B6\"><span class=\"toc-text\">修改&#x2F;path&#x2F;to&#x2F;nginx&#x2F;conf&#x2F;nginx.conf文件</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">参考配置</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95\"><span class=\"toc-text\">运行测试</span></a></li></ol></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"nginx lua 编译安装 « 诗宁","uid":"47d85599ba5132364a2046c6149d4ae7","slug":"zl/2016-01-01-654_nginx lua 编译安装 « 诗宁","date":"2024-04-03T03:47:35.876Z","updated":"2024-04-03T03:47:35.877Z","comments":true,"path":"api/articles/zl/2016-01-01-654_nginx lua 编译安装 « 诗宁.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" 编译安装脚本 主配置文件 systemd启动配置 启动脚本 编译安装脚本 nginx-lua-build.sh #!/bin/bash #Date:2018-09-03 #Written by magic5650. #Readme:install nginx + lua. #s...","link":"","photos":[],"count_time":{"symbolsCount":"12k","symbolsTime":"11 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Lua语言简介","uid":"862e24c321955460c3f363da814f3290","slug":"zl/2016-01-01-652_Lua语言简介","date":"2024-04-03T03:47:35.872Z","updated":"2024-04-03T03:47:35.872Z","comments":true,"path":"api/articles/zl/2016-01-01-652_Lua语言简介.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"简介Lua是一门小巧的脚本语言，由巴西里约热内卢天主教大学的Roberto Ierusalimschy等人于1993年开发，在现代企业开发中Lua通常被作为胶水语言，在游戏领域应用尤为频繁。 Lua中的数据类型Lua中定义以下几种数据类型 1、Nilnil是一个特殊的数据类型，它...","link":"","photos":[],"count_time":{"symbolsCount":"2.2k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}