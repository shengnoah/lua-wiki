{"title":"Ubuntu18.04 Nginx+Lua+GraphicsMagick图片缩放","uid":"a59cd69ee5dd570ef472b014ff61d6f1","slug":"zl/2016-01-01-602_Ubuntu18.04 Nginx+Lua+GraphicsMagick图片缩放","date":"2024-04-03T03:47:35.836Z","updated":"2024-04-03T03:47:35.837Z","comments":true,"path":"api/articles/zl/2016-01-01-602_Ubuntu18.04 Nginx+Lua+GraphicsMagick图片缩放.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<p>自己搭建的图片服务器，有图片缩放的需求，大致思路是可以使用nginx调用lua，使用GraphicMagick的命令来做图片缩放</p>\n<h1 id=\"说明\"><a href=\"#说明\" class=\"headerlink\" title=\"说明\"></a>说明</h1><h2 id=\"文件夹规划\"><a href=\"#文件夹规划\" class=\"headerlink\" title=\"文件夹规划\"></a>文件夹规划</h2><p>lua.jaychang.cn(如/var/filebase)</p>\n<figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/><span class=\"line\">13</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">jaychang@nginx:~$ tree /var/filebase/</span><br/><span class=\"line\">/var/filebase/</span><br/><span class=\"line\">├── avatar.png</span><br/><span class=\"line\">├── cache</span><br/><span class=\"line\">│   └── thumb</span><br/><span class=\"line\">│       ├── avatar.png_100x100.png</span><br/><span class=\"line\">│       └── upload</span><br/><span class=\"line\">│           ├── 1.png_100x100.png #固定高和宽</span><br/><span class=\"line\">│           ├── 1.png_400-.png # 定高</span><br/><span class=\"line\">│           └── 1.png_800-.png # 定宽</span><br/><span class=\"line\">└── upload</span><br/><span class=\"line\">    ├── 1.png</span><br/><span class=\"line\">4 directories, 8 files</span><br/></pre></td></tr></tbody></table></figure>\n<p>其中img.xyz.com为图片站点根目录<br/>cache/thumb为缩略图存放目录<br/>upload目录存放上传的图片</p>\n<h2 id=\"链接地址对应关系\"><a href=\"#链接地址对应关系\" class=\"headerlink\" title=\"链接地址对应关系\"></a>链接地址对应关系</h2><p>原图访问地址：<a href=\"http://img.xyz.com/upload/1.png\" target=\"_blank\" rel=\"noopener noreferrer\">http://img.xyz.com/upload/1.png</a><br/>缩略图访问地址：<a href=\"http://img.xyz.com/upload/1.png_100x100.png\" target=\"_blank\" rel=\"noopener noreferrer\">http://img.xyz.com/upload/1.png_100x100.png</a> 即为宽100,高100<br/>自动宽地址: <a href=\"http://img.xyz.com/upload/1.png_-400.png\" target=\"_blank\" rel=\"noopener noreferrer\">http://img.xyz.com/upload/1.png_-400.png</a> 用”-“表示自动,即为高400,宽自动<br/>自动高地址: <a href=\"http://img.xyz.com/upload/1.png_800-.jpg\" target=\"_blank\" rel=\"noopener noreferrer\">http://img.xyz.com/upload/1.png_800-.jpg</a> 用”-“表示自动,即为宽800,高自动</p>\n<h2 id=\"访问流程\"><a href=\"#访问流程\" class=\"headerlink\" title=\"访问流程\"></a>访问流程</h2><p>首先判断缩略图是否存在，如存在则直接显示缩略图；<br/>缩略图不存在,则判断原图是否存在，如原图存在则拼接graphicsmagick(gm)命令,生成并显示缩略图,否则返回404</p>\n<h1 id=\"所需软件\"><a href=\"#所需软件\" class=\"headerlink\" title=\"所需软件\"></a>所需软件</h1><ul>\n<li>lua-5.3.5.tar.gz</li>\n<li>LuaJIT-2.0.5.tar.gz</li>\n<li>nginx-1.14.2.tar.gz</li>\n<li>nginx模块：lua-nginx-module-0.10.15.tar.gz<blockquote>\n<p>lua-nginx-module 依赖于 LuaJIT 和 ngx_devel_kit。LuaJIT 需要安装，ngx_devel_kit 只需下载源码包，在 Nginx 编译时指定 ngx_devel_kit 目录</p>\n</blockquote>\n</li>\n<li>nginx模块：nginx-http-concat</li>\n<li>nginx模块：ngx_devel_kit</li>\n<li>nginx模块：nginx-http-concat</li>\n</ul>\n<figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">curl -R -O http://www.lua.org/ftp/lua-5.3.5.tar.gz</span><br/><span class=\"line\">curl -R -O http://luajit.org/download/LuaJIT-2.0.5.tar.gz</span><br/><span class=\"line\">curl -R -O http://nginx.org/download/nginx-1.14.2.tar.gz</span><br/><span class=\"line\">curl -R -O https://github.com/openresty/lua-nginx-module/archive/v0.10.15.tar.gz</span><br/><span class=\"line\">curl -R -O https://github.com/openresty/lua-resty-core/archive/v0.1.17.tar.gz</span><br/><span class=\"line\">curl -R -O https://github.com/simpl/ngx_devel_kit/archive/v0.3.0.tar.gz</span><br/><span class=\"line\">git clone git@github.com:alibaba/nginx-http-concat.git</span><br/></pre></td></tr></tbody></table></figure>\n<h1 id=\"安装依赖\"><a href=\"#安装依赖\" class=\"headerlink\" title=\"安装依赖\"></a>安装依赖</h1><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install -y gcc g++ make</span><br/><span class=\"line\"></span><br/><span class=\"line\">apt-get install libreadline-dev libpcre3 libpcre3-dev openssl libssl-dev zlib1g zlib1g-dev libgeoip-dev -y</span><br/></pre></td></tr></tbody></table></figure>\n<h1 id=\"编译安装Lua-LuaJIT\"><a href=\"#编译安装Lua-LuaJIT\" class=\"headerlink\" title=\"编译安装Lua LuaJIT\"></a>编译安装Lua LuaJIT</h1><h2 id=\"编译安装Lua\"><a href=\"#编译安装Lua\" class=\"headerlink\" title=\"编译安装Lua\"></a>编译安装Lua</h2><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">curl -R -O http://www.lua.org/ftp/lua-5.3.5.tar.gz</span><br/><span class=\"line\">tar zxf lua-5.3.5.tar.gz</span><br/><span class=\"line\">cd lua-5.3.5</span><br/><span class=\"line\">make linux test</span><br/></pre></td></tr></tbody></table></figure>\n<h2 id=\"编译安装LuaJIT\"><a href=\"#编译安装LuaJIT\" class=\"headerlink\" title=\"编译安装LuaJIT\"></a>编译安装LuaJIT</h2><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">curl -R -O http://luajit.org/download/LuaJIT-2.0.5.tar.gz</span><br/><span class=\"line\">tar -zxvf LuaJIT-2.0.5.tar.gz</span><br/><span class=\"line\">cd LuaJIT-2.0.5</span><br/><span class=\"line\">make -j2 &amp;&amp; make install</span><br/><span class=\"line\">export LUAJIT_LIB=/usr/local/lib</span><br/><span class=\"line\">export LUAJIT_INC=/usr/local/include/luajit-2.0</span><br/><span class=\"line\">echo &#34;/usr/local/lib&#34; &gt; /etc/ld.so.conf.d/usr_local_lib.conf</span><br/><span class=\"line\">ldconfig</span><br/></pre></td></tr></tbody></table></figure>\n<h1 id=\"安装GraphicsMagick\"><a href=\"#安装GraphicsMagick\" class=\"headerlink\" title=\"安装GraphicsMagick\"></a>安装GraphicsMagick</h1><figure class=\"highlight shell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">apt install -y graphicsmagick</span><br/></pre></td></tr></tbody></table></figure>\n<blockquote>\n<p>直接用apt来安装的话，可以免去安装 jpg,png 等图片库依赖</p>\n</blockquote>\n<h1 id=\"创建用户及相应目录\"><a href=\"#创建用户及相应目录\" class=\"headerlink\" title=\"创建用户及相应目录\"></a>创建用户及相应目录</h1><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">groupadd nginx &amp;&amp; useradd nginx -g nginx -s /sbin/nologin -M</span><br/><span class=\"line\"></span><br/><span class=\"line\">mkdir -p /var/tmp/nginx/client_body_temp</span><br/><span class=\"line\">mkdir -p /var/tmp/nginx/uwsgi_temp</span><br/></pre></td></tr></tbody></table></figure>\n<p>创建用户也可以用以下命令：<br/></p><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">groupadd nginx &amp;&amp; useradd nginx -g nginx -s /bin/false -M</span><br/></pre></td></tr></tbody></table></figure><p></p>\n<h1 id=\"编译安装nginx\"><a href=\"#编译安装nginx\" class=\"headerlink\" title=\"编译安装nginx\"></a>编译安装nginx</h1><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/><span class=\"line\">13</span><br/><span class=\"line\">14</span><br/><span class=\"line\">15</span><br/><span class=\"line\">16</span><br/><span class=\"line\">17</span><br/><span class=\"line\">18</span><br/><span class=\"line\">19</span><br/><span class=\"line\">20</span><br/><span class=\"line\">21</span><br/><span class=\"line\">22</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">./configure --prefix=/usr/local/nginx </span><br/><span class=\"line\">--user=nginx --group=nginx </span><br/><span class=\"line\">--sbin-path=/usr/sbin/nginx </span><br/><span class=\"line\">--with-pcre </span><br/><span class=\"line\">--with-http_realip_module </span><br/><span class=\"line\">--with-http_gzip_static_module </span><br/><span class=\"line\">--with-http_stub_status_module </span><br/><span class=\"line\">--with-http_v2_module </span><br/><span class=\"line\">--with-http_flv_module </span><br/><span class=\"line\">--with-http_ssl_module </span><br/><span class=\"line\">--with-http_addition_module </span><br/><span class=\"line\">--with-http_geoip_module </span><br/><span class=\"line\">--add-module=/usr/local/src/lua-nginx-module-0.10.15 </span><br/><span class=\"line\">--add-module=/usr/local/src/ngx_devel_kit-0.3.0 </span><br/><span class=\"line\">--add-module=/usr/local/src/nginx-http-concat </span><br/><span class=\"line\">--http-scgi-temp-path=/var/tmp/nginx/cgi_temp </span><br/><span class=\"line\">--http-client-body-temp-path=/var/tmp/nginx/client_body_temp </span><br/><span class=\"line\">--http-proxy-temp-path=/var/tmp/nginx/proxy_temp </span><br/><span class=\"line\">--http-uwsgi-temp-path=/var/tmp/nginx/uwsgi_temp </span><br/><span class=\"line\">--http-fastcgi-temp-path=/var/tmp/nginx/fastcgi_temp </span><br/><span class=\"line\">--http-log-path=/var/log/nginx/access.log </span><br/><span class=\"line\">--error-log-path=/var/log/nginx/error.log</span><br/></pre></td></tr></tbody></table></figure>\n<figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">make -j 2 &amp;&amp; make install</span><br/></pre></td></tr></tbody></table></figure>\n<p> 注意：动态加载模块，Nginx官方的load_module指令,详细文档<a href=\"http://nginx.org/en/docs/ngx_core_module.html#load_module\" target=\"_blank\" rel=\"noopener noreferrer\">参考1</a><br/>和 <a href=\"https://www.nginx.com/resources/wiki/extending/converting/#compiling-dynamic\" target=\"_blank\" rel=\"noopener noreferrer\">参考2</a><br/>还有–with-http_spdy_module 已经改为–with-http_v2_module了<br/>,如果不用geo的话，编译的时候可以不加–with-http_geoip_module，可以不安装libgeoip-dev</p>\n<h1 id=\"测试nginx\"><a href=\"#测试nginx\" class=\"headerlink\" title=\"测试nginx\"></a>测试nginx</h1><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -t</span><br/></pre></td></tr></tbody></table></figure>\n<p>如果出现以下错误(没有报错就不用做以下操作了)<br/></p><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu:/usr/local/src/nginx-1.14.2# nginx -t</span><br/><span class=\"line\">nginx: error while loading shared libraries: libluajit-5.1.so.2: cannot open shared object file: No such file or directory</span><br/></pre></td></tr></tbody></table></figure><p></p>\n<p>执行以下命令即可<br/></p><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">echo &#34;/usr/local/lib&#34; &gt; /etc/ld.so.conf.d/usr_local_lib.conf</span><br/><span class=\"line\">ldconfig</span><br/></pre></td></tr></tbody></table></figure><p></p>\n<h1 id=\"修改nginx-conf配置文件\"><a href=\"#修改nginx-conf配置文件\" class=\"headerlink\" title=\"修改nginx.conf配置文件\"></a>修改nginx.conf配置文件</h1><p>将nginx.conf配置文件中的<strong>server{}段</strong>配置注释掉</p>\n<p>加一行配置，以便读取/usr/local/tengine/conf.d目录下所有后缀为.conf的配置文件<br/></p><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">include ../conf.d/*.conf;</span><br/></pre></td></tr></tbody></table></figure><p></p>\n<p>可以参考如下配置<br/></p><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/><span class=\"line\">13</span><br/><span class=\"line\">14</span><br/><span class=\"line\">15</span><br/><span class=\"line\">16</span><br/><span class=\"line\">17</span><br/><span class=\"line\">18</span><br/><span class=\"line\">19</span><br/><span class=\"line\">20</span><br/><span class=\"line\">21</span><br/><span class=\"line\">22</span><br/><span class=\"line\">23</span><br/><span class=\"line\">24</span><br/><span class=\"line\">25</span><br/><span class=\"line\">26</span><br/><span class=\"line\">27</span><br/><span class=\"line\">28</span><br/><span class=\"line\">29</span><br/><span class=\"line\">30</span><br/><span class=\"line\">31</span><br/><span class=\"line\">32</span><br/><span class=\"line\">33</span><br/><span class=\"line\">34</span><br/><span class=\"line\">35</span><br/><span class=\"line\">36</span><br/><span class=\"line\">37</span><br/><span class=\"line\">38</span><br/><span class=\"line\">39</span><br/><span class=\"line\">40</span><br/><span class=\"line\">41</span><br/><span class=\"line\">42</span><br/><span class=\"line\">43</span><br/><span class=\"line\">44</span><br/><span class=\"line\">45</span><br/><span class=\"line\">46</span><br/><span class=\"line\">47</span><br/><span class=\"line\">48</span><br/><span class=\"line\">49</span><br/><span class=\"line\">50</span><br/><span class=\"line\">51</span><br/><span class=\"line\">52</span><br/><span class=\"line\">53</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">user nginx;</span><br/><span class=\"line\">worker_processes 4;</span><br/><span class=\"line\">worker_cpu_affinity 1000 0100 0010 0001;</span><br/><span class=\"line\">error_log /var/log/nginx/error.log error;</span><br/><span class=\"line\">pid /usr/local/nginx/logs/nginx.pid;</span><br/><span class=\"line\">worker_rlimit_nofile 65535;</span><br/><span class=\"line\">events</span><br/><span class=\"line\">{</span><br/><span class=\"line\">\tuse epoll;</span><br/><span class=\"line\">\tworker_connections 65535;</span><br/><span class=\"line\">}</span><br/><span class=\"line\">http</span><br/><span class=\"line\">{</span><br/><span class=\"line\">   lua_load_resty_core off;</span><br/><span class=\"line\">   limit_conn_zone $binary_remote_addr zone=one:10m;</span><br/><span class=\"line\">   limit_conn_zone $server_name zone=perserver:10m;</span><br/><span class=\"line\">\tinclude mime.types;</span><br/><span class=\"line\">\tinclude fastcgi.conf;</span><br/><span class=\"line\">\tdefault_type application/octet-stream;</span><br/><span class=\"line\">\tcharset utf-8;</span><br/><span class=\"line\">\tserver_names_hash_bucket_size 128;</span><br/><span class=\"line\">\tclient_header_buffer_size 32k;</span><br/><span class=\"line\">\tlarge_client_header_buffers 4 64k;</span><br/><span class=\"line\">\tsendfile on;</span><br/><span class=\"line\">\tautoindex off;</span><br/><span class=\"line\">\ttcp_nopush on;</span><br/><span class=\"line\">\ttcp_nodelay on;</span><br/><span class=\"line\">\tkeepalive_timeout 120;</span><br/><span class=\"line\">    </span><br/><span class=\"line\">\tfastcgi_connect_timeout 60;</span><br/><span class=\"line\">\tfastcgi_send_timeout 60;</span><br/><span class=\"line\">\tfastcgi_read_timeout 60;</span><br/><span class=\"line\">\tfastcgi_buffer_size 128k;</span><br/><span class=\"line\">\tfastcgi_buffers 8 128k;</span><br/><span class=\"line\">\tfastcgi_busy_buffers_size 128k;</span><br/><span class=\"line\">\tfastcgi_temp_file_write_size 128k;</span><br/><span class=\"line\">    </span><br/><span class=\"line\">\tgzip on;</span><br/><span class=\"line\">\tgzip_min_length 1k;</span><br/><span class=\"line\">\tgzip_buffers 4 16k;</span><br/><span class=\"line\">\tgzip_http_version 1.0;</span><br/><span class=\"line\">\tgzip_comp_level 2;</span><br/><span class=\"line\">\tgzip_types text/plain application/x-javascript text/css application/xml;</span><br/><span class=\"line\">\tgzip_vary on;</span><br/><span class=\"line\"></span><br/><span class=\"line\">\tlog_format main &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;</span><br/><span class=\"line\">\t&#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;</span><br/><span class=\"line\">\t&#39;&#34;$http_user_agent&#34; $http_x_forwarded_for&#39;;</span><br/><span class=\"line\"></span><br/><span class=\"line\">\tclient_max_body_size 10m;</span><br/><span class=\"line\"></span><br/><span class=\"line\">\tinclude ../conf.d/*.conf;</span><br/><span class=\"line\">}</span><br/></pre></td></tr></tbody></table></figure><p></p>\n<blockquote>\n<p>注意：lua_load_resty_core off;如果不加会有以下错误</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/><span class=\"line\">13</span><br/><span class=\"line\">14</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">nginx: [alert] detected a LuaJIT version which is not OpenResty&#39;s; many optimizations will be disabled and performance will be compromised (see https://github.com/openresty/luajit2 for OpenResty&#39;s LuaJIT or, even better, consider using the OpenResty releases from https://openresty.org/en/download.html)</span><br/><span class=\"line\">nginx: [error] lua_load_resty_core failed to load the resty.core module from https://github.com/openresty/lua-resty-core; ensure you are using an OpenResty release from https://openresty.org/en/download.html (rc: 2, reason: module &#39;resty.core&#39; not found:</span><br/><span class=\"line\">        no field package.preload[&#39;resty.core&#39;]</span><br/><span class=\"line\">        no file &#39; /usr/local/lib/lua-resty-core-0.1.17/lib/resty/core.lua&#39;</span><br/><span class=\"line\">        no file &#39;./resty/core.lua&#39;</span><br/><span class=\"line\">        no file &#39;/usr/local/share/luajit-2.0.5/resty/core.lua&#39;</span><br/><span class=\"line\">        no file &#39;/usr/local/share/lua/5.1/resty/core.lua&#39;</span><br/><span class=\"line\">        no file &#39;/usr/local/share/lua/5.1/resty/core/init.lua&#39;</span><br/><span class=\"line\">        no file &#39;./resty/core.so&#39;</span><br/><span class=\"line\">        no file &#39;/usr/local/lib/lua/5.1/resty/core.so&#39;</span><br/><span class=\"line\">        no file &#39;/usr/local/lib/lua/5.1/loadall.so&#39;</span><br/><span class=\"line\">        no file &#39;./resty.so&#39;</span><br/><span class=\"line\">        no file &#39;/usr/local/lib/lua/5.1/resty.so&#39;</span><br/><span class=\"line\">        no file &#39;/usr/local/lib/lua/5.1/loadall.so&#39;)</span><br/></pre></td></tr></tbody></table></figure>\n<h1 id=\"创建放图片的目录\"><a href=\"#创建放图片的目录\" class=\"headerlink\" title=\"创建放图片的目录\"></a>创建放图片的目录</h1><p>目录规划</p>\n<ul>\n<li>/var/www 放网页,css,js等资源</li>\n<li>/var/fielbase 放图片</li>\n<li>/var/filebase/upload 上传的图片放这里</li>\n</ul>\n<figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /var/filebase/upload </span><br/><span class=\"line\">mkdir -p /var/filebase/cache/thumb</span><br/><span class=\"line\">chown -R nginx:nginx /var/filebase</span><br/></pre></td></tr></tbody></table></figure>\n<h1 id=\"配置站点配置文件\"><a href=\"#配置站点配置文件\" class=\"headerlink\" title=\"配置站点配置文件\"></a>配置站点配置文件</h1><p>在/usr/local/tengine/conf.d目录下创建demo.conf</p>\n<figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/><span class=\"line\">13</span><br/><span class=\"line\">14</span><br/><span class=\"line\">15</span><br/><span class=\"line\">16</span><br/><span class=\"line\">17</span><br/><span class=\"line\">18</span><br/><span class=\"line\">19</span><br/><span class=\"line\">20</span><br/><span class=\"line\">21</span><br/><span class=\"line\">22</span><br/><span class=\"line\">23</span><br/><span class=\"line\">24</span><br/><span class=\"line\">25</span><br/><span class=\"line\">26</span><br/><span class=\"line\">27</span><br/><span class=\"line\">28</span><br/><span class=\"line\">29</span><br/><span class=\"line\">30</span><br/><span class=\"line\">31</span><br/><span class=\"line\">32</span><br/><span class=\"line\">33</span><br/><span class=\"line\">34</span><br/><span class=\"line\">35</span><br/><span class=\"line\">36</span><br/><span class=\"line\">37</span><br/><span class=\"line\">38</span><br/><span class=\"line\">39</span><br/><span class=\"line\">40</span><br/><span class=\"line\">41</span><br/><span class=\"line\">42</span><br/><span class=\"line\">43</span><br/><span class=\"line\">44</span><br/><span class=\"line\">45</span><br/><span class=\"line\">46</span><br/><span class=\"line\">47</span><br/><span class=\"line\">48</span><br/><span class=\"line\">49</span><br/><span class=\"line\">50</span><br/><span class=\"line\">51</span><br/><span class=\"line\">52</span><br/><span class=\"line\">53</span><br/><span class=\"line\">54</span><br/><span class=\"line\">55</span><br/><span class=\"line\">56</span><br/><span class=\"line\">57</span><br/><span class=\"line\">58</span><br/><span class=\"line\">59</span><br/><span class=\"line\">60</span><br/><span class=\"line\">61</span><br/><span class=\"line\">62</span><br/><span class=\"line\">63</span><br/><span class=\"line\">64</span><br/><span class=\"line\">65</span><br/><span class=\"line\">66</span><br/><span class=\"line\">67</span><br/><span class=\"line\">68</span><br/><span class=\"line\">69</span><br/><span class=\"line\">70</span><br/><span class=\"line\">71</span><br/><span class=\"line\">72</span><br/><span class=\"line\">73</span><br/><span class=\"line\">74</span><br/><span class=\"line\">75</span><br/><span class=\"line\">76</span><br/><span class=\"line\">77</span><br/><span class=\"line\">78</span><br/><span class=\"line\">79</span><br/><span class=\"line\">80</span><br/><span class=\"line\">81</span><br/><span class=\"line\">82</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"># 定义lua缩略图支持的图片尺寸及开关</span><br/><span class=\"line\">init_by_lua &#39;</span><br/><span class=\"line\">    image_sizes_check = true</span><br/><span class=\"line\">    image_sizes = {&#34;800x800&#34;, &#34;400x400&#34;,&#34;200x200&#34;,&#34;100x100&#34;, &#34;-800&#34;, &#34;-400&#34;, &#34;-200&#34;,&#34;-100&#34;, &#34;800-&#34;, &#34;400-&#34;, &#34;200-&#34;,&#34;100-&#34;}</span><br/><span class=\"line\">&#39;;</span><br/><span class=\"line\"></span><br/><span class=\"line\">server {</span><br/><span class=\"line\">    listen   80;</span><br/><span class=\"line\">    servername img.xyz.com;</span><br/><span class=\"line\">    index index.php index.html index.htm;</span><br/><span class=\"line\"></span><br/><span class=\"line\">    set $root_path &#39;/var/www&#39;;</span><br/><span class=\"line\">    root $root_path;</span><br/><span class=\"line\"></span><br/><span class=\"line\">   # /lua仅用于测试，可去掉</span><br/><span class=\"line\">\t location /lua {</span><br/><span class=\"line\">\t\tdefault_type &#39;text/plain&#39;;</span><br/><span class=\"line\">        content_by_lua &#39;ngx.say(&#34;hello, ttlsa lua&#34;)&#39;;</span><br/><span class=\"line\">    }</span><br/><span class=\"line\">    </span><br/><span class=\"line\">    # 这里也是需要根据实际情况修改的，这里的是用了rewrite</span><br/><span class=\"line\">    location / {</span><br/><span class=\"line\">        try_files $uri $uri/ /index.php?$args;</span><br/><span class=\"line\"></span><br/><span class=\"line\">        # add support for img which has query params,</span><br/><span class=\"line\">        # like:  xxx.jpg?a=b&amp;c=d_750x750.jpg</span><br/><span class=\"line\">        if ($args ~* &#34;^([^_]+)_(d+)+x(d+)+.(jpg|jpeg|gif|png)$&#34;) {</span><br/><span class=\"line\">            set $w $2;</span><br/><span class=\"line\">            set $h $3;</span><br/><span class=\"line\">            set $img_ext $4;</span><br/><span class=\"line\"></span><br/><span class=\"line\">            # rewrite ^?(.*)$ _${w}x${h}.$img_ext? last;</span><br/><span class=\"line\">            rewrite ([^.]*).(jpg|jpeg|png|gif)$  $1.$2_${w}x${h}.$img_ext? permanent;</span><br/><span class=\"line\">        }</span><br/><span class=\"line\">    }</span><br/><span class=\"line\"></span><br/><span class=\"line\">    # set var for thumb pic</span><br/><span class=\"line\">    set $upload_path /var/filebase;</span><br/><span class=\"line\">    set $img_original_root  $upload_path;# original root;</span><br/><span class=\"line\">    set $img_thumbnail_root $upload_path/cache/thumb;</span><br/><span class=\"line\">    set $img_file $img_thumbnail_root$uri;</span><br/><span class=\"line\"></span><br/><span class=\"line\">    # like：/xx/xx/xx.jpg_100-.jpg or /xx/xx/xx.jpg_-100.jpg</span><br/><span class=\"line\">    location ~* ^(.+.(jpg|jpeg|gif|png))_((d+-)|(-d+)).(jpg|jpeg|gif|png)$ {</span><br/><span class=\"line\">            root $img_thumbnail_root;    # root path for croped img</span><br/><span class=\"line\">            set $img_size $3;</span><br/><span class=\"line\"></span><br/><span class=\"line\">            if (!-f $img_file) {    # if file not exists</span><br/><span class=\"line\">                    add_header X-Powered-By &#39;Nginx+Lua+GraphicsMagick By Botao&#39;;  #  header for test</span><br/><span class=\"line\">                    add_header file-path $request_filename;    #  header for test</span><br/><span class=\"line\">                    set $request_filepath $img_original_root$1;    # origin_img full path：/document_root/1.gif</span><br/><span class=\"line\">                    set $img_size $3;    # img width or height size depends on uri</span><br/><span class=\"line\">                    set $img_ext $2;    # file ext</span><br/><span class=\"line\">                    content_by_lua_file /usr/local/nginx/lua/autoSize.lua;    # load lua</span><br/><span class=\"line\">            }</span><br/><span class=\"line\">    }</span><br/><span class=\"line\"></span><br/><span class=\"line\">    # like: /xx/xx/xx.jpg_100x100.jpg</span><br/><span class=\"line\">    location ~* ^(.+.(jpg|jpeg|gif|png))_(d+)+x(d+)+.(jpg|jpeg|gif|png)$ {</span><br/><span class=\"line\">            root $img_thumbnail_root;    # root path for croped img</span><br/><span class=\"line\"></span><br/><span class=\"line\">            if (!-f $img_file) {    # if file not exists</span><br/><span class=\"line\">                    add_header X-Powered-By &#39;Nginx+Lua+GraphicsMagick By Botao&#39;;  #  header for test</span><br/><span class=\"line\">                    add_header file-path $request_filename;    #  header for test</span><br/><span class=\"line\">                    set $request_filepath $img_original_root$1;    # origin_img file path</span><br/><span class=\"line\">                    set $img_width $3;    # img width</span><br/><span class=\"line\">                    set $img_height $4;    # height</span><br/><span class=\"line\">                    set $img_ext $5;    # file ext</span><br/><span class=\"line\">                    content_by_lua_file /usr/local/nginx/lua/cropSize.lua;    # load lua</span><br/><span class=\"line\">            }</span><br/><span class=\"line\">    }</span><br/><span class=\"line\"></span><br/><span class=\"line\">    # if need (all go there)</span><br/><span class=\"line\">    location ~* /upload {</span><br/><span class=\"line\">            root $img_original_root;</span><br/><span class=\"line\">    }</span><br/><span class=\"line\"></span><br/><span class=\"line\"></span><br/><span class=\"line\">    location ~ /.ht {</span><br/><span class=\"line\">        deny all;</span><br/><span class=\"line\">    }</span><br/><span class=\"line\">}</span><br/></pre></td></tr></tbody></table></figure>\n<h1 id=\"lua脚本\"><a href=\"#lua脚本\" class=\"headerlink\" title=\"lua脚本\"></a>lua脚本</h1><ul>\n<li>/usr/local/tengine/lua/autoSize.lua</li>\n</ul>\n<figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/><span class=\"line\">13</span><br/><span class=\"line\">14</span><br/><span class=\"line\">15</span><br/><span class=\"line\">16</span><br/><span class=\"line\">17</span><br/><span class=\"line\">18</span><br/><span class=\"line\">19</span><br/><span class=\"line\">20</span><br/><span class=\"line\">21</span><br/><span class=\"line\">22</span><br/><span class=\"line\">23</span><br/><span class=\"line\">24</span><br/><span class=\"line\">25</span><br/><span class=\"line\">26</span><br/><span class=\"line\">27</span><br/><span class=\"line\">28</span><br/><span class=\"line\">29</span><br/><span class=\"line\">30</span><br/><span class=\"line\">31</span><br/><span class=\"line\">32</span><br/><span class=\"line\">33</span><br/><span class=\"line\">34</span><br/><span class=\"line\">35</span><br/><span class=\"line\">36</span><br/><span class=\"line\">37</span><br/><span class=\"line\">38</span><br/><span class=\"line\">39</span><br/><span class=\"line\">40</span><br/><span class=\"line\">41</span><br/><span class=\"line\">42</span><br/><span class=\"line\">43</span><br/><span class=\"line\">44</span><br/><span class=\"line\">45</span><br/><span class=\"line\">46</span><br/><span class=\"line\">47</span><br/><span class=\"line\">48</span><br/><span class=\"line\">49</span><br/><span class=\"line\">50</span><br/><span class=\"line\">51</span><br/><span class=\"line\">52</span><br/><span class=\"line\">53</span><br/><span class=\"line\">54</span><br/><span class=\"line\">55</span><br/><span class=\"line\">56</span><br/><span class=\"line\">57</span><br/><span class=\"line\">58</span><br/><span class=\"line\">59</span><br/><span class=\"line\">60</span><br/><span class=\"line\">61</span><br/><span class=\"line\">62</span><br/><span class=\"line\">63</span><br/><span class=\"line\">64</span><br/><span class=\"line\">65</span><br/><span class=\"line\">66</span><br/><span class=\"line\">67</span><br/><span class=\"line\">68</span><br/><span class=\"line\">69</span><br/><span class=\"line\">70</span><br/><span class=\"line\">71</span><br/><span class=\"line\">72</span><br/><span class=\"line\">73</span><br/><span class=\"line\">74</span><br/><span class=\"line\">75</span><br/><span class=\"line\">76</span><br/><span class=\"line\">77</span><br/><span class=\"line\">78</span><br/><span class=\"line\">79</span><br/><span class=\"line\">80</span><br/><span class=\"line\">81</span><br/><span class=\"line\">82</span><br/><span class=\"line\">83</span><br/><span class=\"line\">84</span><br/><span class=\"line\">85</span><br/><span class=\"line\">86</span><br/><span class=\"line\">87</span><br/><span class=\"line\">88</span><br/><span class=\"line\">89</span><br/><span class=\"line\">90</span><br/><span class=\"line\">91</span><br/><span class=\"line\">92</span><br/><span class=\"line\">93</span><br/><span class=\"line\">94</span><br/><span class=\"line\">95</span><br/><span class=\"line\">96</span><br/><span class=\"line\">97</span><br/><span class=\"line\">98</span><br/><span class=\"line\">99</span><br/><span class=\"line\">100</span><br/><span class=\"line\">101</span><br/><span class=\"line\">102</span><br/><span class=\"line\">103</span><br/><span class=\"line\">104</span><br/><span class=\"line\">105</span><br/><span class=\"line\">106</span><br/><span class=\"line\">107</span><br/><span class=\"line\">108</span><br/><span class=\"line\">109</span><br/><span class=\"line\">110</span><br/><span class=\"line\">111</span><br/><span class=\"l","text":"自己搭建的图片服务器，有图片缩放的需求，大致思路是可以使用nginx调用lua，使用GraphicMagick的命令来做图片缩放 说明文件夹规划lua.jaychang.cn(如/var/filebase) 12345678910111213jaychang@nginx:~$ t...","link":"","photos":[],"count_time":{"symbolsCount":"10k","symbolsTime":"9 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E8%AF%B4%E6%98%8E\"><span class=\"toc-text\">说明</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%96%87%E4%BB%B6%E5%A4%B9%E8%A7%84%E5%88%92\"><span class=\"toc-text\">文件夹规划</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%93%BE%E6%8E%A5%E5%9C%B0%E5%9D%80%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB\"><span class=\"toc-text\">链接地址对应关系</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B\"><span class=\"toc-text\">访问流程</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%89%80%E9%9C%80%E8%BD%AF%E4%BB%B6\"><span class=\"toc-text\">所需软件</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96\"><span class=\"toc-text\">安装依赖</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85Lua-LuaJIT\"><span class=\"toc-text\">编译安装Lua LuaJIT</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85Lua\"><span class=\"toc-text\">编译安装Lua</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85LuaJIT\"><span class=\"toc-text\">编译安装LuaJIT</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85GraphicsMagick\"><span class=\"toc-text\">安装GraphicsMagick</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E5%8F%8A%E7%9B%B8%E5%BA%94%E7%9B%AE%E5%BD%95\"><span class=\"toc-text\">创建用户及相应目录</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85nginx\"><span class=\"toc-text\">编译安装nginx</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%B5%8B%E8%AF%95nginx\"><span class=\"toc-text\">测试nginx</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BF%AE%E6%94%B9nginx-conf%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6\"><span class=\"toc-text\">修改nginx.conf配置文件</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA%E6%94%BE%E5%9B%BE%E7%89%87%E7%9A%84%E7%9B%AE%E5%BD%95\"><span class=\"toc-text\">创建放图片的目录</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE%E7%AB%99%E7%82%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6\"><span class=\"toc-text\">配置站点配置文件</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#lua%E8%84%9A%E6%9C%AC\"><span class=\"toc-text\">lua脚本</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Java并发：分布式应用限流 Redis + Lua 实践","uid":"003649475efb2adaa4694d5e1ecd21f9","slug":"zl/2016-01-01-601_Java并发：分布式应用限流 Redis + Lua 实践","date":"2024-04-03T03:47:35.836Z","updated":"2024-04-03T03:47:35.836Z","comments":true,"path":"api/articles/zl/2016-01-01-601_Java并发：分布式应用限流 Redis + Lua 实践.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"任何限流都不是漫无目的的，也不是一个开关就可以解决的问题，常用的限流算法有：令牌桶，漏桶。在之前的文章中，也讲到过，但是那是基于单机场景来写。 之前文章：接口限流算法：漏桶算法&amp;令牌桶算法 然而再牛逼的机器，再优化的设计，对于特殊场景我们也是要特殊处理的。就拿秒杀来说，可...","link":"","photos":[],"count_time":{"symbolsCount":"8k","symbolsTime":"7 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"使用元表优化 Lua 配置文件 II","uid":"9d4eb2ff3916a88a1e1cbccfb13f1376","slug":"zl/2016-01-01-599_使用元表优化 Lua 配置文件 II","date":"2024-04-03T03:47:35.835Z","updated":"2024-04-03T03:47:35.835Z","comments":true,"path":"api/articles/zl/2016-01-01-599_使用元表优化 Lua 配置文件 II.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" 上回提到元表优化 Lua 配置文件，以减少重复字段，节省内存开销。 除了这种直接地减少内存开销的方法，使用元表还能实现数据的延迟加载，从另一个角度节约内存。 延迟加载 -- PropModel.lua PropModel = &#123; [1001] = &#123; ID ...","link":"","photos":[],"count_time":{"symbolsCount":"1.1k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}