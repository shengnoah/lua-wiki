{"title":"cocos2dx lua socket 使用","uid":"52b7141b34fb98dfea442c44e76f4f96","slug":"zl/2016-01-01-158_cocos2dx lua socket 使用","date":"2024-04-03T03:47:33.050Z","updated":"2024-04-03T03:47:33.051Z","comments":true,"path":"api/articles/zl/2016-01-01-158_cocos2dx lua socket 使用.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<p>从事cocos2dx也有好几年了,从开始的懵懂到现在（不知道如何评价自己，至少能把游戏做出来） 中途磕磕碰碰 想分享下tcp socket在lua中的使用 首先还是引入socket库和定义class和状态码 参考了quick的simple tcp 使用方法</p> <div class=\"language-lua highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\t<span class=\"kd\">local</span> <span class=\"n\">gameSocket</span> <span class=\"o\">=</span> <span class=\"n\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">new</span><span class=\"p\">():</span><span class=\"n\">init</span><span class=\"p\">()</span>\n\t<span class=\"kd\">local</span> <span class=\"k\">function</span> <span class=\"nf\">onConnectStatus</span><span class=\"p\">(</span> <span class=\"n\">code</span><span class=\"p\">,</span> <span class=\"n\">msg</span> <span class=\"p\">)</span>\n<pre><code>&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;\n&lt;span class=&quot;n&quot;&gt;gameSocket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setConnectCallback&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;onConnectStatus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;\n&lt;span class=&quot;n&quot;&gt;gameSocket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;\n</code></pre>\n<p></code></pre></div></div> <p>下面贴代码</p> <div class=\"language-lua highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kd\">local</span> <span class=\"n\">scheduler</span> <span class=\"o\">=</span> <span class=\"n\">cc</span><span class=\"p\">.</span><span class=\"n\">Director</span><span class=\"p\">:</span><span class=\"n\">getInstance</span><span class=\"p\">():</span><span class=\"n\">getScheduler</span><span class=\"p\">()</span><br />\n<span class=\"kd\">local</span> <span class=\"n\">socket</span> <span class=\"o\">=</span> <span class=\"nb\">require</span> <span class=\"s2\">&quot;socket&quot;</span></p>\n<p><span class=\"kd\">local</span> <span class=\"n\">SOCKET_CONNECT_FAIL_TIMEOUT</span> <span class=\"o\">=</span> <span class=\"mi\">3</span>\t<span class=\"c1\">– socket failure timeout</span></p>\n<p><span class=\"kd\">local</span> <span class=\"n\">LuaTcpSocket</span> <span class=\"o\">=</span> <span class=\"n\">class</span><span class=\"p\">(</span><span class=\"s2\">&quot;LuaTcpSocket&quot;</span><span class=\"p\">)</span></p>\n<p><span class=\"kd\">local</span> <span class=\"n\">NET_STATUS</span> <span class=\"o\">=</span> <span class=\"p\">&#123;</span><br />\n<span class=\"n\">unconnected</span> <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">,</span><br />\n<span class=\"n\">connected</span> <span class=\"o\">=</span> <span class=\"mi\">2</span><span class=\"p\">,</span><br />\n<span class=\"n\">lostConnection</span> <span class=\"o\">=</span> <span class=\"mi\">3</span><span class=\"p\">,</span><br />\n<span class=\"p\">&#125;</span></p>\n<p><span class=\"c1\">–初始化</span><br />\n<span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">init</span><span class=\"p\">()</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">socket</span> <span class=\"o\">=</span> <span class=\"kc\">nil</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">session</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">tickScheduler</span> <span class=\"o\">=</span> <span class=\"kc\">nil</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"n\">NET_STATUS</span><span class=\"p\">.</span><span class=\"n\">unconnected</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">lastContent</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&quot;</span><br />\n<span class=\"k\">return</span> <span class=\"n\">self</span><br />\n<span class=\"k\">end</span><br />\n<span class=\"c1\">– 判断ipv6 苹果强烈要求</span><br />\n<span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">isIpv6</span><span class=\"p\">(</span> <span class=\"n\">host</span> <span class=\"p\">)</span><br />\n<span class=\"kd\">local</span> <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">socket</span><span class=\"p\">.</span><span class=\"n\">dns</span><span class=\"p\">.</span><span class=\"n\">getaddrinfo</span><span class=\"p\">(</span><span class=\"n\">host</span><span class=\"p\">)</span><br />\n<span class=\"kd\">local</span> <span class=\"n\">ipv6</span> <span class=\"o\">=</span> <span class=\"kc\">false</span><br />\n<span class=\"k\">if</span> <span class=\"n\">result</span> <span class=\"k\">then</span><br />\n<span class=\"k\">for</span> <span class=\"n\">k</span><span class=\"p\">,</span><span class=\"n\">v</span> <span class=\"k\">in</span> <span class=\"nb\">pairs</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span> <span class=\"k\">do</span><br />\n<span class=\"k\">if</span> <span class=\"n\">v</span><span class=\"p\">.</span><span class=\"n\">family</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;inet6&quot;</span> <span class=\"k\">then</span><br />\n<span class=\"n\">ipv6</span> <span class=\"o\">=</span> <span class=\"kc\">true</span><br />\n<span class=\"k\">break</span><br />\n<span class=\"k\">end</span><br />\n<span class=\"k\">end</span><br />\n<span class=\"k\">end</span><br />\n<span class=\"k\">return</span> <span class=\"n\">ipv6</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"c1\">– 连接服务区,ip可以是域名,ipv6环境</span><br />\n<span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">connect</span><span class=\"p\">(</span> <span class=\"n\">ip</span><span class=\"p\">,</span> <span class=\"n\">port</span> <span class=\"p\">)</span><br />\n<span class=\"kd\">local</span> <span class=\"n\">v6</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">:</span><span class=\"n\">isIpv6</span><span class=\"p\">(</span><span class=\"n\">ip</span><span class=\"p\">)</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">lastIp</span> <span class=\"o\">=</span> <span class=\"n\">ip</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">lastPort</span> <span class=\"o\">=</span> <span class=\"n\">port</span></p>\n<pre><code>&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v6&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;\n\t&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tcp6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;\n&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;\n\t&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tcp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;\n&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;\n&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;settimeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;--异步模式&lt;/span&gt;\n\n&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;checkConnect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;\n</code></pre>\n<p><span class=\"k\">end</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">realConnect</span><span class=\"p\">()</span><br />\n<span class=\"kd\">local</span> <span class=\"n\">succ</span><span class=\"p\">,</span> <span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">socket</span><span class=\"p\">:</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">lastIp</span><span class=\"p\">,</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">lastPort</span><span class=\"p\">)</span><br />\n<span class=\"c1\">– print(&quot;LuaTcpSocket.realConnect:&quot;, succ, status)</span><br />\n<span class=\"k\">return</span> <span class=\"n\">succ</span> <span class=\"o\"><mark></span> <span class=\"mi\">1</span> <span class=\"ow\">or</span> <span class=\"n\">status</span> <span class=\"o\"></mark></span> <span class=\"n\">STATUS_ALREADY_CONNECTED</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">checkConnect</span><span class=\"p\">()</span><br />\n<span class=\"n\">self</span><span class=\"p\">:</span><span class=\"n\">stopConnectScheduler</span><span class=\"p\">()</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">waitConnect</span> <span class=\"o\">=</span> <span class=\"mi\">0</span></p>\n<pre><code>&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;connectTimeTickScheduler&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;scheduler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;scheduleScriptFunc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dt&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;\n\t&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;waitConnect&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;waitConnect&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dt&lt;/span&gt;\n\t&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;waitConnect&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SOCKET_CONNECT_FAIL_TIMEOUT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;\n\t\t&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;waitConnect&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;\n\t\t&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;\n\t\t&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;onConnectFail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;\n\t\t&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;\n\t&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;\n\t&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;realConnect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;\n\t\t&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stopConnectScheduler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;\n\t\t&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;onConnected&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;\n\t&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;\n&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;\n</code></pre>\n<p><span class=\"k\">end</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">stopConnectScheduler</span><span class=\"p\">()</span><br />\n<span class=\"k\">if</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">connectTimeTickScheduler</span> <span class=\"k\">then</span><br />\n<span class=\"n\">scheduler</span><span class=\"p\">:</span><span class=\"n\">unscheduleScriptEntry</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">connectTimeTickScheduler</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">connectTimeTickScheduler</span> <span class=\"o\">=</span> <span class=\"kc\">nil</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">close</span><span class=\"p\">()</span><br />\n<span class=\"n\">self</span><span class=\"p\">:</span><span class=\"n\">disconnect</span><span class=\"p\">(</span><span class=\"n\">NET_STATUS</span><span class=\"p\">.</span><span class=\"n\">unconnected</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">isConnected</span><span class=\"p\">()</span><br />\n<span class=\"k\">return</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">NET_STATUS</span><span class=\"p\">.</span><span class=\"n\">connected</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">onConnectFail</span><span class=\"p\">()</span><br />\n<span class=\"k\">if</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">connectCallback</span> <span class=\"o\">~=</span> <span class=\"kc\">nil</span> <span class=\"k\">then</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">connectCallback</span><span class=\"p\">(</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"s2\">&quot;time out&quot;</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">onConnected</span><span class=\"p\">()</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"n\">NET_STATUS</span><span class=\"p\">.</span><span class=\"n\">connected</span><br />\n<span class=\"n\">self</span><span class=\"p\">:</span><span class=\"n\">tick</span><span class=\"p\">()</span><br />\n<span class=\"k\">if</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">connectCallback</span> <span class=\"o\">~=</span> <span class=\"kc\">nil</span> <span class=\"k\">then</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">connectCallback</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"s2\">&quot;sucess&quot;</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">setConnectCallback</span><span class=\"p\">(</span> <span class=\"n\">connectCallback</span> <span class=\"p\">)</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">connectCallback</span> <span class=\"o\">=</span> <span class=\"n\">connectCallback</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">tick</span><span class=\"p\">()</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">tickScheduler</span> <span class=\"o\">=</span> <span class=\"n\">scheduler</span><span class=\"p\">:</span><span class=\"n\">scheduleScriptFunc</span><span class=\"p\">(</span><span class=\"k\">function</span> <span class=\"p\">(</span> <span class=\"n\">dt</span> <span class=\"p\">)</span><br />\n<span class=\"k\">if</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">NET_STATUS</span><span class=\"p\">.</span><span class=\"n\">connected</span> <span class=\"k\">then</span><br />\n<span class=\"kd\">local</span> <span class=\"n\">chunck</span><span class=\"p\">,</span> <span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"n\">partial</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">socket</span><span class=\"p\">:</span><span class=\"n\">receive</span><span class=\"p\">(</span><span class=\"s2\">&quot;*a&quot;</span><span class=\"p\">)</span><br />\n<span class=\"c1\">– print(&quot;chunck&quot;,type(chunck),chunck) --nil\tnil</span><br />\n<span class=\"c1\">– print(&quot;status&quot;,type(status),status)  --string\ttimeout</span><br />\n<span class=\"c1\">– print(&quot;partial&quot;,type(status),partial) --string  len=0</span></p>\n<pre><code>\t\t&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;status&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;status&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;#34;timeout&amp;#34;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;\n\t\t\t&lt;span class=&quot;nb&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;#34;net status&amp;#34;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;\n\t\t\t&lt;span class=&quot;nb&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;#34;chunck&amp;#34;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;chunck&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;\n\t\t\t&lt;span class=&quot;nb&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;#34;partial&amp;#34;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;partial&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;\n\t\t\t&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;disconnect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NET_STATUS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lostConnection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;\n\t\t\t&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;\n\t\t&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;\n\n\t\t&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;chunck&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;chunck&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;partial&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;partial&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;\n\t\t\t&lt;span class=&quot;c1&quot;&gt;-- print(&amp;#34;no data return 111&amp;#34;)&lt;/span&gt;\n\t\t\t&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;\n\t\t&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;\n\n\t\t&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;partial&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;partial&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;\n\t\t\t&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lastContent&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lastContent&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;..&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;partial&lt;/span&gt;\n\t\t&lt;span class=&quot;k&quot;&gt;elseif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;chunck&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;chunck&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;\n\t\t\t&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lastContent&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lastContent&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;..&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;chunck&lt;/span&gt;\n\t\t&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;\n\t\t\n\n\t\t&lt;span class=&quot;kd&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;flag&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;remain&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;unpackage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lastContent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;\n\t\t&lt;span class=&quot;c1&quot;&gt;-- print(&amp;#34;flag,remain,err&amp;#34;,flag,remain,err)&lt;/span&gt;\n\t\t&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;flag&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;\n\t\t\t&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lastContent&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;#34;&amp;#34;&lt;/span&gt;\n\t\t&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;\n\t\t\t&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;\n\t\t\t\t&lt;span class=&quot;nb&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;#34;why happen????&amp;#34;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;\n\t\t\t\t&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;disconnect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NET_STATUS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lostConnection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;\n\t\t\t\t&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;\n\t\t\t&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;\n\t\t\t&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lastContent&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;remain&lt;/span&gt;\n\t\t&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;\n\t\n\t&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;\n\t\t&lt;span class=&quot;c1&quot;&gt;-- print(&amp;#34;error tick&amp;#34;,self.status)&lt;/span&gt;\n\t&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;\n\n&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;\n</code></pre>\n<p><span class=\"k\">end</span></p>\n<p><span class=\"c1\">– return sucess, content, err</span><br />\n<span class=\"c1\">– 这里用自己的字节流实现包的解压缩,需要注意半包,多包</span><br />\n<span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">unpackage</span><span class=\"p\">(</span> <span class=\"n\">content</span> <span class=\"p\">)</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"c1\">– 发生数据,也是用字节流</span><br />\n<span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">send</span><span class=\"p\">(</span> <span class=\"n\">data</span> <span class=\"p\">)</span><br />\n<span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">self</span><span class=\"p\">:</span><span class=\"n\">isConnected</span><span class=\"p\">()</span> <span class=\"k\">then</span><br />\n<span class=\"n\">self</span><span class=\"p\">:</span><span class=\"n\">disconnect</span><span class=\"p\">(</span><span class=\"n\">NET_STATUS</span><span class=\"p\">.</span><span class=\"n\">lostConnection</span><span class=\"p\">)</span><br />\n<span class=\"k\">return</span><br />\n<span class=\"k\">end</span></p>\n<pre><code>&lt;span class=&quot;kd&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;\n&lt;span class=&quot;c1&quot;&gt;-- print(&amp;#34;send,i err&amp;#34;,i,err)&lt;/span&gt;\n\n&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;\n\t&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;#34;closed&amp;#34;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;\n\t\t&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;disconnect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NET_STATUS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lostConnection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;\n\t&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;\n&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;\n</code></pre>\n<p><span class=\"k\">end</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">disconnect</span><span class=\"p\">(</span> <span class=\"n\">status</span> <span class=\"p\">)</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"n\">status</span><br />\n<span class=\"k\">if</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">socket</span> <span class=\"k\">then</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">socket</span><span class=\"p\">:</span><span class=\"n\">close</span><span class=\"p\">()</span><br />\n<span class=\"k\">end</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">socket</span> <span class=\"o\">=</span> <span class=\"kc\">nil</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">lastContent</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&quot;</span><br />\n<span class=\"n\">self</span><span class=\"p\">:</span><span class=\"n\">stopTickScheduler</span><span class=\"p\">()</span><br />\n<span class=\"n\">self</span><span class=\"p\">:</span><span class=\"n\">stopConnectScheduler</span><span class=\"p\">()</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">stopTickScheduler</span><span class=\"p\">()</span><br />\n<span class=\"k\">if</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">tickScheduler</span> <span class=\"o\">~=</span> <span class=\"kc\">nil</span> <span class=\"k\">then</span><br />\n<span class=\"n\">scheduler</span><span class=\"p\">:</span><span class=\"n\">unscheduleScriptEntry</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">tickScheduler</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span><br />\n<span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">tickScheduler</span> <span class=\"o\">=</span> <span class=\"kc\">nil</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"k\">function</span> <span class=\"nf\">LuaTcpSocket</span><span class=\"p\">:</span><span class=\"n\">reconnect</span><span class=\"p\">()</span><br />\n<span class=\"k\">return</span> <span class=\"n\">self</span><span class=\"p\">:</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">lastIp</span><span class=\"p\">,</span><span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">lastPort</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span></p>\n<p></code></pre></div></div></p>\n","text":"从事cocos2dx也有好几年了,从开始的懵懂到现在（不知道如何评价自己，至少能把游戏做出来） 中途磕磕碰碰 想分享下tcp socket在lua中的使用 首先还是引入socket库和定义class和状态码 参考了quick的simple tcp 使用方法 local gameS...","link":"","photos":[],"count_time":{"symbolsCount":"18k","symbolsTime":"17 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"lua 迭代器和泛型for","uid":"3b0fab6604d54755a5ebd02f17ce752d","slug":"zl/2016-01-01-15_lua 迭代器和泛型for","date":"2024-04-03T03:47:33.051Z","updated":"2024-04-03T03:47:33.052Z","comments":true,"path":"api/articles/zl/2016-01-01-15_lua 迭代器和泛型for.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" &lt;h2 id=&quot;迭代器和闭包&quot;&gt;迭代器和闭包&lt;/h2&gt; 迭代器可以遍历集合的每一个元素，在lua中常常使用函数来描述迭代器，每次调用该函数就返回集合的下一个元素。 迭代器需要保留上一次成功调用的状态和下一次成功调用的状态，也就是它知道...","link":"","photos":[],"count_time":{"symbolsCount":"3.7k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"LuaT开发","uid":"bc2226ea889a012b6327c0bcc220cfe3","slug":"zl/2016-01-01-154_LuaT开发","date":"2024-04-03T03:47:33.047Z","updated":"2024-04-03T03:47:33.047Z","comments":true,"path":"api/articles/zl/2016-01-01-154_LuaT开发.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" 准备 Air800 M4开发板 LuaTools 开发板合宙官网 Air800 M4开发板 Air800 M4开发板_详情 开发文档下载调试工具LuaTools的使用指南 时间线 LuaT维基开发文档 成型源码Github_Luat_2G_RDA_8955 实例LuaT实例 L...","link":"","photos":[],"count_time":{"symbolsCount":"1.1k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}