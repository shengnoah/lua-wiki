{"title":"centos下安装openresty+ngx_lua_waf防火墙部署","uid":"0bbecffdbf888a921316fd4ef393eaaa","slug":"zl/2016-01-01-898_centos下安装openresty+ngx_lua_waf防火墙部署","date":"2024-04-03T03:47:36.170Z","updated":"2024-04-03T03:47:36.170Z","comments":true,"path":"api/articles/zl/2016-01-01-898_centos下安装openresty+ngx_lua_waf防火墙部署.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<p>全文默认安装路径：/usr/local/src</p>\n<h3 id=\"1、安装Luagit\"><a href=\"#1、安装Luagit\" class=\"headerlink\" title=\"1、安装Luagit:\"></a>1、安装Luagit:</h3><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"># cd /usr/local/src</span><br/><span class=\"line\"># wget http://luajit.org/download/LuaJIT-2.1.0-beta3.tar.gz</span><br/><span class=\"line\"># tar -zxvf LuaJIT-2.1.0-beta3.tar.gz</span><br/><span class=\"line\"># cd LuaJIT-2.1.0-beta3</span><br/><span class=\"line\"># make</span><br/><span class=\"line\"># make install</span><br/><span class=\"line\">#ln -sf luajit-2.1.0-beta3 /usr/local/bin/luajit</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"2、安装openresty\"><a href=\"#2、安装openresty\" class=\"headerlink\" title=\"2、安装openresty:\"></a>2、安装openresty:</h3><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"># cd /usr/local/src</span><br/><span class=\"line\"># wget http://openresty.org/download/ngx_openresty-1.13.6.2.tar.gz</span><br/><span class=\"line\"># wget https://sourceforge.net/projects/pcre/files/pcre/8.42/pcre-8.42.tar.gz</span><br/><span class=\"line\"># tar -zvxf pcre-8.42.tar.gz</span><br/><span class=\"line\"># tar -zvxf ngx_openresty-1.13.6.2.tar.gz</span><br/><span class=\"line\"># cd ngx_openresty-1.13.6.2.tar.gz</span><br/><span class=\"line\"># ./configure --prefix=/usr/local/openresty --with-luajit --with-pcre=/usr/local/src/pcre-8.42/ --with-http_stub_status_module --with-http_gzip_static_module --with-http_ssl_module</span><br/><span class=\"line\"># gmake &amp;&amp; gmake install</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"3、下载ngx-lua-waf\"><a href=\"#3、下载ngx-lua-waf\" class=\"headerlink\" title=\"3、下载ngx_lua_waf\"></a>3、下载ngx_lua_waf</h3><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"># cd /usr/local/openresty/nginx/</span><br/><span class=\"line\"># git clone https://github.com/loveshell/ngx_lua_waf.git</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"4、修改nginx添加配置，支持lua脚本地址，在http段位置：\"><a href=\"#4、修改nginx添加配置，支持lua脚本地址，在http段位置：\" class=\"headerlink\" title=\"4、修改nginx添加配置，支持lua脚本地址，在http段位置：\"></a>4、修改nginx添加配置，支持lua脚本地址，在http段位置：</h3><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">###相关项目存放地址</span><br/><span class=\"line\">lua_package_path &#34;/usr/local/openresty/nginx/ngx_lua_waf/?.lua&#34;;</span><br/><span class=\"line\">###存放limit表的大小</span><br/><span class=\"line\">lua_shared_dict limit 10m;</span><br/><span class=\"line\">###相应地址</span><br/><span class=\"line\">init_by_lua_file  /usr/local/openresty/nginx/ngx_lua_waf/init.lua;</span><br/><span class=\"line\">access_by_lua_file /usr/local/openresty/nginx/ngx_lua_waf/waf.lua;</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"5、修改ngx-lua-waf相关配置：\"><a href=\"#5、修改ngx-lua-waf相关配置：\" class=\"headerlink\" title=\"5、修改ngx_lua_waf相关配置：\"></a>5、修改ngx_lua_waf相关配置：</h3><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/><span class=\"line\">13</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">RulePath = &#34;/usr/local/openresty/nginx/ngx_lua_waf/wafconf/&#34;   ##指定相应位置</span><br/><span class=\"line\">attacklog = &#34;on&#34;                            ##开启日志</span><br/><span class=\"line\">logdir = &#34;/usr/local/openresty/nginx/logs/hack/&#34;           ##日志存放位置</span><br/><span class=\"line\">UrlDeny=&#34;on&#34;                              ##是否开启URL防护</span><br/><span class=\"line\">Redirect=&#34;on&#34;                             ##地址重定向</span><br/><span class=\"line\">CookieMatch=&#34;on&#34;                           ##cookie拦截</span><br/><span class=\"line\">postMatch=&#34;on&#34;                            ##post拦截</span><br/><span class=\"line\">whiteModule=&#34;on&#34;                           ##白名单</span><br/><span class=\"line\">black_fileExt={&#34;php&#34;,&#34;jsp&#34;}                        </span><br/><span class=\"line\">ipWhitelist={&#34;127.0.0.1&#34;}                    ##白名单IP</span><br/><span class=\"line\">ipBlocklist={&#34;1.0.0.1&#34;}                     ##黑名单IP</span><br/><span class=\"line\">CCDeny=&#34;on&#34;                             ##开启CC防护        </span><br/><span class=\"line\">CCrate=&#34;100/60&#34;                          ##60秒内允许同一个IP访问100次</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"6、创建日志存放目录：\"><a href=\"#6、创建日志存放目录：\" class=\"headerlink\" title=\"6、创建日志存放目录：\"></a>6、创建日志存放目录：</h3><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"># mkdir /usr/local/openresty/nginx/logs/hack/</span><br/><span class=\"line\"># chown -R nobody:nobody /usr/local/openresty/nginx/logs/hack/</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"7、启动nginx-测试\"><a href=\"#7、启动nginx-测试\" class=\"headerlink\" title=\"7、启动nginx 测试\"></a>7、启动nginx 测试</h3><figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"># cd /usr/local/openresty/nginx/sbin</span><br/><span class=\"line\"># ./nginx</span><br/></pre></td></tr></tbody></table></figure>","text":"全文默认安装路径：/usr/local/src 1、安装Luagit:1234567# cd /usr/local/src# wget http://luajit.org/download/LuaJIT-2.1.0-beta3.tar.gz# tar -zxvf LuaJIT-2...","link":"","photos":[],"count_time":{"symbolsCount":"2.2k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1%E3%80%81%E5%AE%89%E8%A3%85Luagit\"><span class=\"toc-text\">1、安装Luagit:</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2%E3%80%81%E5%AE%89%E8%A3%85openresty\"><span class=\"toc-text\">2、安装openresty:</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3%E3%80%81%E4%B8%8B%E8%BD%BDngx-lua-waf\"><span class=\"toc-text\">3、下载ngx_lua_waf</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#4%E3%80%81%E4%BF%AE%E6%94%B9nginx%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%EF%BC%8C%E6%94%AF%E6%8C%81lua%E8%84%9A%E6%9C%AC%E5%9C%B0%E5%9D%80%EF%BC%8C%E5%9C%A8http%E6%AE%B5%E4%BD%8D%E7%BD%AE%EF%BC%9A\"><span class=\"toc-text\">4、修改nginx添加配置，支持lua脚本地址，在http段位置：</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5%E3%80%81%E4%BF%AE%E6%94%B9ngx-lua-waf%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%EF%BC%9A\"><span class=\"toc-text\">5、修改ngx_lua_waf相关配置：</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#6%E3%80%81%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E5%AD%98%E6%94%BE%E7%9B%AE%E5%BD%95%EF%BC%9A\"><span class=\"toc-text\">6、创建日志存放目录：</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#7%E3%80%81%E5%90%AF%E5%8A%A8nginx-%E6%B5%8B%E8%AF%95\"><span class=\"toc-text\">7、启动nginx 测试</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"【leetcode】 399 Evaluate Division","uid":"08d7b5270d0c73bad7990bd645f47b7c","slug":"zl/2016-01-01-897_【leetcode】 399 Evaluate Division","date":"2024-04-03T03:47:36.170Z","updated":"2024-04-03T03:47:36.170Z","comments":true,"path":"api/articles/zl/2016-01-01-897_【leetcode】 399 Evaluate Division.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"给出一些等式，求给定表达式的结果 描述方程式以A/B=k格式给出，其中A和B是用字符串表示的变量，k是实数（浮点数）。给定一些查询，返回答案。如果答案不存在，返回-1。 比如给定: A / B = 2.0，B / C = 3.0。要求: A / C = ？ B / A = ？ A...","link":"","photos":[],"count_time":{"symbolsCount":"2.6k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Lua初体验","uid":"a6fc4e9a872c7a40f571a0b909dcaa98","slug":"zl/2016-01-01-89_Lua初体验","date":"2024-04-03T03:47:36.170Z","updated":"2024-04-03T03:47:36.170Z","comments":true,"path":"api/articles/zl/2016-01-01-89_Lua初体验.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"背景 项目中后期需要支持热更新，因此只能把之前基于UGUI的C#外围逻辑全部修改为Lua，修改过程中的方案是做一个兼容处理，新逻辑用Lua，并在项目推进过程中逐步把外围都改为Lua编码。 项目中的接入实践 工程目录结构 XFramework/lua -- C#端脚本根目录 ---...","link":"","photos":[],"count_time":{"symbolsCount":"3.8k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}