{"title":"Lua 正确处理可变参数","uid":"9073ce92e645b93c4caec3a7c43f9966","slug":"zl/2016-01-01-442_Lua 正确处理可变参数 ","date":"2024-04-03T03:47:35.727Z","updated":"2024-04-03T03:47:35.727Z","comments":true,"path":"api/articles/zl/2016-01-01-442_Lua 正确处理可变参数 .json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<p>为了在 Lua 里处理可变参数，我们可能会写下面这样的代码：</p>\n<div class=\"language-lua highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kd\">local</span> <span class=\"k\">function</span> <span class=\"nf\">args</span><span class=\"p\">(</span><span class=\"o\">...</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"nb\">next</span><span class=\"p\">(&#123;</span><span class=\"o\">...</span><span class=\"p\">&#125;)</span> <span class=\"k\">then</span>\n        <span class=\"k\">for</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">v</span> <span class=\"k\">in</span> <span class=\"nb\">ipairs</span><span class=\"p\">&#123;</span><span class=\"o\">...</span><span class=\"p\">&#125;</span> <span class=\"k\">do</span>\n            <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">)</span>\n        <span class=\"k\">end</span>\n    <span class=\"k\">else</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&#34;empty var&#34;</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n<p><span class=\"n\">args</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"mi\">20</span><span class=\"p\">,</span> <span class=\"mi\">30</span><span class=\"p\">)</span></p>\n<p><span class=\"c1\">– output:</span><br />\n<span class=\"c1\">– 10</span><br />\n<span class=\"c1\">– 20</span><br />\n<span class=\"c1\">– 30</span><br />\n</code></pre></div></div></p>\n<p>咋一看，貌似没什么问题，但是当传入 <code class=\"highlighter-rouge\">args(10, nil, 30)</code> 时，发现并不符合我们的预期：</p>\n<div class=\"language-lua highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">-- output:</span>\n<span class=\"c1\">-- 10</span>\n</code></pre></div></div>\n<p>原因就在于 <code class=\"highlighter-rouge\">ipairs</code> 遍历的 table 必须是一个序列。序列的数字索引必须连续。table 中间包括 <code class=\"highlighter-rouge\">nil</code>，这样的 table 就不是序列，例如：<code class=\"highlighter-rouge\">a=&#123;10, nil, 30&#125;</code> 它不是序列，因为它的数字索引是 1 3 不是连续的, 所以它不是序列。为了处理这个问题，就要引入 <code class=\"highlighter-rouge\">select</code> 了。</p>\n<p>调用 <code class=\"highlighter-rouge\">select</code> 时，需要传入一个 selector 和变长参数。如果 selector 为数字 n, 那么 <code class=\"highlighter-rouge\">select</code> 返回它的第 n 个可变实参，否则只能为字符串 #, 这样 <code class=\"highlighter-rouge\">select</code> 会返回变长参数的总数。</p>\n<p>增强后的函数为：</p>\n<div class=\"language-lua highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kd\">local</span> <span class=\"k\">function</span> <span class=\"nf\">args</span><span class=\"p\">(</span><span class=\"o\">...</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"nb\">next</span><span class=\"p\">(&#123;</span><span class=\"o\">...</span><span class=\"p\">&#125;)</span> <span class=\"k\">then</span>\n        <span class=\"c1\">-- get the count of the params</span>\n        <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"nb\">select</span><span class=\"p\">(</span><span class=\"s1\">&#39;#&#39;</span><span class=\"p\">,</span> <span class=\"o\">...</span><span class=\"p\">)</span> <span class=\"k\">do</span>\n            <span class=\"c1\">-- select the param</span>\n            <span class=\"kd\">local</span> <span class=\"n\">param</span> <span class=\"o\">=</span> <span class=\"nb\">select</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"o\">...</span><span class=\"p\">)</span>\n            <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">param</span><span class=\"p\">)</span>\n        <span class=\"k\">end</span>\n    <span class=\"k\">else</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&#34;empty var&#34;</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n<p><span class=\"n\">args</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"kc\">nil</span><span class=\"p\">,</span> <span class=\"mi\">30</span><span class=\"p\">)</span></p>\n<p><span class=\"c1\">– output:</span><br />\n<span class=\"c1\">– 10</span><br />\n<span class=\"c1\">– nil</span><br />\n<span class=\"c1\">– 30</span><br />\n</code></pre></div></div></p>\n<hr/>\n<blockquote>\n  <p>问: 怎么不用 <code class=\"highlighter-rouge\">pairs</code> 来处理？</p>\n</blockquote>\n<p><strong>我个人认为 <code class=\"highlighter-rouge\">pairs</code> 对 <code class=\"highlighter-rouge\">nil</code> 的表达能力是极其有限的</strong>，比如这个用例：</p>\n<div class=\"language-lua highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kd\">local</span> <span class=\"n\">t</span> <span class=\"o\">=</span> <span class=\"p\">&#123;</span><span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"kc\">nil</span><span class=\"p\">,</span> <span class=\"mi\">30</span><span class=\"p\">&#125;</span>\n<p><span class=\"k\">for</span> <span class=\"n\">k</span><span class=\"p\">,</span><span class=\"n\">v</span> <span class=\"k\">in</span> <span class=\"nb\">pairs</span><span class=\"p\">(</span><span class=\"n\">t</span><span class=\"p\">)</span> <span class=\"k\">do</span><br />\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;in&quot;</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">,</span><span class=\"n\">v</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;=============&quot;</span><span class=\"p\">)</span></p>\n<p><span class=\"k\">for</span> <span class=\"n\">i</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"nb\">select</span><span class=\"p\">(</span><span class=\"s1\">'#'</span><span class=\"p\">,</span> <span class=\"n\">unpack</span><span class=\"p\">(</span><span class=\"n\">t</span><span class=\"p\">))</span> <span class=\"k\">do</span><br />\n<span class=\"kd\">local</span> <span class=\"n\">param</span> <span class=\"o\">=</span> <span class=\"nb\">select</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">unpack</span><span class=\"p\">(</span><span class=\"n\">t</span><span class=\"p\">))</span><br />\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">param</span><span class=\"p\">)</span><br />\n<span class=\"k\">end</span></p>\n<p><span class=\"c1\">– output:</span><br />\n<span class=\"c1\">– in\t1\t10</span><br />\n<span class=\"c1\">– in\t3\t30</span><br />\n<span class=\"c1\">– =============</span><br />\n<span class=\"c1\">– 10</span><br />\n<span class=\"c1\">– nil</span><br />\n<span class=\"c1\">– 30</span><br />\n</code></pre></div></div></p>\n<p>可以看到 <code class=\"highlighter-rouge\">pairs</code> 只遍历了两次，1 =&gt; 10、3 =&gt; 20 其并没有表现出 2 =&gt; nil ，虽然我们可以从结果来推断出这个结论，但是显然，在某些场景下我们更需要的是直接还原出这个结果来。这其实和 cjson 的稀松数组类似。</p>\n<p>而使用 <code class=\"highlighter-rouge\">select</code> 后，我们就可以直接看到期待的效果了。</p>\n<pre><code>            &lt;hr style=&quot;visibility: hidden;&quot;/&gt;\n</code></pre>\n","text":"为了在 Lua 里处理可变参数，我们可能会写下面这样的代码： local function args(...) if next(&#123;...&#125;) then for _, v in ipairs&#123;...&#125; do print(v) end else...","link":"","photos":[],"count_time":{"symbolsCount":"1.5k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"对LuaJIT制作的游戏的简单修改（一）","uid":"6e4664f8c3b0fa66a18a7e477462fa1b","slug":"zl/2016-01-01-443_对LuaJIT制作的游戏的简单修改（一）","date":"2024-04-03T03:47:35.727Z","updated":"2024-04-03T03:47:35.727Z","comments":true,"path":"api/articles/zl/2016-01-01-443_对LuaJIT制作的游戏的简单修改（一）.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"本次修改的游戏是一个使用了LuaJIT制作的梦幻西游类单机游戏，名字叫做《梦战：碧海旭梦》。 这个游戏在我的硬盘里放了有很长一段时间了，当时水平有限，就没有再修改，直到这几天才重新开始研究。 网上关于LuaJIT的分析资料并不多，而有关单机游戏修改的是没有了，所以我基本上是从零开...","link":"","photos":[],"count_time":{"symbolsCount":"2.3k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"财务分析与估值 Financial Analysis and Valuation","uid":"afc7ef521a1f73dbeedc0e71e86df3ec","slug":"zl/2016-01-01-444_财务分析与估值 Financial Analysis and Valuation","date":"2024-04-03T03:47:35.727Z","updated":"2024-04-03T03:47:35.727Z","comments":true,"path":"api/articles/zl/2016-01-01-444_财务分析与估值 Financial Analysis and Valuation.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" 入门别放弃。 企业的价值评估和资产评估是两个不同的概念。 估值——对企业或股权进行估值的过程。 价值组成/来源：主营业务、非经营性净资产——&gt;企业价值 ——&gt;价值分配：负债、其他资本索取权、普通股权益 两类思路： 贴现现金流方法：通过企业创造的（或者股东能够获得的）...","link":"","photos":[],"count_time":{"symbolsCount":"3.3k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}