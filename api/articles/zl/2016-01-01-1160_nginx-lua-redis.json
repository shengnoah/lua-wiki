{"title":"nginx-lua-redis","uid":"d1ab0de5fb0131f1938cebe0ec535ad4","slug":"zl/2016-01-01-1160_nginx-lua-redis","date":"2024-04-03T03:47:33.020Z","updated":"2024-04-03T03:47:33.021Z","comments":true,"path":"api/articles/zl/2016-01-01-1160_nginx-lua-redis.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<h2 id=\"lua\">lua</h2><figure class=\"highlight sql\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get <span class=\"operator\"><span class=\"keyword\">install</span> lua5<span class=\"number\">.1</span></span><br/><span class=\"line\">apt-<span class=\"keyword\">get</span> <span class=\"keyword\">install</span> liblua5<span class=\"number\">.1</span>-dev</span><br/><span class=\"line\">apt-<span class=\"keyword\">get</span> <span class=\"keyword\">install</span> liblua5<span class=\"number\">.1</span>-socket2</span></span><br/></pre></td></tr></tbody></table></figure>\n<p>如果liblua5.1-socket2安装不上，需要添加源<br/></p><figure class=\"highlight groovy\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">deb <span class=\"string\">http:</span></span><br/></pre></td></tr></tbody></table></figure><p></p>\n<p>然后执行<br/></p><figure class=\"highlight q\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt-<span class=\"built_in\">get</span> <span class=\"keyword\">update</span></span><br/></pre></td></tr></tbody></table></figure><p></p>\n<h2 id=\"扩展\">扩展</h2><h3 id=\"lua-redis-parser\">lua-redis-parser</h3><figure class=\"highlight vim\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">git clone http<span class=\"variable\">s:</span>//github.<span class=\"keyword\">com</span>/agentzh/<span class=\"keyword\">lua</span>-redis-parser.git</span><br/><span class=\"line\">export LUA_INCLUDE_DIR=/usr/include/lua5.<span class=\"number\">1</span></span><br/><span class=\"line\"><span class=\"keyword\">cd</span> <span class=\"keyword\">lua</span>-redis-parser</span><br/><span class=\"line\"><span class=\"keyword\">make</span> CC=gcc</span><br/><span class=\"line\"><span class=\"keyword\">make</span> install CC=gcc</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"json\">json</h3><figure class=\"highlight cpp\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">wget http:<span class=\"comment\">//files.luaforge.net/releases/json/json/0.9.50/json4lua-0.9.50.zip</span></span><br/><span class=\"line\">unzip json4lua-<span class=\"number\">0.9</span><span class=\"number\">.50</span>.zip</span><br/><span class=\"line\">cp json4lua-<span class=\"number\">0.9</span><span class=\"number\">.50</span>/json/json.lua /usr/share/lua/<span class=\"number\">5.1</span>/</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"redis-lua\">redis-lua</h3><figure class=\"highlight vim\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">git clone http<span class=\"variable\">s:</span>//github.<span class=\"keyword\">com</span>/nrk/redis-<span class=\"keyword\">lua</span>.git</span><br/><span class=\"line\"><span class=\"keyword\">cp</span> redis-<span class=\"keyword\">lua</span>/src/redis.<span class=\"keyword\">lua</span> /usr/share/<span class=\"keyword\">lua</span>/<span class=\"number\">5.1</span>/</span><br/></pre></td></tr></tbody></table></figure>\n<h2 id=\"nginx\">nginx</h2><h3 id=\"module\">module</h3><figure class=\"highlight vim\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">git clone http<span class=\"variable\">s:</span>//github.<span class=\"keyword\">com</span>/simpl/ngx_devel_kit.git</span><br/><span class=\"line\">git clone http<span class=\"variable\">s:</span>//github.<span class=\"keyword\">com</span>/chaoslawful/<span class=\"keyword\">lua</span>-nginx-module.git</span><br/><span class=\"line\">git clone http<span class=\"variable\">s:</span>//github.<span class=\"keyword\">com</span>/agentzh/redis2-nginx-module.git</span><br/><span class=\"line\">git clone http<span class=\"variable\">s:</span>//github.<span class=\"keyword\">com</span>/agentzh/<span class=\"keyword\">set</span>-misc-nginx-module.git</span><br/><span class=\"line\">git clone http<span class=\"variable\">s:</span>//github.<span class=\"keyword\">com</span>/agentzh/<span class=\"keyword\">echo</span>-nginx-module.git</span><br/><span class=\"line\">git clone http<span class=\"variable\">s:</span>//github.<span class=\"keyword\">com</span>/catap/ngx_http_upstream_keepalive.git</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"编译依赖\">编译依赖</h3><figure class=\"highlight q\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">apt-<span class=\"built_in\">get</span> install libpcre3 libpcre3-<span class=\"built_in\">dev</span> libltdl-<span class=\"built_in\">dev</span> libssl-<span class=\"built_in\">dev</span> libjpeg62 libjpeg62-<span class=\"built_in\">dev</span> libpng12-<span class=\"number\">0</span> libpng12-<span class=\"built_in\">dev</span> libxml2-<span class=\"built_in\">dev</span> libcurl4-openssl-<span class=\"built_in\">dev</span> libmcrypt-<span class=\"built_in\">dev</span> autoconf libxslt1-<span class=\"built_in\">dev</span>  libgeoip-<span class=\"built_in\">dev</span> libperl-<span class=\"built_in\">dev</span> -y</span><br/><span class=\"line\">apt-<span class=\"built_in\">get</span> install libgd2-noxpm-<span class=\"built_in\">dev</span> -y</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"下载\">下载</h3><figure class=\"highlight cpp\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">wget http:<span class=\"comment\">//nginx.org/download/nginx-1.8.0.tar.gz</span></span><br/><span class=\"line\">tar zxvf nginx-<span class=\"number\">1.8</span><span class=\"number\">.0</span>.tar.gz</span><br/><span class=\"line\">cd nginx-<span class=\"number\">1.8</span><span class=\"number\">.0</span></span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"配置\">配置</h3><figure class=\"highlight livescript\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">./configure --prefix=/usr/local/nginx --<span class=\"keyword\">with</span>-debug --<span class=\"keyword\">with</span>-http_addition_module <span class=\"string\"></span></span><br/><span class=\"line\">--<span class=\"keyword\">with</span>-http_dav_module --<span class=\"keyword\">with</span>-http_flv_module --<span class=\"keyword\">with</span>-http_geoip_module <span class=\"string\"></span></span><br/><span class=\"line\">--<span class=\"keyword\">with</span>-http_gzip_static_module --<span class=\"keyword\">with</span>-http_image_filter_module --<span class=\"keyword\">with</span>-http_perl_module <span class=\"string\"></span></span><br/><span class=\"line\">--<span class=\"keyword\">with</span>-http_random_index_module --<span class=\"keyword\">with</span>-http_realip_module --<span class=\"keyword\">with</span>-http_secure_link_module <span class=\"string\"></span></span><br/><span class=\"line\">--<span class=\"keyword\">with</span>-http_stub_status_module --<span class=\"keyword\">with</span>-http_ssl_module --<span class=\"keyword\">with</span>-http_sub_module <span class=\"string\"></span></span><br/><span class=\"line\">--<span class=\"keyword\">with</span>-http_xslt_module --<span class=\"keyword\">with</span>-ipv6 --<span class=\"keyword\">with</span>-sha1=/usr/include/openssl <span class=\"string\"></span></span><br/><span class=\"line\">--<span class=\"keyword\">with</span>-md5=/usr/include/openssl --<span class=\"keyword\">with</span>-mail --<span class=\"keyword\">with</span>-mail_ssl_module <span class=\"string\"></span></span><br/><span class=\"line\">--add-<span class=\"built_in\">module</span>=../ngx_devel_kit <span class=\"string\"></span></span><br/><span class=\"line\">--add-<span class=\"built_in\">module</span>=../echo-nginx-<span class=\"built_in\">module</span> <span class=\"string\"></span></span><br/><span class=\"line\">--add-<span class=\"built_in\">module</span>=../lua-nginx-<span class=\"built_in\">module</span> <span class=\"string\"></span></span><br/><span class=\"line\">--add-<span class=\"built_in\">module</span>=../redis2-nginx-<span class=\"built_in\">module</span> <span class=\"string\"></span></span><br/><span class=\"line\">--add-<span class=\"built_in\">module</span>=../set-misc-nginx-<span class=\"built_in\">module</span></span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"编译安装\">编译安装</h3><figure class=\"highlight go\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">make</span></span><br/><span class=\"line\"><span class=\"built_in\">make</span> install</span><br/></pre></td></tr></tbody></table></figure>\n<p>nginx被安装在<code>/usr/local/nginx</code> 下面,默认环境变量里面没有，需要增加连接<br/></p><figure class=\"highlight gradle\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">ln -s <span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/nginx/</span>sbin<span class=\"regexp\">/nginx /u</span>sr<span class=\"regexp\">/sbin/</span>nginx</span><br/></pre></td></tr></tbody></table></figure><p></p>\n<h1 id=\"配置-1\">配置</h1><h2 id=\"nginx-conf\">nginx.conf</h2><p>注释掉 server块，增加引用<br/></p><figure class=\"highlight gradle\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/etc/</span>nginx<span class=\"regexp\">/conf.d/</span>*.conf;</span><br/></pre></td></tr></tbody></table></figure><p></p>\n<h2 id=\"demo-conf\">demo.conf</h2><figure class=\"highlight nginx\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"string\">&#34;/usr/share/lua/5.1/?.lua;;&#34;</span>;</span><br/><span class=\"line\"><span class=\"title\">server</span> {</span><br/><span class=\"line\">    <span class=\"title\">listen</span> <span class=\"number\">80</span>;</span><br/><span class=\"line\">    <span class=\"title\">server_name</span> demo.local;    </span><br/><span class=\"line\">    <span class=\"title\">root</span>  html;</span><br/><span class=\"line\"></span><br/><span class=\"line\">    <span class=\"title\">location</span> /demo {</span><br/><span class=\"line\">        <span class=\"title\">default_type</span> <span class=\"string\">&#39;text/html&#39;</span>;</span><br/><span class=\"line\">        <span class=\"title\">access_by_lua_file</span> <span class=\"string\">&#34;/opt/demo.lua&#34;</span>;</span><br/><span class=\"line\">    }</span><br/><span class=\"line\">}</span><br/></pre></td></tr></tbody></table></figure>\n<h2 id=\"demo-lua\">demo.lua</h2><figure class=\"highlight stylus\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">ngx.<span class=\"function\"><span class=\"title\">say</span><span class=\"params\">(<span class=\"string\">&#34;hello,world&#34;</span>)</span></span></span><br/></pre></td></tr></tbody></table></figure>","text":"lua123apt-get install lua5.1apt-get install liblua5.1-devapt-get install liblua5.1-socket2 如果liblua5.1-socket2安装不上，需要添加源1deb http: 然后执行1sudo...","link":"","photos":[],"count_time":{"symbolsCount":"2.5k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#lua\"><span class=\"toc-text\">lua</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%89%A9%E5%B1%95\"><span class=\"toc-text\">扩展</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#lua-redis-parser\"><span class=\"toc-text\">lua-redis-parser</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#json\"><span class=\"toc-text\">json</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#redis-lua\"><span class=\"toc-text\">redis-lua</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#nginx\"><span class=\"toc-text\">nginx</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#module\"><span class=\"toc-text\">module</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%BC%96%E8%AF%91%E4%BE%9D%E8%B5%96\"><span class=\"toc-text\">编译依赖</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%B8%8B%E8%BD%BD\"><span class=\"toc-text\">下载</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">配置</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85\"><span class=\"toc-text\">编译安装</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE-1\"><span class=\"toc-text\">配置</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#nginx-conf\"><span class=\"toc-text\">nginx.conf</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#demo-conf\"><span class=\"toc-text\">demo.conf</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#demo-lua\"><span class=\"toc-text\">demo.lua</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"lua5.3源码浅读","uid":"a37bb367273076643fbf1c4cb199a433","slug":"zl/2016-01-01-1163_lua5.3源码浅读","date":"2024-04-03T03:47:33.021Z","updated":"2024-04-03T03:47:33.022Z","comments":true,"path":"api/articles/zl/2016-01-01-1163_lua5.3源码浅读.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" Content ","link":"","photos":[],"count_time":{"symbolsCount":42,"symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"lua面向对象学习","uid":"670b7a60e57dc8637ace9a6fd82af9ef","slug":"zl/2016-01-01-115_lua面向对象学习","date":"2024-04-03T03:47:33.020Z","updated":"2024-04-03T03:47:33.020Z","comments":true,"path":"api/articles/zl/2016-01-01-115_lua面向对象学习.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" 元表和元方法 在Lua中，每个值都有一个元表，table和userdata类型的每个变量都可以有各自独立的元表， 其他类型的值则共享其类型所属的单一元表。 基本的metatable 创建新的table时不会创建元表 getmetatable(table) 获取table或者us...","link":"","photos":[],"count_time":{"symbolsCount":"4.7k","symbolsTime":"4 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}