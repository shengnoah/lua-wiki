{"title":"Lua的require机制","uid":"cf3af81c47f105a555a6bc972ab03ba4","slug":"zl/2016-01-01-616_Lua的require机制","date":"2024-04-03T03:47:35.840Z","updated":"2024-04-03T03:47:35.840Z","comments":true,"path":"api/articles/zl/2016-01-01-616_Lua的require机制.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<p>今天仔细读了文档，弄清楚了Lua的模块require机制。<br/>\nLua是通过require函数来加载模块的，只需提供模块的名字，即可通过require(modname)来加载模块。<br/>\nLua是如何通过modname来载入.lua或.so的呢？</p>\n<h3 id=\"默认加载过程\">默认加载过程</h3>\n<ol>\n  <li>package.loaded[modname]中存了模块的数据，有则直接返回</li>\n  <li>顺序遍历package.searchers，获取loader\n    <blockquote>\n      <ol>\n        <li>package.preload[modname]</li>\n        <li>Lua Loader, 通过package.searchpath搜索package.path</li>\n        <li>C Loader, 通过package.searchpath搜索package.cpath</li>\n        <li>All-In-One loader</li>\n      </ol>\n    </blockquote>\n  </li>\n  <li>调用loader载入模块</li>\n  <li>将载入结果保存至package.loaded[modname]并返回结果</li>\n</ol>\n<p>可用lua模拟载入过程：</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>function findloader(modname)\n    local loader = nil\n    local ext = nil\n    for _,s in ipairs(package.searchers) do\n        loader,ext = s(modname)\n        if type(loader)==&#34;function&#34; then return loader,ext end\n    end\n    error(&#34;findloader fail&#34;)\nend\n<p>function myreq(modname)<br />\nlocal m = package.loaded[modname]<br />\nif m then return m end</p>\n<pre><code>local loader,ext = findloader(modname)\nlocal ret = loader(modname, ext) or true\npackage.loaded[modname] = ret\nreturn ret\n</code></pre>\n<p>end<br />\n</code></pre></div></div></p>\n<h3 id=\"all-in-one-loader\">All-In-One Loader</h3>\n<p>例如:</p>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>require(&#34;a.b.c&#34;)\n</code></pre></div></div>\n<ol>\n  <li>查找a的C library(见过程2.3)</li>\n  <li>检查它是否有luaopen_a_b_c函数</li>\n</ol>","text":"今天仔细读了文档，弄清楚了Lua的模块require机制。 Lua是通过require函数来加载模块的，只需提供模块的名字，即可通过require(modname)来加载模块。 Lua是如何通过modname来载入.lua或.so的呢？ 默认加载过程 package.loaded...","link":"","photos":[],"count_time":{"symbolsCount":"1k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%BB%98%E8%AE%A4%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B\"><span class=\"toc-text\">默认加载过程</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#all-in-one-loader\"><span class=\"toc-text\">All-In-One Loader</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Lua源码分享 Gc篇（三）流程之创建对象","uid":"1dfa68e18bc15f978e17b4ce78c93aaa","slug":"zl/2016-01-01-617_Lua源码分享 Gc篇（三）流程之创建对象","date":"2024-04-03T03:47:35.840Z","updated":"2024-04-03T03:47:35.841Z","comments":true,"path":"api/articles/zl/2016-01-01-617_Lua源码分享 Gc篇（三）流程之创建对象.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"[TOC] 前面两篇主要介绍一些基础，帮助后面gc流程理解的。像是饭前的开胃菜一般，让你后面容易吃的更多。接下来几篇都是gc流程相关 这里列出几个问题，你可以直接跳过。当然，有所了解的按照自己的理解去回答一下，或许会有一些新的想法。如果你都会回答的很清晰了，那么接下来的系列几乎可...","link":"","photos":[],"count_time":{"symbolsCount":"4.1k","symbolsTime":"4 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Lua函数 · 花生肉泥","uid":"0a4e90a7478eff69234200526e4c83a5","slug":"zl/2016-01-01-610_Lua函数 · 花生肉泥","date":"2024-04-03T03:47:35.839Z","updated":"2024-04-03T03:47:35.839Z","comments":true,"path":"api/articles/zl/2016-01-01-610_Lua函数 · 花生肉泥.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"函数的构建lua编程语言函数定义格式如下：1234optional_function_scope function (argument1,argument2,argument3...,argumentn) function_body return result_parames_c...","link":"","photos":[],"count_time":{"symbolsCount":"4.7k","symbolsTime":"4 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}