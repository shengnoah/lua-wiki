{"title":"Nginx Lua Redis防CC攻击","uid":"f2b4e762beb1c911253675c112b44934","slug":"zl/2016-01-01-543_Nginx Lua Redis防CC攻击","date":"2024-04-03T03:47:35.811Z","updated":"2024-04-03T03:47:35.812Z","comments":true,"path":"api/articles/zl/2016-01-01-543_Nginx Lua Redis防CC攻击.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<p><i class=\"fa fa-quote-left\"></i> web安全 <i class=\"fa fa-quote-right\"></i></p>\n<h3 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h3><p>Nginx Lua Redis防止CC攻击实现原理：</p>\n<p>同一个外网IP、同一个网址(ngx.var.request_uri)、同一个客户端(http_user_agent)在某一段时间(CCseconds)内访问某个网址(ngx.var.request_uri)超过指定次数(CCcount)，则禁止这个外网IP+同一个客户端(md5(IP+ngx.var.http_user_agent)访问这个网址(ngx.var.request_uri)一段时间(blackseconds)。</p>\n<p>该脚本使用lua编写(依赖nginx+lua)，将信息写到redis(依赖redis.lua)。</p>\n<h3 id=\"Nginx-lua模块安装\"><a href=\"#Nginx-lua模块安装\" class=\"headerlink\" title=\"Nginx lua模块安装\"></a>Nginx lua模块安装</h3><p>重新编译nginx，安装lua模块，或者直接使用《<a href=\"https://oneinstack.com/\" target=\"_blank\" rel=\"noopener noreferrer\">OneinStack</a>》安装OpenResty自带改模块</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/><span class=\"line\">13</span><br/><span class=\"line\">14</span><br/><span class=\"line\">15</span><br/><span class=\"line\">16</span><br/><span class=\"line\">17</span><br/><span class=\"line\">18</span><br/><span class=\"line\">19</span><br/><span class=\"line\">20</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">pushd</span> /root/oneinstack/src</span><br/><span class=\"line\">wget -c http://nginx.org/download/nginx-1.12.1.tar.gz</span><br/><span class=\"line\">wget -c http://mirrors.linuxeye.com/oneinstack/src/openssl-1.0.2l.tar.gz</span><br/><span class=\"line\">wget -c http://mirrors.linuxeye.com/oneinstack/src/pcre-8.41.tar.gz</span><br/><span class=\"line\">wget -c http://luajit.org/download/LuaJIT-2.0.5.tar.gz</span><br/><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/simpl/ngx_devel_kit.git</span><br/><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/openresty/lua-nginx-module.git</span><br/><span class=\"line\">tar xzf nginx-1.12.1.tar.gz</span><br/><span class=\"line\">tar xzf openssl-1.0.2l.tar.gz</span><br/><span class=\"line\">tar xzf pcre-8.41.tar.gz</span><br/><span class=\"line\">tar xzf LuaJIT-2.0.5.tar.gz</span><br/><span class=\"line\"><span class=\"built_in\">pushd</span> LuaJIT-2.0.5</span><br/><span class=\"line\">make &amp;&amp; make install</span><br/><span class=\"line\"><span class=\"built_in\">popd</span></span><br/><span class=\"line\"><span class=\"built_in\">pushd</span> nginx-1.12.1</span><br/><span class=\"line\">./configure --prefix=/usr/<span class=\"built_in\">local</span>/nginx --user=www --group=www --with-http_stub_status_module --with-http_v2_module --with-http_ssl_module --with-http_gzip_static_module --with-http_realip_module --with-http_flv_module --with-http_mp4_module --with-openssl=../openssl-1.0.2l --with-pcre=../pcre-8.41 --with-pcre-jit --with-ld-opt=-ljemalloc --add-module=../lua-nginx-module --add-module=../ngx_devel_kit</span><br/><span class=\"line\">make</span><br/><span class=\"line\">mv /usr/<span class=\"built_in\">local</span>/nginx/sbin/nginx{,_bk}</span><br/><span class=\"line\">cp objs/nginx /usr/<span class=\"built_in\">local</span>/nginx/sbin</span><br/><span class=\"line\">nginx -t </span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"加载redis-lua\"><a href=\"#加载redis-lua\" class=\"headerlink\" title=\"加载redis.lua\"></a>加载redis.lua</h3><figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /usr/<span class=\"built_in\">local</span>/nginx/conf/lua</span><br/><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/nginx/conf/lua</span><br/><span class=\"line\">wget https://github.com/openresty/lua-resty-redis/raw/master/lib/resty/redis.lua</span><br/></pre></td></tr></tbody></table></figure>\n<p>在/usr/local/nginx/conf/nginx.conf http { }中添加：</p>\n<figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">#the Nginx bundle:</span><br/><span class=\"line\">lua_package_path &#34;/usr/local/nginx/conf/lua/redis.lua&#34;;</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"防止CC规则waf-lua\"><a href=\"#防止CC规则waf-lua\" class=\"headerlink\" title=\"防止CC规则waf.lua\"></a>防止CC规则waf.lua</h3><p>将下面内容保存在/usr/local/nginx/conf/lua/waf.lua</p>\n<figure class=\"highlight lua\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/><span class=\"line\">2</span><br/><span class=\"line\">3</span><br/><span class=\"line\">4</span><br/><span class=\"line\">5</span><br/><span class=\"line\">6</span><br/><span class=\"line\">7</span><br/><span class=\"line\">8</span><br/><span class=\"line\">9</span><br/><span class=\"line\">10</span><br/><span class=\"line\">11</span><br/><span class=\"line\">12</span><br/><span class=\"line\">13</span><br/><span class=\"line\">14</span><br/><span class=\"line\">15</span><br/><span class=\"line\">16</span><br/><span class=\"line\">17</span><br/><span class=\"line\">18</span><br/><span class=\"line\">19</span><br/><span class=\"line\">20</span><br/><span class=\"line\">21</span><br/><span class=\"line\">22</span><br/><span class=\"line\">23</span><br/><span class=\"line\">24</span><br/><span class=\"line\">25</span><br/><span class=\"line\">26</span><br/><span class=\"line\">27</span><br/><span class=\"line\">28</span><br/><span class=\"line\">29</span><br/><span class=\"line\">30</span><br/><span class=\"line\">31</span><br/><span class=\"line\">32</span><br/><span class=\"line\">33</span><br/><span class=\"line\">34</span><br/><span class=\"line\">35</span><br/><span class=\"line\">36</span><br/><span class=\"line\">37</span><br/><span class=\"line\">38</span><br/><span class=\"line\">39</span><br/><span class=\"line\">40</span><br/><span class=\"line\">41</span><br/><span class=\"line\">42</span><br/><span class=\"line\">43</span><br/><span class=\"line\">44</span><br/><span class=\"line\">45</span><br/><span class=\"line\">46</span><br/><span class=\"line\">47</span><br/><span class=\"line\">48</span><br/><span class=\"line\">49</span><br/><span class=\"line\">50</span><br/><span class=\"line\">51</span><br/><span class=\"line\">52</span><br/><span class=\"line\">53</span><br/><span class=\"line\">54</span><br/><span class=\"line\">55</span><br/><span class=\"line\">56</span><br/><span class=\"line\">57</span><br/><span class=\"line\">58</span><br/><span class=\"line\">59</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">local</span> get_headers = ngx.req.get_headers</span><br/><span class=\"line\"><span class=\"keyword\">local</span> ua = ngx.var.http_user_agent</span><br/><span class=\"line\"><span class=\"keyword\">local</span> uri = ngx.var.request_uri</span><br/><span class=\"line\"><span class=\"keyword\">local</span> url = ngx.var.host .. uri</span><br/><span class=\"line\"><span class=\"keyword\">local</span> redis = <span class=\"built_in\">require</span> <span class=\"string\">&#39;redis&#39;</span></span><br/><span class=\"line\"><span class=\"keyword\">local</span> red = redis.new()</span><br/><span class=\"line\"><span class=\"keyword\">local</span> CCcount = <span class=\"number\">20</span></span><br/><span class=\"line\"><span class=\"keyword\">local</span> CCseconds = <span class=\"number\">60</span></span><br/><span class=\"line\"><span class=\"keyword\">local</span> RedisIP = <span class=\"string\">&#39;127.0.0.1&#39;</span></span><br/><span class=\"line\"><span class=\"keyword\">local</span> RedisPORT = <span class=\"number\">6379</span></span><br/><span class=\"line\"><span class=\"keyword\">local</span> blackseconds = <span class=\"number\">7200</span></span><br/><span class=\"line\"><span class=\"keyword\">if</span> ua == <span class=\"literal\">nil</span> <span class=\"keyword\">then</span></span><br/><span class=\"line\">    ua = <span class=\"string\">&#34;unknown&#34;</span></span><br/><span class=\"line\"><span class=\"keyword\">end</span></span><br/><span class=\"line\"><span class=\"keyword\">if</span> (uri == <span class=\"string\">&#34;/wp-admin.php&#34;</span>) <span class=\"keyword\">then</span></span><br/><span class=\"line\">    CCcount=<span class=\"number\">20</span></span><br/><span class=\"line\">    CCseconds=<span class=\"number\">60</span></span><br/><span class=\"line\"><span class=\"keyword\">end</span></span><br/><span class=\"line\">red:set_timeout(<span class=\"number\">100</span>)</span><br/><span class=\"line\"><span class=\"keyword\">local</span> ok, err = red.connect(red, RedisIP, RedisPORT)</span><br/><span class=\"line\"><span class=\"keyword\">if</span> ok <span class=\"keyword\">then</span></span><br/><span class=\"line\">    red.connect(red, RedisIP, RedisPORT)</span><br/><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">()</span></span></span><br/><span class=\"line\">        IP = ngx.req.get_headers()[<span class=\"string\">&#34;X-Real-IP&#34;</span>]</span><br/><span class=\"line\">        <span class=\"keyword\">if</span> IP == <span class=\"literal\">nil</span> <span class=\"keyword\">then</span></span><br/><span class=\"line\">            IP = ngx.req.get_headers()[<span class=\"string\">&#34;x_forwarded_for&#34;</span>]</span><br/><span class=\"line\">        <span class=\"keyword\">end</span></span><br/><span class=\"line\">        <span class=\"keyword\">if</span> IP == <span class=\"literal\">nil</span> <span class=\"keyword\">then</span></span><br/><span class=\"line\">            IP  = ngx.var.remote_addr</span><br/><span class=\"line\">        <span class=\"keyword\">end</span></span><br/><span class=\"line\">        <span class=\"keyword\">if</span> IP == <span class=\"literal\">nil</span> <span class=\"keyword\">then</span></span><br/><span class=\"line\">            IP  = <span class=\"string\">&#34;unknown&#34;</span></span><br/><span class=\"line\">        <span class=\"keyword\">end</span></span><br/><span class=\"line\">        <span class=\"keyword\">return</span> IP</span><br/><span class=\"line\">    <span class=\"keyword\">end</span></span><br/><span class=\"line\">    <span class=\"keyword\">local</span> token = getClientIp() .. <span class=\"string\">&#34;.&#34;</span> .. ngx.md5(url .. ua)</span><br/><span class=\"line\">    <span class=\"keyword\">local</span> req = red:exists(token)</span><br/><span class=\"line\">    <span class=\"keyword\">if</span> req == <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br/><span class=\"line\">        red:incr(token)</span><br/><span class=\"line\">        red:expire(token,CCseconds)</span><br/><span class=\"line\">    <span class=\"keyword\">else</span></span><br/><span class=\"line\">        <span class=\"keyword\">local</span> times = <span class=\"built_in\">tonumber</span>(red:get(token))</span><br/><span class=\"line\">        <span class=\"keyword\">if</span> times &gt;= CCcount <span class=\"keyword\">then</span></span><br/><span class=\"line\">            <span class=\"keyword\">local</span> blackReq = red:exists(<span class=\"string\">&#34;black.&#34;</span> .. token)</span><br/><span class=\"line\">            <span class=\"keyword\">if</span> (blackReq == <span class=\"number\">0</span>) <span class=\"keyword\">then</span></span><br/><span class=\"line\">                red:set(<span class=\"string\">&#34;black.&#34;</span> .. token,<span class=\"number\">1</span>)</span><br/><span class=\"line\">                red:expire(<span class=\"string\">&#34;black.&#34;</span> .. token,blackseconds)</span><br/><span class=\"line\">                red:expire(token,blackseconds)</span><br/><span class=\"line\">                ngx.<span class=\"built_in\">exit</span>(<span class=\"number\">580</span>)</span><br/><span class=\"line\">            <span class=\"keyword\">else</span></span><br/><span class=\"line\">                ngx.<span class=\"built_in\">exit</span>(<span class=\"number\">580</span>)</span><br/><span class=\"line\">            <span class=\"keyword\">end</span></span><br/><span class=\"line\">            <span class=\"keyword\">return</span></span><br/><span class=\"line\">        <span class=\"keyword\">else</span></span><br/><span class=\"line\">            red:incr(token)</span><br/><span class=\"line\">        <span class=\"keyword\">end</span></span><br/><span class=\"line\">    <span class=\"keyword\">end</span></span><br/><span class=\"line\">    <span class=\"keyword\">return</span></span><br/><span class=\"line\"><span class=\"keyword\">end</span></span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"Nginx虚拟主机加载waf-lua\"><a href=\"#Nginx虚拟主机加载waf-lua\" class=\"headerlink\" title=\"Nginx虚拟主机加载waf.lua\"></a>Nginx虚拟主机加载waf.lua</h3><p>在虚拟主机配置文件/usr/local/nginx/conf/vhost/oneinstack.com.conf</p>\n<figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br/></pre></td><td class=\"code\"><pre><span class=\"line\">access_by_lua_file &#34;/usr/local/nginx/conf/lua/waf.lua&#34;;</span><br/></pre></td></tr></tbody></table></figure>\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p>一分钟之内，一个页面快速点击20次以上，登录redis，看到black开通的key即被禁止访问（nginx 503）</p>\n<img src=\"https://jiesunn.github.io//2019/02/02/2019-02-02-Nginx%20Lua%20Redis防CC攻击/pic1.png\"/>","text":" web安全 原理Nginx Lua Redis防止CC攻击实现原理： 同一个外网IP、同一个网址(ngx.var.request_uri)、同一个客户端(http_user_agent)在某一段时间(CCseconds)内访问某个网址(ngx.var.request_uri)超...","link":"","photos":[],"count_time":{"symbolsCount":"3.7k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%8E%9F%E7%90%86\"><span class=\"toc-text\">原理</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Nginx-lua%E6%A8%A1%E5%9D%97%E5%AE%89%E8%A3%85\"><span class=\"toc-text\">Nginx lua模块安装</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%8A%A0%E8%BD%BDredis-lua\"><span class=\"toc-text\">加载redis.lua</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%98%B2%E6%AD%A2CC%E8%A7%84%E5%88%99waf-lua\"><span class=\"toc-text\">防止CC规则waf.lua</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Nginx%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E5%8A%A0%E8%BD%BDwaf-lua\"><span class=\"toc-text\">Nginx虚拟主机加载waf.lua</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%B5%8B%E8%AF%95\"><span class=\"toc-text\">测试</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Lua语言学习","uid":"dae13169524ea349e263ee8c4692efab","slug":"zl/2016-01-01-542_Lua语言学习","date":"2024-04-03T03:47:35.811Z","updated":"2024-04-03T03:47:35.811Z","comments":true,"path":"api/articles/zl/2016-01-01-542_Lua语言学习.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"Lua 网上教程Lua简明教程 极客学院Openresty教程 Windows安装 使用 tasklist /fi &#34;imagename eq nginx.exe&#34; 命令查看 nginx 进程，其中一个是 master 进程，另一个是 worker 进程 cmd进...","link":"","photos":[],"count_time":{"symbolsCount":"5.9k","symbolsTime":"5 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Lua编程","uid":"126596b376cfeb845620aa16e8a50d64","slug":"zl/2016-01-01-53_Lua编程","date":"2024-04-03T03:47:35.810Z","updated":"2024-04-03T03:47:35.810Z","comments":true,"path":"api/articles/zl/2016-01-01-53_Lua编程.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"1. 将字符串分割成一个一个单元，存在表中 代码如下： local s = &#34;sofgs啊等级高5584撒旦法规&#34; local tb = &#123;&#125; for utfChar in string.gmatch(s, &#34;[%z1-127194-2...","link":"","photos":[],"count_time":{"symbolsCount":"1.4k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}