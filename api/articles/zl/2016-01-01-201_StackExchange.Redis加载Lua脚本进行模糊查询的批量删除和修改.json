{"title":"StackExchange.Redis加载Lua脚本进行模糊查询的批量删除和修改","uid":"f637a9bed7edc1a303f75d2f48bec364","slug":"zl/2016-01-01-201_StackExchange.Redis加载Lua脚本进行模糊查询的批量删除和修改","date":"2024-04-03T03:47:33.083Z","updated":"2024-04-03T03:47:33.083Z","comments":true,"path":"api/articles/zl/2016-01-01-201_StackExchange.Redis加载Lua脚本进行模糊查询的批量删除和修改.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<pre><code>    &lt;ul id=&quot;markdown-toc&quot;&gt;\n</code></pre>\n  <li><a href=\"https://lxljh398.github.io/#%E9%80%9A%E8%BF%87keys%E8%BF%9B%E8%A1%8C%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%E5%90%8E%E7%9A%84%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C\" id=\"markdown-toc-通过keys进行模糊查询后的批量操作\">通过keys进行模糊查询后的批量操作</a></li>\n  <li><a href=\"https://lxljh398.github.io/#%E5%AF%B9hash%E9%9B%86%E5%90%88%E4%B8%8B%E7%9A%84key%E8%BF%9B%E8%A1%8C%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%E5%90%8E%E7%9A%84%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C\" id=\"markdown-toc-对hash集合下的key进行模糊查询后的批量操作\">对Hash集合下的key进行模糊查询后的批量操作</a></li>\n  <li><a href=\"https://lxljh398.github.io/#%E5%AF%B9set%E9%9B%86%E5%90%88%E4%B8%8B%E7%9A%84%E5%80%BC%E8%BF%9B%E8%A1%8C%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%E5%90%8E%E7%9A%84%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C\" id=\"markdown-toc-对set集合下的值进行模糊查询后的批量操作\">对Set集合下的值进行模糊查询后的批量操作</a></li>\n  <li><a href=\"https://lxljh398.github.io/#%E6%B3%A8%E6%84%8F\" id=\"markdown-toc-注意\">注意</a></li>\n</ul>\n<h2 id=\"通过keys进行模糊查询后的批量操作\">通过keys进行模糊查询后的批量操作</h2>\n<div class=\"language-java highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>     <span class=\"n\">var</span> <span class=\"n\">redis</span> <span class=\"o\">=</span> <span class=\"n\">ConnectionMultiplexer</span><span class=\"o\">.</span><span class=\"na\">Connect</span><span class=\"o\">(</span><span class=\"s\">\"127.0.0.1:6379,allowAdmin = true\"</span><span class=\"o\">);</span>\n     <span class=\"n\">redis</span><span class=\"o\">.</span><span class=\"na\">GetDatabase</span><span class=\"o\">().</span><span class=\"na\">ScriptEvaluate</span><span class=\"o\">(</span><span class=\"n\">LuaScript</span><span class=\"o\">.</span><span class=\"na\">Prepare</span><span class=\"o\">(</span>\n         <span class=\"c1\">//Redis的keys模糊查询：</span>\n         <span class=\"s\">\" local ks = redis.call('KEYS', @keypattern) \"</span> <span class=\"o\">+</span> <span class=\"c1\">//local ks为定义一个局部变量，其中用于存储获取到的keys</span>\n         <span class=\"s\">\" for i=1,#ks,5000 do \"</span> <span class=\"o\">+</span>    <span class=\"c1\">//#ks为ks集合的个数, 语句的意思： for(int i = 1; i &lt;= ks.Count; i+=5000)</span>\n         <span class=\"s\">\"     redis.call('del', unpack(ks, i, math.min(i+4999, #ks))) \"</span> <span class=\"o\">+</span> <span class=\"c1\">//Lua集合索引值从1为起始，unpack为解包，获取ks集合中的数据，每次5000，然后执行删除</span>\n         <span class=\"s\">\" end \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" return true \"</span>\n         <span class=\"o\">),</span>\n         <span class=\"k\">new</span> <span class=\"o\">&#123;</span> <span class=\"n\">keypattern</span> <span class=\"o\">=</span> <span class=\"s\">\"mykey*\"</span> <span class=\"o\">&#125;);</span>\n</code></pre></div></div>\n<h2 id=\"对hash集合下的key进行模糊查询后的批量操作\">对Hash集合下的key进行模糊查询后的批量操作</h2>\n<div class=\"language-java highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>     <span class=\"n\">redis</span><span class=\"o\">.</span><span class=\"na\">GetDatabase</span><span class=\"o\">().</span><span class=\"na\">ScriptEvaluate</span><span class=\"o\">(</span><span class=\"n\">LuaScript</span><span class=\"o\">.</span><span class=\"na\">Prepare</span><span class=\"o\">(</span>\n         <span class=\"s\">\" local ks = redis.call('hkeys', @hashid) \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" local fkeys = &#123;&#125; \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" for i=1,#ks do \"</span> <span class=\"o\">+</span>\n         <span class=\"c1\">//使用string.find进行匹配操作</span>\n         <span class=\"s\">\"   if string.find(ks[i], @keypattern) then \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\"      fkeys[#fkeys + 1] = ks[i] \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\"   end \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" end \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" for i=1,#fkeys,5000 do \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\"   redis.call('hdel', @hashid, unpack(fkeys, i, math.min(i+4999, #fkeys))) \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" end \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" return true \"</span>\n         <span class=\"o\">),</span>\n         <span class=\"k\">new</span> <span class=\"o\">&#123;</span> <span class=\"n\">hashid</span> <span class=\"o\">=</span> <span class=\"s\">\"hkey\"</span><span class=\"o\">,</span> <span class=\"n\">keypattern</span> <span class=\"o\">=</span> <span class=\"s\">\"^mykey\"</span> <span class=\"o\">&#125;);</span>   <span class=\"c1\">//keypattern为可使用正则表达式</span>\n</code></pre></div></div>\n<p>或</p>\n<div class=\"language-java highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>     <span class=\"n\">redis</span><span class=\"o\">.</span><span class=\"na\">GetDatabase</span><span class=\"o\">().</span><span class=\"na\">ScriptEvaluate</span><span class=\"o\">(</span><span class=\"n\">LuaScript</span><span class=\"o\">.</span><span class=\"na\">Prepare</span><span class=\"o\">(</span>\n         <span class=\"s\">\" local ks = redis.call('hkeys', @hashid) \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" local fkeys = &#123;&#125; \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" for i=1,#ks do \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\"   if string.find(ks[i], @keypattern) then \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\"      fkeys[#fkeys + 1] = ks[i] \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\"   end \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" end \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" for i=1,#fkeys do \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\"   redis.call('hset', @hashid, fkeys[i], @value) \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" end \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" return true \"</span>\n         <span class=\"o\">),</span>\n         <span class=\"k\">new</span> <span class=\"o\">&#123;</span> <span class=\"n\">hashid</span> <span class=\"o\">=</span> <span class=\"s\">\"hkey\"</span><span class=\"o\">,</span> <span class=\"n\">keypattern</span> <span class=\"o\">=</span> <span class=\"s\">\"^key\"</span><span class=\"o\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"s\">\"hashValue\"</span> <span class=\"o\">&#125;);</span>   <span class=\"c1\">//keypattern为可使用正则表达式</span>\n</code></pre></div></div>\n<h2 id=\"对set集合下的值进行模糊查询后的批量操作\">对Set集合下的值进行模糊查询后的批量操作</h2>\n<div class=\"language-java highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>     <span class=\"n\">redis</span><span class=\"o\">.</span><span class=\"na\">GetDatabase</span><span class=\"o\">().</span><span class=\"na\">ScriptEvaluate</span><span class=\"o\">(</span><span class=\"n\">LuaScript</span><span class=\"o\">.</span><span class=\"na\">Prepare</span><span class=\"o\">(</span>\n         <span class=\"s\">\" local ks = redis.call('smembers', @keyid) \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" local fkeys = &#123;&#125; \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" for i=1,#ks do \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\"   if string.find(ks[i], @keypattern) then \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\"      fkeys[#fkeys + 1] = ks[i] \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\"   end \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" end \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" for i=1,#fkeys,5000 do \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\"   redis.call('srem', @keyid, unpack(fkeys, i, math.min(i+4999, #fkeys))) \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" end \"</span> <span class=\"o\">+</span>\n         <span class=\"s\">\" return true \"</span>\n         <span class=\"o\">),</span>\n         <span class=\"k\">new</span> <span class=\"o\">&#123;</span> <span class=\"n\">keyid</span> <span class=\"o\">=</span> <span class=\"s\">\"setkey\"</span><span class=\"o\">,</span> <span class=\"n\">keypattern</span> <span class=\"o\">=</span> <span class=\"s\">\"^myval\"</span> <span class=\"o\">&#125;);</span>   <span class=\"c1\">//keypattern为可使用正则表达式</span>\n</code></pre></div></div>\n<h2 id=\"注意\">注意</h2>\n<div class=\"highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>从 Redis 2.6.0 版本开始，才可通过内置的 Lua 解释器，使用 EVAL 命令对 Lua 脚本进行求值。\n</code></pre></div></div>","text":" &lt;ul id=&quot;markdown-toc&quot;&gt; 通过keys进行模糊查询后的批量操作 对Hash集合下的key进行模糊查询后的批量操作 对Set集合下的值进行模糊查询后的批量操作 注意 通过keys进行模糊查询后的批量操作 var redis = ...","link":"","photos":[],"count_time":{"symbolsCount":"2.7k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%80%9A%E8%BF%87keys%E8%BF%9B%E8%A1%8C%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%E5%90%8E%E7%9A%84%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C\"><span class=\"toc-text\">通过keys进行模糊查询后的批量操作</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AF%B9hash%E9%9B%86%E5%90%88%E4%B8%8B%E7%9A%84key%E8%BF%9B%E8%A1%8C%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%E5%90%8E%E7%9A%84%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C\"><span class=\"toc-text\">对Hash集合下的key进行模糊查询后的批量操作</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AF%B9set%E9%9B%86%E5%90%88%E4%B8%8B%E7%9A%84%E5%80%BC%E8%BF%9B%E8%A1%8C%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%E5%90%8E%E7%9A%84%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C\"><span class=\"toc-text\">对Set集合下的值进行模糊查询后的批量操作</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%B3%A8%E6%84%8F\"><span class=\"toc-text\">注意</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"proxy_cache_fastcgi_cache_lua","uid":"bef0d97634f836c6fcf89761496747d8","slug":"zl/2016-01-01-206_proxy_cache_fastcgi_cache_lua","date":"2024-04-03T03:47:33.084Z","updated":"2024-04-03T03:47:33.084Z","comments":true,"path":"api/articles/zl/2016-01-01-206_proxy_cache_fastcgi_cache_lua.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" &lt;p&gt;[区别] 网上照搬&lt;br&gt;proxy_cache 缓存后端服务器的内容，可以是动态或者静态的任何内容&lt;br&gt;fastcg_cache 缓存fastcgi生成的内容，很多情况是php生成的内容&lt;br&gt;proxy_cache 主...","link":"","photos":[],"count_time":{"symbolsCount":"3.8k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"EmmyLua 学习使用","uid":"376015f4c2dda13cf46623a4606c4c88","slug":"zl/2016-01-01-202_EmmyLua 学习使用 ","date":"2024-04-03T03:47:33.083Z","updated":"2024-04-03T03:47:33.083Z","comments":true,"path":"api/articles/zl/2016-01-01-202_EmmyLua 学习使用 .json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" &lt;h3 id=&quot;目录&quot;&gt;目录&lt;/h3&gt; lua元表 class的探索 要想对lua有更加深入的了解，不深入的了解lua的元表是不行的，在lua中元表是你构建一个复杂的数据结构的基础，所以需要对元表有非常深入的了解。 元表允许改变tab...","link":"","photos":[],"count_time":{"symbolsCount":"16k","symbolsTime":"15 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}