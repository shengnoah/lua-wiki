{"title":"反编译OpenWrt的Lua文件","uid":"ae5de1c6c94f93e3ef1489dd656b1cb2","slug":"zl/2016-01-01-976_反编译OpenWrt的Lua文件","date":"2024-04-03T03:47:36.235Z","updated":"2024-04-03T03:47:36.235Z","comments":true,"path":"api/articles/zl/2016-01-01-976_反编译OpenWrt的Lua文件.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","content":"<div id=\"md_content_2\" class=\"md_content\" style=\"min-height: 50px;\"><textarea id=\"append-test\" style=\"display:none;\">![](https://xiaokou.top/usr/uploads/md/1569651126274.png)\n先是今天的主角，极路由。\n<p>获取root权限然后拿到web源码，找到对应文件</p>\n<p><img src=\"https://xiaokou.top/usr/uploads/md/1569651204062.png\" alt=\"\" /></p>\n<p><img src=\"https://xiaokou.top/usr/uploads/md/1569651262766.png\" alt=\"\" /><br />\n<img src=\"https://xiaokou.top/usr/uploads/md/1569651242403.png\" alt=\"\" /></p>\n<p><img src=\"https://xiaokou.top/usr/uploads/md/1569651287367.png\" alt=\"\" /><br />\n确认了是lua 5.1以后，google找到了<a href=\"http://ju.outofmemory.cn/entry/356320\">文章</a>，根据内容操作发现了一些问题，最后也都解决了，在这里做一个记录。<br />\n首先</p>\n<ol>\n<li class=\"lvl-3\">\n<p>Lua有一种预编译机制，能够把文本代码预编译成Bytecode/Opcode 提高解析、执行速度，降低内存占用</p>\n</li>\n<li class=\"lvl-3\">\n<p>原版Lua（Vanilla Lua）默认的Bytecode的字节结构和OpenWrt的并不相同，因为OpenWrt为了一系列需要，在截止我写此文时候， 在Lua5.1.5的版本主线上 ， 对原版的LUA引擎打了补丁 ， 导致其产生的字节码和原版的Lua产生的并不一样 ，（ <a href=\"http://lua-users.org/lists/lua-l/2012-06/msg00065.html\">http://lua-users.org/lists/lua-l/2012-06/msg00065.html</a> ），因此也不能使用原版的Lua引擎解释，会报类似 bad header in precompiled chunk 的错误</p>\n</li>\n<li class=\"lvl-3\">\n<p>本机尝试逆向原版的Lua产生的LuaC， 使用这个 luadec 项目 无任何问题   ，但是逆向Openwrt上的luaC失败， 所以需要在Openwrt的Patch过的Lua lib的基础上 ，编译luadec</p>\n</li>\n</ol>\n<p>如果是常规的lua文件 使用Unluac就可以。<br />\n但是我们的这个luac文件是openwrt处理后的，也就不能使用常规的unluac，需要手动打补丁。</p>\n<ol start=\"4\">\n<li class=\"lvl-3\">\n<p>过程</p>\n</li>\n</ol>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"> #安装依赖\nsudo apt install libncurses-dev libreadline-dev\n#获得luadec源码\ngit clone https:&#x2F;&#x2F;github.com&#x2F;viruscamp&#x2F;luadec\ncd luadec\ngit submodule update --init lua-5.1\n#下面开始不同\nref&#x3D;master\npatch_dir&#x3D;patches.$ref\nmkdir $patch_dir &amp;&amp; cd $patch_dir\n#如下命令需要grep支持pcre正则，如果不支持，请自己手动处理把。 \npatchs&#x3D;$(curl -sSL -H &#39;Accept: application&#x2F;vnd.github.v3+json&#39; &#39;https:&#x2F;&#x2F;api.github.com&#x2F;repos&#x2F;openwrt&#x2F;openwrt&#x2F;contents&#x2F;package&#x2F;utils&#x2F;lua&#x2F;patches?ref&#x3D;&#39;&amp;#34;$ref&amp;#34; |grep -oP &#39;name&amp;#34;s*:s*&amp;#34;.*.patch&#39; |grep -oP &#39;d+.*.patch&#39;)\n#下载补丁文件\n#这里的补丁如果下载不成功，可以访问https:&#x2F;&#x2F;github.com&#x2F;openwrt&#x2F;openwrt&#x2F;tree&#x2F;master&#x2F;package&#x2F;utils&#x2F;lua&#x2F;patches-host\n手动下载替换。\nfor p in $patchs;do  \nwget &#39;https:&#x2F;&#x2F;github.com&#x2F;openwrt-mirror&#x2F;openwrt&#x2F;raw&#x2F;&#39;&amp;#34;$ref&amp;#34;&#39;&#x2F;package&#x2F;utils&#x2F;lua&#x2F;patches&#x2F;&#39;$&#123;p&#125;  -O $p; \ndone\ncd ..&#x2F;lua-5.1\n#打上补丁\nfor i in ..&#x2F;$&#123;patch_dir&#125;&#x2F;*.patch; do patch -p1 &lt;$i ; done\nmake linux<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>根据原文内的提示：<br />\n<code>需要修改Makefile 给CFLAGS加上 -fPIC 选项 另外，为了使得Patch过后生成的so文件带版本号，还需要加上版本，最终生成的是如下的lua-5.1/src/Makefile的补丁 </code></p>\n<p>这里修改的是lua-5.1/src下的Makefile</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">--- Makefile.bak\t2018-05-29 18:04:44.979014076 +0800\n+++ Makefile\t2018-05-29 18:21:35.110112120 +0800\n@@ -8,7 +8,7 @@\n PLAT&#x3D; none\n \n CC&#x3D; gcc\n-CFLAGS&#x3D; -O2 -Wall $(MYCFLAGS)\n+CFLAGS&#x3D;  -fPIC -O2 -Wall $(MYCFLAGS)\n AR&#x3D; ar rcu\n RANLIB&#x3D; ranlib\n RM&#x3D; rm -f\n@@ -18,7 +18,7 @@\n MYLDFLAGS&#x3D;\n MYLIBS&#x3D;\n # USE_READLINE&#x3D;1\n-\n+PKG_VERSION &#x3D; 5.1.5\n # &#x3D;&#x3D; END OF USER SETTINGS. NO NEED TO CHANGE ANYTHING BELOW THIS LINE &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n \n PLATS&#x3D; aix ansi bsd freebsd generic linux macosx mingw posix solaris\n #由于openwrt中的lua默认情况下是通过动态链接库进行编译，会出现找不到函数体的错误，参考源码中的设置，将对lua库的连接改为静态：\n \n  $(LUA_T): $(LUA_O) $(LUA_A)\n\t$(CC) -o $@ -L. -llua $(MYLDFLAGS) $(LUA_O) $(LUA_A) $(LIBS)\n\n$(LUAC_T): $(LUAC_O) $(LUA_A)\n\t$(CC) -o $@ -L. -llua $(MYLDFLAGS) $(LUAC_O) $(LUA_A) $(LIBS)\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>做完这些以后，执行一下操作完成编译<br />\nmake linux<br />\nexport LD_LIBRARY_PATH=<code>pwd</code>/src/<br />\ncd …/luadec<br />\nmake LUAVER=5.1</p>\n<ol start=\"5\">\n<li class=\"lvl-3\">\n<p>反编译luci-indexcache<br />\n<img src=\"https://xiaokou.top/usr/uploads/md/1569652208101.png\" alt=\"\" /></p>\n</li>\n</ol>\n<p></textarea></div></p>\n","text":"![](https://xiaokou.top/usr/uploads/md/1569651126274.png) 先是今天的主角，极路由。 获取root权限然后拿到web源码，找到对应文件 确认了是lua 5.1以后，google找到了文章，根据内容操作发现了一些问题，最后也都...","link":"","photos":[],"count_time":{"symbolsCount":"2.9k","symbolsTime":"3 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"toc":"","author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"399 Evaluate Division","uid":"d52806f532a05cde407ce40f8a15f379","slug":"zl/2016-01-01-977_399 Evaluate Division","date":"2024-04-03T03:47:36.235Z","updated":"2024-04-03T03:47:36.236Z","comments":true,"path":"api/articles/zl/2016-01-01-977_399 Evaluate Division.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":"Equations are given in the format A / B = k, where A and B are variables represented as strings, and k is a real number (floating point numb...","link":"","photos":[],"count_time":{"symbolsCount":"6.5k","symbolsTime":"6 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Lua之Table个人总结","uid":"8e148f7d0ca183bc864d5f807e1a3198","slug":"zl/2016-01-01-975_Lua之Table个人总结","date":"2024-04-03T03:47:36.235Z","updated":"2024-04-03T03:47:36.235Z","comments":true,"path":"api/articles/zl/2016-01-01-975_Lua之Table个人总结.json","keywords":"AIGC,LLM,糖果AIGC实验室","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","text":" 在lua中Table是数组和集合的混合物。作为数组时，可以使用除了nil以外的值作为索引。 Table的构造利用下标来标明元素123456local table = {}table[1]=&#39;hello&#39;table[5]=&#39;world&#39;for i,...","link":"","photos":[],"count_time":{"symbolsCount":"4.4k","symbolsTime":"4 mins."},"categories":[{"name":"topic","slug":"topic","count":1441,"path":"api/categories/topic.json"}],"tags":[{"name":"lua文章","slug":"lua文章","count":1133,"path":"api/tags/lua文章.json"}],"author":{"name":"安全书","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"《墨守之道-Web服务安全架构与实践》","socials":{"github":"https://github.com/shengnoah","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/3732639263","zhihu":"https://www.zhihu.com/people/openresty","csdn":"","juejin":"","customs":{}}}}}